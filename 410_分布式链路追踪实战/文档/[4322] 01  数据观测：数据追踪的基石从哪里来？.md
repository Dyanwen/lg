<p data-nodeid="298002" class="">我们在日常开发过程中无时无刻不在和数据打交道，想要让程序运行得稳定顺畅就要实时对数据进行观测。本课时我就先来讲解观测的数据到底从哪里来的？</p>
<h3 data-nodeid="298003">监控数据来源</h3>
<p data-nodeid="298004">我们一般讲的数据观测，其实观测的就是从发起请求，到真正查询的这个过程中的数据。那在这个过程中，我们需要关注哪几个层次的数据呢？接下来，我会从数据请求发起的用户端到数据查询响应的服务端逐层分析。</p>
<h4 data-nodeid="298005">端上访问</h4>
<p data-nodeid="298006">首先是用户侧的端上访问，这应该是最容易理解的。在互联网发展的早期，我们通过 PC 浏览网页，就属于端上访问的范畴。随着移动互联网的发展，端上访问的范围得以扩大。我们打开各种 App，或是访问 App 中的小程序/H5 页面，都属于端上访问。用户通过端上访问，也最能直观地感受到我们程序的响应速度，所以端上访问的数据就变得十分重要。</p>
<p data-nodeid="298007">我们一般可以通过以下几个方式获取端上访问的数据：</p>
<ol data-nodeid="298008">
<li data-nodeid="298009">
<p data-nodeid="298010"><strong data-nodeid="298107">用户体验监控</strong>：Web 页面中的白屏时间、DOM 元素/资源加载耗时、文档网络耗时；App 的卡顿率、崩溃率、热启动加载时长等。</p>
</li>
<li data-nodeid="298011">
<p data-nodeid="298012"><strong data-nodeid="298112">日志</strong>：在 Web 页面中，如果出现脚本错误，则需要将相应的异常信息通过日志的方式上报服务器；App 也会有相应的日志输出，但移动端更关注系统崩溃或出现异常时的日志信息。</p>
</li>
<li data-nodeid="298013">
<p data-nodeid="298014"><strong data-nodeid="298117">端到端</strong>：指的是用户端（Web/App）到后端服务器的请求情况，比如访问量、成功率、响应时间等。通过端到端观测时，我们还需要了解端上所处的地区、网络环境、响应状态码等信息，才能更好地掌握用户真实的使用情况。</p>
</li>
<li data-nodeid="298015">
<p data-nodeid="298016"><strong data-nodeid="298122">可用率</strong>：因运营商和地区的不同，会导致访问端上时有一些差异，比如访问是否可用、响应耗时长短等。这与 CDN、DNS 等公共资源有莫大的关系。</p>
</li>
</ol>
<h4 data-nodeid="298017">应用程序</h4>
<p data-nodeid="298018">当端上发起请求后，一般会到达应用程序。这里是代码运行，以及处理用户请求的地方。在应用程序中，我们可能会集成各种第三方组件，比如常见的 Kafka、Redis、MySQL。应用程序的执行效率最终会通过端上响应情况反映出来，直接影响到用户的使用体验。</p>
<p data-nodeid="298019">如果我们想要提升程序的响应速度，就不得不关注以下几个指标：</p>
<ol data-nodeid="298020">
<li data-nodeid="298021">
<p data-nodeid="298022"><strong data-nodeid="298130">执行情况</strong>：我们常说的响应时间、QPS 等，都可以反映应用程序的执行情况。针对端上的请求，或者我们的定时任务，应用程序的执行情况就十分关键。执行情况越差，用户的直观体验也会越差。在组件级别，像 MySQL 中的慢查询监控，Kafka 中的 Lag 监控等，也可以反映应用程序的执行情况。</p>
</li>
<li data-nodeid="298023">
<p data-nodeid="298024"><strong data-nodeid="298135">资源消耗</strong>：应用程序部署后，会消耗一定的资源，例如内存级别的 Redis 会消耗大量的内存，Kakfa 则因为要进行磁盘写入所以会要求较好的 I/O。我们的应用程序会区分 I/O 密集型和 CPU 密集型，它们所对应的资源消耗是不同的。</p>
</li>
<li data-nodeid="298025">
<p data-nodeid="298026"><strong data-nodeid="298140">VM 指标监控</strong>：指的是 JVM 监控，比如 GC 时间、线程数、FGC/YGC 耗时等信息。当然，其他语言也有其独特的统计指标信息。</p>
</li>
<li data-nodeid="298027">
<p data-nodeid="298028"><strong data-nodeid="298145">容量</strong>：指单个系统可最大承受的容量。容量也是一个非常重要的指标，当应用访问量到达阈值时，我们一般会对这个应用的访问容量进行扩缩容。</p>
</li>
<li data-nodeid="298029">
<p data-nodeid="298030"><strong data-nodeid="298150">服务关系</strong>：随着分布式系统架构的流行，我们在监控单体应用的基础上，还必须考虑应用之间的调用关系和调用速度，比如是否会存在两个服务之间的相互循环引用，下游服务出现问题是否会干扰整个流程的执行，又或是服务之间的响应时长、上下游服务的依赖程度等。</p>
</li>
<li data-nodeid="298031">
<p data-nodeid="298032"><strong data-nodeid="298155">应用日志</strong>：应用日志应该是我们再熟悉不过的内容了。我们开发的应用程序，会记录下自身的日志，第三方组件也会有相应的日志，比如 MySQL 的进程日志、慢查询日志等。充分利用应用日志，可以大幅提高我们的排错能力。</p>
</li>
<li data-nodeid="298033">
<p data-nodeid="298034"><strong data-nodeid="298160">健康情况</strong>：当前服务是否存活、服务运行是否稳定等，这也是十分关键的指标。我们在 ES 中可以看到服务的状态（RED、YELLOW、GREEN）。</p>
</li>
</ol>
<h4 data-nodeid="298035">业务监控</h4>
<p data-nodeid="298036">业务监控也是可观测系统中一个重要的内容，如果你只是让应用程序稳定运行那肯定是远远不够的。因此，我们常常会对具体业务产生的数据进行监控，例如网站系统中我们会关注 PV、UV 等参数；在支付系统中，我们则会关注创建订单量、成单量等。</p>
<p data-nodeid="298037">业务指标能很好地体现出系统是否稳定。任何系统，如果出现了问题，最先受到影响的肯定是业务指标。当然，如果影响不是特别大，那就说明对这个指标进行监控的意义也不是很大。</p>
<p data-nodeid="298038">业务指标也可以衡量上线后的成效。如果我们需要通过 A/B Test 了解用户更偏好哪一种模式，可以分别观察两种模式下的业务指标来比对用户喜好。再或者，我们可以通过业务指标得出的结论，在上线前进行一些改进（例如选择用户更偏好的模式）来提高成单率。</p>
<p data-nodeid="298039">核心业务指标的设定因具体的业务和场景而异，因此开发人员也需要对业务和代码有一定的了解。</p>
<h4 data-nodeid="298040">基础设施</h4>
<p data-nodeid="298041">基础监控我想你也不陌生。我们的应用程序/组件一般都是运行在云主机、操作系统上的，如果基础设施出现了严重问题，会影响到云主机和操作系统，进而牵连应用程序/组件的正常运行。</p>
<p data-nodeid="298042">为了避免这种情况，我们会对基础设施进行监控，以保证它们可以良好地运行着。</p>
<p data-nodeid="298043">我们一般会从 2 个方向监控：</p>
<ol data-nodeid="298044">
<li data-nodeid="298045">
<p data-nodeid="298046"><strong data-nodeid="298174">资源利用</strong>：这个很好理解，像 I/O 使用率、CPU 利用率、内存使用率、磁盘使用率、网络使用率、负载等都属于资源利用的范畴。</p>
</li>
<li data-nodeid="298047">
<p data-nodeid="298048"><strong data-nodeid="298179">通信情况</strong>：这里是指主机与主机之间的网络情况。通信是互联网中最重要的基石之一，如果两台主机之间出现如网络延迟时间大、丢包率高这样的网络问题，会导致业务受阻。</p>
</li>
</ol>
<h3 data-nodeid="298049">可观测性核心概念</h3>
<p data-nodeid="298050">基于上面几个层次的数据来源的介绍，你应该对要观测的数据有了一个大概的了解。</p>
<p data-nodeid="298051">为了解决我在“开篇词”中提到的 3 个问题，我们通常会通过几个维度来观测这些数据，这也是我接下来要为你介绍的可观测性中比较关键的概念：<strong data-nodeid="298195">日志</strong>、<strong data-nodeid="298196">统计指标</strong>和<strong data-nodeid="298197">链路跟踪</strong>。</p>
<p data-nodeid="298052"><img src="https://s0.lgstatic.com/i/image/M00/3C/5E/CgqCHl8nrEuAdTFMAAFkhS5ucBI061.png" alt="图片1.png" data-nodeid="298200"></p>
<h4 data-nodeid="298053">日志（Logging）</h4>
<p data-nodeid="298054"><strong data-nodeid="298206">日志</strong>是系统中的常见功能，我们前面说的数据来源的各个部分都有可能产生日志。日志一般的描述是：在特定时间发生的事件，被以结构化的形式记录并产生的文本数据。</p>
<p data-nodeid="298055">日志可以为我们展现系统在任意时间的运行状态，又因为它是结构化的文本，所以我们很容易通过某种格式来进行检索，比如下图就是对 7 月 24 日用户支付下单操作的记录：</p>
<p data-nodeid="298056"><img src="https://s0.lgstatic.com/i/image/M00/3C/88/Ciqc1F8n2O6AXUU_AACiGPnzHJ0060.png" alt="4.png" data-nodeid="298210"></p>
<p data-nodeid="298057">由于日志是最容易生成的，如果它大量地输出，会占据比较大的存储空间，进而影响整个应用程序的性能，比如 Java 中 logback 的日志框架，就算使用了异步线程来执行，也会对磁盘和 I/O 的使用率造成影响。</p>
<p data-nodeid="298058">当然，也有一部分系统是利用日志可追溯、结构化的特点，来实现相关功能的，比如我们最常见的 WAL（Write-Ahead Logging）。WAL 就是在操作之前先进行日志写入，再执行操作；如果没有执行操作，那么在下次启动时就可以通过日志中结构化的，有时间标记的信息恢复操作，其中最典型的就是 MySQL 中的 Redo log。</p>
<h4 data-nodeid="298059">统计指标（Metrics）</h4>
<p data-nodeid="298060"><strong data-nodeid="298218">统计指标</strong>也是我们经常使用的。它是一种可累加的聚合的数值结果，具有原子性。因此，我们可以通过各种数学计算方式来获取一段时间内的数值。</p>
<p data-nodeid="298061"><img src="https://s0.lgstatic.com/i/image/M00/3C/60/CgqCHl8nrU6AQfBSAACjSdwOzUQ263.png" alt="image (3).png" data-nodeid="298221"></p>
<p data-nodeid="298062">统计指标针对数据的存储、处理、压缩和检索进行了优化，所以一般可以长期存储并以很简单的方式（聚合）查询。但由于涉及数据的处理（数学计算方式）和压缩，所以它也会占用一定的 CPU 资源。</p>
<p data-nodeid="298063">统计指标是一个压缩后的数值，因此如果指标出现异常，我们很难得知是什么原因导致的异常。此外，如果我们使用了一个高基数的指标来作为统计的维度，那么统计就很容易给机器带来高性能损耗，比如，在基于用户 ID 的维度去做数据统计时，因为在统计的时候需要一段时间范围，如果数据过多就必然会造成内存上的占用。</p>
<p data-nodeid="298064">讲到这里，你应该对指标有了一定的认识。我们后端经常说的 QPS、TPS、SLA 都是计算后得到的指标；基础设施中的 CPU 使用率、负载情况也可以认为是指标。</p>
<h4 data-nodeid="298065">链路追踪（Tracing）</h4>
<p data-nodeid="298066"><strong data-nodeid="298230">链路追踪</strong> 可能是一个较新的概念，但是“全链路压测”这个词你一定不陌生。链路追踪中的“链路”和全链路压测中的“链路”，它们的概念是一样的，只不过链路追踪是将链路的完整行为信息进行记录，然后通过可视化的形式展现出来。这里我用一张图来说明：</p>
<p data-nodeid="298067"><img src="https://s0.lgstatic.com/i/image/M00/3C/60/CgqCHl8nrYiAbto2AABwOErWGno259.png" alt="图片2.png" data-nodeid="298233"></p>
<p data-nodeid="298068">假设我们程序中的一个接口总共有 4 个服务参与，调用的关系分别是 A-&gt;B-&gt;C-&gt;D，其中 B 服务还与 Redis 这种第三方应用产生了调用/请求关系。这一过程，我们就可以在链路追踪中，通过类似于上面这张图的形式来展示。当然，这只是个例子，在实际中，链路追踪展示的图会比这个更加清楚。我会在后面的课程中更加详细地讲解，这里就不加赘述了。</p>
<p data-nodeid="298069">链路是支持跨应用的，比如我们常见的 RPC 请求，就可以说是链路中的一部分。</p>
<p data-nodeid="298070">与日志一样，链路追踪也会造成一定的性能损耗，因为任何形式的观测都需要存储一定的数据和时间信息，这必然会占用一定的 CPU 和内存资源。我们一般可以通过采样的方式解决资源占用的问题，我会在后面“链路追踪”章节中介绍。</p>
<p data-nodeid="298071">链路追踪是整个可观测性中一个很有趣，也是很重要的部分。希望通过这个简单的说明，能让你对它有一个基础的认识。</p>
<h4 data-nodeid="298072">三者之间关系</h4>
<p data-nodeid="298073">我们一般可以将数据的来源分为 2 个级别：</p>
<ol data-nodeid="298074">
<li data-nodeid="298075">
<p data-nodeid="298076"><strong data-nodeid="298244">请求级别：</strong> 数据来源于真实的请求，比如一次 HTTP 调用，RPC 调用；</p>
</li>
<li data-nodeid="298077">
<p data-nodeid="298078"><strong data-nodeid="298249">聚合级别：</strong> 真实的请求指标，或是系统的一些参数数据聚合，比如 QPS、CPU 数值。</p>
</li>
</ol>
<p data-nodeid="298079">根据这 2 个级别，我们可以对上面的 3 个内容加以细化，其中<strong data-nodeid="298263">链路追踪</strong>是请求级别，因为它和每个请求都挂钩；<strong data-nodeid="298264">日志</strong>和<strong data-nodeid="298265">统计指标</strong>可以是请求级别，也可以是聚合级别，因为它们可能是真实的请求，也可能是系统在对自身诊断时记录下来的信息。</p>
<p data-nodeid="298080">那么当它们两两组合之后又是什么关系呢？我们可以从下图中看到：</p>
<p data-nodeid="298081"><img src="https://s0.lgstatic.com/i/image/M00/3C/8E/CgqCHl8n0peAVsZsAAIx_TZards535.png" alt="3.png" data-nodeid="298269"></p>
<ol data-nodeid="298082">
<li data-nodeid="298083">
<p data-nodeid="298084"><strong data-nodeid="298278">链路追踪+统计指标</strong>（Request-scoped metrics）<strong data-nodeid="298279">，请求级别的统计</strong>：在链路追踪的基础上，与相关的统计数据结合，从而得知数据与数据、应用与应用之间的关系。</p>
</li>
<li data-nodeid="298085">
<p data-nodeid="298086"><strong data-nodeid="298288">链路追踪+日志</strong>（Request-scoped events）<strong data-nodeid="298289">，请求级别的事件</strong>：这是链路中一个比较常见的组合模式。日志本身是每一条单独存在的，将链路追踪收集到的信息集成在日志中，可以让日志之间具备关联性，使其具有除了事件维度以外的另一个新的维度，上下文信息。</p>
</li>
<li data-nodeid="298087">
<p data-nodeid="298088"><strong data-nodeid="298298">日志+统计指标</strong>（Aggregatable events）<strong data-nodeid="298299">，聚合级别的事件</strong>：这是在日志中的比较常见的组合。通过解析这部分具有统计指标的信息，我们可以获取相关的指标数据。</p>
</li>
<li data-nodeid="298089">
<p data-nodeid="298090"><strong data-nodeid="298308">三者结合</strong>（Request-scoped,aggregatable events）：三者结合可以理解为<strong data-nodeid="298309">请求级别+聚合级别的事件</strong>，由此就形成了一个丰富的、全局的观测体系。</p>
</li>
</ol>
<p data-nodeid="298091">根据以上这 3 个概念，我们再来想想它们最终会输出的<strong data-nodeid="298315">数据量（Volume）</strong>。</p>
<p data-nodeid="298092"><strong data-nodeid="298328">统计指标</strong>是数值的形式，同时又可以压缩，所以它所需的存储量是最小的；<strong data-nodeid="298329">日志</strong>的输出量最大，但相对的，它也有比较全的内容记录；<strong data-nodeid="298330">链路追踪</strong>则正好处于二者之间，它不会像日志一样大量地输出，也不像统计指标一样节能。</p>
<p data-nodeid="298093">于是，这三者的关系就形成了我们图中最左侧的竖线。</p>
<h4 data-nodeid="304362" class="">总结</h4>










<p data-nodeid="298095">我相信通过这节课的学习，你已经对可观测性有了一个整体的认识。在接下来的课程中，我会分别对日志、统计指标、链路追踪这 3 个概念做更深入的讲解。当然，我也会以开发的角度，从更细的维度来介绍我们该如何去参与其中。</p>
<p data-nodeid="298096" class="">最后，给你留道思考题，除了这三个关键点以外，你觉得在观测中还有什么也是必不可少的？欢迎你在留言区留言，分享你的理解和在工作中的经验。</p>

---

### 精选评论

##### **高：
> 链路追踪同时也会带来性能损耗，我自己理解：一般有比较多的c端流量，肯定又会相关的API可用率以及RT监控（SLA），在保证无外界干扰的情况下利用普通的SLA服务进行监控，如果出现服务指标告警时在灰度机器机器加上类似于听云、skywalking类似的链路追踪工具。

##### **狗：
> 老师问道观测的点还有那些，我在思考，除了观测应用程序本身，可能还要观测整个服务器本身，以及程序对于数据库的IO还有抗压，并发等信息的预警；读完前两节，感觉这门课程可能偏理论一些的知识点，要是老师能给出一些实践的样例，可能会更好更容易理解（当然，没准后续课程，老师就会给出来了）；单就前面的课程而言，个人认为，还是很有必要去认真阅读，因为对于开发而言，快速查找定位问题根源，并且高效的解决问题才是工作的关键核心，对自身的提高也有好处，希望自己再接再厉，继续加油！谢谢老师！😁😁

 ###### &nbsp;&nbsp;&nbsp; 编辑回复：
> &nbsp;&nbsp;&nbsp; 后面会有案例哦~

##### *炜：
> 学习知识，要善于思考，在思考。🤔

##### **安：
> 这里的日志是包括了操作日志和系统日志吗

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 当然包含，每种日志都是可观测性的一部分。越多的日志可以越快地分析出问题所在。

##### **定：
> 老师好！请问一下elasticsearch stack中的apm server不是也可以监测嘛！请问它与链接路追踪有哪些本质上的区别呢？

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 您是指ELASTIC OBSERVABILITY么？关于ELK我会在后面讲到，它是一种日志收集的实现。APM是由链路追踪和指标、日志中的数据聚合在一起形成的。日志和链路追踪都是可观测性中的一环，并不是可观测性的全部。

##### ✔：
> 大厂都有自己的一套，业务数据观测，性能监控，可用率监控，链路追踪，多数都是自研，感觉易用性和三者结合能做好的很难，如果有机会能去基础平台从零研发自己的一套就好了，很羡慕老师呀

##### **才：
> 端上访问这里，老师总结得很好，以前觉得各个端得情况是比较复杂得，但是老师这里统一到了端上访问对用户得影响，尤其是这里得日志层面，老师确实让我一个新人前端了解了其他层面

##### *伟：
> 每天上班都很累，今天抽空看了一下，希望以后能跟得上老师的进度

##### *旭：
> 观测中必不可少的，当然是应用，我学到了这门课，如何在实践中应用它才是最重要的，期待老师后续的实战讲解

##### **见峰来：
> 日志、链路追踪和统计指标，可观测性的三大核心概念，都是必不可少的东西

##### **伟：
> 老师，我想知道下，链路最追踪的目的是找出问题，然后通过告警来协助开发处理，比如调用服务延迟，异常信息，这些也可以跟日志结合吗?阿里的arthas应该不能规划到链路这个层面吧！目前业界通用的追踪技术框架方便简单回复下吗？谢谢

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 链路追踪记录的就是当前请求链路的数据信息。通常链路信息也会伴随着唯一的一个 ID，那么我们就可以将当前所执行链路中的链路 ID 和日志相结合。出现异常信息时，结合当前链路中的链路 ID 来快速查询。这是一种很常见的排查问题方式。
阿里的 arthas 就我了解只能观察单个服务中针对于具体方法级别的延迟信息，无法纵观全局。目前主流的链路追踪技术我会在后面的实践章节中有所介绍，比如现在主流的 Zipkin、SkyWalking。

##### **~：
> 作为一个开发，以前只片面关注我应该完成什么功能，用到什么技术，但是看了老师文章以后，意识到了数据反馈非常重要，从数据中我能看到自己需要改进什么，非常期待后面得课程~

 ###### &nbsp;&nbsp;&nbsp; 编辑回复：
> &nbsp;&nbsp;&nbsp; 小编想告诉你后面更精彩

##### **阳：
> 我工作的时候就经常遇到老师说的踢皮球，希望在后面的课程能知道该如何解决！

##### **升：
> 可观测系统，阿里用了都说好


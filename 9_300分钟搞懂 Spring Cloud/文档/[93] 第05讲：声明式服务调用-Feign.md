<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">你好，我是你的 Spring Cloud 老师尹吉欢，欢迎来到课时 5 "声明式服务调用-Feign"的学习。本课时我们主要讲解：Feign 基础知识，Feign 的使用以及最佳使用技巧，Feign 源码分析。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">在日常工作中，我们经常会遇到需要调用内部&nbsp;API&nbsp;或者第三方&nbsp;API&nbsp;的情况，主要有以下方式：</span></p>
<ul style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">HttpURLConnection</span></p></li>
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">HttpClient</span></p></li>
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">OKHttp</span></p></li>
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">RestTemplate</span></p></li>
</ul>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"><br></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">以上这四种是我们最常见的&nbsp;API&nbsp;调用方式，在调用 API 之前，我们首先需要知道&nbsp;API&nbsp;的地址，其次是&nbsp;API&nbsp;对应的参数，然后发起调用，本质上调用 API 的过程就是一个&nbsp;HTTP&nbsp;请求过程。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">如果你用过&nbsp;Dubbo&nbsp;框架，就会知道在&nbsp;Dubbo&nbsp;中发起远程调用是不需要使用者去关注服务提供者信息的，直接注入一个接口，然后调用接口中的方法，就像调用本地方法一样。这样的好处是开发效率高，代码优雅。</span></p>
<h1></h1>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">Feign 基础知识</span></h6>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Feign&nbsp;简介</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">Feign 是一个声明式的 REST 客户端，它的目的就是让&nbsp;REST&nbsp;调用更加简单。Feign&nbsp;提供了&nbsp;HTTP&nbsp;请求的模板，通过编写简单的接口和插入注解，就可以定义好&nbsp;HTTP&nbsp;请求的参数、格式、地址等信息。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">而且&nbsp;Feign&nbsp;会完全代理&nbsp;HTTP&nbsp;请求，我们只需要像调用方法一样调用它就可以完成服务请求及相关处理。Spring Cloud 对 Feign 进行了封装，使其支持 SpringMVC 标准注解和 HttpMessageConverters。Feign 可以与 Eureka 和 Ribbon 组合使用以支持负载均衡，与 Hystrix 组合使用，支持熔断回退。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">如果你没有使用&nbsp;Spring Cloud，那么可以直接用原生的&nbsp;Feign&nbsp;来调用&nbsp;API，如果你使用了&nbsp;Spring Cloud，可以直接用&nbsp;Spring Cloud OpenFeign&nbsp;来调用&nbsp;API。</span></p>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Feign 重要组件</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Feign&nbsp;有如此强大的功能，离不开内部众多组件的支持，这些组件同时也为&nbsp;Feign&nbsp;提供了非常灵活的扩展机制，我们可以根据自身的需求去扩展这些组件，下面我们讲解 Feign 中的重要组件。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: center; line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://s0.lgstatic.com/i/image2/M01/9B/86/CgotOV2oGbmAMIEfAAFD417806k525.png"></span></p>
<ul style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">Contract&nbsp;契约组件</span></p></li>
</ul>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">在&nbsp;Feign&nbsp;中可以通过定义&nbsp;API&nbsp;接口的方式来调用远程的&nbsp;Http API，在定义调用&nbsp;Client&nbsp;的时候需要增加一些注解来描述这个调用&nbsp;API&nbsp;的基本信息，比如请求类型是&nbsp;GET&nbsp;还是&nbsp;POST，请求的&nbsp;URI&nbsp;是什么。Contract&nbsp;允许用户自定义契约去解析注解信息，最典型的应用场景就是在&nbsp;Spring Cloud&nbsp;中使用&nbsp;Feign，我们可以使用&nbsp;Spring MVC&nbsp;的注解来定义&nbsp;Feign&nbsp;的客户端，这是因为&nbsp;Spring Cloud OpenFeign&nbsp;中实现了自己的&nbsp;SpringMvcContract。</span></p>
<ul style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">Encoder&nbsp;编码组件</span></p></li>
</ul>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">通过该组件我们可以将请求信息采用指定的编码方式进行编码后传输。</span></p>
<ul style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">Decoder&nbsp;解码组件</span></p></li>
</ul>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">Decoder&nbsp;将相应数据解码成对象。</span></p>
<ul style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">ErrorDecoder&nbsp;异常解码器</span></p></li>
</ul>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">当被调用方发生异常后，我们可以在&nbsp;ErrorDecoder&nbsp;中将响应的数据转换成具体的异常返回给调用方，适合内部服务之间调用，但不想通过指定的字段来判断是否成功的场景，直接用自定义异常代替。</span></p>
<ul style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">Logger 日志记录</span></p></li>
</ul>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">Logger&nbsp;组件是负责&nbsp;Feign&nbsp;中记录日志的，可以指定&nbsp;Logger&nbsp;的级别以及自定义日志的输出。</span></p>
<ul style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">Client 请求执行组件</span></p></li>
</ul>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">Client&nbsp;是负责&nbsp;HTTP&nbsp;请求执行的组件，Feign&nbsp;将请求信息封装好后会交由&nbsp;Client&nbsp;来执行，Feign&nbsp;中默认的&nbsp;Client&nbsp;是通过&nbsp;JDK 的 HttpURLConnection 来发起请求的，在每次发送请求的时候，都会创建新的&nbsp;HttpURLConnection 链接，使用默认的方式，Feign&nbsp;的性能会很差，原因就是使用了&nbsp;HttpURLConnection。你可以通过扩展该接口，使用&nbsp;Apache HttpClient 等基于连接池的高性能&nbsp;HTTP&nbsp;客户端。</span></p>
<ul style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">Retryer 重试组件</span></p></li>
</ul>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">Retryer&nbsp;是负责重试的组件，Feign 内置了重试器，当&nbsp;HTTP&nbsp;请求出现&nbsp;IO&nbsp;异常时，Feign&nbsp;会限定一个最大重试次数来进行重试操作。</span></p>
<ul style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">InvocationHandlerFactory 代理</span></p></li>
</ul>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">InvocationHandlerFactory&nbsp;采用&nbsp;JDK&nbsp;的动态代理方式生成代理对象，我们定义的&nbsp;Feign Client&nbsp;是接口，当我们调用这个接口中定义的方法时，实际上是要去调用远程的&nbsp;HTTP API，这里用了动态代理方式，当调用某个方法时，会进入代理中真正的去调用远程&nbsp;HTTP API。</span></p>
<ul style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">RequestInterceptor&nbsp;请求拦截器</span></p></li>
</ul>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">可以为&nbsp;Feign&nbsp;添加多个拦截器，在请求执行前设置一些扩展的参数信息。</span></p>
<ul style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">QueryMapEncoder 参数查询</span></p></li>
</ul>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">QueryMapEncoder&nbsp;是针对实体类参数查询的编码器，可以基于&nbsp;QueryMapEncoder&nbsp;将实体类生成对应的查询参数。</span></p>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Feign 执行过程</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: center; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://s0.lgstatic.com/i/image2/M01/9B/66/CgoB5l2oGbmACVdMAACewrpciZo953.png"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: justify; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">在使用&nbsp;feign 时，我们会定义对应的接口类，在接口类上使用&nbsp;Feign&nbsp;自带的注解来标识&nbsp;HTTP&nbsp;的请求参数信息，当调用接口对应的方法时，Feign 内部会基于面向接口的动态代理方式生成实现类，将请求调用委托到动态代理实现类，负责动态代理的组件是&nbsp;InvocationHandlerFactory。</span><br></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">根据&nbsp;Contract&nbsp;规则，解析接口类的注解信息，翻译成&nbsp;Feign&nbsp;内部能识别的信息。Feign 默认有一套自己的协议规范，我们也可以自定义其他的规范来进行扩展，在&nbsp;Spring Cloud OpenFeign中就扩展了&nbsp;SpringMvcContract，这样做的目的是为了降低学习和使用成本，客户端和服务端使用同一个接口定义，发布成&nbsp;SDK&nbsp;给调用方使用。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">MethodHandler&nbsp;在执行的时候会生成&nbsp;Request&nbsp;对象，在构建&nbsp;Request&nbsp;对象的时候会为其设置拦截器，交由&nbsp;Client&nbsp;执行前记录一些日志，Client&nbsp;执行完成后也记录一些日志，然后使&nbsp;Decoder&nbsp;进行相应结果的解码操作，并返回结果。</span></p>
<h1></h1>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">Feign 的使用</span></h6>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">原生 API</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: center; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://s0.lgstatic.com/i/image2/M01/9B/86/CgotOV2oGbmAGk9hAAEqjsNnfEc049.png"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: justify; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">这段代码是我从&nbsp;Feign&nbsp;的&nbsp;GitHub&nbsp;主页上摘下来的，通过这个简单的示列我们可以感受到&nbsp;Feign调用&nbsp;API&nbsp;的简便性。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">这是一个&nbsp;GET&nbsp;请求的示列，定义了一个&nbsp;GitHub&nbsp;的接口，接口中定义了一个查询的方法和参数。在方法上有&nbsp;@RequestLine&nbsp;注解，定义了请求类型和请求的&nbsp;URI，URI&nbsp;中有对应的参数占位符，返回值是集合，集合中是对应的返回结构对象。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">我们通过&nbsp;Feign&nbsp;的&nbsp;builder&nbsp;模式构建了&nbsp;GitHub&nbsp;接口对象后，就可以直接通过&nbsp;GiuHub&nbsp;接口对象调用里面的&nbsp;contributors&nbsp;方法，然后可以得到返回结果。Feign&nbsp;的这种方式就跟&nbsp;Dubbo&nbsp;中的调用方式是一样的，就像调用本地方法一样。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">使用原生的&nbsp;Feign&nbsp;来调用&nbsp;API，只需要通过特定的注解来描述调用的&nbsp;API&nbsp;信息，这些信息的请求方式可以是&nbsp;GET&nbsp;或者&nbsp;POST&nbsp;等，请求参数是什么？请求的地址是什么? 把这些信息定义好后就可以直接使用这个定好了的接口来调用对应的远程&nbsp;API。</span></p>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">自带注解</span>&nbsp;</h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: center; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"><img src="http://s0.lgstatic.com/i/image2/M01/9B/66/CgoB5l2oGbmAAxxlAACsHadsFYk931.png"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">通过前面的示列我们感受到了&nbsp;Feign&nbsp;的简便性，通过定义接口，加几个注解就可以轻松完成&nbsp;API的远程调用，Feign&nbsp;中自带的注解跟我们平时使用&nbsp;Spring MVC&nbsp;的注解不一样，除了前面我们提到的&nbsp;@RequestLine&nbsp;注解，Feign&nbsp;中还有很多其他内置的注解，我整理了一个表格，表格中就是Feign&nbsp;中内置的注解以及它们的作用。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">RequestLine&nbsp;前面已经讲过了，用来定义请求类型和请求的&nbsp;URI，Param&nbsp;是用来做参数映射的，Headers&nbsp;是用来做请求头映射的，QueryMap&nbsp;是用来接收多个参数的，最常见的就是将多个参数封装在一个实体类中，然后就可以用&nbsp;QueryMap&nbsp;来修饰。HeaderMap&nbsp;可以将请求头映射成一个&nbsp;Map&nbsp;对象，Body&nbsp;可以定义一个数据模板，通过&nbsp;@Param&nbsp;解析对应的表达式，最终替换成完成的请求体。</span></p>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Spring Cloud</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">原生的&nbsp;Feign&nbsp;在使用层面已经很方便了，但是在&nbsp;Spring Cloud&nbsp;体系中却不那么适用，所以官方团队在&nbsp;Feign&nbsp;的基础上进行扩展，推出了&nbsp;spring-cloud-openfeign，目的是能够让广大的开发者在&nbsp;Spring Cloud&nbsp;体系中使用&nbsp;Feign&nbsp;变得更加简单。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">首先我们开发的&nbsp;API&nbsp;都用的是&nbsp;Spring MVC&nbsp;的注解，比如&nbsp;RequestMapping&nbsp;等，Feign&nbsp;的注解是单独的一套，所以我们编写调用&nbsp;Client&nbsp;接口时，需要根据已有的接口来编写，在&nbsp;spring-cloud-openfeign&nbsp;中，实现了&nbsp;Spring MVC&nbsp;的一套注解，调用方&nbsp;Client&nbsp;接口中的注解和&nbsp;API&nbsp;方可以一致，非常方便。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: center; line-height: 1.75em;"><span style="background-color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"></span><img src="http://s0.lgstatic.com/i/image2/M01/9B/87/CgotOV2oGvSAB6lzACuH262SK0o630.gif"><span style="background-color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">下面我们来体验下&nbsp;Spring Cloud 中&nbsp;Feign&nbsp;的简便性，在&nbsp;Spring Cloud&nbsp;中使用&nbsp;Feign&nbsp;主要有三步。</span></p>
<ol style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">需要在启动类加&nbsp;@EnableFeignClients&nbsp;启用&nbsp;Feign。</span></p></li>
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">可以定义&nbsp;Feign&nbsp;的调用客户端了，需要在接口上增加&nbsp;@FeignClient&nbsp;注解。</span></p></li>
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">可以直接通过客户端访问接口。</span></p></li>
</ol>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: center; line-height: 1.75em;"><span style="background-color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"></span><img src="http://s0.lgstatic.com/i/image2/M01/9B/87/CgotOV2oGu2AYbCzAD5-YgFFrj0939.gif"><span style="background-color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">下面来实际操作一下，创建一个&nbsp;UserRemoteClient，定义一个&nbsp;getUser&nbsp;方法，getUser&nbsp;方法上的注解跟服务提供方一致即可。然后在接口上增加一个&nbsp;@FeignClient&nbsp;的注解，value&nbsp;指定为服务提供方的服务名称，也就是&nbsp;Eureka&nbsp;中的服务名。然后看下启动类，需要增加@EnableFeignClients&nbsp;注解开启&nbsp;Feign&nbsp;的装配。在使用的地方直接注入&nbsp;UserRemoteClient，然后调用&nbsp;getUser&nbsp;方法就可以获取到远程的数据了。</span></p>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Feign 整合 Hystrix</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: center; line-height: 1.75em;"><span style="background-color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"></span><img src="http://s0.lgstatic.com/i/image2/M01/9B/67/CgoB5l2oGuCAdFnGAA6QDTT4wB4893.gif"><span style="background-color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">在&nbsp;pom&nbsp;中增加&nbsp;spring-cloud-starter-netflix-hystrix&nbsp;的依赖，然后在配置文件中开启&nbsp;Feign&nbsp;对&nbsp;Hystrix&nbsp;的支持，配置&nbsp;feign.hystrix.enabled=true。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: center; line-height: 1.75em;"><span style="background-color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"></span><img src="http://s0.lgstatic.com/i/image2/M01/9B/87/CgotOV2oGtiAUD-yABz3qehaijk305.gif"><span style="background-color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">然后为我们的&nbsp;Feign Client&nbsp;增加&nbsp;Fallback，新建一个&nbsp;UserRemoteClientFallbackFactory，实现&nbsp;FallbackFactory&nbsp;接口，泛型传入我们的&nbsp;Feign Client。在&nbsp;create&nbsp;方法中创建&nbsp;UserRemoteClient&nbsp;并编写回退逻辑。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">最后需要在&nbsp;@FeignClient&nbsp;注解中指定我们的&nbsp;FallbackFactory&nbsp;类，这样才能让这个&nbsp;Feign Client应用我们的回退逻辑。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: center; line-height: 1.75em;"><span style="background-color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"></span><img src="http://s0.lgstatic.com/i/image2/M01/9B/67/CgoB5l2oGr6AGh27ADHEa_iaFU8088.gif"><span style="background-color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">访问&nbsp;getUser&nbsp;接口测试下，将对应的服务先停止，然后我们就可以看到相应的回退内容了。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">FallbackFactory&nbsp;回退需要知道异常信息，还有一种回退方式是不知道异常信息，创建一个&nbsp;UserRemoteClientFallback&nbsp;实现我们的&nbsp;UserRemoteClient，重写&nbsp;getUser&nbsp;方法，然后在&nbsp;@FeignClient&nbsp;注解中指定&nbsp;fallback&nbsp;即可。</span></p>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Feign 的配置-代码方式</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Feign&nbsp;的配置在代码中可以指定，我们可以为每个&nbsp;Feign Client&nbsp;创建一个单独的配置类，在类中配置对应的信息，比如我们要改变日志的级别，可以配置一个&nbsp;Logger.Level&nbsp;的&nbsp;Bean、访问对应的接口，可以在控制台看见详细的调用日志输出。前提是日志的级别必须为&nbsp;Debug。还需要在&nbsp;@FeignClient&nbsp;注解中进行配置类的指定。</span></p>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Feign 的配置-配置文件方式</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">更灵活的配置方式应该是放入配置文件中，建议你在工作中将配置都放入配置文件中，那么&nbsp;Feign&nbsp;在配置文件中如何进行配置呢？</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: center; line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://s0.lgstatic.com/i/image2/M01/9B/86/CgotOV2oGbqAQfgPAAFRayo3xS8984.png">&nbsp;&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">当然也是有统一的格式的，而且格式也比较简单，前缀都是固定的&nbsp;feign.client.config，后面接的是&nbsp;Feign Client&nbsp;的名称，也就是我们&nbsp;@FeignClient&nbsp;注解中的&nbsp;value。然后是对应的配置项，这样的配置就可以为不同的&nbsp;Feign Client&nbsp;配置不同的值。</span></p>
<h1></h1>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">Feign 的最佳使用技巧</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">在使用&nbsp;Feign&nbsp;的过程中，我也总结了一些比较实用的技巧，主要有下面几点：</span></p>
<ul style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">继承特性</span></p></li>
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">拦截器</span></p></li>
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">GET&nbsp;请求多参数传递</span></p></li>
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">日志配置</span></p></li>
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">异常解码器</span></p></li>
</ul>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">继承特性-方式一</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: center; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://s0.lgstatic.com/i/image2/M01/9B/66/CgoB5l2oGbqAcCubAAD1tEMB1xw892.png"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: justify; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">因为&nbsp;Spring Cloud Open Feign&nbsp;中支持继承的特性，我们可以将&nbsp;API&nbsp;的定义提取出来封装成一个单独的接口，给&nbsp;API&nbsp;的实现方和调用方共用，在一定程度上简化了重复的代码。</span><br></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">我们定义了一个&nbsp;UserFeignRemoteClient&nbsp;的接口，加了&nbsp;@FeignClient&nbsp;注解，这个接口就变成了一个&nbsp;Feign&nbsp;的&nbsp;Client。接口中我们定义了&nbsp;getUser&nbsp;方法，指定了访问的&nbsp;URI。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">再创建一个&nbsp;UserController，增加&nbsp;RestController&nbsp;注解，并且实现了上面定义的&nbsp;UserFeignRemoteClient&nbsp;接口，实现了&nbsp;getUser&nbsp;方法。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">使用的地方只要注入&nbsp;UserFeignRemoteClient&nbsp;就可以使用&nbsp;getUser&nbsp;方法，UserController&nbsp;中也不用重复定义&nbsp;API&nbsp;的&nbsp;URI&nbsp;等信息，当接口的&nbsp;URI&nbsp;发生变化时，提供方和使用方用的都是一个共用的接口，两边不会出现不一致的情况，这就是继承特性带来的好处。</span></p>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">继承特性-方式二</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: center; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://s0.lgstatic.com/i/image2/M01/9B/86/CgotOV2oGbuASp8GAAC5YoZgIl0061.png"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: justify; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">上面的继承方式是我简化之后的，其实在&nbsp;Spring Cloud Open Feign&nbsp;的文档中，给出的继承示列还要多一个类，第一步是抽出一个公共的接口，比如我们这边的&nbsp;UserService，UserService&nbsp;中定义了要实现的&nbsp;API&nbsp;的方法。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">在&nbsp;UserController&nbsp;中还是一样，需要实现&nbsp;UserService，然后创建一个UserFeignRemoteClient，UserFeignRemoteClient&nbsp;中需要继承&nbsp;UserService，不同点在于之前是将&nbsp;API&nbsp;的方法定义在&nbsp;UserFeignRemoteClient&nbsp;中，然后&nbsp;Controller&nbsp;中实现UserFeignRemoteClient。现在&nbsp;API&nbsp;方法的定义是一个独立的&nbsp;UserService&nbsp;接口，Controller&nbsp;和&nbsp;Feign Client&nbsp;都是需要实现或者继承&nbsp;UserService&nbsp;的接口，使用方式是一样的。</span></p>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">拦截器</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: center; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://s0.lgstatic.com/i/image2/M01/9B/66/CgoB5l2oGbuAIUQoAAC9NEkPsms617.png"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: justify; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Feign&nbsp;中提供了拦截器机制，我们可以添加自己的拦截器来实现某些场景下的需求。BasicAuth&nbsp;在&nbsp;Feign&nbsp;中默认提供了拦截器，我们只需要配置一下就可以使用，如果我们需要自定义拦截器，可以参考&nbsp;BasicAuth&nbsp;的代码，只要实现&nbsp;RequestInterceptor&nbsp;接口，在&nbsp;apply&nbsp;方法中编写你自己的逻辑就可以了，通过&nbsp;RequestTemplate&nbsp;可以进行很多操作，比如添加指定的请求头信息，这个可以用在服务间传递某些信息的时候。</span><br></p>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">GET 请求多参数传递</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: center; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://s0.lgstatic.com/i/image2/M01/9B/86/CgotOV2oGbuAG632AACHzF9lMXk706.png"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: justify; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Feign&nbsp;中对于&nbsp;GET&nbsp;请求传递多个参数，我们可以用多个&nbsp;@RequestParam&nbsp;来接收，参数多了对代码的可读性不友好，一般超过&nbsp;3&nbsp;个以上的参数我们都会将参数封装在一个实体类中，在&nbsp;Spring Cloud Open Feign&nbsp;中要支持对象接收多个参数，但需要增加&nbsp;@SpringQueryMap&nbsp;注解才可以。</span><br></p>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">日志配置</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">当&nbsp;API&nbsp;调用失败后，需要有详细的请求信息来分析失败原因，我们可以设置&nbsp;Feign&nbsp;的日志级别来输出详细的请求信息，Feign&nbsp;的日志级别有四种：</span></p>
<ul style="">
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">NONE&nbsp;表示不输出日志。</span></p></li>
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">BASIC&nbsp;表示只输出请求方法的&nbsp;URL&nbsp;和响应的状态码以及执行的时间。</span></p></li>
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">HEADERS&nbsp;将&nbsp;BASIC&nbsp;信息和请求头信息输出。</span></p></li>
 <li><p style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(63, 63, 63);">FULL&nbsp;会输出全部完整的请求信息。</span></p></li>
</ul>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"><br></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">了解了日志级别后，我们就可以为&nbsp;Feign Client&nbsp;设置不同的级别了，级别不同输出的请求信息的详细程度也不一样，后面的课时我会介绍动态的去调整日志级别，这样在平时是不输出日志的，一旦需要排查问题的时候就可以动态的将日志打开，非常方便。</span></p>
<h2></h2>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">异常解码器</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: center; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://s0.lgstatic.com/i/image2/M01/9B/66/CgoB5l2oGbuAFUvrAADJtR7jdKs966.png"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; text-align: justify; font-size: 11pt; color: rgb(73, 73, 73); line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Feign&nbsp;中提供了异常的解码器，但我们也可以自定义异常解码器，自定义异常解码器可以用于内部服务之间调用的异常传递。比如说&nbsp;A&nbsp;服务调用&nbsp;B&nbsp;服务，B&nbsp;服务中出现异常后，会由&nbsp;B&nbsp;服务中的全局异常处理器进行处理，然后返回给&nbsp;A&nbsp;服务的数据格式是固定的&nbsp;code 是多少，message 是什么。</span><br></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">&nbsp;</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">在&nbsp;A&nbsp;服务中，我们就可以通过&nbsp;B&nbsp;服务返回的&nbsp;code&nbsp;码来做对应的判断，调用是成功了，还是失败了。一般内部服务之间为了简便性，希望跟调用本地方法一样，当被调用方抛出异常后，调用方也能感知到对应的异常，这个时候可以在异常解码器中获取异常信息，然后转换成对应的异常对象返回。</span></p>
<h1></h1>
<h6 style="text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Feign-源码分析</span></h6>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: center; line-height: 1.75em;"><span style="background-color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"></span><img src="http://s0.lgstatic.com/i/image2/M01/9B/67/CgoB5l2oGpiAEY_oABwyiU6L1t0316.gif"><span style="background-color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">首先来看下&nbsp;Feign&nbsp;执行请求的源码，从&nbsp;Feign&nbsp;这个类开始，通过&nbsp;Feign&nbsp;类提供的&nbsp;Builder&nbsp;模式，我们可以构建出一个&nbsp;Feign Client，通过这个&nbsp;Client&nbsp;就可以调用远程的&nbsp;API，看下&nbsp;Builder&nbsp;类中的参数信息，如&nbsp;Logger、Client。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: center; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><img src="http://s0.lgstatic.com/i/image2/M01/9B/67/CgoB5l2oGomATcVTAErP1s9Xx08760.gif"></span><br></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">接下来看下&nbsp;target&nbsp;方法，target&nbsp;是最终生成代理类的方法，首先会进入&nbsp;build&nbsp;方法，在&nbsp;build&nbsp;中创建了&nbsp;ReflectiveFeign&nbsp;对象，最终调用的是&nbsp;newInstance&nbsp;方法，解析出&nbsp;MethodHandler，然后创建&nbsp;InvocationHandler&nbsp;生成代理类，接着查看&nbsp;SynchronousMethodHandler&nbsp;类，在&nbsp;invoke&nbsp;方法中就是调用远程&nbsp;API&nbsp;的逻辑，创建一个&nbsp;RequestTemplate，然后根据&nbsp;RequestTemplate&nbsp;获取对应的Request&nbsp;记录日志，然后交由&nbsp;client&nbsp;执行，得到&nbsp;response、decode&nbsp;进行解码。这就是一个大致的整体流程，想要仔细的了解内部的实现细节，课后可以深入的去了解这段代码。</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: center; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);"><img src="http://s0.lgstatic.com/i/image2/M01/9B/67/CgoB5l2oGlKAYPhyADyseZWK2iI541.gif"></span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">然后看下&nbsp;Feign&nbsp;中是如何集成&nbsp;Hystrix，打开源码&nbsp;FeignClientsConfiguration&nbsp;类，在HystrixFeignConfiguration&nbsp;对&nbsp;Feign.Builder&nbsp;进行了重新定义，返回的是&nbsp;HystrixFeign.builder()</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">进入&nbsp;HystrixFeign.builder&nbsp;中可以看到继承了&nbsp;Feign&nbsp;的&nbsp;Builder，增加了&nbsp;Hystrix的SetterFactory</span></p>
<p style="margin-top: 0pt; margin-bottom: 0pt; font-size: 11pt; color: rgb(73, 73, 73); text-align: justify; line-height: 1.75em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(63, 63, 63);">，看下&nbsp;build&nbsp;方法里，对&nbsp;invocationHandlerFactory&nbsp;进行了重写，在&nbsp;create&nbsp;的时候返回的是&nbsp;HystrixInvocationHandler，HystrixInvocationHandler&nbsp;中在&nbsp;invoke&nbsp;的时候会将请求包装成&nbsp;HystrixCommand&nbsp;去执行，这里就自然的集成了&nbsp;Hystrix。</span></p>
<p><br style="white-space: normal;"></p>
<p><br></p>

---

### 精选评论



<p data-nodeid="3984" class="">è¿™ä¸€è®²æˆ‘ä»¬å°†ä¸€åŒå­¦ä¹  etcd éƒ¨ç½²çš„å‡ ç§æ–¹å¼ï¼Œä»¥åŠå¦‚ä½•è¿›è¡Œ TLS åŠ å¯†å®è·µï¼Œä»¥ä¿è¯ etcd çš„é€šä¿¡å®‰å…¨ã€‚</p>
<h3 data-nodeid="3985">etcd å•æœºå®‰è£…éƒ¨ç½²</h3>
<p data-nodeid="3986">etcd çš„å®‰è£…æœ‰å¤šç§æ–¹å¼ï¼Œè¿™é‡Œæˆ‘ä»¥ CentOS 7 ä¸ºä¾‹ï¼Œå¯ä»¥é€šè¿‡<code data-backticks="1" data-nodeid="4128">yum install etcd</code>è¿›è¡Œå®‰è£…ã€‚ç„¶è€Œé€šè¿‡ç³»ç»Ÿå·¥å…·å®‰è£…çš„ etcd ç‰ˆæœ¬æ¯”è¾ƒæ»åï¼Œå¦‚æœéœ€è¦å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ etcd ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡äºŒè¿›åˆ¶åŒ…ã€æºç ç¼–è¯‘ä»¥åŠ Docker å®¹å™¨å®‰è£…ã€‚</p>
<h4 data-nodeid="3987">äºŒè¿›åˆ¶å®‰è£…</h4>
<p data-nodeid="3988">ç›®å‰æœ€æ–°çš„ etcd API ç‰ˆæœ¬ä¸º v3.4ï¼Œæˆ‘ä»¬åŸºäº 3.4.4 ç‰ˆæœ¬è¿›è¡Œå®è·µï¼ŒAPI ç‰ˆæœ¬ä¸æœ€æ–°ç‰ˆä¿æŒä¸€è‡´ï¼Œåœ¨ CentOS 7 ä¸Šé¢ä½¿ç”¨å¦‚ä¸‹è„šæœ¬è¿›è¡Œå®‰è£…ï¼š</p>
<pre class="lang-java" data-nodeid="3989"><code data-language="java">ETCD_VER=v3<span class="hljs-number">.4</span><span class="hljs-number">.4</span>
GITHUB_URL=https:<span class="hljs-comment">//github.com/etcd-io/etcd/releases/download</span>
DOWNLOAD_URL=${GITHUB_URL}
rm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz
rm -rf /tmp/etcd-download-test &amp;&amp; mkdir -p /tmp/etcd-download-test
curl -L ${DOWNLOAD_URL}/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz -o /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz
tar xzvf /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz -C /tmp/etcd-download-test --strip-components=<span class="hljs-number">1</span>
rm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz
/tmp/etcd-download-test/etcd --version
/tmp/etcd-download-test/etcdctl version
</code></pre>
<p data-nodeid="3990">ä¸‹è½½å¯èƒ½æ¯”è¾ƒæ…¢ï¼Œæ‰§è¡Œåï¼ŒæŸ¥çœ‹ etcd ç‰ˆæœ¬çš„ç»“æœå¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="3991"><code data-language="java">etcd Version: <span class="hljs-number">3.4</span><span class="hljs-number">.4</span>
Git SHA: e784ba73c
Go Version: go1<span class="hljs-number">.12</span><span class="hljs-number">.12</span>
Go OS/Arch: linux/amd64
</code></pre>
<p data-nodeid="3992">æ ¹æ®ä¸Šé¢çš„æ‰§è¡Œç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ Linux ä¸Šå®‰è£…æˆåŠŸï¼ŒmacOS çš„äºŒè¿›åˆ¶å®‰è£…ä¹Ÿç±»ä¼¼ï¼Œè¿™é‡Œä¸é‡å¤æ¼”ç¤ºäº†ã€‚å…³äº Windows ç³»ç»Ÿçš„å®‰è£…æ¯”è¾ƒç®€å•ï¼Œä¸‹è½½å¥½å®‰è£…åŒ…åï¼Œç›´æ¥æ‰§è¡Œã€‚å…¶ä¸­ etcd.exe æ˜¯æœåŠ¡ç«¯ï¼Œetcdctl.exe æ˜¯å®¢æˆ·ç«¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p data-nodeid="3993"><img src="https://s0.lgstatic.com/i/image/M00/92/39/Ciqc1GARCpyAUXI0AAFxf5H1G0s496.png" alt="Drawing 0.png" data-nodeid="4136"></p>
<h4 data-nodeid="3994">æºç å®‰è£…</h4>
<p data-nodeid="3995">ä½¿ç”¨æºç å®‰è£…ï¼Œé¦–å…ˆä½ éœ€è¦ç¡®ä¿æœ¬åœ°çš„ Go è¯­è¨€ç¯å¢ƒã€‚å¦‚æœªå®‰è£…ï¼Œè¯·å‚è€ƒ https://golang.org/doc/install å®‰è£… Go è¯­è¨€ç¯å¢ƒã€‚æˆ‘ä»¬éœ€è¦ Go ç‰ˆæœ¬ä¸º 1.13+ï¼Œæ¥æ„å»ºæœ€æ–°ç‰ˆæœ¬çš„ etcdã€‚å¦‚æœä½ æƒ³å°è¯•æœ€æ–°ç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥ä» master åˆ†æ”¯æ„å»º etcdã€‚</p>
<p data-nodeid="3996">é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬æœ¬åœ°çš„ Go ç‰ˆæœ¬ï¼š</p>
<pre class="lang-java" data-nodeid="3997"><code data-language="java">$ go version
Go version go1<span class="hljs-number">.13</span><span class="hljs-number">.6</span> linux/amd64
</code></pre>
<p data-nodeid="3998">ç»æ£€æµ‹ï¼Œæœ¬åœ°çš„ Go ç‰ˆæœ¬æ»¡è¶³è¦æ±‚ã€‚å°†åˆ¶å®šç‰ˆæœ¬çš„ etcd é¡¹ç›® clone åˆ°æœ¬åœ°ä¹‹åï¼Œåœ¨é¡¹ç›®æ–‡ä»¶å¤¹æ„å»º etcdã€‚æ„å»ºå¥½ä¹‹åï¼Œæ‰§è¡Œæµ‹è¯•å‘½ä»¤ï¼Œç¡®ä¿ etcd ç¼–è¯‘å®‰è£…æˆåŠŸï¼š</p>
<pre class="lang-java" data-nodeid="3999"><code data-language="java">$ ./etcdctl version
etcdctl version: <span class="hljs-number">3.4</span><span class="hljs-number">.4</span>
API version: <span class="hljs-number">3.4</span>
</code></pre>
<p data-nodeid="4000">ç»è¿‡ä¸Šè¿°æ­¥éª¤ï¼Œæˆ‘ä»¬å·²ç»é€šè¿‡æºç ç¼–è¯‘æˆåŠŸå®‰è£… etcdã€‚</p>
<p data-nodeid="4001">é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ Docker å®¹å™¨å®‰è£…ï¼Œè¿™ç§æ–¹å¼æ›´ä¸ºç®€å•ï¼Œä½†è¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªå¼Šç«¯ï¼šå¯åŠ¨æ—¶ä¼šå°† etcd çš„ç«¯å£æš´éœ²å‡ºæ¥ã€‚</p>
<h3 data-nodeid="4002">etcd é›†ç¾¤å®‰è£…éƒ¨ç½²</h3>
<p data-nodeid="4003">åˆšåˆšæˆ‘ä»¬ä»‹ç»äº† etcd çš„å•æœºå®‰è£…ï¼Œä½†æ˜¯<strong data-nodeid="4149">åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸ºäº†æ•´ä¸ªé›†ç¾¤çš„é«˜å¯ç”¨ï¼Œetcd é€šå¸¸éƒ½ä¼šä»¥é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼Œä»¥é¿å…å•ç‚¹æ•…éšœ</strong>ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è¿›è¡Œ etcd é›†ç¾¤éƒ¨ç½²ã€‚</p>
<p data-nodeid="4004">å¼•å¯¼ etcd é›†ç¾¤çš„å¯åŠ¨æœ‰ä»¥ä¸‹ä¸‰ç§æ–¹å¼ï¼š</p>
<ul data-nodeid="4005">
<li data-nodeid="4006">
<p data-nodeid="4007">é™æ€å¯åŠ¨</p>
</li>
<li data-nodeid="4008">
<p data-nodeid="4009">etcd åŠ¨æ€å‘ç°</p>
</li>
<li data-nodeid="4010">
<p data-nodeid="4011">DNS å‘ç°</p>
</li>
</ul>
<p data-nodeid="4012">å…¶ä¸­é™æ€å¯åŠ¨ etcd é›†ç¾¤çš„æ–¹å¼è¦æ±‚æ¯ä¸ªæˆå‘˜éƒ½çŸ¥é“é›†ç¾¤ä¸­çš„å…¶ä»–æˆå‘˜ã€‚ç„¶è€Œå¾ˆå¤šåœºæ™¯ä¸­ï¼Œç¾¤é›†æˆå‘˜çš„ IP å¯èƒ½æœªçŸ¥ã€‚å› æ­¤éœ€è¦å€ŸåŠ©å‘ç°æœåŠ¡å¼•å¯¼ etcd ç¾¤é›†å¯åŠ¨ã€‚ä¸‹é¢æˆ‘ä»¬å°†ä¼šåˆ†åˆ«ä»‹ç»è¿™å‡ ç§æ–¹å¼ã€‚</p>
<h4 data-nodeid="4013">é™æ€æ–¹å¼å¯åŠ¨ etcd é›†ç¾¤</h4>
<p data-nodeid="4014">å¦‚æœæˆ‘ä»¬æƒ³åœ¨ä¸€å°æœºå™¨ä¸Šå®è·µ etcd é›†ç¾¤çš„æ­å»ºï¼Œå¯ä»¥é€šè¿‡ goreman å·¥å…·ã€‚</p>
<p data-nodeid="4015">goreman æ˜¯ä¸€ä¸ª Go è¯­è¨€ç¼–å†™çš„å¤šè¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œæ˜¯å¯¹ Ruby ä¸‹å¹¿æ³›ä½¿ç”¨çš„ Foreman çš„é‡å†™ã€‚ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ goreman æ¥æ¼”ç¤ºåœ¨ä¸€å°ç‰©ç†æœºä¸Šé¢ä»¥é™æ€æ–¹å¼å¯åŠ¨ etcd é›†ç¾¤ã€‚</p>
<p data-nodeid="4016">å‰é¢æˆ‘ä»¬å·²ç»ç¡®è®¤è¿‡ Go è¯­è¨€çš„å®‰è£…ç¯å¢ƒï¼Œç°åœ¨å¯ä»¥ç›´æ¥æ‰§è¡Œï¼š</p>
<pre class="lang-java" data-nodeid="4017"><code data-language="java">go get github.com/mattn/goreman
</code></pre>
<p data-nodeid="4018">ç¼–è¯‘åçš„æ–‡ä»¶æ”¾åœ¨<code data-backticks="1" data-nodeid="4160">$GOPATH/bin</code>ä¸­ï¼Œ<code data-backticks="1" data-nodeid="4162">$GOPATH/bin</code>ç›®å½•å·²ç»æ·»åŠ åˆ°äº†ç³»ç»Ÿ<code data-backticks="1" data-nodeid="4164">$PATH</code>ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°æ‰§è¡Œå‘½ä»¤<code data-backticks="1" data-nodeid="4166">goreman</code>å‘½ä»¤ã€‚</p>
<p data-nodeid="4019">ä¸‹é¢å°±æ˜¯ç¼–å†™ Procfile è„šæœ¬ï¼Œæˆ‘ä»¬å¯åŠ¨ä¸‰ä¸ª etcdï¼Œå…·ä½“å¯¹åº”å¦‚ä¸‹ï¼š</p>
<p data-nodeid="4020"><img src="https://s0.lgstatic.com/i/image/M00/92/39/Ciqc1GARCqeAFsCeAABdZ1B5LLA739.png" alt="Drawing 1.png" data-nodeid="4171"></p>
<p data-nodeid="4021">Procfile è„šæœ¬ä¸­ infra1 å¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="4022"><code data-language="java">etcd1: etcd --name infra1 --listen-client-urls http:<span class="hljs-comment">//127.0.0.1:12379 --advertise-client-urls http://127.0.0.1:12379 --listen-peer-urls http://127.0.0.1:12380 --initial-advertise-peer-urls http://127.0.0.1:12380 --initial-cluster-token etcd-cluster-1 --initial-cluster 'infra1=http://127.0.0.1:12380,infra2=http://127.0.0.1:22380,infra3=http://127.0.0.1:32380' --initial-cluster-state new --enable-pprof --logger=zap --log-outputs=stderr</span>
</code></pre>
<p data-nodeid="4023">infra2 å’Œ infra3 çš„å¯åŠ¨å‘½ä»¤ç±»ä¼¼ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶ä¸­å„é…ç½®é¡¹çš„è¯´æ˜ã€‚</p>
<ul data-nodeid="4024">
<li data-nodeid="4025">
<p data-nodeid="4026">--nameï¼šetcd é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åï¼Œè¿™é‡Œå¯ä»¥éšæ„ï¼Œæ–¹ä¾¿åŒºåˆ†ä¸”ä¸é‡å¤å³å¯ã€‚</p>
</li>
<li data-nodeid="4027">
<p data-nodeid="4028">--listen-client-urlsï¼šç›‘å¬ç”¨äºå®¢æˆ·ç«¯é€šä¿¡çš„ urlï¼ŒåŒæ ·å¯ä»¥ç›‘å¬å¤šä¸ªã€‚</p>
</li>
<li data-nodeid="4029">
<p data-nodeid="4030">--advertise-client-urlsï¼šå»ºè®®ä½¿ç”¨çš„å®¢æˆ·ç«¯é€šä¿¡ urlï¼Œè¯¥å€¼ç”¨äº etcd ä»£ç†æˆ– etcd æˆå‘˜ä¸ etcd èŠ‚ç‚¹é€šä¿¡ã€‚</p>
</li>
<li data-nodeid="4031">
<p data-nodeid="4032">--listen-peer-urlsï¼šç›‘å¬ç”¨äºèŠ‚ç‚¹ä¹‹é—´é€šä¿¡çš„ urlï¼Œå¯ç›‘å¬å¤šä¸ªï¼Œé›†ç¾¤å†…éƒ¨å°†é€šè¿‡è¿™äº› url è¿›è¡Œæ•°æ®äº¤äº’(å¦‚é€‰ä¸¾ã€æ•°æ®åŒæ­¥ç­‰)ã€‚</p>
</li>
<li data-nodeid="4033">
<p data-nodeid="4034">--initial-advertise-peer-urlsï¼šå»ºè®®ç”¨äºèŠ‚ç‚¹ä¹‹é—´é€šä¿¡çš„ urlï¼ŒèŠ‚ç‚¹é—´å°†ä»¥è¯¥å€¼è¿›è¡Œé€šä¿¡ã€‚</p>
</li>
<li data-nodeid="4035">
<p data-nodeid="4036">--initial-cluster-tokenï¼š etcd-cluster-1ï¼ŒèŠ‚ç‚¹çš„ token å€¼ï¼Œè®¾ç½®è¯¥å€¼åé›†ç¾¤å°†ç”Ÿæˆå”¯ä¸€ IDï¼Œå¹¶ä¸ºæ¯ä¸ªèŠ‚ç‚¹ä¹Ÿç”Ÿæˆå”¯ä¸€ IDã€‚å½“ä½¿ç”¨ç›¸åŒé…ç½®æ–‡ä»¶å†å¯åŠ¨ä¸€ä¸ªé›†ç¾¤æ—¶ï¼Œåªè¦è¯¥ token å€¼ä¸ä¸€æ ·ï¼Œetcd é›†ç¾¤å°±ä¸ä¼šç›¸äº’å½±å“ã€‚</p>
</li>
<li data-nodeid="4037">
<p data-nodeid="4038">--initial-clusterï¼šé›†ç¾¤ä¸­æ‰€æœ‰çš„ initial-advertise-peer-urls çš„åˆé›†ã€‚</p>
</li>
<li data-nodeid="4039">
<p data-nodeid="4040">--initial-cluster-stateï¼šnewï¼Œæ–°å»ºé›†ç¾¤çš„æ ‡å¿—ã€‚</p>
</li>
</ul>
<p data-nodeid="4041">æ³¨æ„ä¸Šé¢çš„è„šæœ¬ï¼Œ<strong data-nodeid="4189">etcd å‘½ä»¤æ‰§è¡Œæ—¶éœ€è¦æ ¹æ®æœ¬åœ°å®é™…çš„å®‰è£…åœ°å€è¿›è¡Œé…ç½®</strong>ã€‚ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨<code data-backticks="1" data-nodeid="4187">goreman</code>å‘½ä»¤å¯åŠ¨ etcd é›†ç¾¤ï¼š</p>
<pre class="lang-java" data-nodeid="4042"><code data-language="java">goreman -f /opt/procfile start
</code></pre>
<p data-nodeid="4043">å¯åŠ¨å®ŒæˆåæŸ¥çœ‹é›†ç¾¤å†…çš„æˆå‘˜ï¼š</p>
<pre class="lang-java" data-nodeid="4044"><code data-language="java">$ etcdctl --endpoints=http:<span class="hljs-comment">//localhost:22379  member list</span>
<span class="hljs-number">8211f</span>1d0f64f3269, started, infra1, http:<span class="hljs-comment">//127.0.0.1:12380, http://127.0.0.1:12379, false</span>
<span class="hljs-number">91</span>bc3c398fb3c146, started, infra2, http:<span class="hljs-comment">//127.0.0.1:22380, http://127.0.0.1:22379, false</span>
fd422379fda50e48, started, infra3, http:<span class="hljs-comment">//127.0.0.1:32380, http://127.0.0.1:32379, false</span>
</code></pre>
<p data-nodeid="4045">ç°åœ¨æˆ‘ä»¬çš„ etcd é›†ç¾¤å·²ç»æ­å»ºæˆåŠŸã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼š<strong data-nodeid="4196">åœ¨é›†ç¾¤å¯åŠ¨æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡é™æ€çš„æ–¹å¼æŒ‡å®šé›†ç¾¤çš„æˆå‘˜ã€‚ä½†åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œé›†ç¾¤æˆå‘˜çš„ IP å¯èƒ½ä¸ä¼šæå‰çŸ¥é“ï¼Œæ­¤æ—¶éœ€è¦é‡‡ç”¨åŠ¨æ€å‘ç°çš„æœºåˆ¶</strong>ã€‚</p>
<h4 data-nodeid="4046">åŠ¨æ€å‘ç°å¯åŠ¨ etcd é›†ç¾¤</h4>
<p data-nodeid="4047">Discovery Serviceï¼Œå³å‘ç°æœåŠ¡ï¼Œå¸®åŠ©æ–°çš„ etcd æˆå‘˜ä½¿ç”¨å…±äº« URL åœ¨é›†ç¾¤å¼•å¯¼é˜¶æ®µå‘ç°æ‰€æœ‰å…¶ä»–æˆå‘˜ã€‚</p>
<p data-nodeid="4048">Discovery Service ä½¿ç”¨å·²æœ‰çš„ etcd é›†ç¾¤æ¥åè°ƒæ–°é›†ç¾¤çš„å¯åŠ¨ï¼Œä¸»è¦æ“ä½œå¦‚ä¸‹ï¼š</p>
<ul data-nodeid="4049">
<li data-nodeid="4050">
<p data-nodeid="4051">é¦–å…ˆï¼Œæ‰€æœ‰æ–°æˆå‘˜éƒ½ä¸å‘ç°æœåŠ¡äº¤äº’ï¼Œå¹¶å¸®åŠ©ç”Ÿæˆé¢„æœŸçš„æˆå‘˜åˆ—è¡¨ï¼›</p>
</li>
<li data-nodeid="4052">
<p data-nodeid="4053">ä¹‹åï¼Œæ¯ä¸ªæ–°æˆå‘˜ä½¿ç”¨æ­¤åˆ—è¡¨å¼•å¯¼å…¶æœåŠ¡å™¨ï¼Œè¯¥åˆ—è¡¨æ‰§è¡Œä¸<code data-backticks="1" data-nodeid="4202">--initial-cluster</code>æ ‡å¿—ç›¸åŒçš„åŠŸèƒ½ï¼Œå³è®¾ç½®æ‰€æœ‰é›†ç¾¤çš„æˆå‘˜ä¿¡æ¯ã€‚</p>
</li>
</ul>
<p data-nodeid="4054">æˆ‘ä»¬çš„å®éªŒä¸­å¯åŠ¨ä¸‰ä¸ª etcd å®ä¾‹ï¼Œå…·ä½“å¯¹åº”å¦‚ä¸‹ï¼š</p>
<p data-nodeid="4055"><img src="https://s0.lgstatic.com/i/image/M00/92/3A/Ciqc1GARCuKAalsHAABj2KBNcMc677.png" alt="image (1).png" data-nodeid="4207"></p>
<p data-nodeid="4056">ä¸‹é¢å°±å¼€å§‹ä»¥åŠ¨æ€å‘ç°çš„æ–¹å¼æ¥å¯åŠ¨ etcd é›†ç¾¤ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ã€‚</p>
<p data-nodeid="4057"><strong data-nodeid="4212">è·å– discovery çš„ token</strong></p>
<p data-nodeid="4058"><strong data-nodeid="4217">é¦–å…ˆéœ€è¦ç”Ÿæˆæ ‡è¯†æ–°é›†ç¾¤çš„å”¯ä¸€ä»¤ç‰Œ</strong>ã€‚è¯¥ä»¤ç‰Œå°†ç”¨äºé”®ç©ºé—´ä¸­çš„å”¯ä¸€å‰ç¼€ï¼Œæ¯”è¾ƒç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ uuidgen ç”Ÿæˆ UUIDï¼š</p>
<pre class="lang-java" data-nodeid="4059"><code data-language="java">UUID=$(uuidgen)
</code></pre>
<p data-nodeid="4060"><strong data-nodeid="4221">æŒ‡å®šé›†ç¾¤çš„å¤§å°</strong></p>
<p data-nodeid="4061">è·å–ä»¤ç‰Œæ—¶ï¼Œå¿…é¡»æŒ‡å®šç¾¤é›†å¤§å°ã€‚<strong data-nodeid="4227">å‘ç°æœåŠ¡ä½¿ç”¨è¯¥æ•°å€¼æ¥ç¡®å®šç»„æˆé›†ç¾¤çš„æ‰€æœ‰æˆå‘˜</strong>ï¼š</p>
<pre class="lang-java" data-nodeid="4062"><code data-language="java">curl -X PUT http:<span class="hljs-comment">//10.0.10.10:2379/v2/keys/discovery/6c007a14875d53d9bf0ef5a6fc0257c817f0fb83/_config/size -d value=3</span>
</code></pre>
<p data-nodeid="4063">æˆ‘ä»¬éœ€è¦æŠŠè¯¥ url ä½œä¸º<code data-backticks="1" data-nodeid="4229">--discovery</code>å‚æ•°æ¥å¯åŠ¨ etcdï¼ŒèŠ‚ç‚¹ä¼šè‡ªåŠ¨ä½¿ç”¨è¯¥è·¯å¾„å¯¹åº”çš„ç›®å½•è¿›è¡Œ etcd çš„æœåŠ¡æ³¨å†Œä¸å‘ç°ã€‚</p>
<p data-nodeid="4064"><strong data-nodeid="4234">å…¬å…±å‘ç°æœåŠ¡</strong></p>
<p data-nodeid="4065">å½“æˆ‘ä»¬æœ¬åœ°æ²¡æœ‰å¯ç”¨çš„ etcd é›†ç¾¤ï¼Œetcd å®˜ç½‘æä¾›äº†ä¸€ä¸ªå¯ä»¥å…¬ç½‘è®¿é—®çš„ etcd å­˜å‚¨åœ°å€ã€‚ä½ å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¾—åˆ° etcd æœåŠ¡çš„ç›®å½•ï¼Œå¹¶æŠŠå®ƒä½œä¸º<code data-backticks="1" data-nodeid="4236">--discovery</code>å‚æ•°ä½¿ç”¨ã€‚</p>
<p data-nodeid="4066">å…¬å…±å‘ç°æœåŠ¡<code data-backticks="1" data-nodeid="4239">discovery.etcd.io</code>ä»¥ç›¸åŒçš„æ–¹å¼å·¥ä½œï¼Œä½†æ˜¯æœ‰ä¸€å±‚ä¿®é¥°ï¼Œåœ¨æ­¤ä¹‹ä¸Šä»ç„¶ä½¿ç”¨ etcd ç¾¤é›†ä½œä¸ºæ•°æ®å­˜å‚¨ã€‚</p>
<pre class="lang-java te-preview-highlight" data-nodeid="4346"><code data-language="java">$ curl https:<span class="hljs-comment">//discovery.etcd.io/new?size=3</span>
https:<span class="hljs-comment">//discovery.etcd.io/3e86b59982e49066c5d813af1c2e2579cbf573de</span>
</code></pre>

<p data-nodeid="4068"><strong data-nodeid="4244">ä»¥åŠ¨æ€å‘ç°æ–¹å¼å¯åŠ¨é›†ç¾¤</strong></p>
<p data-nodeid="4069">etcd å‘ç°æ¨¡å¼ä¸‹ï¼Œå¯åŠ¨ etcd çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="4070"><code data-language="java"># etcd1 å¯åŠ¨
$ /opt/etcd/bin/etcd  --name etcd1 --initial-advertise-peer-urls http://192.168.202.128:2380 \
  --listen-peer-urls http://192.168.202.128:2380 \
  --data-dir /opt/etcd/data \
  --listen-client-urls http://192.168.202.128:2379,http://127.0.0.1:2379 \
  --advertise-client-urls http://192.168.202.128:2379 \
  --discovery https://discovery.etcd.io/3e86b59982e49066c5d813af1c2e2579cbf573de
</code></pre>
<p data-nodeid="4071">etcd2 å’Œ etcd3 å¯åŠ¨ç±»ä¼¼ï¼Œæ›¿æ¢ listen-peer-urls å’Œ advertise-client-urls å³å¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼š<strong data-nodeid="4252">åœ¨æˆ‘ä»¬å®Œæˆäº†é›†ç¾¤çš„åˆå§‹åŒ–åï¼Œ</strong><code data-backticks="1" data-nodeid="4250">--discovery</code>å°±å¤±å»äº†ä½œç”¨ã€‚å½“éœ€è¦å¢åŠ èŠ‚ç‚¹æ—¶ï¼Œéœ€è¦ä½¿ç”¨ etcdctl è¿›è¡Œæ“ä½œã€‚</p>
<p data-nodeid="4072">ä¸ºäº†å®‰å…¨ï¼Œæ¯æ¬¡å¯åŠ¨æ–° etcd é›†ç¾¤æ—¶ï¼Œéƒ½ä¼šä½¿ç”¨æ–°çš„ discovery token è¿›è¡Œæ³¨å†Œã€‚å½“å‡ºç°åˆå§‹åŒ–å¯åŠ¨çš„èŠ‚ç‚¹è¶…è¿‡äº†æŒ‡å®šçš„æ•°é‡æ—¶ï¼Œå¤šä½™çš„èŠ‚ç‚¹ä¼šè‡ªåŠ¨è½¬åŒ–ä¸º Proxy æ¨¡å¼çš„ etcdï¼ˆåœ¨åé¢è¯¾æ—¶ä¼šè¯¦ç»†ä»‹ç»ï¼‰ã€‚</p>
<p data-nodeid="4073"><strong data-nodeid="4257">ç»“æœéªŒè¯</strong></p>
<p data-nodeid="4074">é›†ç¾¤å¯åŠ¨åï¼Œè¿›è¡ŒéªŒè¯ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹é›†ç¾¤èŠ‚ç‚¹çš„å¥åº·çŠ¶æ€ï¼š</p>
<pre class="lang-java" data-nodeid="4075"><code data-language="java">$ /opt/etcd/bin/etcdctl  --endpoints="http://192.168.202.128:2379,http://192.168.202.129:2379,http://192.168.202.130:2379"  endpoint  health
# ç»“æœå¦‚ä¸‹
    http://192.168.202.128:2379 is healthy: successfully committed proposal: took = 3.157068ms
    http://192.168.202.130:2379 is healthy: successfully committed proposal: took = 3.300984ms
    http://192.168.202.129:2379 is healthy: successfully committed proposal: took = 3.263923ms
</code></pre>
<p data-nodeid="4076">å¯ä»¥çœ‹åˆ°ï¼Œé›†ç¾¤ä¸­çš„ä¸‰ä¸ªèŠ‚ç‚¹éƒ½æ˜¯å¥åº·çš„æ­£å¸¸çŠ¶æ€ï¼Œå¯ä»¥è¯´æ˜ä»¥åŠ¨æ€å‘ç°æ–¹å¼å¯åŠ¨é›†ç¾¤æˆåŠŸã€‚</p>
<p data-nodeid="4077">é™¤æ­¤ä¹‹å¤–ï¼Œ<strong data-nodeid="4265">etcd è¿˜æ”¯æŒä½¿ç”¨ DNS SRV è®°å½•å¯åŠ¨ etcd é›†ç¾¤</strong>ã€‚ä½¿ç”¨ DNSmasq åˆ›å»º DNS æœåŠ¡ï¼Œå®é™…ä¸Šæ˜¯åˆ©ç”¨ DNS çš„ SRV è®°å½•ä¸æ–­è½®è®­æŸ¥è¯¢å®ç°ï¼ŒDNS SRV æ˜¯ DNS æ•°æ®åº“ä¸­æ”¯æŒçš„ä¸€ç§èµ„æºè®°å½•çš„ç±»å‹ï¼Œå®ƒè®°å½•äº†è®¡ç®—æœºä¸æ‰€æä¾›æœåŠ¡ä¿¡æ¯çš„å¯¹åº”å…³ç³»ã€‚</p>
<p data-nodeid="4078">è‡³æ­¤ï¼Œæˆ‘ä»¬å°±ä»‹ç»å®Œäº† etcd å®‰è£…éƒ¨ç½²çš„ä¸¤ç§æ–¹å¼ï¼Œå¯¹äºå¯é çš„ç³»ç»Ÿæ¥è¯´ï¼Œè¿˜éœ€è¦è€ƒè™‘ etcd é›†ç¾¤é€šä¿¡çš„å®‰å…¨æ€§ï¼Œä¸ºæˆ‘ä»¬çš„æ•°æ®å®‰å…¨å¢åŠ é˜²æŠ¤ã€‚</p>
<h3 data-nodeid="4079">etcd é€šä¿¡å®‰å…¨</h3>
<p data-nodeid="4080">etcd æ”¯æŒé€šè¿‡ TLS åè®®è¿›è¡Œçš„åŠ å¯†é€šä¿¡ï¼ŒTLS é€šé“å¯ç”¨äºå¯¹ç­‰ä½“ï¼ˆæŒ‡ etcd é›†ç¾¤ä¸­çš„æœåŠ¡å®ä¾‹ï¼‰ä¹‹é—´çš„åŠ å¯†å†…éƒ¨ç¾¤é›†é€šä¿¡ä»¥åŠåŠ å¯†çš„å®¢æˆ·ç«¯æµé‡ã€‚è¿™ä¸€èŠ‚æˆ‘ä»¬çœ‹ä¸€ä¸‹å®¢æˆ·ç«¯ TLS è®¾ç½®ç¾¤é›†çš„å®ç°ã€‚</p>
<p data-nodeid="4081">æƒ³è¦å®ç°æ•°æ® HTTPS åŠ å¯†åè®®è®¿é—®ã€ä¿éšœæ•°æ®çš„å®‰å…¨ï¼Œå°±éœ€è¦ SSL è¯ä¹¦ï¼ŒTLS æ˜¯ SSL ä¸ HTTPS å®‰å…¨ä¼ è¾“å±‚åè®®åç§°ã€‚</p>
<h4 data-nodeid="4082">è¿›è¡Œ TLS åŠ å¯†å®è·µ</h4>
<p data-nodeid="4083">ä¸ºäº†è¿›è¡Œå®è·µï¼Œæˆ‘ä»¬å°†å®‰è£…ä¸€äº›å®ç”¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œè¿™åŒ…æ‹¬ CFSSL ã€cfssljsonã€‚</p>
<p data-nodeid="4084">CFSSL æ˜¯ CloudFlare çš„ PKI/TLS åŠ å¯†åˆ©å™¨ã€‚å®ƒæ—¢æ˜¯å‘½ä»¤è¡Œå·¥å…·ï¼Œä¹Ÿå¯ä»¥ç”¨äºç­¾åã€éªŒè¯å’Œæ†ç»‘ TLS è¯ä¹¦çš„ HTTP API æœåŠ¡å™¨ï¼Œéœ€è¦ Go 1.12+ ç‰ˆæœ¬æ‰èƒ½æ„å»ºã€‚</p>
<p data-nodeid="4085"><strong data-nodeid="4276">ç¯å¢ƒé…ç½®</strong></p>
<p data-nodeid="4086"><img src="https://s0.lgstatic.com/i/image/M00/92/49/Ciqc1GARNceAKjyVAABikQzRQNU984.png" alt="Lark20210127-174258.png" data-nodeid="4279"></p>
<p data-nodeid="4087"><strong data-nodeid="4283">å®‰è£… CFSSL</strong></p>
<pre class="lang-java" data-nodeid="4088"><code data-language="java">$ ls ~/Downloads/cfssl
cfssl-certinfo_1<span class="hljs-number">.4</span><span class="hljs-number">.1</span>_linux_amd64 cfssl_1<span class="hljs-number">.4</span><span class="hljs-number">.1</span>_linux_amd64          cfssljson_1<span class="hljs-number">.4</span><span class="hljs-number">.1</span>_linux_amd64
chmod +x cfssl_1<span class="hljs-number">.4</span><span class="hljs-number">.1</span>_linux_amd64 cfssljson_1<span class="hljs-number">.4</span><span class="hljs-number">.1</span>_linux_amd64 cfssl-certinfo_1<span class="hljs-number">.4</span><span class="hljs-number">.1</span>_linux_amd64
mv cfssl_1<span class="hljs-number">.4</span><span class="hljs-number">.1</span>_linux_amd64 /usr/local/bin/cfssl
mv cfssljson_1<span class="hljs-number">.4</span><span class="hljs-number">.1</span>_linux_amd64 /usr/local/bin/cfssljson
mv cfssl-certinfo_1<span class="hljs-number">.4</span><span class="hljs-number">.1</span>_linux_amd64 /usr/bin/cfssl-certinfo
</code></pre>
<p data-nodeid="4089">å®‰è£…å®Œæˆåï¼ŒæŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="4090"><code data-language="java">$ cfssl version
Version: <span class="hljs-number">1.4</span><span class="hljs-number">.1</span>
Runtime: go1<span class="hljs-number">.12</span><span class="hljs-number">.12</span>
</code></pre>
<p data-nodeid="4091"><strong data-nodeid="4288">é…ç½® CA å¹¶åˆ›å»º TLS è¯ä¹¦</strong></p>
<p data-nodeid="4092">æˆ‘ä»¬å°†ä½¿ç”¨ CloudFlare's PKI å·¥å…· CFSSL æ¥é…ç½® PKI å®‰å…¨ç­–ç•¥ï¼Œç„¶åç”¨å®ƒåˆ›å»º Certificate Authorityï¼ˆCAï¼Œå³è¯ä¹¦æœºæ„ï¼‰ï¼Œå¹¶ä¸º etcd åˆ›å»º TLS è¯ä¹¦ã€‚</p>
<p data-nodeid="4093">é¦–å…ˆåˆ›å»º SSL é…ç½®ç›®å½•ï¼š</p>
<pre class="lang-java" data-nodeid="4094"><code data-language="java">mkdir /opt/etcd/{bin,cfg,ssl} -p
cd /opt/etcd/ssl/
</code></pre>
<p data-nodeid="4095">æ¥ä¸‹æ¥å®Œå–„ etcd CA é…ç½®ï¼Œå†™å…¥ ca-config.json å¦‚ä¸‹çš„é…ç½®ï¼š</p>
<pre class="lang-java" data-nodeid="4096"><code data-language="java">cat &lt;&lt; EOF | tee ca-config.json
{
  <span class="hljs-string">"signing"</span>: {
    <span class="hljs-string">"default"</span>: {
      <span class="hljs-string">"expiry"</span>: <span class="hljs-string">"87600h"</span>
    },
    <span class="hljs-string">"profiles"</span>: {
      <span class="hljs-string">"etcd"</span>: {
         <span class="hljs-string">"expiry"</span>: <span class="hljs-string">"87600h"</span>,
         <span class="hljs-string">"usages"</span>: [
            <span class="hljs-string">"signing"</span>,
            <span class="hljs-string">"key encipherment"</span>,
            <span class="hljs-string">"server auth"</span>,
            <span class="hljs-string">"client auth"</span>
        ]
      }
    }
  }
}
EOF
</code></pre>
<p data-nodeid="4097">ç”Ÿæˆè·å– etcd ca è¯ä¹¦ï¼Œéœ€è¦è¯ä¹¦ç­¾åçš„è¯·æ±‚æ–‡ä»¶ï¼Œå› æ­¤åœ¨ca-csr.json å†™å…¥å¦‚ä¸‹çš„é…ç½®ï¼š</p>
<pre class="lang-java" data-nodeid="4098"><code data-language="java">cat &lt;&lt; EOF | tee ca-csr.json
{
    <span class="hljs-string">"CN"</span>: <span class="hljs-string">"etcd CA"</span>,
    <span class="hljs-string">"key"</span>: {
        <span class="hljs-string">"algo"</span>: <span class="hljs-string">"rsa"</span>,
        <span class="hljs-string">"size"</span>: <span class="hljs-number">2048</span>
    },
    <span class="hljs-string">"names"</span>: [
        {
            <span class="hljs-string">"C"</span>: <span class="hljs-string">"CN"</span>,
            <span class="hljs-string">"L"</span>: <span class="hljs-string">"Shanghai"</span>,
            <span class="hljs-string">"ST"</span>: <span class="hljs-string">"Shanghai"</span>
        }
    ]
}
EOF
</code></pre>
<p data-nodeid="4099">æ ¹æ®ä¸Šé¢çš„é…ç½®ï¼Œç”Ÿæˆ CA å‡­è¯å’Œç§é’¥ï¼š</p>
<pre class="lang-java" data-nodeid="4100"><code data-language="java">$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca
</code></pre>
<p data-nodeid="4101">ç”Ÿæˆ etcd server è¯ä¹¦ï¼Œå†™å…¥ server-csr.json å¦‚ä¸‹çš„é…ç½®ï¼š</p>
<pre class="lang-java" data-nodeid="4102"><code data-language="java">cat &lt;&lt; EOF | tee server-csr.json
{
    <span class="hljs-string">"CN"</span>: <span class="hljs-string">"etcd"</span>,
    <span class="hljs-string">"hosts"</span>: [
    <span class="hljs-string">"192.168.202.128"</span>,
    <span class="hljs-string">"192.168.202.129"</span>,
    <span class="hljs-string">"192.168.202.130"</span>
    ],
    <span class="hljs-string">"key"</span>: {
        <span class="hljs-string">"algo"</span>: <span class="hljs-string">"rsa"</span>,
        <span class="hljs-string">"size"</span>: <span class="hljs-number">2048</span>
    },
    <span class="hljs-string">"names"</span>: [
        {
            <span class="hljs-string">"C"</span>: <span class="hljs-string">"CN"</span>,
            <span class="hljs-string">"L"</span>: <span class="hljs-string">"Beijing"</span>,
            <span class="hljs-string">"ST"</span>: <span class="hljs-string">"Beijing"</span>
        }
    ]
}
EOF
</code></pre>
<p data-nodeid="4103">æœ€åå°±å¯ä»¥ç”Ÿæˆ server è¯ä¹¦äº†ï¼š</p>
<pre class="lang-java" data-nodeid="4104"><code data-language="java">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd server-csr.json | cfssljson -bare server
</code></pre>
<p data-nodeid="4105">å¯åŠ¨ etcd é›†ç¾¤ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="4106"><code data-language="java">#etcd1 å¯åŠ¨
$ /opt/etcd/bin/etcd --name etcd1 --initial-advertise-peer-urls https://192.168.202.128:2380 \
     --listen-peer-urls https://192.168.202.128:2380 \
     --listen-client-urls https://192.168.202.128:2379,https://127.0.0.1:2379 \
     --advertise-client-urls https://192.168.202.128:2379 \
     --initial-cluster-token etcd-cluster-1 \
     --initial-cluster etcd1=https://192.168.202.128:2380, etcd2=https://192.168.202.129:2380, etcd3=https://192.168.202.130:2380 \
     --initial-cluster-state new \
     --client-cert-auth --trusted-ca-file=/opt/etcd/ssl/ca.pem \
     --cert-file=/opt/etcd/ssl/server.pem --key-file=/opt/etcd/ssl/server-key.pem \
     --peer-client-cert-auth --peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \
     --peer-cert-file=/opt/etcd/ssl/server.pem --peer-key-file=/opt/etcd/ssl/server-key.pem
</code></pre>
<p data-nodeid="4107">etcd2 å’Œ etcd3 å¯åŠ¨ç±»ä¼¼ï¼Œ<strong data-nodeid="4304">æ³¨æ„æ›¿æ¢ listen-peer-urls å’Œ advertise-client-urls</strong>ã€‚é€šè¿‡ä¸‰å°æœåŠ¡å™¨çš„æ§åˆ¶å°å¯ä»¥çŸ¥é“ï¼Œé›†ç¾¤å·²ç»æˆåŠŸå»ºç«‹ã€‚</p>
<p data-nodeid="4108">ä¸‹é¢æˆ‘ä»¬è¿›è¡ŒéªŒè¯ï¼š</p>
<pre class="lang-java" data-nodeid="4109"><code data-language="java">$ /opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints="https://192.168.202.128:2379,https://192.168.202.129:2379,https://192.168.202.130:2379"  endpoint health
# è¾“å‡ºå¦‚ä¸‹ï¼š
https://192.168.202.129:2379 is healthy: successfully committed proposal: took = 9.492956ms
https://192.168.202.130:2379 is healthy: successfully committed proposal: took = 12.805109ms
https://192.168.202.128:2379 is healthy: successfully committed proposal: took = 13.036091ms
</code></pre>
<p data-nodeid="4110">æŸ¥çœ‹ä¸‰ä¸ªèŠ‚ç‚¹çš„å¥åº·çŠ¶å†µï¼Œ<code data-backticks="1" data-nodeid="4307">endpoint health</code>ï¼Œè¾“å‡ºçš„ç»“æœç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚</p>
<p data-nodeid="4111">ç»è¿‡ TLS åŠ å¯†çš„ etcd é›†ç¾¤ï¼Œåœ¨è¿›è¡Œæ“ä½œæ—¶ï¼Œéœ€è¦åŠ ä¸Šè®¤è¯ç›¸å…³çš„ä¿¡æ¯ã€‚</p>
<p data-nodeid="4112"><strong data-nodeid="4313">è‡ªåŠ¨è¯ä¹¦</strong></p>
<p data-nodeid="4113">å¦‚æœé›†ç¾¤éœ€è¦åŠ å¯†çš„é€šä¿¡ä½†ä¸éœ€è¦ç»è¿‡èº«ä»½éªŒè¯çš„è¿æ¥ï¼Œå¯ä»¥å°† etcd é…ç½®ä¸ºè‡ªåŠ¨ç”Ÿæˆå…¶å¯†é’¥ã€‚åœ¨åˆå§‹åŒ–æ—¶ï¼Œæ¯ä¸ªæˆå‘˜éƒ½åŸºäºå…¶é€šå‘Šçš„ IP åœ°å€å’Œä¸»æœºåˆ›å»ºè‡ªå·±çš„å¯†é’¥é›†ã€‚</p>
<p data-nodeid="4114">åœ¨æ¯å°æœºå™¨ä¸Šï¼Œetcd å°†ä½¿ç”¨ä»¥ä¸‹æ ‡å¿—å¯åŠ¨ï¼š</p>
<pre class="lang-java" data-nodeid="4115"><code data-language="java">$ etcd --name etcd1 --initial-advertise-peer-urls https:<span class="hljs-comment">//192.168.202.128:2380 \</span>
  --listen-peer-urls https:<span class="hljs-comment">//192.168.202.128:2380 \</span>
  --listen-client-urls https:<span class="hljs-comment">//192.168.202.128:2379,https://127.0.0.1:2379 \</span>
  --advertise-client-urls https:<span class="hljs-comment">//10.0.1.10:2379 \</span>
  --initial-cluster-token etcd-cluster-<span class="hljs-number">1</span> \
  --initial-cluster infra0=https:<span class="hljs-comment">//192.168.202.128:2380,infra1=https://192.168.202.129:2380,infra2=https://192.168.202.130:2380 \</span>
  --initial-cluster-state <span class="hljs-keyword">new</span> \
  --auto-tls \
  --peer-auto-tls
</code></pre>
<p data-nodeid="4116">ç”±äºè‡ªåŠ¨ç­¾å‘è¯ä¹¦å¹¶ä¸èƒ½è®¤è¯èº«ä»½ï¼Œç›´æ¥ curl ä¼šè¿”å›é”™è¯¯ï¼Œ<strong data-nodeid="4323">éœ€è¦ä½¿ç”¨ curl çš„<code data-backticks="1" data-nodeid="4319">-k</code>å‘½ä»¤å±è”½å¯¹è¯ä¹¦é“¾çš„æ ¡éªŒ</strong>ã€‚</p>
<h3 data-nodeid="4117">å°ç»“</h3>
<p data-nodeid="4118">è¿™ä¸€è®²æˆ‘ä»¬ä¸»è¦ä»‹ç»äº† etcd çš„å®‰è£…éƒ¨ç½²æ–¹å¼ï¼ŒåŒ…æ‹¬å•æœºå’Œé›†ç¾¤çš„éƒ¨ç½²ã€‚ä¸ºäº†é«˜å¯ç”¨ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬ä¸€èˆ¬é€‰æ‹©ä½¿ç”¨é›†ç¾¤çš„æ–¹å¼éƒ¨ç½² etcdã€‚åœ¨é›†ç¾¤éƒ¨ç½²çš„æ—¶å€™ï¼Œæœ‰é™æ€å’ŒåŠ¨æ€ä¸¤ç§æ–¹å¼å‘ç°é›†ç¾¤ä¸­çš„æˆå‘˜ã€‚é™æ€çš„æ–¹å¼æ˜¯ç›´æ¥åœ¨å¯åŠ¨æ—¶æŒ‡å®šå„ä¸ªæˆå‘˜çš„åœ°å€ï¼Œä½†åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œé›†ç¾¤æˆå‘˜çš„ IP å¯èƒ½ä¸ä¼šæå‰çŸ¥é“ï¼Œè¿™æ—¶å€™å°±éœ€è¦é‡‡ç”¨åŠ¨æ€å‘ç°çš„æœºåˆ¶ã€‚</p>
<p data-nodeid="4119"><img src="https://s0.lgstatic.com/i/image/M00/92/45/CgqCHmARCxWAYbu_AAFSH3KwqSA512.png" alt="Drawing 2.png" data-nodeid="4328"></p>
<p data-nodeid="4120">Discovery Service ç”¨äºç”Ÿæˆé›†ç¾¤çš„å‘ç°ä»¤ç‰Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong data-nodeid="4334">è¯¥ä»¤ç‰Œä»…ç”¨äºé›†ç¾¤å¼•å¯¼é˜¶æ®µï¼Œä¸èƒ½ç”¨äºè¿è¡Œæ—¶é‡æ–°é…ç½®æˆ–é›†ç¾¤ç›‘è§†</strong>ã€‚ä¸€ä¸ªå‘ç°ä»¤ç‰Œåªèƒ½ä»£è¡¨ä¸€ä¸ª etcd é›†ç¾¤ï¼Œåªè¦æ­¤ä»¤ç‰Œä¸Šçš„å‘ç°åè®®å¯åŠ¨ï¼Œå³ä½¿å®ƒä¸­é€”å¤±è´¥ï¼Œä¹Ÿä¸èƒ½ç”¨äºå¼•å¯¼å¦ä¸€ä¸ª etcd é›†ç¾¤ã€‚æˆ‘åœ¨è¿™ä¸€è®²æœ€åä¹Ÿä»‹ç»äº† etcd é›†ç¾¤é€šè¿‡ TLS åè®®è¿›è¡Œçš„åŠ å¯†é€šä¿¡ï¼Œæ¥ä¿è¯ etcd é€šä¿¡çš„å®‰å…¨ã€‚</p>
<p data-nodeid="4121">ä¸‹ä¸€è®²æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨ etcdctl å®¢æˆ·ç«¯ä¸ etcd æœåŠ¡ç«¯è¿›è¡Œäº¤äº’ï¼Œä»¥åŠæ“ä½œ etcd æœåŠ¡ç«¯ã€‚æœ‰ä»»ä½•ç–‘é—®æ¬¢è¿åœ¨ç•™è¨€åŒºå’Œæˆ‘äº’åŠ¨ï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²å†è§ï¼</p>
<hr data-nodeid="4122">
<p data-nodeid="4123"><a href="https://shenceyun.lagou.com/t/Mka" data-nodeid="4342"><img src="https://s0.lgstatic.com/i/image/M00/8B/BD/Ciqc1F_gEFiAcnCNAAhXSgFweBY589.png" alt="java_é«˜è–ªè®­ç»ƒè¥.png" data-nodeid="4341"></a></p>
<p data-nodeid="4124" class=""><a href="https://shenceyun.lagou.com/t/Mka" data-nodeid="4345">æ‹‰å‹¾èƒŒä¹¦å†…æ¨ + ç¡¬æ ¸å®æˆ˜æŠ€æœ¯å¹²è´§ï¼Œå¸®åŠ©æ¯ä½ Java å·¥ç¨‹å¸ˆè¾¾åˆ°é˜¿é‡Œ P7 æŠ€æœ¯èƒ½åŠ›ã€‚ç‚¹æ­¤é“¾æ¥ï¼Œå¿«æ¥é¢†å–ï¼</a></p>

---

### ç²¾é€‰è¯„è®º

##### **å­¦ï¼š
> https://etcd.io/docs/v2/docker_guide/docker å‘½ä»¤èµ°å¤©ä¸‹

##### *é˜³ï¼š
> TLSè¯ä¹¦æŠ˜è…¾äº†æˆ‘å¾ˆä¹…ï¼Œå†éƒ¨ç½²å‰æœ€å¥½ç›´æ¥æŠŠtlsè¯ä¹¦é…ç½®å¥½ã€‚

##### *é”ï¼š
> https://etcd.io/docs/v2/docker_guide/ä¸Šé¢åŒå­¦å‘çš„ï¼Œdocker å’Œé“¾æ¥é åœ¨ä¸€èµ·äº†ã€‚

##### *å¸†ï¼š
> docker å®‰è£…æ›´å¥½ï¼Œè¿˜ä¸ä¼šæ±¡æŸ“æœ¬æœºçš„ç¯å¢ƒ

##### **é£ï¼š
> etcd--discovery https://discovery.etcd.io/79867d2514b575e8ad2d0362f62fc50bè€å¸ˆå¥½ï¼Œæœ¬åœ°æ‰§è¡Œå¦‚ä¸Šå‘½ä»¤æŠ¥é”™ï¼ŒæŒ‰æç¤ºç»“æŸå ç”¨ç«¯å£çš„è¿›ç¨‹åé‡æ–°æ‰§è¡Œè¿˜æ˜¯æŠ¥ç›¸åŒé”™è¯¯ï¼Œè¯·é—®å¦‚ä½•è§£å†³ï¼Ÿè°¢è°¢ï¼[WARNING] Deprecated '--logger=capnslog' flag is set; use '--logger=zap' flag instead2021-01-29 17:41:55.205259 I | etcdmain: etcd Version: 3.4.42021-01-29 17:41:55.207348 I | etcdmain: Git SHA: c65a9e2dd2021-01-29 17:41:55.207351 I | etcdmain: Go Version: go1.12.122021-01-29 17:41:55.207354 I | etcdmain: Go OS/Arch: linux/amd642021-01-29 17:41:55.207357 I | etcdmain: setting maximum number of CPUs to 1, total number of available CPUs is 12021-01-29 17:41:55.320869 N | etcdmain: the server is already initialized as member before, starting as etcd member...[WARNING] Deprecated '--logger=capnslog' flag is set; use '--logger=zap' flag instead2021-01-29 17:41:55.322074 C | etcdmain: listen tcp 192.168.56.101:2380: bind: address already in use

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; å‘½ä»¤æ²¡æœ‰é—®é¢˜ï¼Œä»æŠ¥é”™æ¥çœ‹ï¼Œè¯·æ£€æŸ¥è¿›ç¨‹æ²¡æœ‰æ¸…ç†å¹²å‡€ã€‚

##### **ç”Ÿï¼š
> å¤šæ•°æ˜¯å†…å¤–éƒ¨ç½²çš„ï¼Œä½¿ç”¨ä¸äº†å…¬å…±æœåŠ¡

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; å†…ç½‘éƒ¨ç½²çš„è¯ï¼Œå¯ä»¥è€ƒè™‘å…¶ä»–æœåŠ¡å‘ç°çš„æ–¹æ¡ˆã€‚

##### **å¼ºï¼š
> docker å®¹å™¨å®‰è£…ä¼šå°†etcdçš„ç«¯å£æš´éœ²å‡ºæ¥ï¼Œè¿™æ˜¯ä¸ªå¼Šç«¯ï¼Ÿæ€ä¹ˆè¯´ã€‚

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; è¿™ä¸ªæš´éœ²æ˜¯æœ‰èŒƒå›´çš„ï¼ŒæœåŠ¡ç«¯çš„ç‰©ç†æœºè¿˜ä¼šæœ‰å®‰å…¨è®¿é—®æªæ–½ã€‚

##### **é£ï¼š
> etcd --name etcd1 --initial-advertise-peer-urls http://192.168.56.101:2380 \ --listen-peer-urls http://192.168.56.101:2380 \ --data-dir /opt/etcd/data \ --listen-client-urls http://192.168.56.101:2379,http://127.0.0.1:2379 \ --advertise-client-urls http://192.168.56.101:2379 \ --discovery https://discovery.etcd.io/79867d2514b575e8ad2d0362f62fc50bè€å¸ˆå¥½ï¼Œè¿è¡ŒæŠ¥é”™ï¼Œæ€æ‰è¿›ç¨‹é‡æ¥è¿˜æ˜¯ä¸€æ ·ï¼Œè¯·é—®å¦‚ä½•è§£å†³ï¼Ÿ[WARNING] Deprecated '--logger=capnslog' flag is set; use '--logger=zap' flag instead2021-01-29 17:41:55.205259 I | etcdmain: etcd Version: 3.4.42021-01-29 17:41:55.207348 I | etcdmain: Git SHA: c65a9e2dd2021-01-29 17:41:55.207351 I | etcdmain: Go Version: go1.12.122021-01-29 17:41:55.207354 I | etcdmain: Go OS/Arch: linux/amd642021-01-29 17:41:55.207357 I | etcdmain: setting maximum number of CPUs to 1, total number of available CPUs is 12021-01-29 17:41:55.320869 N | etcdmain: the server is already initialized as member before, starting as etcd member...[WARNING] Deprecated '--logger=capnslog' flag is set; use '--logger=zap' flag instead2021-01-29 17:41:55.322074 C | etcdmain: listen tcp 192.168.56.101:2380: bind: address already in use

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; å‘½ä»¤æ²¡æœ‰é—®é¢˜ï¼Œä»æŠ¥é”™æ¥çœ‹ï¼Œè¯·æ£€æŸ¥è¿›ç¨‹æ²¡æœ‰æ¸…ç†å¹²å‡€ã€‚

##### **å­¦ï¼š
> etcd community meetinghttps://docs.google.com/document/d/16XEGyPBisZvmmoIHSZzv__LoyOeluC5a4x353CX0SIM/edit#ç¤¾åŒºæœˆæŠ¥ä»¥åŠå½•å±ï¼Œscrum master æ˜¯ä¸ªæ¼‚äº®å°å§å§

##### **é¸¿ï¼š
> å¿«å¿«æ›´æ–°ï¼ğŸ˜‚

 ###### &nbsp;&nbsp;&nbsp; ç¼–è¾‘å›å¤ï¼š
> &nbsp;&nbsp;&nbsp; æ¯å‘¨2/5æ›´æ–°ï¼Œå°ç¼–æ­£åœ¨æ‘©æ‹³æ“¦æŒå‡†å¤‡å‘¢~


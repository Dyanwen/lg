<p data-nodeid="198521">æˆ‘ä»¬çŸ¥é“æ•´ä¸ª SQL è§£æå¼•æ“å¯ä»¥åˆ†æˆä¸‰ä¸ªé˜¶æ®µï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼Œä¸Šä¸€è¯¾æ—¶æˆ‘ä»¬ä¸»è¦ä»‹ç»äº† ShardingSphere ä¸­ SQL è§£æå¼•æ“çš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œé‚£ä¹ˆä»Šå¤©æˆ‘å°†æ‰¿æ¥ä¸Šä¸€è¯¾æ—¶ï¼Œç»§ç»­è®²è§£ ShardingSphere ä¸­ SQL è§£ææµç¨‹ä¸­å‰©ä½™çš„ä¸¤ä¸ªé˜¶æ®µã€‚</p>
<p data-nodeid="198927"><img src="https://s0.lgstatic.com/i/image/M00/3E/39/Ciqc1F8ry7-AWFaOAACKmUmdLPs289.png" alt="Drawing 0.png" data-nodeid="198930"></p>








<h3 data-nodeid="197111">SQL è§£æå¼•æ“çš„ä¸‰å¤§é˜¶æ®µ</h3>
<p data-nodeid="197112">åœ¨ SQL è§£æå¼•æ“çš„ç¬¬ä¸€é˜¶æ®µä¸­ï¼Œæˆ‘ä»¬è¯¦ç»†ä»‹ç»äº† ShardingSphere ç”Ÿæˆ SQL æŠ½è±¡è¯­æ³•æ ‘çš„è¿‡ç¨‹ï¼Œå¹¶å¼•å‡ºäº† SQLStatementRule è§„åˆ™ç±»ã€‚ä»Šå¤©æˆ‘ä»¬å°†åŸºäºè¿™ä¸ªè§„åˆ™ç±»æ¥åˆ†æå¦‚ä½•æå– SQLSegment ä»¥åŠå¦‚ä½•å¡«å…… SQL è¯­å¥çš„å®ç°æœºåˆ¶ã€‚</p>
<h4 data-nodeid="197113">1.ç¬¬äºŒé˜¶æ®µï¼šæå– SQL ç‰‡æ®µ</h4>
<p data-nodeid="197114">è¦ç†è§£ SQLStatementRuleï¼Œå°±éœ€è¦å…ˆä»‹ç» ParseRuleRegistry ç±»ã€‚ä»å‘½åä¸Šçœ‹ï¼Œè¯¥ç±»å°±æ˜¯ä¸€ä¸ªè§„åˆ™æ³¨å†Œè¡¨ï¼Œä¿å­˜ç€å„ç§è§£æè§„åˆ™ä¿¡æ¯ã€‚ParseRuleRegistry ç±»ä¸­çš„æ ¸å¿ƒå˜é‡åŒ…æ‹¬å¦‚ä¸‹æ‰€ç¤ºçš„ä¸‰ä¸ª Loader ç±»ï¼š</p>
<pre class="lang-java" data-nodeid="197115"><code data-language="java">	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExtractorRuleDefinitionEntityLoader extractorRuleLoader = <span class="hljs-keyword">new</span> ExtractorRuleDefinitionEntityLoader(); 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> FillerRuleDefinitionEntityLoader fillerRuleLoader = <span class="hljs-keyword">new</span> FillerRuleDefinitionEntityLoader(); 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SQLStatementRuleDefinitionEntityLoader statementRuleLoader = <span class="hljs-keyword">new</span> SQLStatementRuleDefinitionEntityLoader(); 
</code></pre>
<p data-nodeid="197116">ä»å‘½åä¸Šå¯ä»¥çœ‹åˆ°è¿™ä¸‰ä¸ª Loader ç±»åˆ†åˆ«å¤„ç†å¯¹ SQLStatementRuleã€ExtractorRule å’Œ FillerRule è¿™ä¸‰ç§è§„åˆ™å®šä¹‰çš„åŠ è½½ã€‚</p>
<p data-nodeid="197117">æˆ‘ä»¬å…ˆæ¥çœ‹ SQLStatementRuleï¼Œå®ƒä»¬çš„å®šä¹‰ä½äº sql-statement-rule-definition.xml é…ç½®æ–‡ä»¶ä¸­ã€‚æˆ‘ä»¬ä»¥ Mysql ä¸ºä¾‹ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶ä½äº shardingsphere-sql-parser-mysql å·¥ç¨‹ä¸­çš„ META-INF/parsing-rule-definition/mysql ç›®å½•ä¸‹ã€‚æˆ‘ä»¬æˆªå–è¯¥é…ç½®æ–‡ä»¶ä¸­çš„éƒ¨åˆ†é…ç½®ä¿¡æ¯ä½œä¸ºæ¼”ç¤ºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-xml" data-nodeid="197118"><code data-language="xml"><span class="hljs-tag">&lt;<span class="hljs-name">sql-statement-rule-definition</span>&gt;</span> 
&nbsp;&nbsp;&nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">sql-statement-rule</span> <span class="hljs-attr">context</span>=<span class="hljs-string">"select"</span> <span class="hljs-attr">sql-statement-class</span>=<span class="hljs-string">"org.apache.shardingsphere.sql.parser.sql.statement.dml.SelectStatement"</span> <span class="hljs-attr">extractor-rule-refs</span>=<span class="hljs-string">"tableReferences, columns, selectItems, where, predicate, groupBy, orderBy, limit, subqueryPredicate, lock"</span> /&gt;</span> 
&nbsp;&nbsp;&nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">sql-statement-rule</span> <span class="hljs-attr">context</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">sql-statement-class</span>=<span class="hljs-string">"org.apache.shardingsphere.sql.parser.sql.statement.dml.InsertStatement"</span> <span class="hljs-attr">extractor-rule-refs</span>=<span class="hljs-string">"table, columns, insertColumns, insertValues, setAssignments, onDuplicateKeyColumns"</span> /&gt;</span> 
&nbsp;&nbsp;&nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">sql-statement-rule</span> <span class="hljs-attr">context</span>=<span class="hljs-string">"update"</span> <span class="hljs-attr">sql-statement-class</span>=<span class="hljs-string">"org.apache.shardingsphere.sql.parser.sql.statement.dml.UpdateStatement"</span> <span class="hljs-attr">extractor-rule-refs</span>=<span class="hljs-string">"tableReferences, columns, setAssignments, where, predicate"</span> /&gt;</span> 
&nbsp;&nbsp;&nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">sql-statement-rule</span> <span class="hljs-attr">context</span>=<span class="hljs-string">"delete"</span> <span class="hljs-attr">sql-statement-class</span>=<span class="hljs-string">"org.apache.shardingsphere.sql.parser.sql.statement.dml.DeleteStatement"</span> <span class="hljs-attr">extractor-rule-refs</span>=<span class="hljs-string">"tables, columns, where, predicate"</span> /&gt;</span> 
â€¦ 
<span class="hljs-tag">&lt;/<span class="hljs-name">sql-statement-rule-definition</span>&gt;</span> 
</code></pre>
<p data-nodeid="199703">åŸºäº ParseRuleRegistry ç±»è¿›è¡Œè§„åˆ™è·å–å’Œå¤„ç†è¿‡ç¨‹ï¼Œæ¶‰åŠä¸€å¤§æ‰¹å®ä½“å¯¹è±¡ä»¥åŠç”¨äºè§£æ XML é…ç½®æ–‡ä»¶çš„ JAXB å·¥å…·ç±»çš„å®šä¹‰ï¼Œå†…å®¹è™½å¤šä½†å¹¶ä¸å¤æ‚ã€‚æ ¸å¿ƒç±»ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p data-nodeid="200487"><img src="https://s0.lgstatic.com/i/image/M00/3E/3A/Ciqc1F8ry9CAPtDdAACEYYKrCTU070.png" alt="Drawing 2.png" data-nodeid="200491"></p>
<div data-nodeid="200876" class=""><p style="text-align:center">ParseRuleRegistry ç±»å±‚ç»“æ„å›¾</p> </div>







<p data-nodeid="197123">å½“è·å–è§„åˆ™ä¹‹åï¼Œå¯¹äºå…·ä½“æŸç§æ•°æ®åº“ç±»å‹çš„æ¯æ¡ SQL è€Œè¨€ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ª SQLStatementRule å¯¹è±¡ã€‚æˆ‘ä»¬æ³¨æ„åˆ°æ¯ä¸ª SQLStatementRule éƒ½å®šä¹‰äº†ä¸€ä¸ªâ€œcontextâ€ä»¥åŠä¸€ä¸ªâ€œsql-statement-classâ€ã€‚</p>
<p data-nodeid="197124">è¿™é‡Œçš„ context å®é™…ä¸Šå°±æ˜¯é€šè¿‡ SQL è§£ææ‰€ç”Ÿæˆçš„æŠ½è±¡è¯­æ³•æ ‘ SQLAST ä¸­çš„ ParserRuleContextï¼ŒåŒ…æ‹¬ CreateTableContextã€SelectContext ç­‰å„ç§ StatementContextã€‚è€Œé’ˆå¯¹æ¯ä¸€ç§ contextï¼Œéƒ½æœ‰ä¸“é—¨çš„ä¸€ä¸ª SQLStatement å¯¹è±¡ä¸ä¹‹å¯¹åº”ï¼Œé‚£ä¹ˆè¿™ä¸ª SQLStatement ç©¶ç«Ÿé•¿ä»€ä¹ˆæ ·å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ã€‚</p>
<pre class="lang-java" data-nodeid="197125"><code data-language="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SQLStatement</span> </span>{ 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//è·å–å‚æ•°ä¸ªæ•° </span>
&nbsp;&nbsp;&nbsp; <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">getParametersCount</span><span class="hljs-params">()</span></span>; 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//è·å–æ‰€æœ‰SQLSegment </span>
&nbsp;&nbsp;&nbsp; <span class="hljs-function">Collection&lt;SQLSegment&gt; <span class="hljs-title">getAllSQLSegments</span><span class="hljs-params">()</span></span>; 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//æ ¹æ®ç±»å‹è·å–ä¸€ä¸ªSQLSegment </span>
&nbsp;&nbsp;&nbsp; &lt;T extends SQLSegment&gt; <span class="hljs-function">Optional&lt;T&gt; <span class="hljs-title">findSQLSegment</span><span class="hljs-params">(Class&lt;T&gt; sqlSegmentType)</span></span>; 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//æ ¹æ®ç±»å‹è·å–ä¸€ç»„SQLSegment </span>
&nbsp;&nbsp;&nbsp; &lt;T extends SQLSegment&gt; <span class="hljs-function">Collection&lt;T&gt; <span class="hljs-title">findSQLSegments</span><span class="hljs-params">(Class&lt;T&gt; sqlSegmentType)</span></span>; 
} 
</code></pre>
<p data-nodeid="197126">ä½ å¯ä»¥çœ‹åˆ°ï¼Œä½œä¸ºè§£æå¼•æ“æœ€ç»ˆäº§ç‰©çš„ SQLStatement ï¼Œå®é™…ä¸Šå°è£…çš„æ˜¯å¯¹ SQL ç‰‡æ®µå¯¹è±¡ SQLSegment çš„è·å–æ“ä½œã€‚æ˜¾ç„¶ï¼Œå¯¹äºæ¯ä¸€ä¸ª ParserRuleContext è€Œè¨€ï¼Œæˆ‘ä»¬æœ€ç»ˆå°±æ˜¯æ„å»ºäº†ä¸€ä¸ªåŒ…å«ä¸€ç»„ SQLSegment çš„ SQLStatement å¯¹è±¡ï¼Œè€Œè¿™äº› SQLSegment çš„æ„å»ºè¿‡ç¨‹å°±æ˜¯æ‰€è°“çš„æå– SQLSegment çš„è¿‡ç¨‹ã€‚æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­ä¹Ÿæ˜ç¡®çœ‹åˆ°äº† SQLStatementRule ä¸­å¯¹å„ç§æå–è§„åˆ™å¯¹è±¡ ExtractorRule çš„å¼•ç”¨ã€‚</p>
<p data-nodeid="197127">åœ¨ ShardingSphere ä¸­å†…ç½®äº†ä¸€å¤§æ‰¹é€šç”¨çš„ SQLSegmentï¼ŒåŒ…æ‹¬æŸ¥è¯¢é€‰æ‹©é¡¹ï¼ˆSelectItemsï¼‰ã€è¡¨ä¿¡æ¯ï¼ˆTableï¼‰ã€æ’åºä¿¡æ¯ï¼ˆOrderByï¼‰ã€åˆ†ç»„ä¿¡æ¯ï¼ˆGroupByï¼‰ä»¥åŠåˆ†é¡µä¿¡æ¯ï¼ˆLimitï¼‰ç­‰ã€‚è¿™äº›é€šç”¨ SQLSegment éƒ½æœ‰å¯¹åº”çš„ SQLSegmentExtractorï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ SQLStatementRule ä¸­è¿›è¡Œä½¿ç”¨ã€‚</p>
<p data-nodeid="197128">å¦ä¸€æ–¹é¢ï¼Œè€ƒè™‘åˆ° SQL æ–¹è¨€çš„å·®å¼‚æ€§ï¼ŒShardingSphere åŒæ ·æä¾›äº†é’ˆå¯¹å„ç§æ•°æ®åº“çš„ SQLSegment çš„æå–å™¨å®šä¹‰ã€‚ä»¥ Mysql ä¸ºä¾‹ï¼Œåœ¨å…¶ä»£ç å·¥ç¨‹çš„ META-INF/parsing-rule-definition/mysql ç›®å½•ä¸‹ï¼Œå­˜åœ¨ä¸€ä¸ª extractor-rule-definition.xml é…ç½®æ–‡ä»¶ï¼Œä¸“é—¨ç”¨æ¥å®šä¹‰é’ˆå¯¹ Mysql çš„å„ç§ SQLSegmentExtractorï¼Œéƒ¨åˆ†å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼Œä½œä¸ºä¸€æ¬¾é€‚ç”¨äºå¤šæ•°æ®åº“çš„ä¸­é—´ä»¶ï¼Œè¿™ä¹Ÿæ˜¯ ShardingSphere åº”å¯¹ SQL æ–¹è¨€çš„å®ç°æœºåˆ¶ä¹‹ä¸€ã€‚</p>
<pre class="lang-xml" data-nodeid="197129"><code data-language="xml"><span class="hljs-tag">&lt;<span class="hljs-name">extractor-rule-definition</span>&gt;</span> 
&nbsp;&nbsp;&nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">extractor-rule</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"addColumnDefinition"</span> <span class="hljs-attr">extractor-class</span>=<span class="hljs-string">"org.apache.shardingsphere.sql.parser.core.extractor.ddl.MySQLAddColumnDefinitionExtractor"</span> /&gt;</span> 
&nbsp;&nbsp;&nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">extractor-rule</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"modifyColumnDefinition"</span> <span class="hljs-attr">extractor-class</span>=<span class="hljs-string">"org.apache.shardingsphere.sql.parser.core.extractor.ddl.MySQLModifyColumnDefinitionExtractor"</span> /&gt;</span> 
&nbsp;&nbsp;&nbsp; â€¦ 
<span class="hljs-tag">&lt;/<span class="hljs-name">extractor-rule-definition</span>&gt;</span> 
</code></pre>
<p data-nodeid="197130">ç°åœ¨ï¼Œå‡è®¾æœ‰è¿™æ ·ä¸€å¥ SQLï¼š</p>
<pre class="lang-sql" data-nodeid="197131"><code data-language="sql"><span class="hljs-keyword">SELECT</span> task_id, task_name <span class="hljs-keyword">FROM</span> health_task <span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-string">'user1'</span> <span class="hljs-keyword">AND</span> record_id = <span class="hljs-number">2</span>  
</code></pre>
<p data-nodeid="202007">é€šè¿‡è§£æï¼Œæˆ‘ä»¬è·å–äº†å¦‚ä¸‹æ‰€ç¤ºçš„æŠ½è±¡è¯­æ³•æ ‘ï¼š</p>
<p data-nodeid="202776"><img src="https://s0.lgstatic.com/i/image/M00/3E/3A/Ciqc1F8ry_WAEwAzAACKQ3CnEFw961.png" alt="Drawing 4.png" data-nodeid="202780"></p>
<div data-nodeid="202777" class=""><p style="text-align:center">æŠ½è±¡è¯­æ³•æ ‘ç¤ºæ„å›¾</p> </div>
<p></p>










<p data-nodeid="197136">æˆ‘ä»¬å‘ç°ï¼Œå¯¹äºä¸Šè¿°æŠ½è±¡è¯­æ³•æ ‘ä¸­çš„æŸäº›èŠ‚ç‚¹ï¼ˆå¦‚ SELECTã€FROM å’Œ WHEREï¼‰æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œè€Œå¯¹äºå¦‚ FIELDSã€TABLES å’Œ CONDITIONS èŠ‚ç‚¹è€Œè¨€ï¼Œæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ã€‚æ˜¾ç„¶ï¼Œè¿™ä¸¤ç§èŠ‚ç‚¹çš„æå–è§„åˆ™åº”è¯¥æ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<p data-nodeid="197137">å› æ­¤ï¼ŒShardingSphere æä¾›äº†ä¸¤ç§ SQLSegmentExtractorï¼Œä¸€ç§æ˜¯é’ˆå¯¹å•èŠ‚ç‚¹çš„ OptionalSQLSegmentExtractorï¼›å¦ä¸€ç§æ˜¯é’ˆå¯¹æ ‘çŠ¶èŠ‚ç‚¹çš„ CollectionSQLSegmentExtractorã€‚ç”±äºç¯‡å¹…å› ç´ ï¼Œè¿™é‡Œä»¥ TableExtractor ä¸ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•æå– TableSegment çš„è¿‡ç¨‹ï¼ŒTableExtractor çš„å®ç°æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="197138"><code data-language="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TableExtractor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OptionalSQLSegmentExtractor</span> </span>{ 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-meta">@Override</span> 
&nbsp;&nbsp;&nbsp; <span class="hljs-function"><span class="hljs-keyword">public</span> Optional&lt;TableSegment&gt; <span class="hljs-title">extract</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ParserRuleContext ancestorNode, <span class="hljs-keyword">final</span> Map&lt;ParserRuleContext, Integer&gt; parameterMarkerIndexes)</span> </span>{ 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//ä»Contextä¸­è·å–TableNameèŠ‚ç‚¹ </span>
&nbsp;&nbsp;&nbsp;  Optional&lt;ParserRuleContext&gt; tableNameNode = ExtractorUtils.findFirstChildNode(ancestorNode, RuleName.TABLE_NAME); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">if</span> (!tableNameNode.isPresent()) { 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">return</span> Optional.absent(); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//æ ¹æ®TableNameèŠ‚ç‚¹æ„å»ºTableSegment </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TableSegment result = getTableSegment(tableNameNode.get()); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//è®¾ç½®è¡¨çš„åˆ«å </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setAlias(tableNameNode.get(), result); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">return</span> Optional.of(result); 
&nbsp;&nbsp;&nbsp; } 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-function"><span class="hljs-keyword">private</span> TableSegment <span class="hljs-title">getTableSegment</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ParserRuleContext tableNode)</span> </span>{ 
&nbsp;&nbsp;&nbsp;  <span class="hljs-comment">//ä»Contextä¸­è·å–NameèŠ‚ç‚¹&nbsp;&nbsp;&nbsp; &nbsp;  </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ParserRuleContext nameNode = ExtractorUtils.getFirstChildNode(tableNode, RuleName.NAME); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//æ ¹æ®NameèŠ‚ç‚¹è·å–èŠ‚ç‚¹çš„èµ·æ­¢ä½ç½®ä»¥åŠèŠ‚ç‚¹å†…å®¹ </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TableSegment result = <span class="hljs-keyword">new</span> TableSegment(nameNode.getStart().getStartIndex(), nameNode.getStop().getStopIndex(), nameNode.getText()); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//ä»Contextä¸­è·å–è¡¨çš„OwnerèŠ‚ç‚¹ï¼Œå¦‚æœæœ‰çš„è¯å°±è®¾ç½®Owner </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Optional&lt;ParserRuleContext&gt; ownerNode = ExtractorUtils.findFirstChildNodeNoneRecursive(tableNode, RuleName.OWNER); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">if</span> (ownerNode.isPresent()) { 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result.setOwner(<span class="hljs-keyword">new</span> SchemaSegment(ownerNode.get().getStart().getStartIndex(), ownerNode.get().getStop().getStopIndex(), ownerNode.get().getText())); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">return</span> result; 
&nbsp;&nbsp;&nbsp; } 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAlias</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ParserRuleContext tableNameNode, <span class="hljs-keyword">final</span> TableSegment tableSegment)</span> </span>{ 
&nbsp;&nbsp;&nbsp;  <span class="hljs-comment">//ä»Contextä¸­è·å–AliasèŠ‚ç‚¹ï¼Œå¦‚æœæœ‰çš„è¯å°±è®¾ç½®åˆ«å </span>
&nbsp;&nbsp;&nbsp;  Optional&lt;ParserRuleContext&gt; aliasNode = ExtractorUtils.findFirstChildNode(tableNameNode.getParent(), RuleName.ALIAS); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">if</span> (aliasNode.isPresent()) { 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tableSegment.setAlias(aliasNode.get().getText()); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } 
&nbsp;&nbsp;&nbsp; } 
} 
</code></pre>
<p data-nodeid="197139">æ˜¾ç„¶ï¼Œè¯­æ³•æ ‘ä¸­çš„ Table æ˜¯ä¸€ç§å•èŠ‚ç‚¹ï¼Œæ‰€ä»¥ TableExtractor ç»§æ‰¿è‡ª OptionalSQLSegmentExtractorã€‚å¯¹äº TableExtractor è€Œè¨€ï¼Œæ•´ä¸ªè§£æè¿‡ç¨‹å°±æ˜¯ä» ParserRuleContext ä¸­è·å–ä¸è¡¨å®šä¹‰ç›¸å…³çš„å„ç§èŠ‚ç‚¹ï¼Œç„¶åé€šè¿‡èŠ‚ç‚¹çš„èµ·æ­¢ä½ç½®ä»¥åŠèŠ‚ç‚¹å†…å®¹æ¥æ„å»º TableSegment å¯¹è±¡ã€‚TableSegment å®ç°äº† SQLSegmentï¼Œå…¶æ ¸å¿ƒå˜é‡çš„å®šä¹‰ä¹Ÿæ¯”è¾ƒæ˜ç¡®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="197140"><code data-language="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TableSegment</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SQLSegment</span>, <span class="hljs-title">TableAvailable</span>, <span class="hljs-title">OwnerAvailable</span>&lt;<span class="hljs-title">SchemaSegment</span>&gt;, <span class="hljs-title">AliasAvailable</span> </span>{ 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> startIndex;&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> stopIndex;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;  
&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> QuoteCharacter quoteCharacter; 
&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">private</span> SchemaSegment owner;  
	<span class="hljs-keyword">private</span> String alias; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â€¦ 
} 
</code></pre>
<p data-nodeid="197141">ç°åœ¨ï¼ŒåŸºäºä»¥ä¸Šå…³äºæå–å™¨ä»¥åŠæå–æ“ä½œçš„ç›¸å…³æ¦‚å¿µçš„ç†è§£ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ SQLSegment æå–å¼•æ“ SQLSegmentsExtractorEngine çš„å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="197142"><code data-language="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SQLSegmentsExtractorEngine</span> </span>{ 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//ç”¨æ¥æå–SQLASTè¯­æ³•æ ‘ä¸­çš„SQLç‰‡æ®µ </span>
&nbsp;&nbsp;&nbsp; <span class="hljs-function"><span class="hljs-keyword">public</span> Collection&lt;SQLSegment&gt; <span class="hljs-title">extract</span><span class="hljs-params">(<span class="hljs-keyword">final</span> SQLAST ast)</span> </span>{ 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Collection&lt;SQLSegment&gt; result = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;(); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//éå†æå–å™¨ï¼Œä»Contextä¸­æå–å¯¹åº”ç±»å‹çš„SQLSegmentï¼Œæ¯”å¦‚TableSegment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">for</span> (SQLSegmentExtractor each : ast.getSqlStatementRule().getExtractors()) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//å•èŠ‚ç‚¹çš„åœºæ™¯ï¼Œç›´æ¥æå–å•ä¸€èŠ‚ç‚¹ä¸‹çš„å†…å®¹ </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">if</span> (each <span class="hljs-keyword">instanceof</span> OptionalSQLSegmentExtractor) { 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Optional&lt;? extends SQLSegment&gt; sqlSegment = ((OptionalSQLSegmentExtractor) each).extract(ast.getParserRuleContext(), ast.getParameterMarkerIndexes()); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">if</span> (sqlSegment.isPresent()) { 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result.add(sqlSegment.get()); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æ ‘çŠ¶èŠ‚ç‚¹çš„åœºæ™¯ï¼Œéå†æå–èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹<span class="hljs-comment">// </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (each <span class="hljs-keyword">instanceof</span> CollectionSQLSegmentExtractor) { 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result.addAll(((CollectionSQLSegmentExtractor) each).extract(ast.getParserRuleContext(), ast.getParameterMarkerIndexes())); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">return</span> result; 
&nbsp;&nbsp;&nbsp; } 
} 
</code></pre>
<p data-nodeid="197143">æ˜¾ç„¶ï¼ŒSQLSegmentsExtractorEngine çš„ä½œç”¨å°±æ˜¯é’ˆå¯¹æŸä¸€æ¡ SQLï¼Œéå† SQLStatementRule ä¸­æ‰€é…ç½®çš„æå–å™¨ï¼Œç„¶åä» Context ä¸­æå–å¯¹åº”ç±»å‹çš„ SQLSegmentï¼Œå¹¶æœ€ç»ˆå­˜æ”¾åœ¨ä¸€ä¸ªé›†åˆå¯¹è±¡ä¸­è¿›è¡Œè¿”å›ã€‚</p>
<h4 data-nodeid="197144">2.ç¬¬ä¸‰é˜¶æ®µï¼šå¡«å…… SQL è¯­å¥</h4>
<p data-nodeid="197145">å®Œæˆæ‰€æœ‰ SQLSegment çš„æå–ä¹‹åï¼Œæˆ‘ä»¬å°±æ¥åˆ°äº†è§£æå¼•æ“çš„æœ€åä¸€ä¸ªé˜¶æ®µï¼Œå³å¡«å…… SQLStatementã€‚æ‰€è°“çš„<strong data-nodeid="197238">å¡«å……è¿‡ç¨‹</strong>ï¼Œå°±æ˜¯é€šè¿‡å¡«å……å™¨ SQLSegmentFiller ä¸º SQLStatement æ³¨å…¥å…·ä½“ SQLSegment çš„è¿‡ç¨‹ã€‚è¿™ç‚¹ä» SQLSegmentFiller æ¥å£å®šä¹‰ä¸­çš„å„ä¸ªå‚æ•°å°±å¯ä»¥å¾—åˆ°æ˜ç¡®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="197146"><code data-language="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SQLSegmentFiller</span>&lt;<span class="hljs-title">T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SQLSegment</span>&gt; </span>{ 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">fill</span><span class="hljs-params">(T sqlSegment, SQLStatement sqlStatement)</span></span>; 
} 
</code></pre>
<p data-nodeid="197147">é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œæˆ‘ä»¬å¦‚ä½•æ­£ç¡®æŠŠæ¡ SQLSegmentFillerã€SQLSegment å’Œ SQLStatement è¿™ä¸‰è€…ä¹‹é—´çš„å¤„ç†å…³ç³»å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ ¹æ®æŸä¸ª SQLSegment æ‰¾åˆ°å¯¹åº”çš„ SQLSegmentFillerï¼Œè¿™éƒ¨åˆ†å…³ç³»åœ¨ ShardingSphere ä¸­åŒæ ·æ˜¯ç»´æŠ¤åœ¨ä¸€ä¸ª filler-rule-definition.xml é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆªå–éƒ¨åˆ†é…ç½®é¡¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-xml" data-nodeid="197148"><code data-language="xml"><span class="hljs-tag">&lt;<span class="hljs-name">filler-rule-definition</span>&gt;</span> 
&nbsp;&nbsp;&nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">filler-rule</span> <span class="hljs-attr">sql-segment-class</span>=<span class="hljs-string">"org.apache.shardingsphere.sql.parser.sql.segment.generic.TableSegment"</span> <span class="hljs-attr">filler-class</span>=<span class="hljs-string">"org.apache.shardingsphere.sql.parser.core.filler.impl.TableFiller"</span> /&gt;</span> 
&nbsp;&nbsp;&nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">filler-rule</span> <span class="hljs-attr">sql-segment-class</span>=<span class="hljs-string">"org.apache.shardingsphere.sql.parser.sql.segment.generic.SchemaSegment"</span> <span class="hljs-attr">filler-class</span>=<span class="hljs-string">"org.apache.shardingsphere.sql.parser.core.filler.impl.dal.SchemaFiller"</span> /&gt;</span> 
	â€¦ 
<span class="hljs-tag">&lt;/<span class="hljs-name">filler-rule-definition</span>&gt;</span> 
</code></pre>
<p data-nodeid="197149">æ˜¾ç„¶ï¼Œè¿™é‡Œä¿å­˜ç€ SQLSegment ä¸ SQLSegmentFiller ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚å½“ç„¶ï¼Œå¯¹äºä¸åŒçš„ SQL æ–¹è¨€ï¼Œä¹ŸåŒæ ·å¯ä»¥ç»´æŠ¤è‡ªèº«çš„ filler-rule-definition.xml æ–‡ä»¶ã€‚</p>
<p data-nodeid="197150">æˆ‘ä»¬è¿˜æ˜¯ä»¥ä¸ TableSegment å¯¹åº”çš„ TableFiller ä¸ºä¾‹ï¼Œæ¥åˆ†æä¸€ä¸ª SQLSegmentFiller çš„å…·ä½“å®ç°æ–¹æ³•ï¼ŒTableFiller ç±»å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="197151"><code data-language="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TableFiller</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SQLSegmentFiller</span>&lt;<span class="hljs-title">TableSegment</span>&gt; </span>{ 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-meta">@Override</span> 
&nbsp;&nbsp;&nbsp; <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">fill</span><span class="hljs-params">(<span class="hljs-keyword">final</span> TableSegment sqlSegment, <span class="hljs-keyword">final</span> SQLStatement sqlStatement)</span> </span>{ 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">if</span> (sqlStatement <span class="hljs-keyword">instanceof</span> TableSegmentAvailable) { 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((TableSegmentAvailable) sqlStatement).setTable(sqlSegment); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sqlStatement <span class="hljs-keyword">instanceof</span> TableSegmentsAvailable) { 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((TableSegmentsAvailable) sqlStatement).getTables().add(sqlSegment); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } 
&nbsp;&nbsp;&nbsp; } 
} 
</code></pre>
<p data-nodeid="203515">è¿™æ®µä»£ç åœ¨å®ç°ä¸Šé‡‡ç”¨äº†å›è°ƒæœºåˆ¶æ¥å®Œæˆå¯¹è±¡çš„æ³¨å…¥ã€‚åœ¨ ShardingSphere ä¸­ï¼ŒåŸºäºå›è°ƒçš„å¤„ç†æ–¹å¼ä¹Ÿéå¸¸æ™®éã€‚æœ¬è´¨ä¸Šï¼Œå›è°ƒè§£å†³äº†å› ä¸ºç±»ä¸ç±»ä¹‹é—´çš„ç›¸äº’è°ƒç”¨è€Œé€ æˆçš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œå›è°ƒçš„å®ç°ç­–ç•¥é€šå¸¸é‡‡ç”¨äº†å¦‚ä¸‹æ‰€ç¤ºçš„ç±»å±‚ç»“æ„ï¼š</p>
<p data-nodeid="203889"><img src="https://s0.lgstatic.com/i/image/M00/3E/3A/Ciqc1F8rzBeAL-gtAAAtxVTlOkM440.png" alt="Drawing 6.png" data-nodeid="203893"></p>
<div data-nodeid="204258" class=""><p style="text-align:center">å›è°ƒæœºåˆ¶ç¤ºæ„å›¾</p> </div>







<p data-nodeid="197156">TableFiller ä¸­æ‰€ä¾èµ–çš„ TableSegmentAvailable å’Œ TableSegmentsAvailable æ¥å£å°±ç±»ä¼¼äºä¸Šå›¾ä¸­çš„ Callback æ¥å£ï¼Œå…·ä½“çš„ SQLStatement å°±æ˜¯ Callback çš„å®ç°ç±»ï¼Œè€Œ TableFiller åˆ™æ˜¯ Callback çš„è°ƒç”¨è€…ã€‚ä»¥ TableFiller ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ï¼Œå¦‚æœå¯¹åº”çš„ SQLStatement å®ç°äº†è¿™ä¸¤ä¸ªæ¥å£ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ TableFiller æ³¨å…¥å¯¹åº”çš„ TableSegmentï¼Œä»è€Œå®Œæˆ SQLSegment çš„å¡«å……ã€‚</p>
<p data-nodeid="205710">è¿™é‡Œä»¥ TableSegmentAvailable æ¥å£ä¸ºä¾‹ï¼Œå®ƒæœ‰ä¸€ç»„å®ç°ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p data-nodeid="205711" class=""><img src="https://s0.lgstatic.com/i/image/M00/3E/45/CgqCHl8rzC2ADPHvAAAxxRKUUYw921.png" alt="Drawing 8.png" data-nodeid="205716"></p>
<div data-nodeid="205712"><p style="text-align:center">TableSegmentAvailableå®ç°ç±»</p> </div>




<p></p>

<p data-nodeid="197160">ä»¥ä¸Šå›¾ä¸­çš„ CreateTableStatement ä¸ºä¾‹ï¼Œè¯¥ç±»åŒæ—¶å®ç°äº† TableSegmentAvailable å’Œ IndexSegmentsAvailable è¿™ä¸¤ä¸ªå›è°ƒæ¥å£ï¼Œæ‰€ä»¥å°±å¯ä»¥åŒæ—¶æ“ä½œ TableSegment å’Œ IndexSegment è¿™ä¸¤ä¸ª SQLSegmentã€‚CreateTableStatement ç±»çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="197161"><code data-language="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateTableStatement</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DDLStatement</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">TableSegmentAvailable</span>, <span class="hljs-title">IndexSegmentsAvailable</span> </span>{ 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">private</span> TableSegment table; 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Collection&lt;ColumnDefinitionSegment&gt; columnDefinitions = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;(); 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Collection&lt;IndexSegment&gt; indexes = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;(); 
} 
</code></pre>
<p data-nodeid="206427">è‡³æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç¤ºä¾‹è§£é‡Šäº†ä¸å¡«å……æ“ä½œç›¸å…³çš„å„ä¸ªç±»ä¹‹é—´çš„åä½œå…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºçš„ç±»å›¾å±•ç¤ºäº†è¿™ç§åä½œå…³ç³»çš„æ•´ä½“ç»“æ„ã€‚</p>
<p data-nodeid="206789"><img src="https://s0.lgstatic.com/i/image/M00/3E/45/CgqCHl8rzDqAVtDCAAB-8xyeFnI893.png" alt="Drawing 9.png" data-nodeid="206793"></p>
<div data-nodeid="207146" class=""><p style="text-align:center">SQLStatementç±»å±‚ç»“æ„å›¾</p> </div>







<p data-nodeid="197166">æœ‰äº†ä¸Šå›¾çš„åŸºç¡€ï¼Œæˆ‘ä»¬ç†è§£å¡«å……å¼•æ“ SQLStatementFillerEngine å°±æ˜¾å¾—æ¯”è¾ƒç®€å•äº†ï¼ŒSQLStatementFillerEngine ç±»çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="197167"><code data-language="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SQLStatementFillerEngine</span> </span>{ 
&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ParseRuleRegistry parseRuleRegistry;&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String databaseTypeName; 
&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp; <span class="hljs-meta">@SuppressWarnings("unchecked")</span> 
&nbsp;&nbsp;&nbsp; <span class="hljs-meta">@SneakyThrows</span> 
&nbsp;&nbsp;&nbsp; <span class="hljs-function"><span class="hljs-keyword">public</span> SQLStatement <span class="hljs-title">fill</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Collection&lt;SQLSegment&gt; sqlSegments, <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> parameterMarkerCount, <span class="hljs-keyword">final</span> SQLStatementRule rule)</span> </span>{ 
&nbsp;&nbsp;&nbsp;  <span class="hljs-comment">//ä»SQLStatementRuleä¸­è·å–SQLStatementå®ä¾‹ï¼Œå¦‚CreateTableStatement </span>
&nbsp;&nbsp;&nbsp;  SQLStatement result = rule.getSqlStatementClass().newInstance(); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//é€šè¿‡æ–­è¨€å¯¹SQLStatementçš„åˆæ³•æ€§è¿›è¡Œæ ¡éªŒ </span>
&nbsp;&nbsp;&nbsp;  Preconditions.checkArgument(result <span class="hljs-keyword">instanceof</span> AbstractSQLStatement, <span class="hljs-string">"%s must extends AbstractSQLStatement"</span>, result.getClass().getName()); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//è®¾ç½®å‚æ•°ä¸ªæ•° </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((AbstractSQLStatement) result).setParametersCount(parameterMarkerCount); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//æ·»åŠ æ‰€æœ‰çš„SQLSegmentåˆ°SQLStatementä¸­ </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result.getAllSQLSegments().addAll(sqlSegments); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//éå†å¡«å……å¯¹åº”ç±»å‹çš„SQLSegment </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">for</span> (SQLSegment each : sqlSegments) { 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <span class="hljs-comment">//æ ¹æ®æ•°æ®åº“ç±»å‹å’ŒSQLSegmentæ‰¾åˆ°å¯¹åº”çš„SQLSegmentFillerï¼Œå¹¶ä¸ºSQLStatementå¡«å……SQLSegment </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-comment">//å¦‚é€šè¿‡TableSegmentæ‰¾åˆ°è·å–TableFillerï¼Œç„¶åé€šè¿‡TableFillerä¸ºCreateTableStatementå¡«å……TableSegment </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Optional&lt;SQLSegmentFiller&gt; filler = parseRuleRegistry.findSQLSegmentFiller(databaseTypeName, each.getClass()); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">if</span> (filler.isPresent()) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; <span class="hljs-comment">//åˆ©ç”¨SQLSegmentFilleræ¥å¡«å……SQLStatementä¸­çš„SQLSegment </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; filler.get().fill(each, result); 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-keyword">return</span> result; 
	}  
} 
</code></pre>
<p data-nodeid="197168">æˆ‘ä»¬å¯¹ SQLStatementFillerEngine ä¸­çš„æ ¸å¿ƒä»£ç éƒ½æ·»åŠ äº†æ³¨é‡Šï¼Œæ³¨æ„åˆ°è¿™é‡Œé€šè¿‡æ•°æ®åº“ç±»å‹ä»¥åŠ SQLSegment çš„ç±»å‹ï¼Œä»è§„åˆ™æ³¨å†Œè¡¨ ParseRuleRegistry ä¸­è·å–äº†å¯¹åº”çš„ SQLSegmentFiller å¹¶å®Œæˆå¯¹ SQLStatement çš„å¡«å……æ“ä½œã€‚</p>
<p data-nodeid="197169">è‡³æ­¤ï¼ŒShardingSphere ä¸­ SQL è§£æå¼•æ“çš„ä¸‰å¤§é˜¶æ®µä»‹ç»å®Œæ¯•ã€‚æˆ‘ä»¬å·²ç»è·å–äº†ç›®æ ‡ SQLStatementï¼Œä¸ºè¿›è¡Œåç»­çš„è·¯ç”±ç­‰æ“ä½œæä¾›äº†åŸºç¡€ã€‚</p>
<h3 data-nodeid="197170">ä»æºç è§£æåˆ°æ—¥å¸¸å¼€å‘</h3>
<p data-nodeid="197171">é€šè¿‡å¯¹æ¡†æ¶æºä»£ç çš„å­¦ä¹ ï¼Œä¸€æ–¹é¢å¯ä»¥å¸®å¿™æˆ‘ä»¬æ›´å¥½åœ°ç†è§£è¯¥æ¡†æ¶æ ¸å¿ƒåŠŸèƒ½èƒŒåçš„å®ç°åŸç†ï¼›å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¸æ”¶è¿™äº›ä¼˜ç§€æ¡†æ¶çš„è®¾è®¡æ€æƒ³å’Œå®ç°æ–¹æ³•ï¼Œä»è€Œæ›´å¥½åœ°æŒ‡å¯¼æ—¥å¸¸å¼€å‘å·¥ä½œã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬åŒæ ·æ€»ç»“äº†ä¸€ç»„è®¾è®¡å’Œå®ç°ä¸Šçš„æŠ€å·§ã€‚</p>
<h4 data-nodeid="197172">1.è®¾è®¡æ¨¡å¼çš„åº”ç”¨æ–¹å¼</h4>
<p data-nodeid="197173">åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦æ¶‰åŠäº†ä¸¤ç§è®¾è®¡æ¨¡å¼çš„åº”ç”¨åœºæ™¯ï¼Œä¸€ç§æ˜¯å·¥å‚æ¨¡å¼ï¼Œå¦ä¸€ç§æ˜¯å¤–è§‚æ¨¡å¼ã€‚</p>
<p data-nodeid="197174"><strong data-nodeid="197276">å·¥å‚æ¨¡å¼</strong>çš„åº”ç”¨æ¯”è¾ƒç®€å•ï¼Œä½œç”¨ä¹Ÿæ¯”è¾ƒç›´æ¥ã€‚ä¾‹å¦‚ï¼ŒSQLParseEngineFactory å·¥å‚ç±»ç”¨äºåˆ›å»º SQLParseEngineï¼Œè€Œ SQLParserFactory å·¥å‚ç±»ç”¨äºåˆ›å»º SQLParserã€‚</p>
<p data-nodeid="197175">ç›¸æ¯”å·¥å‚æ¨¡å¼ï¼Œ<strong data-nodeid="197282">å¤–è§‚ç±»</strong>é€šå¸¸æ¯”è¾ƒéš¾è¯†åˆ«å’ŒæŠŠæ¡ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä¹ŸèŠ±äº†ä¸€å®šç¯‡å¹…ä»‹ç»äº† SQL è§£æå¼•æ“ä¸­çš„å¤–è§‚ç±» SQLParseKernelï¼Œä»¥åŠä¸ SQLParseEngine ä¹‹é—´çš„å§”æ‰˜å…³ç³»ã€‚</p>
<h4 data-nodeid="197176">2.ç¼“å­˜çš„å®ç°æ–¹å¼</h4>
<p data-nodeid="197177">ç¼“å­˜åœ¨ ShardingSphere ä¸­åº”ç”¨éå¸¸å¹¿æ³›ï¼Œå…¶å®ç°æ–¹å¼ä¹Ÿæ¯”è¾ƒå¤šæ ·ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°±æ¥è§¦åˆ°äº†ä¸¤ç§ç¼“å­˜çš„å®ç°æ–¹å¼ã€‚</p>
<p data-nodeid="197178">ç¬¬ä¸€ç§æ˜¯é€šè¿‡ ConcurrentHashMap ç±»æ¥ä¿å­˜ SQLParseEngine çš„å®ä¾‹ï¼Œä½¿ç”¨ä¸Šæ¯”è¾ƒç®€å•ã€‚</p>
<p data-nodeid="197179">å¦ä¸€ç§åˆ™åŸºäº Guava æ¡†æ¶ä¸­çš„ Cache ç±»æ„å»ºäº†ä¸€ä¸ª SQLParseResultCache æ¥ä¿å­˜ SQLStatement å¯¹è±¡ã€‚Guava ä¸­çš„ Cache ç±»åˆå§‹åŒ–æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ put å’Œ getIfPresent ç­‰æ–¹æ³•å¯¹ç¼“å­˜è¿›è¡Œæ“ä½œï¼š</p>
<pre class="lang-java" data-nodeid="197180"><code data-language="java">Cache&lt;String, SQLStatement&gt; cache = CacheBuilder.newBuilder().softValues().initialCapacity(<span class="hljs-number">2000</span>).maximumSize(<span class="hljs-number">65535</span>).build();&nbsp;&nbsp;&nbsp;  
</code></pre>
<h4 data-nodeid="197181">3.é…ç½®ä¿¡æ¯çš„ä¸¤çº§ç®¡ç†æœºåˆ¶</h4>
<p data-nodeid="197182">åœ¨ ShardingSphere ä¸­ï¼Œå…³äºå„ç§æå–è§„åˆ™å’Œå¡«å……è§„åˆ™çš„å®šä¹‰éƒ½æ”¾åœ¨äº† XML é…ç½®æ–‡ä»¶ä¸­ï¼Œå¹¶é‡‡ç”¨äº†é…ç½®ä¿¡æ¯çš„ä¸¤çº§ç®¡ç†æœºåˆ¶ã€‚è¿™ç§<strong data-nodeid="197293">ä¸¤çº§ç®¡ç†æœºåˆ¶</strong>çš„è®¾è®¡æ€æƒ³åœ¨äºï¼Œç³»ç»Ÿåœ¨æä¾›äº†å¯¹å„ç§é€šç”¨è§„åˆ™é»˜è®¤å®ç°çš„åŒæ—¶ï¼Œä¹Ÿèƒ½å¤Ÿé›†æˆæ¥è‡ªå„ç§ SQL æ–¹è¨€çš„å®šåˆ¶åŒ–è§„åˆ™ï¼Œä»è€Œå½¢æˆä¸€å¥—å…·æœ‰è¾ƒé«˜çµæ´»æ€§ä»¥åŠå¯æ‰©å±•æ€§çš„è§„åˆ™ç®¡ç†ä½“ç³»ã€‚</p>
<h4 data-nodeid="197183">4.å›è°ƒæœºåˆ¶</h4>
<p data-nodeid="197184">æ‰€è°“<strong data-nodeid="197304">å›è°ƒ</strong>ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ç§<strong data-nodeid="197305">åŒå‘è°ƒç”¨æ¨¡å¼</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¢«è°ƒç”¨æ–¹åœ¨è¢«è°ƒç”¨çš„åŒæ—¶ä¹Ÿä¼šè°ƒç”¨å¯¹æ–¹ã€‚åœ¨å®ç°ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æå–ä¸€ä¸ªç”¨äºä¸šåŠ¡æ¥å£ä½œä¸ºä¸€ç§ Callback æ¥å£ï¼Œç„¶åè®©å…·ä½“çš„ä¸šåŠ¡å¯¹è±¡å»å®ç°è¿™ä¸ªæ¥å£ã€‚è¿™æ ·ï¼Œå½“å¤–éƒ¨å¯¹è±¡ä¾èµ–äºè¿™ä¸ªä¸šåŠ¡åœºæ™¯æ—¶ï¼Œåªéœ€è¦ä¾èµ–è¿™ä¸ª Callback æ¥å£ï¼Œè€Œä¸éœ€è¦å…³å¿ƒè¿™ä¸ªæ¥å£çš„å…·ä½“å®ç°ç±»ã€‚</p>
<p data-nodeid="197185">è¿™åœ¨è½¯ä»¶è®¾è®¡å’Œå®ç°è¿‡ç¨‹ä¸­æ˜¯ä¸€ç§å¸¸è§çš„æ¶ˆé™¤ä¸šåŠ¡å¯¹è±¡å’Œå¤–éƒ¨å¯¹è±¡ä¹‹é—´å¾ªç¯ä¾èµ–çš„å¤„ç†æ–¹å¼ã€‚ShardingSphere ä¸­å¤§é‡é‡‡ç”¨äº†è¿™ç§å®ç°æ–¹å¼æ¥ç¡®ä¿ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼Œè¿™éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚</p>
<h3 data-nodeid="197186">å°ç»“</h3>
<p data-nodeid="197187">ä½œä¸º ShardingSphere åˆ†ç‰‡å¼•æ“çš„ç¬¬ä¸€ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œè§£æå¼•æ“çš„ç›®çš„åœ¨äºç”Ÿæˆ SQLStatement ç›®æ ‡å¯¹è±¡ã€‚è€Œæ•´ä¸ªè§£æå¼•æ“åˆ†æˆä¸‰å¤§é˜¶æ®µï¼Œå³ç”Ÿæˆ SQL æŠ½è±¡è¯­æ³•æ ‘ã€æå– SQL ç‰‡æ®µä»¥åŠä½¿ç”¨è¿™äº›ç‰‡æ®µæ¥å¡«å…… SQL è¯­å¥ã€‚æœ¬æ–‡å¯¹è§£æå¼•æ“çš„æ•´ä½“ç»“æ„ä»¥åŠè¿™ä¸‰ä¸ªé˜¶æ®µè¿›è¡Œäº†è¯¦ç»†çš„è®¨è®ºã€‚</p>
<p data-nodeid="197188">æœ€åç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ï¼šç®€è¦ä»‹ç» ShardingSphere ä¸­ SQL è§£æçš„å„ä¸ªé˜¶æ®µçš„è¾“å…¥å’Œäº§å‡ºï¼Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸å¤§å®¶è®¨è®ºï¼Œæˆ‘å°†ä¸€ä¸€ç‚¹è¯„è§£ç­”ã€‚</p>
<p data-nodeid="197189">ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»è·å–äº† SQLStatementï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ç”¨æ¥æ‰§è¡Œ SQL è·¯ç”±æ“ä½œï¼Œè¿™å°±æ˜¯ä¸‹ä¸€è¯¾æ—¶å†…å®¹ã€‚</p>

---

### ç²¾é€‰è¯„è®º

##### **æŒ¯ï¼š
> çœ‹çš„æœ‰ç‚¹æ™•ğŸ˜²


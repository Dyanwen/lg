<p data-nodeid="1553" class="">在“自己动手用 Go 实现 Service Mesh”这个大的模块中，我会带你动手用 Go 语言实现一套简单的 Service Mesh 系统，以加强你对 Service Mesh 原理的掌握和理解。在编写代码之前，这一讲我们先来讲一下项目背景，包括为什么要进行自研、自研 Service Mesh 的优势、自研 Service Mesh 可以解决哪些问题，以及项目框架的初步搭建等内容。</p>
<p data-nodeid="1554">首先，我们先来看一下这个项目的背景。假定你所在的 B 公司目前已经初具规模，正在进行从单体服务到微服务的初步拆分，公司的主要语言为 Go 语言，同时存在 Python、Node.js、PHP 等多种语言。</p>
<h3 data-nodeid="1555">项目背景</h3>
<p data-nodeid="1556">公司的 X 项目目前已经初具规模，随着人员的扩张，从单体服务拆解到了多个子服务。但现在遇到了一些问题，急需解决方案。该项目目前面临如下困难。</p>
<ol data-nodeid="1557">
<li data-nodeid="1558">
<p data-nodeid="1559"><strong data-nodeid="1708">入口层缺乏统一的系统网关</strong>：多个服务同时对外暴露，无法进行统一的登录验证、加/解密等功能，只能在各个对外暴露的服务中单独实现，无法进行统一的维护。</p>
</li>
<li data-nodeid="1560">
<p data-nodeid="1561"><strong data-nodeid="1713">存在雪崩现象</strong>：某一个核心微服务出现故障后，导致级联故障，依赖的服务因为响应延时变高，都将出现故障，最终导致整站故障。</p>
</li>
<li data-nodeid="1562">
<p data-nodeid="1563"><strong data-nodeid="1718">无法处理突发流量</strong>：很多时候因为运营活动，前期没有配合提前扩容资源, 导致服务被突发流量打挂。</p>
</li>
<li data-nodeid="1564">
<p data-nodeid="1565"><strong data-nodeid="1723">内部通过内网集中网关调用</strong>：内部通过统一的网关调用，一旦内部集中网关出现问题，导致所有服务出现故障，继而引起整站故障。</p>
</li>
<li data-nodeid="1566">
<p data-nodeid="1567"><strong data-nodeid="1728">项目可观测性不足，问题排查困难</strong>：各个服务自己实现监控指标，没有统一的监控，随着服务数量增多，问题越来越难以排查。</p>
</li>
</ol>
<p data-nodeid="1568">鉴于以上多种问题，已经影响了线上 App 的稳定性，急需技术手段解决。</p>
<p data-nodeid="1569">下面我们针对上述问题，进行技术选型，调研以下几种解决方案，包括微服务框架、开源 Service Mesh 方案、自研 Service Mesh 方案。</p>
<p data-nodeid="1570">以下三种方案，通过服务治理的方式，都可以解决上述问题，其中<strong data-nodeid="1736">微服务框架需要再引入一个开源系统网关或者用框架实现聚合层</strong>。</p>
<h3 data-nodeid="1571">技术选型</h3>
<h4 data-nodeid="1572">微服务框架</h4>
<p data-nodeid="2403">微服务框架在 Web 框架的基础上，增加了服务治理、注册发现、可观测性、负载均衡、RPC 等多种功能，目的是提高微服务架构的稳定性。下面我们来看几种常见的框架选型。</p>
<p data-nodeid="3902" class="te-preview-highlight"><img src="https://s0.lgstatic.com/i/image6/M01/06/E3/CioPOWAy6ZiAYmbqAAGi7ecB2-s294.png" alt="222.png" data-nodeid="3905"></p>






<p data-nodeid="1593" class=""><strong data-nodeid="1797">优点</strong>：</p>
<ol data-nodeid="1594">
<li data-nodeid="1595">
<p data-nodeid="1596">通过服务发现的方式直接调用 upstream 服务，无须经过中间代理层，性能高；</p>
</li>
<li data-nodeid="1597">
<p data-nodeid="1598">微服务框架相对比较成熟。</p>
</li>
</ol>
<p data-nodeid="1599"><strong data-nodeid="1804">缺点</strong>：</p>
<ol data-nodeid="1600">
<li data-nodeid="1601">
<p data-nodeid="1602">框架维护升级成本高，微服务的拆分会导致服务数量非常多，一旦框架发布，后续升级几乎不可能完成；</p>
</li>
<li data-nodeid="1603">
<p data-nodeid="1604">旧服务接入困难，修改代码成本高；</p>
</li>
<li data-nodeid="1605">
<p data-nodeid="1606">语言相关，一般情况下只能维护一种语言的微服务框架，对于小众语言无法支持。</p>
</li>
</ol>
<p data-nodeid="1607"><strong data-nodeid="1812">总结</strong>：相对来说 Go 语言的微服务框架并不算丰富，更多框架还停留在 Web 方面，比如 Gin、Echo 都是出色的 Web 框架。如果是新项目，微服务框架 go-zero 是相对不错的选择。</p>
<h4 data-nodeid="1608">开源 Service Mesh 方案</h4>
<p data-nodeid="1609">开源 Service Mesh 方案，我们在<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=586#/detail/pc?id=6005" data-nodeid="1817">12</a><a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=586#/detail/pc?id=6005" data-nodeid="1820">讲“技术选型：在众多 Service Mesh 开源产品中选择合适自己的”</a>中，已经做了详细讲解，这里我们还是通过一张技术方案对比图做一个简单的回顾：</p>
<p data-nodeid="1610"><img src="https://s0.lgstatic.com/i/image6/M00/05/80/Cgp9HWAwy2yAL6ClAAHMvGtTFKU621.png" alt="Drawing 0.png" data-nodeid="1824"></p>
<p data-nodeid="1611">下面我们对开源 Service Mesh 方案的优缺点也做一个简单的总结。</p>
<p data-nodeid="1612"><strong data-nodeid="1830">优点</strong>：</p>
<ol data-nodeid="1613">
<li data-nodeid="1614">
<p data-nodeid="1615">相对于微服务框架，通过和业务架构解耦的方式，降低了升级维护的成本；</p>
</li>
<li data-nodeid="1616">
<p data-nodeid="1617">新旧服务接入同样简单，可以通过 iptables 网络劫持无感知方式接入，也可以通过修改少量代码支持；</p>
</li>
<li data-nodeid="1618">
<p data-nodeid="1619">语言无关性，公司的小众语言也可以很好地支持；</p>
</li>
<li data-nodeid="1620">
<p data-nodeid="1621">可以持续跟进社区方案，获得社区的最新成果；</p>
</li>
<li data-nodeid="1622">
<p data-nodeid="1623">项目启动快，不需要研发，只需要做好测试。</p>
</li>
</ol>
<p data-nodeid="1624"><strong data-nodeid="1840">缺点</strong>：</p>
<ol data-nodeid="1625">
<li data-nodeid="1626">
<p data-nodeid="1627">代码二次扩展难度比较大，需要特定的语言开发经验，公司个性化的需求无法满足；</p>
</li>
<li data-nodeid="1628">
<p data-nodeid="1629">开源软件往往版本变化比较大，向前兼容性比较差，如果想要维护升级，也需要对源码有一定的掌握，否则升级风险比较大。</p>
</li>
</ol>
<p data-nodeid="1630"><strong data-nodeid="1847">总结</strong>：开源 Service Mesh 方案最大的优势是和社区贴近，项目启动快，但也有二次扩展的瓶颈，难以满足公司的个性化需求。</p>
<h4 data-nodeid="1631">自研 Service Mesh 方案</h4>
<p data-nodeid="1632">自研 Service Mesh 方案分为两种，一种是数据面 Sidecar 和控制面全部自研，另外一种是使用开源数据面，但是自研或者二次开发控制面。</p>
<ul data-nodeid="1633">
<li data-nodeid="1634">
<p data-nodeid="1635"><strong data-nodeid="1853">完全自研</strong></p>
</li>
</ul>
<p data-nodeid="1636">我们先来看一下数据面和控制面完全自研的方案。</p>
<p data-nodeid="1637"><strong data-nodeid="1859">优点</strong>：</p>
<ol data-nodeid="1638">
<li data-nodeid="1639">
<p data-nodeid="1640">具备开源 Service Mesh 方案相对于微服务框架的优势；</p>
</li>
<li data-nodeid="1641">
<p data-nodeid="1642">可扩展性强，可以兼容公司运维环境，对于一些定制型需求，比如新的 RPC 协议支持、多协议服务治理、新的负载均衡支持等；</p>
</li>
<li data-nodeid="1643">
<p data-nodeid="1644">项目把控力强，出现问题可以快速解决。</p>
</li>
</ol>
<p data-nodeid="1645"><strong data-nodeid="1867">缺点</strong>：</p>
<ol data-nodeid="1646">
<li data-nodeid="1647">
<p data-nodeid="1648">研发成本高，需要一定的研发时间，上线灰度到稳定版本也需要时间，在灰度过程中可能会有 Bug 出现；</p>
</li>
<li data-nodeid="1649">
<p data-nodeid="1650">和社区有一定的割裂。</p>
</li>
</ol>
<ul data-nodeid="1651">
<li data-nodeid="1652">
<p data-nodeid="1653"><strong data-nodeid="1873">开源数据面+自研控制面</strong></p>
</li>
</ul>
<p data-nodeid="1654">因为公司运维环境的原因，直接使用<strong data-nodeid="1879">开源控制面方案基本上无法满足控制面个性的需求</strong>，比如第三方注册中心的支持、虚拟机环境的支持等。下面看一下这种方案的优缺点。</p>
<p data-nodeid="1655"><strong data-nodeid="1884">优点</strong>：</p>
<ol data-nodeid="1656">
<li data-nodeid="1657">
<p data-nodeid="1658">可以满足公司多样的运维环境；</p>
</li>
<li data-nodeid="1659">
<p data-nodeid="1660">控制面自研或者二次开发，有一定的定制性。</p>
</li>
</ol>
<p data-nodeid="1661"><strong data-nodeid="1891">缺点</strong>：</p>
<ol data-nodeid="1662">
<li data-nodeid="1663">
<p data-nodeid="1664">数据面 Sidecar 依然有开源方案的弊端。</p>
</li>
<li data-nodeid="1665">
<p data-nodeid="1666">首先于数据面无法定制，其次对于控制面能做的联动有一定的局限性。</p>
</li>
</ol>
<h4 data-nodeid="1667">最终选择</h4>
<p data-nodeid="1668">结合以上调研，最终我们决定选择数据面和控制面都自研的 Service Mesh 方案。相对于上述缺点，完全自研的方案可控性和可扩展性都很出色，对比微服务框架方案又有<strong data-nodeid="1900">维护升级成本低、兼容多种语言</strong>等优势。</p>
<p data-nodeid="1669">至此，我们的方案已经确定了。下面我们来看一下技术实现部分，具体包括数据面和控制面需要实现的功能点，以及技术选型，如何依靠开源社区的力量快速实现核心功能。</p>
<h3 data-nodeid="1670">技术实现</h3>
<p data-nodeid="1671">下面我们来看一下本次方案要实现的功能点，因为篇章有限，这里只讲解最核心的部分。具体的数据面和控制面的实现部分，接下来的两讲我们将详细展开。</p>
<h4 data-nodeid="1672">功能点</h4>
<p data-nodeid="1673"><strong data-nodeid="1909">数据面 Sidecar</strong>：</p>
<ol data-nodeid="1674">
<li data-nodeid="1675">
<p data-nodeid="1676">实现基础框架，能够代理 HTTP 协议，并具备扩展性；</p>
</li>
<li data-nodeid="1677">
<p data-nodeid="1678">支持限流、熔断等服务治理中间件；</p>
</li>
<li data-nodeid="1679">
<p data-nodeid="1680">支持可观测性组件，包括 Log、Trace 和 Metrics；</p>
</li>
<li data-nodeid="1681">
<p data-nodeid="1682">支持服务注册和发现，能够代理业务服务进行注册；</p>
</li>
<li data-nodeid="1683">
<p data-nodeid="1684">通过 xDS 和控制面通信。</p>
</li>
</ol>
<p data-nodeid="1685"><strong data-nodeid="1919">控制面</strong>：</p>
<ol data-nodeid="1686">
<li data-nodeid="1687">
<p data-nodeid="1688">同时兼容虚拟机和 Kubernetes，和公司现有的 CMDB 系统打通，同步机器元数据。</p>
</li>
<li data-nodeid="1689">
<p data-nodeid="1690">支持 xDS 协议，兼容现有的、采用 xDS 协议的数据面。</p>
</li>
</ol>
<h4 data-nodeid="1691">技术选型</h4>
<p data-nodeid="1692">为了快速实现，这里我们就不从头设计框架层了，经过调研，Go-Micro 框架完全可以满足我们数据面 Sidecar 的需求，其本身也支持了多种协议。（Go-Micro 项目地址<a href="https://github.com/asim/go-micro" data-nodeid="1926">https://github.com/asim/go-micro</a>）</p>
<p data-nodeid="1693">控制面 Envoy 也提供了基础框架，为了降低复杂度，我们不使用 Istio 二次开发，直接用 Envoy 提供的控制面基础框架来开发。（地址为<a href="https://github.com/envoyproxy/go-control-plane" data-nodeid="1931">https://github.com/envoyproxy/go-control-plane</a>）</p>
<h3 data-nodeid="1694">总结</h3>
<p data-nodeid="1695">今天我们主要了解了自研 Service Mesh 项目的原因，对比了微服务框架和多种开源 Service Mesh 方案，结合项目的背景现状确定了自研 Service Mesh 的方案。</p>
<p data-nodeid="1696">本讲内容总结如下：</p>
<p data-nodeid="1697"><img src="https://s0.lgstatic.com/i/image6/M00/05/80/Cgp9HWAwy5OAaZzXAAJLShOgMYc816.png" alt="Drawing 1.png" data-nodeid="1938"></p>
<p data-nodeid="1698">根据今天内容的讲解，结合公司项目背景，如果让你选择合适的方案，你会做出何种选择呢，是选用微服务框架还是开源 Service Mesh 方案，抑或和我一样选择自研的方案呢，欢迎在留言区和我分享你的观点。</p>
<p data-nodeid="1699" class="">今天的内容到这里就结束了，下一讲我们讲解数据面：基于 Go-Micro 快速实现代理模块，在这一讲我会实现一个简单的 Sidecar，然后结合代码讲解，帮助你从源码出发更好地了解 Service Mesh 数据面的原理。</p>

---

### 精选评论



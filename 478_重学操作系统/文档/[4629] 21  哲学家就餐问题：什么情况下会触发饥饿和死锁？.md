<p data-nodeid="40444" class=""><strong data-nodeid="40539">è¿™ä¸€è®²ç»™ä½ å¸¦æ¥çš„é¢è¯•é¢˜ç›®æ˜¯ï¼šä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘é¥¥é¥¿å’Œæ­»é”</strong>ï¼Ÿ</p>
<p data-nodeid="40445">è¯»é¢˜å¯çŸ¥ï¼Œè¿™é“é¢˜ç›®åœ¨æé—®â€œåœºæ™¯â€ï¼Œä»è¡¨é¢æ¥çœ‹ï¼Œè§£é¢˜æ€è·¯æ˜¯åˆ—ä¸¾å‡ ä¸ªä¾‹å­ã€‚ä½†æ˜¯åœ¨å›ç­”è¿™ç±»é¢è¯•é¢˜å‰ä½ ä¸€å®šè¦æƒ³ä¸€æƒ³é¢è¯•å®˜åœ¨è€ƒå¯Ÿä»€ä¹ˆï¼Œå¾€å¾€åœ¨é¢˜ç›®ä¸­çœ‹åˆ°â€œ<strong data-nodeid="40545">ä»€ä¹ˆæƒ…å†µä¸‹</strong>â€æ—¶ï¼Œå…¶å®è€ƒå¯Ÿçš„æ˜¯ä½ æ€»ç»“å’Œæ¦‚æ‹¬ä¿¡æ¯çš„èƒ½åŠ›ã€‚</p>
<p data-nodeid="40446">å…³äºä¸Šé¢è¿™é“é¢˜ç›®ï¼Œå¦‚æœä½ åªå›ç­”ä¸€ä¸ªåœºæ™¯ï¼Œè€Œæ²¡æœ‰è¾“å‡ºæ¦‚æ‹¬æ€§çš„æ€»ç»“å†…å®¹ï¼Œå°±å¾ˆå®¹æ˜“è¢«é¢è¯•å®˜è®¤ä¸ºå¯¹çŸ¥è¯†ç†è§£ä¸åˆ°ä½ï¼Œå› è€ŒæŒ‚æ‰é¢è¯•ã€‚å¦å¤–ï¼Œ<strong data-nodeid="40551">æé—®æ­»é”å’Œé¥¥é¥¿è¿˜æœ‰ä¸€ä¸ªæ›´æ·±å±‚çš„æ„æ€ï¼Œå°±æ˜¯è€ƒå¯Ÿä½ åœ¨å®æˆ˜ä¸­å¯¹å¹¶å‘æ§åˆ¶ç®—æ³•çš„ç†è§£ï¼Œæ˜¯å¦å…·å¤‡è®¾è®¡å¹¶å‘ç®—æ³•æ¥è§£å†³æ­»é”é—®é¢˜å¹¶ä¸”å…¼é¡¾æ€§èƒ½ï¼ˆå¹¶å‘é‡ï¼‰çš„æ€ç»´å’Œèƒ½åŠ›</strong>ã€‚</p>
<p data-nodeid="40447">è¦å­¦ä¹ è¿™éƒ¨åˆ†çŸ¥è¯†æœ‰ä¸€ä¸ªéå¸¸ä¸é”™çš„æ¨¡å‹ï¼Œå°±æ˜¯å“²å­¦å®¶å°±é¤é—®é¢˜ã€‚1965 å¹´ï¼Œè®¡ç®—æœºç§‘å­¦å®¶ Dijkstra ä¸ºäº†å¸®åŠ©å­¦ç”Ÿæ›´å¥½åœ°å­¦ä¹ å¹¶å‘ç¼–ç¨‹è®¾è®¡çš„ä¸€é“ç»ƒä¹ é¢˜ï¼Œåæ¥é€æ¸æˆä¸ºå¤§å®¶å¹¿æ³›è®¨è®ºçš„é—®é¢˜ã€‚</p>
<h3 data-nodeid="40448">å“²å­¦å®¶å°±é¤é—®é¢˜</h3>
<p data-nodeid="40449">é—®é¢˜æè¿°å¦‚ä¸‹ï¼šæœ‰ 5 ä¸ªå“²å­¦å®¶ï¼Œå›´ç€ä¸€ä¸ªåœ†æ¡Œå°±é¤ã€‚åœ†æ¡Œä¸Šæœ‰ 5 ä»½æ„å¤§åˆ©é¢å’Œ 5 ä»½å‰å­ã€‚å“²å­¦å®¶æ¯”è¾ƒç¬¨ï¼Œä»–ä»¬å¿…é¡»æ‹¿åˆ°å·¦æ‰‹å’Œå³æ‰‹çš„ 2 ä¸ªå‰å­æ‰èƒ½åƒé¢ã€‚å“²å­¦ä¸é¥¿çš„æ—¶å€™å°±åœ¨æ€è€ƒï¼Œé¥¿äº†å°±å»åƒé¢ï¼Œåƒé¢çš„å¿…é¡»å‰ææ˜¯æ‹¿åˆ° 2 ä¸ªå‰å­ï¼Œåƒå®Œé¢å“²å­¦å®¶å°±å»æ€è€ƒã€‚</p>
<p data-nodeid="40450"><img src="https://s0.lgstatic.com/i/image/M00/6F/3D/CgqCHl-04I2AWTRGAABMYcirc5o121.png" alt="Drawing 0.png" data-nodeid="40557"></p>
<p data-nodeid="40451">å‡è®¾æ¯ä¸ªå“²å­¦å®¶ç”¨ä¸€ä¸ªçº¿ç¨‹å®ç°ï¼Œæ±‚ä¸€ç§å¹¶å‘æ§åˆ¶çš„ç®—æ³•ï¼Œè®©å“²å­¦å®¶ä»¬æŒ‰éƒ¨å°±ç­åœ°æ€è€ƒå’Œåƒé¢ã€‚å½“ç„¶æˆ‘è¿™é‡Œåšäº†ä¸€äº›æ”¹åŠ¨ï¼Œæ¯”å¦‚ Dijkstra é‚£ä¸ªå¹´ä»£çº¿ç¨‹è¿˜æ²¡æœ‰æ™®åŠï¼Œæœ€æ—©çš„é¢˜ç›®æ¯ä¸ªå“²å­¦å®¶æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚</p>
<h3 data-nodeid="40452">é—®é¢˜çš„æŠ½è±¡</h3>
<p data-nodeid="40453">æ¥ä¸‹æ¥è¯·ä½ ç»§ç»­æ€è€ƒï¼Œæˆ‘ä»¬å¯¹é—®é¢˜è¿›è¡Œä¸€äº›æŠ½è±¡ï¼Œæ¯”å¦‚å“²å­¦æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç¼–å· 0~4ã€‚æˆ‘è¿™é‡Œç”¨ Java è¯­è¨€ç»™ä½ æ¼”ç¤ºï¼Œå“²å­¦å®¶æ˜¯ä¸€ä¸ªç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="40454"><code data-language="java"><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Philosopher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Philosopher[] philosophers;

    <span class="hljs-keyword">static</span> {
       philosophers = <span class="hljs-keyword">new</span> Philosopher[<span class="hljs-number">5</span>];
    }
}
</code></pre>
<p data-nodeid="40455">è¿™é‡Œè€ƒè™‘å‰å­ä¹Ÿä½¿ç”¨ç¼–å· 0~4ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="40456"><code data-language="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Integer[] forks;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Philosopher[] philosophers;
<span class="hljs-keyword">static</span> {
 &nbsp; <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
&nbsp; &nbsp; &nbsp; &nbsp; philosophers[i] = <span class="hljs-keyword">new</span> Philosopher(i);
&nbsp; &nbsp; &nbsp; &nbsp; forks[i] = -<span class="hljs-number">1</span>;
&nbsp; &nbsp; }
}
</code></pre>
<p data-nodeid="40457"><code data-backticks="1" data-nodeid="40566">forks[i]</code>çš„å€¼ç­‰äº xï¼Œç›¸å½“äºç¼–å·ä¸º<code data-backticks="1" data-nodeid="40568">i</code>çš„å‰å­è¢«ç¼–å·ä¸º x çš„å“²å­¦å®¶æ‹¿èµ·ï¼›å¦‚æœç­‰äº<code data-backticks="1" data-nodeid="40570">-1</code>ï¼Œé‚£ä¹ˆå‰å­ç›®å‰æ”¾åœ¨æ¡Œå­ä¸Šã€‚</p>
<p data-nodeid="40458">æˆ‘ä»¬ç»å¸¸éœ€è¦æè¿°å·¦ã€å³çš„å…³ç³»ï¼Œä¸ºäº†æ–¹ä¾¿è®¡ç®—ï¼Œå¯ä»¥è®¾è®¡ 1 ä¸ªå¸®åŠ©å‡½æ•°ï¼ˆhelper functionsï¼‰ï¼Œå¸®åŠ©æˆ‘ä»¬æ ¹æ®ä¸€ä¸ªç¼–å·ï¼Œè®¡ç®—å®ƒå·¦è¾¹çš„ç¼–å·ã€‚</p>
<pre class="lang-java" data-nodeid="40459"><code data-language="java">&nbsp;<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">LEFT</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>{
&nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> i == <span class="hljs-number">0</span> ? <span class="hljs-number">4</span> : i-<span class="hljs-number">1</span>;
}
</code></pre>
<p data-nodeid="40460">å‡è®¾å’Œå“²å­¦å®¶ç¼–å·ä¸€è‡´çš„å‰å­åœ¨å³è¾¹ï¼Œè¿™æ ·å¦‚æœè¦åˆ¤æ–­ç¼–å·ä¸º<code data-backticks="1" data-nodeid="40574">id</code>å“²å­¦å®¶æ˜¯å¦å¯ä»¥åƒé¢ï¼Œéœ€è¦è¿™æ ·åšï¼š</p>
<pre class="lang-java" data-nodeid="40461"><code data-language="java"><span class="hljs-keyword">if</span>(forks[LEFT(id)] == id &amp;&amp; forks[id] == id) {
  <span class="hljs-comment">// å¯ä»¥åƒé¢</span>
}
</code></pre>
<p data-nodeid="40462">ç„¶åå®šä¹‰ä¸€ä¸ª<code data-backticks="1" data-nodeid="40577">_take</code>å‡½æ•°æ‹¿èµ·ç¼–å·ä¸º<code data-backticks="1" data-nodeid="40579">i</code>å‰å­; å†è®¾è®¡ä¸€ä¸ª<code data-backticks="1" data-nodeid="40581">_put</code>æ–¹æ³•æ”¾ä¸‹å‰å­ï¼š</p>
<pre class="lang-java" data-nodeid="40463"><code data-language="java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">_take</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{
&nbsp; &nbsp; Thread.sleep(<span class="hljs-number">10</span>);
&nbsp; &nbsp; forks[i] = id;
}
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">_put</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span>{
  <span class="hljs-keyword">if</span>(forks[i] == id)
    forks[i] = -<span class="hljs-number">1</span>;
}
</code></pre>
<p data-nodeid="40464"><code data-backticks="1" data-nodeid="40583">_take</code>å‡½æ•°ä¹‹æ‰€ä»¥ä¼šç­‰å¾… 10msï¼Œæ˜¯å› ä¸º<strong data-nodeid="40589">å“²å­¦å®¶å°±é¤é—®é¢˜çš„å®é™…æ„ä¹‰ï¼Œæ˜¯ I/O å¤„ç†çš„åœºæ™¯ï¼Œæ‹¿èµ·å‰å­å¥½æ¯”è¯»å–ç£ç›˜ï¼Œéœ€è¦æœ‰ä¸€ç­‰çš„æ—¶é—´å¼€é”€ï¼Œè¿™æ ·æ€è€ƒæ‰æœ‰æ„ä¹‰</strong>ã€‚</p>
<p data-nodeid="40465">ç„¶åæ˜¯å¯¹<code data-backticks="1" data-nodeid="40591">think</code>å’Œ<code data-backticks="1" data-nodeid="40593">eat</code>ä¸¤ä¸ªæ–¹æ³•çš„æŠ½è±¡ã€‚é¦–å…ˆæˆ‘å°è£…äº†ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œæè¿°å“²å­¦å®¶çš„çŠ¶æ€ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="lang-plain" data-nodeid="40466"><code data-language="plain">enum PHIS {
&nbsp; &nbsp; THINKING,
&nbsp; &nbsp; HUNGRY,
&nbsp; &nbsp; EATING
}
</code></pre>
<p data-nodeid="40467">ç„¶åå®ç°<code data-backticks="1" data-nodeid="40596">think</code>æ–¹æ³•ï¼Œ<code data-backticks="1" data-nodeid="40598">think</code>æ–¹æ³•ä¸éœ€è¦å¹¶å‘æ§åˆ¶ï¼Œä½†æ˜¯è¿™é‡Œç”¨<code data-backticks="1" data-nodeid="40600">Thread.sleep</code>æ¨¡æ‹Ÿå®é™…æ€è€ƒéœ€è¦çš„å¼€é”€ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="lang-plain" data-nodeid="40468"><code data-language="plain">void think() throws InterruptedException {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; System.out.println(String.format("Philosopher %d thinking...", id));
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Thread.sleep((long) Math.floor(Math.random()*1000));
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this.state = PHIS.HUNGRY;
</code></pre>
<p data-nodeid="40469">æœ€åæ˜¯<code data-backticks="1" data-nodeid="40603">eat</code>æ–¹æ³•ï¼š</p>
<pre class="lang-plain" data-nodeid="40470"><code data-language="plain">void eat() throws InterruptedException {
  synchronized (forks) {
    &nbsp; if(forks[LEFT(id)] == id &amp;&amp; forks[id] == id) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this.state = PHIS.EATING;
&nbsp; &nbsp; &nbsp; } else {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;
&nbsp; &nbsp; &nbsp; }
  }
 &nbsp;Thread.sleep((long) Math.floor(Math.random()*1000));
 
}
</code></pre>
<p data-nodeid="40471"><code data-backticks="1" data-nodeid="40605">eat</code>æ–¹æ³•ä¾èµ–äº<code data-backticks="1" data-nodeid="40607">forks</code>å¯¹è±¡çš„é”ï¼Œç›¸å½“äº<code data-backticks="1" data-nodeid="40609">eat</code>æ–¹æ³•è¿™é‡Œä¼šåŒæ­¥â€”â€”å› ä¸ºè¿™é‡Œæœ‰è¯»å–ä¸´ç•ŒåŒºæ“ä½œåšã€‚<code data-backticks="1" data-nodeid="40611">Thread.sleep</code>ä¾ç„¶ç”¨äºæè¿°<code data-backticks="1" data-nodeid="40613">eat</code>æ–¹æ³•çš„æ—¶é—´å¼€é”€ã€‚<code data-backticks="1" data-nodeid="40615">sleep</code>æ–¹æ³•æ²¡æœ‰æ”¾åˆ°<code data-backticks="1" data-nodeid="40617">synchronized</code>å†…æ˜¯å› ä¸º<strong data-nodeid="40623">åœ¨å¹¶å‘æ§åˆ¶æ—¶ï¼Œåº”è¯¥å°½é‡è¾ƒå°‘é”çš„èŒƒå›´ï¼Œè¿™æ ·å¯ä»¥å¢åŠ æ›´å¤§çš„å¹¶å‘é‡</strong>ã€‚</p>
<p data-nodeid="40472">ä»¥ä¸Šï¼Œæˆ‘ä»¬å¯¹é—®é¢˜è¿›è¡Œäº†ä¸€ä¸ªåŸºæœ¬çš„æŠ½è±¡ã€‚æ¥ä¸‹æ¥è¯·ä½ æ€è€ƒåœ¨ä»€ä¹ˆæƒ…å†µä¼šå‘ç”Ÿæ­»é”ï¼Ÿ</p>
<h3 data-nodeid="40473">æ­»é”ï¼ˆDeadLockï¼‰å’Œæ´»é”ï¼ˆLiveLockï¼‰</h3>
<p data-nodeid="40474">é¦–å…ˆï¼Œå¯ä»¥æ€è€ƒä¸€ç§æœ€ç®€å•çš„è§£æ³•ï¼Œæ¯ä¸ªå“²å­¦å®¶ç”¨ä¸€ä¸ª<code data-backticks="1" data-nodeid="40627">while</code>å¾ªç¯è¡¨ç¤ºï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="lang-plain" data-nodeid="40475"><code data-language="plain">while(true){
  think();
  _take(LEFT(id)); 
  _take(id);
  eat();
  _put(LEFT(id));
  _put(id); 
}
void _take(id){
  while(forks[id] != -1) {  Thread.yield();  }
  Thread.sleep(10); // æ¨¡æ‹ŸI/Oç”¨æ—¶
}
</code></pre>
<p data-nodeid="40476"><code data-backticks="1" data-nodeid="40629">_take</code>å¯ä»¥è€ƒè™‘é˜»å¡ï¼Œç›´åˆ°å“²å­¦å®¶å¾—åˆ°å‰å­ã€‚ä¸Šé¢ç¨‹åºæˆ‘ä»¬è¿˜æ²¡æœ‰è¿›è¡Œå¹¶å‘æ§åˆ¶ï¼Œä¼šå‘ç”Ÿç«äº‰æ¡ä»¶ã€‚ é¡ºç€è¿™ä¸ªæ€è·¯ï¼Œå°±å¯ä»¥æƒ³åˆ°åŠ å…¥å¹¶å‘æ§åˆ¶ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="lang-plain" data-nodeid="40477"><code data-language="plain">while(true){
  think();

  synchronized(fork[LEFT(id)]) {
    _take(LEFT(id)); 
    synchronized(fork[id]) {
      _take(id);
    }
  }
  eat();
&nbsp; synchronized(fork[LEFT(id)]) {
    _put(LEFT(id));
    synchronized(fork[id]) {
    &nbsp; _put(id);&nbsp;
    }
  }
}
</code></pre>
<p data-nodeid="40478">ä¸Šé¢çš„å¹¶å‘æ§åˆ¶ï¼Œä¼šå‘ç”Ÿæ­»é”é—®é¢˜ï¼Œå¤§å®¶å¯ä»¥æ€è€ƒè¿™æ ·ä¸€ä¸ªæ—¶åºï¼Œå¦‚æœ 5 ä¸ªå“²å­¦å®¶éƒ½åŒæ—¶é€šè¿‡<code data-backticks="1" data-nodeid="40632">synchronized(fork[LEFT(id)])</code>ï¼Œæœ‰å¯èƒ½ä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µï¼š</p>
<ul data-nodeid="40479">
<li data-nodeid="40480">
<p data-nodeid="40481">ç¬¬ 0 ä¸ªå“²å­¦å®¶è·å¾—å‰å­ 4ï¼Œæ¥ä¸‹æ¥è¯·æ±‚å‰å­ 0ï¼›</p>
</li>
<li data-nodeid="40482">
<p data-nodeid="40483">ç¬¬ 1 ä¸ªå“²å­¦å®¶è·å¾—å‰å­ 0ï¼Œæ¥ä¸‹æ¥è¯·æ±‚å‰å­ 1ï¼›</p>
</li>
<li data-nodeid="40484">
<p data-nodeid="40485">ç¬¬ 2 ä¸ªå“²å­¦å®¶è·å¾—å‰å­ 1ï¼Œæ¥ä¸‹æ¥è¯·æ±‚å‰å­ 2ï¼›</p>
</li>
<li data-nodeid="40486">
<p data-nodeid="40487">ç¬¬ 3 ä¸ªå“²å­¦å®¶è·å¾—å‰å­ 2ï¼Œæ¥ä¸‹æ¥è¯·æ±‚å‰å­ 3ï¼›</p>
</li>
<li data-nodeid="40488">
<p data-nodeid="40489">ç¬¬ 4 ä¸ªå“²å­¦å®¶è·å¾—å‰å­ 3ï¼Œæ¥ä¸‹æ¥è¯·æ±‚å‰å­ 4ã€‚</p>
</li>
</ul>
<p data-nodeid="40490">ä¸ºäº†å¸®åŠ©ä½ ç†è§£ï¼Œè¿™é‡Œæˆ‘ç”»äº†ä¸€å¹…å›¾ã€‚</p>
<p data-nodeid="40491"><img src="https://s0.lgstatic.com/i/image/M00/6F/4A/CgqCHl-1AGWABRYZAACklm4__ZQ120.png" alt="11111.png" data-nodeid="40642"></p>
<p data-nodeid="40492">å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ç§å¾ªç¯ä¾èµ–çš„å…³ç³»ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ‰€æœ‰å“²å­¦å®¶éƒ½è·å¾—äº†ä¸€ä¸ªå‰å­ï¼Œå¹¶ä¸”åœ¨ç­‰å¾…ä¸‹ä¸€ä¸ªå‰å­ã€‚è¿™ç§ç­‰å¾…æ°¸è¿œä¸ä¼šç»“æŸï¼Œå› ä¸ºæ²¡æœ‰å“²å­¦å®¶æ„¿æ„æ”¾å¼ƒè‡ªå·±æ‹¿èµ·çš„å‰å­ã€‚</p>
<p data-nodeid="40493">ä»¥ä¸Šè¿™ç§æƒ…å†µç§°ä¸º**æ­»é”ï¼ˆDeadlockï¼‰ï¼Œ<strong data-nodeid="40655">è¿™æ˜¯ä¸€ç§</strong>é¥¥é¥¿ï¼ˆStarvationï¼‰**çš„å½¢å¼ã€‚ä»æ¦‚å¿µä¸Šè¯´ï¼Œæ­»é”æ˜¯çº¿ç¨‹é—´äº’ç›¸ç­‰å¾…èµ„æºï¼Œä½†æ˜¯æ²¡æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚é¥¥é¥¿å°±æ˜¯å› ä¸ºæŸç§åŸå› å¯¼è‡´çº¿ç¨‹å¾—ä¸åˆ°éœ€è¦çš„èµ„æºï¼Œæ— æ³•ç»§ç»­å·¥ä½œã€‚æ­»é”æ˜¯é¥¥é¥¿çš„ä¸€ç§å½¢å¼ï¼Œå› ä¸ºå¾ªç¯ç­‰å¾…æ— æ³•å¾—åˆ°èµ„æºã€‚å“²å­¦å®¶å°±é¤é—®é¢˜ï¼Œä¼šå½¢æˆä¸€ç§ç¯çŠ¶çš„æ­»é”ï¼ˆå¾ªç¯ä¾èµ–ï¼‰ï¼Œ å› æ­¤éå¸¸å…·æœ‰ä»£è¡¨æ€§ã€‚</p>
<p data-nodeid="40494">æ­»é”æœ‰ 4 ä¸ªåŸºæœ¬æ¡ä»¶ã€‚</p>
<ol data-nodeid="40495">
<li data-nodeid="40496">
<p data-nodeid="40497"><strong data-nodeid="40661">èµ„æºå­˜åœ¨äº’æ–¥é€»è¾‘ï¼šæ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æŠ¢å åˆ°èµ„æº</strong>ã€‚è¿™é‡Œæ˜¯å“²å­¦å®¶æŠ¢å å‰å­ã€‚</p>
</li>
<li data-nodeid="40498">
<p data-nodeid="40499"><strong data-nodeid="40666">æŒæœ‰ç­‰å¾…</strong>ï¼šè¿™é‡Œå“²å­¦å®¶ä¼šä¸€ç›´ç­‰å¾…æ‹¿åˆ°å‰å­ã€‚</p>
</li>
<li data-nodeid="40500">
<p data-nodeid="40501"><strong data-nodeid="40671">ç¦æ­¢æŠ¢å ï¼šå¦‚æœæ‹¿ä¸åˆ°èµ„æºä¸€ç›´ä¼šå¤„äºç­‰å¾…çŠ¶æ€ï¼Œè€Œä¸ä¼šé‡Šæ”¾å·²ç»æ‹¥æœ‰çš„èµ„æº</strong>ã€‚</p>
</li>
<li data-nodeid="40502">
<p data-nodeid="40503"><strong data-nodeid="40676">å¾ªç¯ç­‰å¾…</strong>ï¼šè¿™é‡Œå“²å­¦å®¶ä»¬ä¼šå¾ªç¯ç­‰å¾…å½¼æ­¤çš„å‰å­ã€‚</p>
</li>
</ol>
<p data-nodeid="40504">åˆšæ‰æåˆ°æ­»é”ä¹Ÿæ˜¯ä¸€ç§é¥¥é¥¿ï¼ˆStarvationï¼‰çš„å½¢å¼ï¼Œé¥¥é¥¿æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯çº¿ç¨‹é•¿æœŸæ‹¿ä¸åˆ°éœ€è¦çš„èµ„æºï¼Œæ— æ³•è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚</p>
<p data-nodeid="40505">è¦è§£å†³æ­»é”çš„é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘å“²å­¦å®¶æ‹¿èµ· 1 ä¸ªå‰å­åï¼Œå¦‚æœè¿Ÿè¿Ÿæ²¡æœ‰ç­‰åˆ°ä¸‹ä¸€ä¸ªå‰å­ï¼Œå°±æ”¾å¼ƒè¿™æ¬¡æ“ä½œã€‚æ¯”å¦‚ Java çš„ Lock Interface ä¸­ï¼Œæä¾›çš„<code data-backticks="1" data-nodeid="40679">tryLock</code>æ–¹æ³•ï¼Œå°±å¯ä»¥å®ç°å®šæ—¶è·å–ï¼š</p>
<pre class="lang-java" data-nodeid="40506"><code data-language="java"><span class="hljs-keyword">var</span> lock = <span class="hljs-keyword">new</span> ReentrantLock();
lock.tryLock(<span class="hljs-number">5</span>, TimeUnit.SECONDS);
</code></pre>
<p data-nodeid="40507">Java æä¾›çš„è¿™ä¸ªèƒ½åŠ›æ˜¯æ‹¿ä¸åˆ°é”ï¼Œå°±æŠ¥å¼‚å¸¸ï¼Œå¹¶å¯ä»¥ä¾æ®è¿™ä¸ªèƒ½åŠ›å¼€å‘é‡Šæ”¾å·²è·å¾—èµ„æºçš„èƒ½åŠ›ã€‚</p>
<p data-nodeid="40508">ä½†æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬ä¼šç¢°åˆ°ä¸€ä¸ªå«ä½œæ´»é”ï¼ˆLiveLockï¼‰çš„é—®é¢˜ã€‚LiveLock ä¹Ÿæ˜¯ä¸€ç§é¥¥é¥¿ã€‚å¯èƒ½åœ¨æŸä¸ªæ—¶åˆ»ï¼Œæ‰€æœ‰å“²å­¦åŠéƒ½æ‹¿èµ·äº†å·¦æ‰‹çš„å‰å­ï¼Œç„¶åå‘ç°å³æ‰‹çš„å‰å­æ‹¿ä¸åˆ°ï¼Œå°±æ”¾ä¸‹äº†å·¦æ‰‹çš„å‰å­â€”â€”å¦‚æ­¤å‘¨è€Œå¤å§‹ï¼Œè¿™å°±æ˜¯ä¸€ç§æ´»é”ã€‚æ‰€æœ‰çº¿ç¨‹éƒ½åœ¨å·¥ä½œï¼Œä½†æ˜¯æ²¡æœ‰çº¿ç¨‹èƒ½å¤Ÿè¿›ä¸€æ­¥â€”â€”è§£å†³é—®é¢˜ã€‚</p>
<p data-nodeid="40509">åœ¨å®é™…å·¥ä½œåœºæ™¯ä¸‹ï¼ŒLiveLock å¯ä»¥é æ¦‚ç‡è§£å†³ï¼Œå› ä¸ºåŒæ—¶æ‹¿èµ·ï¼ŒåˆåŒæ—¶æ”¾ä¸‹è¿™ç§æƒ…å†µä¸ä¼šå¾ˆå¤šã€‚å®é™…å·¥ä½œåœºæ™¯å¾ˆå¤šç³»ç»Ÿï¼Œç¡®å®ä¾èµ–äºè¿™ä¸ªé—®é¢˜ä¸é¢‘å‘ã€‚ä½†æ˜¯ï¼Œä¼˜ç§€çš„è®¾è®¡è€…ä¸èƒ½æŠŠç³»ç»Ÿè®¾è®¡ä¾æ‰˜åœ¨ä¸€ä¸ªæœ‰æ¦‚ç‡é£é™©çš„æ“ä½œä¸Šï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç»§ç»­å¾€æ·±ä¸€å±‚æ€è€ƒã€‚</p>
<h3 data-nodeid="40510">è§£å†³æ–¹æ¡ˆ</h3>
<p data-nodeid="40511">å…¶å®è§£å†³ä¸Šè¿°é—®é¢˜æœ‰å¾ˆå¤šçš„æ–¹æ¡ˆï¼Œæœ€ç®€å•ã€æœ€ç›´è§‚çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="40512"><code data-language="java"><span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>){
    <span class="hljs-keyword">synchronized</span>(someLock) {
      think();
      _take(LEFT(id)); 
      _take(id);
      eat();
      _put(LEFT(id));
    &nbsp; _put(id);&nbsp;
  &nbsp; }
}
</code></pre>
<p data-nodeid="40513">ä¸Šé¢è¿™æ®µç¨‹åºåŒæ—¶åªå…è®¸ä¸€ä¸ªå“²å­¦å®¶ä½¿ç”¨æ‰€æœ‰èµ„æºï¼Œæˆ‘ä»¬ç”¨<code data-backticks="1" data-nodeid="40687">synchronized</code>æ„é€ äº†ä¸€ç§æ’é˜Ÿçš„é€»è¾‘ã€‚è€Œå“²å­¦å®¶ï¼Œæ¯æ¬¡å¿…é¡»æ‹¿èµ·æ‰€æœ‰çš„å‰å­ï¼Œåƒå®Œï¼Œå†åˆ°ä¸‹ä¸€å“²å­¦å®¶ã€‚ è¿™æ ·å¹¶å‘åº¦æ˜¯ 1ï¼ŒåŒæ—¶æœ€å¤šæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œã€‚ è¿™æ ·çš„æ–¹å¼å¯ä»¥å®Œæˆä»»åŠ¡ï¼Œä½†æ˜¯æ€§èƒ½å¤ªå·®ã€‚</p>
<p data-nodeid="40514">å¦ä¸€ç§æ–¹æ³•æ˜¯è§„å®šæ‹¿èµ·è¿‡ç¨‹å¿…é¡»åŒæ—¶æ‹¿èµ·ï¼Œæ”¾ä¸‹è¿‡ç¨‹ä¹ŸåŒæ—¶æ”¾ä¸‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="40515"><code data-language="java"><span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>){
    think();
&nbsp; &nbsp; <span class="hljs-keyword">synchronized</span>(someLock) {
      _takeForks(); 
    }
    eat();
    <span class="hljs-keyword">synchronized</span>(someLock) {
      _puts();
    }
}
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">_takeForks</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">if</span>( forks[LEFT(id)] == -<span class="hljs-number">1</span> &amp;&amp; forks[id] == -<span class="hljs-number">1</span> ) {
    forks[LEFT(id)] = id;
    forks[id] = id;
  }
}
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">_puts</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">if</span>(forks[LEFT(id)] == id)
      forks[LEFT(id)] = -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(forks[id] == id)
      forks[id] = -<span class="hljs-number">1</span>;
}
</code></pre>
<p data-nodeid="40516">ä¸Šé¢è¿™æ®µç¨‹åºï¼Œ<code data-backticks="1" data-nodeid="40691">think</code>å‡½æ•°æ²¡æœ‰å¹¶å‘æ§åˆ¶ï¼Œä¸€ä¸ªå“²å­¦å®¶è¦ä¹ˆæ‹¿èµ·ä¸¤ä¸ªå‰å­ï¼Œè¦ä¹ˆä¸æ‹¿èµ·ï¼Œè¿™æ ·å¹¶å‘åº¦æœ€é«˜ä¸º 2ï¼ˆæœ€å¤šæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼‰ã€‚è€Œä¸”ï¼Œè¿™ä¸ªç®—æ³•ä¸­åªæœ‰ä¸€ä¸ªé”ï¼Œå› æ­¤ä¸å­˜åœ¨æ­»é”å’Œé¥¥é¥¿é—®é¢˜ã€‚</p>
<p data-nodeid="40517">åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å¯¹è¿™ä¸ªé—®é¢˜æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„æ–¹æ¡ˆï¼Œé‚£ä¹ˆå¦‚ä½•è¿›ä¸€æ­¥ä¼˜åŒ–å‘¢ï¼Ÿ</p>
<h3 data-nodeid="40518">æ€è€ƒå’Œæœ€ç»ˆæ–¹æ¡ˆ</h3>
<p data-nodeid="40519">æ•´ä¸ªé—®é¢˜å¤æ‚åº¦çš„æ ¸å¿ƒåœ¨äºå“²å­¦å®¶æ‹¿èµ·å‰å­æ˜¯æœ‰æˆæœ¬çš„ã€‚å¥½æ¯”çº¿ç¨‹è¯»å–ç£ç›˜ï¼Œéœ€è¦æ¶ˆè€—æ—¶é—´ã€‚å“²å­¦å®¶çš„æ€è€ƒï¼Œæ˜¯ç‹¬ç«‹çš„ã€‚å¥½æ¯”è¯»å–äº†ç£ç›˜æ•°æ®ï¼Œè¿›è¡Œè®¡ç®—ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•å…è®¸ 5 ä¸ªå“²å­¦å®¶éƒ½åŒæ—¶å»æ‹¿å‰å­å‘¢ï¼Ÿè¿™æ ·å¹¶å‘åº¦æ˜¯æœ€é«˜çš„ã€‚</p>
<p data-nodeid="40520">ç»è¿‡åˆæ­¥æ€è€ƒï¼Œé©¬ä¸Šä¼šå‘ç°è¿™é‡Œæœ‰ç¯çŠ¶ä¾èµ–ï¼Œ ä¼šå‡ºç°<strong data-nodeid="40701">æ­»é”</strong>ã€‚ åŸå› å°±æ˜¯å¦‚æœ 5 ä¸ªå“²å­¦å®¶åŒæ—¶æ‹¿å‰å­ï¼Œé‚£å°±æ„å‘³ç€æœ‰çš„å“²å­¦å®¶å¿…é¡»è¦æ”¾å¼ƒå‰å­ã€‚ä½†æ˜¯å¦‚æœä¸æ”¾ä¸‹ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</p>
<p data-nodeid="40521">å‡è®¾å½“ä¸€ä¸ªå“²å­¦å®¶å‘ç°è‡ªå·±æ‹¿ä¸åˆ°ä¸¤ä¸ªå‰å­çš„æ—¶å€™ï¼Œä»–å»å’Œå¦ä¸€ä¸ªå“²å­¦å®¶æ²Ÿé€šæŠŠè‡ªå·±çš„å‰å­ç»™å¯¹æ–¹ã€‚è¿™æ ·å°±ç›¸å½“äºï¼Œæœ‰ä¸€ä¸ªè½¬è®©æ–¹æ³•ã€‚ç›¸æ¯”äºç£ç›˜ I/Oï¼Œè½¬è®©å†…å­˜ä¸­çš„æ•°æ®æˆæœ¬å°±ä½çš„å¤šäº†ã€‚ æˆ‘ä»¬å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªè½¬è®©çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="40522"><code data-language="java">&nbsp;<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">_transfer</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fork, <span class="hljs-keyword">int</span> philosopher)</span> </span>{
&nbsp; &nbsp; &nbsp; forks[fork] = philosopher;
      dirty[fork] = <span class="hljs-keyword">false</span>;
&nbsp;}
</code></pre>
<p data-nodeid="40523">è¿™ä¸ªæ–¹æ³•ç›¸å½“äºæŠŠå‰å­è½¬è®©ç»™å¦ä¸€ä¸ªå“²å­¦å®¶ï¼Œè¿™é‡Œä½ å…ˆä¸ç”¨ç®¡ä¸Šé¢ä»£ç ä¸­çš„ dirtyï¼Œåæ–‡ä¸­ä¼šè®²åˆ°ã€‚è€Œè·å–å‰å­çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œè°ƒæ•´ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="40524"><code data-language="java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">take</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{
&nbsp; &nbsp; &nbsp; <span class="hljs-keyword">synchronized</span> (forks[i]) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span>(forks[i] == -<span class="hljs-number">1</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _take(id); 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="hljs-keyword">else</span> {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Philosopher other = philosophers[forks[i]];
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span>(other.state != PHIS.EATING &amp;&amp; dirty[i]) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; other._transfer(i, forks[i]);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; }
&nbsp; }
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">_take</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{
&nbsp; &nbsp; Thread.sleep(<span class="hljs-number">10</span>);
&nbsp; &nbsp; forks[i] = id;
}
</code></pre>
<p data-nodeid="40525">è¿™é‡Œæˆ‘ä»¬æŠŠæ¯ä¸ªå‰å­çœ‹ä½œä¸€ä¸ªé”ï¼Œæœ‰å¤šå°‘ä¸ªå‰å­ï¼Œå°±æœ‰å¤šå°‘ä¸ªé”ï¼Œç›¸å½“äºåŒæ—¶å¯ä»¥æ‹¿èµ· 5 ä¸ªå‰å­ï¼ˆå¹¶å‘åº¦æ˜¯ 5ï¼‰ã€‚å¦‚æœå½“å‰æ²¡æœ‰äººæ‹¿èµ·å‰å­ï¼Œé‚£ä¹ˆå¯ä»¥è‡ªå·±æ‹¿èµ·ã€‚ å¦‚æœå‰å­å±äºå…¶ä»–å“²å­¦å®¶ï¼Œå°±éœ€è¦åˆ¤æ–­å¯¹æ–¹çš„çŠ¶æ€ã€‚åªè¦å¯¹æ–¹ä¸åœ¨<code data-backticks="1" data-nodeid="40705">EATING</code>ï¼Œå°±å¯ä»¥è€ƒè™‘è½¬è®©å‰å­ã€‚</p>
<p data-nodeid="40526">æœ€åæ˜¯å¯¹ LiveLock çš„æ€è€ƒï¼Œä¸ºäº†é¿å…å‰å­åœ¨ä¸¤ä¸ªå“²å­¦å®¶ä¹‹é—´æ¥å›è½¬è®©ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªå‰å­å¢åŠ äº†ä¸€ä¸ª<code data-backticks="1" data-nodeid="40708">dirty</code>å±æ€§ã€‚ä¸€å¼€å§‹å‰å­çš„<code data-backticks="1" data-nodeid="40710">dirty</code>æ˜¯<code data-backticks="1" data-nodeid="40712">true</code>ï¼Œæ¯æ¬¡è½¬è®©åï¼Œå“²å­¦å®¶ä¼šæŠŠè‡ªå·±çš„å‰å­æ“¦å¹²å‡€ç»™å¦ä¸€ä¸ªå“²å­¦å®¶ã€‚è½¬è®©çš„å‰ç½®æ¡ä»¶æ˜¯å‰å­æ˜¯<code data-backticks="1" data-nodeid="40714">dirty</code>çš„ï¼Œæ‰€ä»¥å‰å­åœ¨ä¸¤ä¸ªå“²å­¦å®¶ä¹‹é—´åªä¼šè½¬è®©ä¸€æ¬¡ã€‚</p>
<p data-nodeid="40527">é€šè¿‡ä¸Šé¢ç®—æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥é¿å…æ­»é”ã€é¥¥é¥¿ä»¥åŠæé«˜è¯»å–æ•°æ®ï¼ˆè·å–å‰å­ï¼‰çš„å¹¶å‘åº¦ã€‚æœ€åå®Œæ•´çš„ç¨‹åºå¦‚ä¸‹ï¼Œç»™ä½ åšå‚è€ƒï¼š</p>
<pre class="lang-java te-preview-highlight" data-nodeid="43650"><code data-language="java"><span class="hljs-keyword">package</span> test;

<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;
<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;
<span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;
<span class="hljs-keyword">import</span> java.util.concurrent.locks.StampedLock;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DiningPhilosophers</span> </span>{

&nbsp; &nbsp; <span class="hljs-keyword">enum</span> PHIS {
&nbsp; &nbsp; &nbsp; &nbsp; THINKING,
&nbsp; &nbsp; &nbsp; &nbsp; HUNGRY,
&nbsp; &nbsp; &nbsp; &nbsp; EATING
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Philosopher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>{

&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Philosopher[] philosophers;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Integer[] forks;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span>[] dirty;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">private</span> PHIS state = PHIS.THINKING;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">static</span> {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; philosophers = <span class="hljs-keyword">new</span> Philosopher[<span class="hljs-number">5</span>];
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; forks = <span class="hljs-keyword">new</span> Integer[<span class="hljs-number">5</span>];
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dirty = <span class="hljs-keyword">new</span> <span class="hljs-keyword">boolean</span>[<span class="hljs-number">5</span>];
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; philosophers[i] = <span class="hljs-keyword">new</span> Philosopher(i);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; forks[i] = -<span class="hljs-number">1</span>;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dirty[i] = <span class="hljs-keyword">true</span>;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; }

&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">LEFT</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>{
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> i == <span class="hljs-number">0</span> ? <span class="hljs-number">4</span> : i-<span class="hljs-number">1</span>;
&nbsp; &nbsp; &nbsp; &nbsp; }

&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Philosopher</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> </span>{
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">this</span>.id = id;
&nbsp; &nbsp; &nbsp; &nbsp; }

&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;

&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">think</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; System.out.println(String.format(<span class="hljs-string">"Philosopher %d thinking..."</span>, id));
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Thread.sleep((<span class="hljs-keyword">long</span>) Math.floor(Math.random()*<span class="hljs-number">1000</span>));
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">this</span>.state = PHIS.HUNGRY;
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; System.out.println(Arrays.toString(forks));
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">//System.out.println(Arrays.toString(dirty));</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span>(forks[LEFT(id)] == id &amp;&amp; forks[id] == id) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">this</span>.state = PHIS.EATING;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="hljs-keyword">else</span> {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span>;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; System.out.println(String.format(<span class="hljs-string">"Philosopher %d eating..."</span>, id));
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Thread.sleep((<span class="hljs-keyword">long</span>) Math.floor(Math.random()*<span class="hljs-number">1000</span>));

&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">synchronized</span> (forks) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dirty[LEFT(id)] = <span class="hljs-keyword">true</span>;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dirty[id] = <span class="hljs-keyword">true</span>;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }

&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">var</span> lock = <span class="hljs-keyword">new</span> ReentrantLock();
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lock.tryLock(<span class="hljs-number">5</span>, TimeUnit.SECONDS);

&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = PHIS.THINKING;
&nbsp; &nbsp; &nbsp; &nbsp; }

&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">_take</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Thread.sleep(<span class="hljs-number">10</span>);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; forks[i] = id;
&nbsp; &nbsp; &nbsp; &nbsp; }

&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">_transfer</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fork, <span class="hljs-keyword">int</span> philosopher)</span> </span>{
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; forks[fork] = philosopher;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dirty[fork] = <span class="hljs-keyword">false</span>;
&nbsp; &nbsp; &nbsp; &nbsp; }

&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">_putdown</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Thread.sleep(<span class="hljs-number">10</span>);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; forks[i] = -<span class="hljs-number">1</span>;
&nbsp; &nbsp; &nbsp; &nbsp; }

&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">take</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">synchronized</span> (forks[i]) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span>(forks[i] == -<span class="hljs-number">1</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _take(id);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="hljs-keyword">else</span> {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Philosopher other = philosophers[forks[i]];
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span>(other.state != PHIS.EATING &amp;&amp; dirty[i]) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; other._transfer(i, forks[i]);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">takeForks</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; take(LEFT(id));
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; take(id);
&nbsp; &nbsp; &nbsp; &nbsp; }

&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-meta">@Override</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">try</span> {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; think();
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">while</span> (state == PHIS.HUNGRY) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; takeForks();
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; System.out.println(<span class="hljs-string">"here--"</span> + Math.random());
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; eat();
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="hljs-keyword">catch</span> (InterruptedException e) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e.printStackTrace();
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }

&nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{

&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Philosopher(i)).start();
&nbsp; &nbsp; &nbsp; &nbsp; }

&nbsp; &nbsp; }
}
</code></pre>






<h3 data-nodeid="40529">æ€»ç»“</h3>
<p data-nodeid="40530"><strong data-nodeid="40722">é‚£ä¹ˆé€šè¿‡è¿™èŠ‚è¯¾çš„å­¦ä¹ ï¼Œä½ ç°åœ¨å¯ä»¥å°è¯•æ¥å›ç­”æœ¬èŠ‚å…³è”çš„é¢è¯•é¢˜ç›®ï¼šä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘é¥¥é¥¿å’Œæ­»é”</strong>ï¼Ÿ</p>
<p data-nodeid="40531"><strong data-nodeid="40727">ã€è§£æã€‘</strong> çº¿ç¨‹éœ€è¦èµ„æºæ²¡æœ‰æ‹¿åˆ°ï¼Œæ— æ³•è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œå°±æ˜¯é¥¥é¥¿ã€‚æ­»é”ï¼ˆDeadlockï¼‰å’Œæ´»é”ï¼ˆLivelockï¼‰éƒ½æ˜¯é¥¥é¥¿çš„ä¸€ç§å½¢å¼ã€‚ éæŠ¢å çš„ç³»ç»Ÿä¸­ï¼Œäº’æ–¥çš„èµ„æºè·å–ï¼Œå½¢æˆå¾ªç¯ä¾èµ–å°±ä¼šäº§ç”Ÿæ­»é”ã€‚æ­»é”å‘ç”Ÿåï¼Œå¦‚æœåˆ©ç”¨æŠ¢å è§£å†³ï¼Œå¯¼è‡´èµ„æºé¢‘ç¹è¢«è½¬è®©ï¼Œæœ‰ä¸€å®šæ¦‚ç‡è§¦å‘æ´»é”ã€‚æ­»é”ã€æ´»é”ï¼Œéƒ½å¯ä»¥é€šè¿‡è®¾è®¡å¹¶å‘æ§åˆ¶ç®—æ³•è§£å†³ï¼Œæ¯”å¦‚å“²å­¦å®¶å°±é¤é—®é¢˜ã€‚</p>
<h3 data-nodeid="40532">æ€è€ƒé¢˜</h3>
<p data-nodeid="40533"><strong data-nodeid="40733">æœ€åæˆ‘å†ç»™ä½ å‡ºä¸€é“éœ€è¦æŸ¥èµ„æ–™çš„æ€è€ƒé¢˜ï¼šå¦‚æœå“²å­¦å®¶å°±é¤é—®é¢˜æ‹¿èµ·å‰å­ã€æ”¾ä¸‹å‰å­ï¼Œåªéœ€è¦å¾®å°çš„æ—¶é—´ï¼Œä¸»è¦æ—¶é—´å¼€é”€é›†ä¸­åœ¨ think éœ€è¦è®¡ç®—èµ„æºï¼ˆCPU èµ„æºï¼‰ä¸Šï¼Œé‚£ä¹ˆä½¿ç”¨ä»€ä¹ˆæ¨¡å‹æ¯”è¾ƒåˆé€‚</strong>ï¼Ÿ</p>
<p data-nodeid="40534" class="">ä½ å¯ä»¥æŠŠä½ çš„ç­”æ¡ˆã€æ€è·¯æˆ–è€…è¯¾åæ€»ç»“å†™åœ¨ç•™è¨€åŒºï¼Œè¿™æ ·å¯ä»¥å¸®åŠ©ä½ äº§ç”Ÿæ›´å¤šçš„æ€è€ƒï¼Œè¿™ä¹Ÿæ˜¯æ„å»ºçŸ¥è¯†ä½“ç³»çš„ä¸€éƒ¨åˆ†ã€‚ç»è¿‡é•¿æœŸçš„ç§¯ç´¯ï¼Œç›¸ä¿¡ä½ ä¼šå¾—åˆ°æ„æƒ³ä¸åˆ°çš„æ”¶è·ã€‚å¦‚æœä½ è§‰å¾—ä»Šå¤©çš„å†…å®¹å¯¹ä½ æœ‰æ‰€å¯å‘ï¼Œæ¬¢è¿åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ã€‚æœŸå¾…çœ‹åˆ°ä½ çš„æ€è€ƒï¼</p>

---

### ç²¾é€‰è¯„è®º

##### **ç”¨æˆ·9684ï¼š
> eatä»£ç å¥½åƒæœ‰é—®é¢˜ã€‚1ï¼ŒåŠ é”åº”è¯¥åŠ folks[i],ä¸æ˜¯folksã€‚ 2. eatæ–¹æ³•æœ€ååº”è¯¥è°ƒç”¨putæ–¹æ³•ã€‚ 3.ä¸ºä»€ä¹ˆeatæ–¹æ³•æœ€åè¦try lockä¸€ä¸‹ï¼Œé‚£ä¸ªé”æ˜¯loxal å˜é‡ï¼Œå¿…å®šèƒ½æ‹¿åˆ°é”

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; 1.eatæ“ä½œäº†å·¦å³ä¸¤ä¸ªå˜é‡å› æ­¤ä¸èƒ½åŠ forks[i]ï¼Œ2.å‰å­æ€»æ˜¯ä¼šè¢«transferå› æ­¤ä¸éœ€è¦putã€‚3.trylockä¸éœ€è¦ï¼Œå»æ‰äº†ï¼ˆå†…å®¹å·²ä¿®æ­£ï¼Œè°¢è°¢åŒå­¦ï¼Œä¸å°å¿ƒç²˜è´´é”™äº†ï¼‰ã€‚

##### *å¸…ï¼š
> å¤±è´¥è¶…æ—¶æ”¾å¼ƒï¼šå¯èƒ½å­˜åœ¨åŒæ—¶æ‹¿èµ·åŒæ—¶æ”¾ä¸‹å¯èƒ½ï¼›ç›´æ¥åŠ é”ï¼šå¹¶å‘é‡ä½ï¼›å¤±è´¥ååå•†è½¬è®©ï¼šå†…å­˜è½¬è®©æ€§èƒ½é«˜

##### **æ˜Šï¼š
> è‹¥æœ‰æ‰€æ€ï¼Œå´åˆä¸çŸ¥é“åœ¨æ€è€ƒä»€ä¹ˆğŸ˜‚

 ###### &nbsp;&nbsp;&nbsp; ç¼–è¾‘å›å¤ï¼š
> &nbsp;&nbsp;&nbsp; è¿‡ä¸¤å¤©å¯ä»¥å†çœ‹ä¸€éï¼Œé‡æ–°æ€è€ƒä¸€ç•ªï¼Œä¹Ÿè®¸å°±èä¼šè´¯é€šäº†ï½

##### **ç”¨æˆ·9684ï¼š
> æ€è€ƒé¢˜ç­”æ¡ˆ è€ƒè™‘ç”¨ä¹è§‚é”cas

##### *æ—ºï¼š
> åƒå®Œä¹‹åçŠ¶æ€ä¹Ÿä¸æ”¹å˜ï¼Œä¸€ç›´åƒï¼Œä¸æ€è€ƒäº†ã€‚ã€‚ã€‚


<p data-nodeid="569" class="">åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å’ŒæœåŠ¡æä¾›è€…éƒ½å­˜åœ¨å¤šä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœæœåŠ¡æä¾›è€…å‡ºç°éƒ¨åˆ†æœºå™¨èŠ‚ç‚¹è´Ÿè½½è¿‡é«˜ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´è¯¥èŠ‚ç‚¹ä¸Šæ¥æ”¶çš„è¯·æ±‚å¤„ç†è¶…æ—¶ï¼Œä»è€Œå¯¼è‡´æœåŠ¡æä¾›è€…æ•´ä½“å¯ç”¨ç‡ä¸‹é™ã€‚æ‰€ä»¥ RPC æ¡†æ¶éœ€è¦å®ç°åˆç†çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œé‚£ä¹ˆå¦‚ä½•æ§åˆ¶æµé‡èƒ½å¤Ÿå‡åŒ€åœ°åˆ†æ‘Šåˆ°æ¯ä¸ªæœåŠ¡æä¾›è€…å‘¢ï¼Ÿä»Šå¤©è¿™èŠ‚è¯¾æˆ‘ä»¬ä¾¿è®¨è®º RPC æ¡†æ¶è´Ÿè½½å‡è¡¡æœºåˆ¶çš„ç›¸å…³å®ç°ã€‚</p>
<blockquote data-nodeid="570">
<p data-nodeid="571">æºç å‚è€ƒåœ°å€ï¼š<a href="https://github.com/wangyapu/mini-rpc" data-nodeid="634">mini-rpc</a></p>
</blockquote>
<h3 data-nodeid="572">æ³¨å†Œä¸­å¿ƒé€‰å‹</h3>
<p data-nodeid="573">æœåŠ¡æ¶ˆè´¹è€…åœ¨å‘èµ· RPC è°ƒç”¨ä¹‹å‰ï¼Œéœ€è¦çŸ¥é“æœåŠ¡æä¾›è€…æœ‰å“ªäº›èŠ‚ç‚¹æ˜¯å¯ç”¨çš„ï¼Œè€Œä¸”æœåŠ¡æä¾›è€…èŠ‚ç‚¹ä¼šå­˜åœ¨ä¸Šçº¿å’Œä¸‹çº¿çš„æƒ…å†µã€‚æ‰€ä»¥æœåŠ¡æ¶ˆè´¹è€…éœ€è¦æ„ŸçŸ¥æœåŠ¡æä¾›è€…çš„èŠ‚ç‚¹åˆ—è¡¨çš„åŠ¨æ€å˜åŒ–ï¼Œåœ¨ RPC æ¡†æ¶ä¸­ä¸€èˆ¬é‡‡ç”¨æ³¨å†Œä¸­å¿ƒæ¥å®ç°æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ã€‚</p>
<p data-nodeid="574">ç›®å‰ä¸»æµçš„æ³¨å†Œä¸­å¿ƒæœ‰ ZooKeeperã€Eurekaã€Etcdã€Consulã€Nacos ç­‰ï¼Œé€‰æ‹©ä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ³¨å†Œä¸­å¿ƒå¯¹ RPC æ¡†æ¶è‡³å…³é‡è¦ã€‚è¯´åˆ°é«˜å¯ç”¨è‡ªç„¶ç¦»ä¸å¼€ CAP ç†è®ºï¼Œä¸€è‡´æ€§ Consistencyã€å¯ç”¨æ€§ Availability å’Œåˆ†åŒºå®¹å¿æ€§ Partition tolerance æ˜¯æ— æ³•åŒæ—¶æ»¡è¶³çš„ï¼Œæ³¨å†Œä¸­å¿ƒä¸€èˆ¬åˆ†ä¸º CP ç±»å‹æ³¨å†Œä¸­å¿ƒå’Œ AP ç±»å‹æ³¨å†Œä¸­å¿ƒã€‚ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„ Zookeeper å°±æ˜¯ CP ç±»å‹çš„æ³¨å†Œä¸­å¿ƒï¼Œé›†ç¾¤ä¸­ä¼šæœ‰ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸º Leaderï¼Œå¦‚æœ Leader èŠ‚ç‚¹æŒ‚äº†ï¼Œä¼šé‡æ–°è¿›è¡Œ Leader é€‰ä¸¾ï¼ŒZooKeeper ä¿è¯äº†æ‰€æœ‰èŠ‚ç‚¹çš„å¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯åœ¨ Leader é€‰ä¸¾çš„è¿‡ç¨‹ä¸­æ˜¯æ— æ³•å¯¹å¤–æä¾›æœåŠ¡çš„ï¼Œç‰ºç‰²äº†éƒ¨åˆ†å¯ç”¨æ€§ã€‚Eureka æ˜¯å…¸å‹çš„ AP ç±»å‹æ³¨å†Œä¸­å¿ƒï¼Œåœ¨å®ç°æœåŠ¡å‘ç°çš„åœºæ™¯ä¸‹æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿ï¼Œæ•´ä¸ªé›†ç¾¤æ˜¯ä¸å­˜åœ¨ Leaderã€Flower æ¦‚å¿µçš„ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œè¯·æ±‚ä¼šç«‹åˆ»è½¬ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚å¯èƒ½ä¼šå­˜åœ¨çš„é—®é¢˜æ˜¯å¦‚æœä¸åŒåˆ†åŒºæ— æ³•è¿›è¡ŒèŠ‚ç‚¹é€šä¿¡ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šé€ æˆèŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®æ˜¯æœ‰å·®å¼‚çš„ï¼Œæ‰€ä»¥ AP ç±»å‹çš„æ³¨å†Œä¸­å¿ƒé€šè¿‡ç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥ä¿è¯é«˜å¯ç”¨æ€§ ã€‚</p>
<p data-nodeid="575">å¯¹äº RPC æ¡†æ¶è€Œè¨€ï¼Œå³ä½¿æ³¨å†Œä¸­å¿ƒå‡ºç°é—®é¢˜ï¼Œä¹Ÿä¸åº”è¯¥å½±å“æœåŠ¡çš„æ­£å¸¸è°ƒç”¨ï¼Œæ‰€ä»¥ AP ç±»å‹çš„æ³¨å†Œä¸­å¿ƒåœ¨è¯¥åœºæ™¯ä¸‹ç›¸æ¯”äº CP ç±»å‹çš„æ³¨å†Œä¸­å¿ƒæ›´æœ‰ä¼˜åŠ¿ã€‚å¯¹äºæˆç†Ÿçš„ RPC æ¡†æ¶è€Œè¨€ï¼Œä¼šæä¾›å¤šç§æ³¨å†Œä¸­å¿ƒçš„é€‰æ‹©ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿è®¾è®¡ä¸€ä¸ªé€šç”¨çš„æ³¨å†Œä¸­å¿ƒæ¥å£ï¼Œç„¶åæ¯ç§æ³¨å†Œä¸­å¿ƒçš„å®ç°éƒ½æŒ‰è¯¥æ¥å£è§„èŒƒè¡Œæ‰©å±•ã€‚</p>
<h3 data-nodeid="576">æ³¨å†Œä¸­å¿ƒæ¥å£è®¾è®¡</h3>
<p data-nodeid="577">æ³¨å†Œä¸­å¿ƒä¸»è¦ç”¨äºå­˜å‚¨æœåŠ¡çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å°†æœåŠ¡å…ƒæ•°æ®ä¿¡æ¯å°è£…æˆä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…æ‹¬æœåŠ¡åç§°ã€æœåŠ¡ç‰ˆæœ¬ã€æœåŠ¡åœ°å€å’ŒæœåŠ¡ç«¯å£å·ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="578"><code data-language="java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceMeta</span> </span>{
&nbsp; &nbsp; <span class="hljs-keyword">private</span> String serviceName;
&nbsp; &nbsp; <span class="hljs-keyword">private</span> String serviceVersion;
&nbsp; &nbsp; <span class="hljs-keyword">private</span> String serviceAddr;
&nbsp; &nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> servicePort;
}
</code></pre>
<p data-nodeid="579">æ¥ä¸‹æ¥æˆ‘ä»¬æä¾›ä¸€ä¸ªé€šç”¨çš„æ³¨å†Œä¸­å¿ƒæ¥å£ï¼Œè¯¥æ¥å£ä¸»è¦çš„æ“ä½œå¯¹è±¡æ˜¯ ServiceMetaï¼Œä¸åº”è¯¥ä¸å…¶ä»–ä»»ä½•ç¬¬ä¸‰æ–¹çš„æ³¨å†Œä¸­å¿ƒå·¥å…·åº“æœ‰ä»»ä½•è”ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<pre class="lang-java" data-nodeid="580"><code data-language="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">RegistryService</span> </span>{
&nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">register</span><span class="hljs-params">(ServiceMeta serviceMeta)</span> <span class="hljs-keyword">throws</span> Exception</span>;
&nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unRegister</span><span class="hljs-params">(ServiceMeta serviceMeta)</span> <span class="hljs-keyword">throws</span> Exception</span>;
&nbsp; &nbsp; <span class="hljs-function">ServiceMeta <span class="hljs-title">discovery</span><span class="hljs-params">(String serviceName, <span class="hljs-keyword">int</span> invokerHashCode)</span> <span class="hljs-keyword">throws</span> Exception</span>;
&nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException</span>;
}
</code></pre>
<p data-nodeid="581">RegistryService æ¥å£åŒ…å«æ³¨å†Œä¸­å¿ƒå››ä¸ªåŸºæœ¬æ“ä½œï¼š<strong data-nodeid="659">æœåŠ¡æ³¨å†Œ register</strong>ã€<strong data-nodeid="660">æœåŠ¡æ³¨é”€ unRegister</strong>ã€<strong data-nodeid="661">æœåŠ¡å‘ç° discovery</strong>ã€<strong data-nodeid="662">æ³¨å†Œä¸­å¿ƒé”€æ¯ destroy</strong>ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥ ZooKeeper æ³¨å†Œä¸­å¿ƒå®ç°ä¸ºä¾‹ï¼Œé€ä¸€å®ç°ä¸Šé¢å››ä¸ªæ¥å£ã€‚</p>
<h3 data-nodeid="582">æ³¨å†Œä¸­å¿ƒåˆå§‹åŒ–å’Œé”€æ¯</h3>
<p data-nodeid="583">Zookeeper å¸¸ç”¨çš„å¼€æºå®¢æˆ·ç«¯å·¥å…·åŒ…æœ‰ ZkClient å’Œ Apache Curatorï¼Œç›®å‰éƒ½æ¨èä½¿ç”¨ Apache Curator å®¢æˆ·ç«¯ã€‚Apache Curator ç›¸æ¯”äº ZkClientï¼Œä¸ä»…æä¾›çš„åŠŸèƒ½æ›´åŠ ä¸°å¯Œï¼Œè€Œä¸”å®ƒçš„æŠ½è±¡å±‚æ¬¡æ›´é«˜ï¼Œæä¾›äº†æ›´åŠ æ˜“ç”¨çš„ API æ¥å£ä»¥åŠ Fluent æµå¼ç¼–ç¨‹é£æ ¼ã€‚åœ¨ä½¿ç”¨ Apache Curator ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ pom.xml ä¸­å¼•å…¥ Maven ä¾èµ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-xml" data-nodeid="584"><code data-language="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
&nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.curator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
&nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>curator-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
&nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.12.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
&nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
&nbsp; &nbsp; <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
&nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.curator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
&nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>curator-recipes<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
&nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.12.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
&nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.curator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
&nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>curator-x-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
&nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.12.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p data-nodeid="585">éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒApache Curator éœ€è¦å’Œ Zookeeeper ç‰ˆæœ¬æ­é…ä½¿ç”¨ï¼Œæœ¬é¡¹ç›®ä½¿ç”¨çš„æ˜¯ Zookeeeper 3.4.14ï¼Œå…³äºç‰ˆæœ¬å…¼å®¹æ€§ä½ éœ€è¦æ›´å¤šå…³æ³¨ Curator å®˜ç½‘ï¼ˆ<a href="https://curator.apache.org" data-nodeid="668">https://curator.apache.org</a>ï¼‰çš„ç‰ˆæœ¬æ›´æ–°è¯´æ˜ã€‚</p>
<p data-nodeid="586">é¦–å…ˆæˆ‘ä»¬éœ€è¦æ„å»º Zookeeeper çš„å®¢æˆ·ç«¯ï¼Œä½¿ç”¨ Apache Curator åˆå§‹åŒ– Zookeeeper å®¢æˆ·ç«¯çš„åŸºäºç”¨æ³•å¤§å¤šéƒ½ä¸å¦‚ä¸‹ä»£ç ç±»ä¼¼ï¼š</p>
<pre class="lang-java" data-nodeid="587"><code data-language="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZookeeperRegistryService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RegistryService</span> </span>{
&nbsp; &nbsp; <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> BASE_SLEEP_TIME_MS = <span class="hljs-number">1000</span>;
&nbsp; &nbsp; <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MAX_RETRIES = <span class="hljs-number">3</span>;
&nbsp; &nbsp; <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String ZK_BASE_PATH = <span class="hljs-string">"/mini_rpc"</span>;
&nbsp; &nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ServiceDiscovery&lt;ServiceMeta&gt; serviceDiscovery;
&nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ZookeeperRegistryService</span><span class="hljs-params">(String registryAddr)</span> <span class="hljs-keyword">throws</span> Exception </span>{
&nbsp; &nbsp; &nbsp; &nbsp; CuratorFramework client = CuratorFrameworkFactory.newClient(registryAddr, <span class="hljs-keyword">new</span> ExponentialBackoffRetry(BASE_SLEEP_TIME_MS, MAX_RETRIES));
&nbsp; &nbsp; &nbsp; &nbsp; client.start();
&nbsp; &nbsp; &nbsp; &nbsp; JsonInstanceSerializer&lt;ServiceMeta&gt; serializer = <span class="hljs-keyword">new</span> JsonInstanceSerializer&lt;&gt;(ServiceMeta.class);
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">this</span>.serviceDiscovery = ServiceDiscoveryBuilder.builder(ServiceMeta.class)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .client(client)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .serializer(serializer)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .basePath(ZK_BASE_PATH)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .build();
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">this</span>.serviceDiscovery.start();
&nbsp; &nbsp; }
}
</code></pre>
<p data-nodeid="588">é€šè¿‡ CuratorFrameworkFactory é‡‡ç”¨å·¥å‚æ¨¡å¼åˆ›å»º CuratorFramework å®ä¾‹ï¼Œæ„é€ å®¢æˆ·ç«¯å”¯ä¸€éœ€ä½ æŒ‡å®šçš„æ˜¯é‡è¯•ç­–ç•¥ï¼Œåˆ›å»ºå®Œ CuratorFramework å®ä¾‹ä¹‹åéœ€è¦è°ƒç”¨ start() è¿›è¡Œå¯åŠ¨ã€‚ç„¶åæˆ‘ä»¬éœ€è¦åˆ›å»º ServiceDiscovery å¯¹è±¡ï¼Œç”± ServiceDiscovery å®ŒæˆæœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ï¼Œåœ¨ç³»ç»Ÿé€€å‡ºçš„æ—¶å€™éœ€è¦å°†åˆå§‹åŒ–çš„å®ä¾‹è¿›è¡Œå…³é—­ï¼Œdestroy() æ–¹æ³•å®ç°éå¸¸ç®€å•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="589"><code data-language="java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{
&nbsp; &nbsp; serviceDiscovery.close();
}
</code></pre>
<h3 data-nodeid="590">æœåŠ¡æ³¨å†Œå®ç°</h3>
<p data-nodeid="591">åˆå§‹åŒ–å¾—åˆ° ServiceDiscovery å®ä¾‹ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†æœåŠ¡å…ƒæ•°æ®ä¿¡æ¯ ServiceMeta å‘å¸ƒåˆ°æ³¨å†Œä¸­å¿ƒï¼Œregister() æ–¹æ³•çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="592"><code data-language="java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">register</span><span class="hljs-params">(ServiceMeta serviceMeta)</span> <span class="hljs-keyword">throws</span> Exception </span>{
&nbsp; &nbsp; ServiceInstance&lt;ServiceMeta&gt; serviceInstance = ServiceInstance
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .&lt;ServiceMeta&gt;builder()
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .name(RpcServiceHelper.buildServiceKey(serviceMeta.getServiceName(), serviceMeta.getServiceVersion()))
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .address(serviceMeta.getServiceAddr())
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .port(serviceMeta.getServicePort())
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .payload(serviceMeta)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .build();
&nbsp; &nbsp; serviceDiscovery.registerService(serviceInstance);
}
</code></pre>
<p data-nodeid="593">ServiceInstance å¯¹è±¡ä»£è¡¨ä¸€ä¸ªæœåŠ¡å®ä¾‹ï¼Œå®ƒåŒ…å«åç§° nameã€å”¯ä¸€æ ‡è¯† idã€åœ°å€ addressã€ç«¯å£ port ä»¥åŠç”¨æˆ·è‡ªå®šä¹‰çš„å¯é€‰å±æ€§ payloadï¼Œæˆ‘ä»¬æœ‰å¿…è¦äº†è§£&nbsp; ServiceInstance åœ¨ Zookeeper æœåŠ¡å™¨ä¸­çš„å­˜å‚¨å½¢å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p data-nodeid="594"><img src="https://s0.lgstatic.com/i/image2/M01/05/42/CgpVE1_-X2qAZ0QwAALfB-0Ouy4852.png" alt="Drawing 0.png" data-nodeid="677"></p>
<p data-nodeid="595">ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šå°†ç›¸åŒç‰ˆæœ¬çš„ RPC æœåŠ¡å½’ç±»åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥å¯ä»¥å°† ServiceInstance çš„åç§° name æ ¹æ®æœåŠ¡åç§°å’ŒæœåŠ¡ç‰ˆæœ¬è¿›è¡Œèµ‹å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<pre class="lang-java" data-nodeid="596"><code data-language="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RpcServiceHelper</span> </span>{
&nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">buildServiceKey</span><span class="hljs-params">(String serviceName, String serviceVersion)</span> </span>{
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> String.join(<span class="hljs-string">"#"</span>, serviceName, serviceVersion);
&nbsp; &nbsp; }
}
</code></pre>
<p data-nodeid="597">åœ¨ã€ŠæœåŠ¡å‘å¸ƒä¸è®¢é˜…ï¼šæ­å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åŸºç¡€æ¡†æ¶ã€‹è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬è®²è§£äº† RpcProvider åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­æ˜¯å¦‚ä½•æ ¹æ® @RpcService æ³¨è§£è¯†åˆ«éœ€è¦å‘å¸ƒçš„æœåŠ¡ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ RegistryService æ¥å£çš„ register() æ–¹æ³•å°†è¯†åˆ«å‡ºçš„æœåŠ¡è¿›è¡Œå‘å¸ƒäº†ï¼Œå®Œå–„åçš„ RpcProvider#postProcessAfterInitialization() æ–¹æ³•å®ç°å¦‚ä¸‹ã€‚</p>
<pre class="lang-java" data-nodeid="598"><code data-language="java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException </span>{
&nbsp; &nbsp; RpcService rpcService = bean.getClass().getAnnotation(RpcService.class);
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (rpcService != <span class="hljs-keyword">null</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; String serviceName = rpcService.serviceInterface().getName();
&nbsp; &nbsp; &nbsp; &nbsp; String serviceVersion = rpcService.serviceVersion();
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">try</span> {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ServiceMeta serviceMeta = <span class="hljs-keyword">new</span> ServiceMeta();
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; serviceMeta.setServiceAddr(serverAddress);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; serviceMeta.setServicePort(serverPort);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; serviceMeta.setServiceName(serviceName);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; serviceMeta.setServiceVersion(serviceVersion);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; serviceRegistry.register(serviceMeta); <span class="hljs-comment">// æ³¨å†ŒæœåŠ¡</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rpcServiceMap.put(RpcServiceHelper.buildServiceKey(serviceMeta.getServiceName(), serviceMeta.getServiceVersion()), bean);
&nbsp; &nbsp; &nbsp; &nbsp; } <span class="hljs-keyword">catch</span> (Exception e) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.error(<span class="hljs-string">"failed to register service {}#{}"</span>, serviceName, serviceVersion, e);
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-keyword">return</span> bean;
}
</code></pre>
<p data-nodeid="599">è‡³æ­¤ï¼ŒæœåŠ¡æä¾›è€…åœ¨å¯åŠ¨åå°±å¯ä»¥å°† @RpcService æ³¨è§£ä¿®é¥°çš„æœåŠ¡å‘å¸ƒåˆ°æ³¨å†Œä¸­å¿ƒäº†ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­çœ‹çœ‹æœåŠ¡æ¶ˆè´¹è€…åº”å½“å¦‚ä½•é€šè¿‡åˆç†çš„è´Ÿè½½å‡è¡¡ç®—æ³•å¾—åˆ°åˆé€‚çš„æœåŠ¡èŠ‚ç‚¹å‘¢ï¼Ÿåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹è´Ÿè½½å‡è¡¡ç®—æ³•çš„åŸºç¡€çŸ¥è¯†ã€‚</p>
<h3 data-nodeid="600">è´Ÿè½½å‡è¡¡ç®—æ³•åŸºç¡€</h3>
<p data-nodeid="601">æœåŠ¡æ¶ˆè´¹è€…åœ¨å‘èµ· RPC è°ƒç”¨ä¹‹å‰ï¼Œéœ€è¦æ„ŸçŸ¥æœ‰å¤šå°‘æœåŠ¡ç«¯èŠ‚ç‚¹å¯ç”¨ï¼Œç„¶åä»ä¸­é€‰å–ä¸€ä¸ªè¿›è¡Œè°ƒç”¨ã€‚ä¹‹å‰æˆ‘ä»¬æåˆ°äº†å‡ ç§å¸¸ç”¨çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼šRound-Robin è½®è¯¢ã€Weighted Round-Robin æƒé‡è½®è¯¢ã€Least Connections æœ€å°‘è¿æ¥æ•°ã€Consistent Hash ä¸€è‡´æ€§ Hash ç­‰ã€‚æœ¬èŠ‚è¯¾æˆ‘ä»¬è®¨è®ºçš„ä¸»è§’æ˜¯åŸºäºä¸€è‡´æ€§ Hash çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œä¸€è‡´æ€§ Hash ç®—æ³•å¯ä»¥ä¿è¯æ¯ä¸ªæœåŠ¡èŠ‚ç‚¹åˆ†æ‘Šçš„æµé‡å°½å¯èƒ½å‡åŒ€ï¼Œè€Œä¸”èƒ½å¤ŸæŠŠæœåŠ¡èŠ‚ç‚¹æ‰©ç¼©å®¹å¸¦æ¥çš„å½±å“é™åˆ°æœ€ä½ã€‚ä¸‹é¢æˆ‘ä»¬ä¸€èµ·çœ‹ä¸‹ä¸€è‡´æ€§ Hash ç®—æ³•çš„è®¾è®¡æ€è·¯ã€‚</p>
<p data-nodeid="602">åœ¨æœåŠ¡ç«¯èŠ‚ç‚¹æ‰©ç¼©å®¹æ—¶ï¼Œä¸€è‡´æ€§ Hash ç®—æ³•ä¼šå°½å¯èƒ½ä¿è¯å®¢æˆ·ç«¯å‘èµ·çš„ RPC è°ƒç”¨è¿˜æ˜¯å›ºå®šåˆ†é…åˆ°ç›¸åŒçš„æœåŠ¡èŠ‚ç‚¹ä¸Šã€‚ä¸€è‡´æ€§ Hash ç®—æ³•æ˜¯é‡‡ç”¨å“ˆå¸Œç¯æ¥å®ç°çš„ï¼Œé€šè¿‡ Hash å‡½æ•°å°†å¯¹è±¡å’ŒæœåŠ¡å™¨èŠ‚ç‚¹æ”¾ç½®åœ¨å“ˆå¸Œç¯ä¸Šï¼Œä¸€èˆ¬æ¥è¯´æœåŠ¡å™¨å¯ä»¥é€‰æ‹© IP + Port è¿›è¡Œ Hashï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p data-nodeid="603"><img src="https://s0.lgstatic.com/i/image2/M01/05/40/Cip5yF_-X3eAC2U7AAVmjGbnvBo221.png" alt="Drawing 1.png" data-nodeid="686"></p>
<p data-nodeid="604">å›¾ä¸­ C1ã€C2ã€C3ã€C4 æ˜¯å®¢æˆ·ç«¯å¯¹è±¡ï¼ŒN1ã€N2ã€N3 ä¸ºæœåŠ¡èŠ‚ç‚¹ï¼Œç„¶ååœ¨å“ˆå¸Œç¯ä¸­é¡ºæ—¶é’ˆæŸ¥æ‰¾è·ç¦»å®¢æˆ·ç«¯å¯¹è±¡ Hash å€¼æœ€è¿‘çš„æœåŠ¡èŠ‚ç‚¹ï¼Œå³ä¸ºå®¢æˆ·ç«¯å¯¹åº”è¦è°ƒç”¨çš„æœåŠ¡èŠ‚ç‚¹ã€‚å‡è®¾ç°åœ¨æœåŠ¡èŠ‚ç‚¹æ‰©å®¹äº†ä¸€å° N4ï¼Œç»è¿‡ Hash å‡½æ•°è®¡ç®—å°†å…¶æ”¾å…¥åˆ°å“ˆå¸Œç¯ä¸­ï¼Œå“ˆå¸Œç¯å˜åŒ–å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p data-nodeid="605"><img src="https://s0.lgstatic.com/i/image/M00/8D/59/Ciqc1F_-X32AB67NAAWtkSEKYRo724.png" alt="Drawing 2.png" data-nodeid="690"></p>
<p data-nodeid="711">æ­¤æ—¶ N2 å’Œ N4 ä¹‹é—´çš„å®¢æˆ·ç«¯å¯¹è±¡éœ€è¦é‡æ–°è¿›è¡Œåˆ†é…ï¼Œå¯ä»¥çœ‹å‡ºåªæœ‰ C3 ä¼šè¢«åˆ†é…åˆ°æ–°çš„èŠ‚ç‚¹ N4 ä¸Šï¼Œå…¶ä»–çš„éƒ½ä¿æŒä¸å˜ã€‚æœåŠ¡èŠ‚ç‚¹ä¸‹çº¿ä¸ä¸Šçº¿çš„å¤„ç†è¿‡ç¨‹æ˜¯ç±»ä¼¼çš„ï¼Œä½ å¯ä»¥è‡ªè¡Œåˆ†æä¸‹æœåŠ¡èŠ‚ç‚¹ä¸‹çº¿æ—¶å“ˆå¸Œç¯æ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚</p>
<p data-nodeid="712" class="te-preview-highlight">å¦‚æœæœåŠ¡èŠ‚ç‚¹çš„æ•°é‡å¾ˆå°‘ï¼Œä¸ç®¡ Hash ç®—æ³•å¦‚ä½•ï¼Œå¾ˆå¤§å¯èƒ½å­˜åœ¨æœåŠ¡èŠ‚ç‚¹è´Ÿè½½ä¸å‡çš„ç°è±¡ã€‚è€Œä¸”ä¸Šå›¾ä¸­åœ¨æ–°å¢æœåŠ¡èŠ‚ç‚¹ N4 æ—¶ï¼Œä»…ä»…åˆ†æ‹…äº† N1 èŠ‚ç‚¹çš„æµé‡ï¼Œå…¶ä»–èŠ‚ç‚¹å¹¶æ²¡æœ‰æµé‡å˜åŒ–ã€‚ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä¸€è‡´æ€§ Hash ç®—æ³•ä¸€èˆ¬ä¼šå¼•å…¥è™šæ‹ŸèŠ‚ç‚¹çš„æ¦‚å¿µã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>


<p data-nodeid="608" class=""><img src="https://s0.lgstatic.com/i/image/M00/8D/64/CgqCHl_-X4WAKf5LAAgqURGXbLE488.png" alt="Drawing 3.png" data-nodeid="695"></p>
<p data-nodeid="609">å›¾ä¸­ç›¸åŒé¢œè‰²è¡¨ç¤ºåŒä¸€ç»„è™šæ‹ŸæœåŠ¡å™¨ï¼Œå®ƒä»¬ç»è¿‡ Hash å‡½æ•°è®¡ç®—åè¢«å‡åŒ€æ”¾ç½®åœ¨å“ˆå¸Œç¯ä¸­ã€‚å¦‚æœçœŸå®çš„æœåŠ¡èŠ‚ç‚¹è¶Šå¤šï¼Œé‚£ä¹ˆæ‰€éœ€çš„è™šæ‹ŸèŠ‚ç‚¹å°±è¶Šå°‘ã€‚åœ¨ä¸ºå®¢æˆ·ç«¯å¯¹è±¡åˆ†é…èŠ‚ç‚¹çš„æ—¶å€™ï¼Œéœ€è¦é¡ºæ—¶é’ˆä»å“ˆå¸Œç¯ä¸­æ‰¾åˆ°è·ç¦»æœ€è¿‘çš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œç„¶åå³å¯ç¡®å®šçœŸå®çš„æœåŠ¡èŠ‚ç‚¹ã€‚</p>
<p data-nodeid="610">æœ‰äº†ä¸Šè¿°ä¸€è‡´æ€§ Hash ç®—æ³•çš„åŸºç¡€çŸ¥è¯†ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ä¸€è‡´æ€§ Hash ç®—æ³•æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<h3 data-nodeid="611">è´Ÿè½½å‡è¡¡ç®—æ³•å®ç°</h3>
<p data-nodeid="612">ä¸æ³¨å†Œä¸­å¿ƒç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿé¦–å…ˆå®šä¹‰ä¸€ä¸ªé€šç”¨çš„è´Ÿè½½å‡è¡¡æ¥å£ï¼ŒRound-Robin è½®è¯¢ã€ä¸€è‡´æ€§ Hash ç­‰è´Ÿè½½å‡è¡¡ç®—æ³•éƒ½éœ€è¦å®ç°è¯¥æ¥å£ï¼Œæ¥å£çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="613"><code data-language="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ServiceLoadBalancer</span>&lt;<span class="hljs-title">T</span>&gt; </span>{
&nbsp; &nbsp; <span class="hljs-function">T <span class="hljs-title">select</span><span class="hljs-params">(List&lt;T&gt; servers, <span class="hljs-keyword">int</span> hashCode)</span></span>;
}
</code></pre>
<p data-nodeid="614">select() æ–¹æ³•çš„ä¼ å…¥å‚æ•°æ˜¯ä¸€æ‰¹æœåŠ¡èŠ‚ç‚¹ä»¥åŠå®¢æˆ·ç«¯å¯¹è±¡çš„ hashCodeï¼Œé’ˆå¯¹ Zookeeper çš„åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„ä¸€è‡´æ€§ Hash ç®—æ³•ã€‚</p>
<pre class="lang-java" data-nodeid="615"><code data-language="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZKConsistentHashLoadBalancer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ServiceLoadBalancer</span>&lt;<span class="hljs-title">ServiceInstance</span>&lt;<span class="hljs-title">ServiceMeta</span>&gt;&gt; </span>{
&nbsp; &nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> VIRTUAL_NODE_SIZE = <span class="hljs-number">10</span>;
&nbsp; &nbsp; <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String VIRTUAL_NODE_SPLIT = <span class="hljs-string">"#"</span>;
&nbsp; &nbsp; <span class="hljs-meta">@Override</span>
&nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">public</span> ServiceInstance&lt;ServiceMeta&gt; <span class="hljs-title">select</span><span class="hljs-params">(List&lt;ServiceInstance&lt;ServiceMeta&gt;&gt; servers, <span class="hljs-keyword">int</span> hashCode)</span> </span>{
&nbsp; &nbsp; &nbsp; &nbsp; TreeMap&lt;Integer, ServiceInstance&lt;ServiceMeta&gt;&gt; ring = makeConsistentHashRing(servers); <span class="hljs-comment">// æ„é€ å“ˆå¸Œç¯</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> allocateNode(ring, hashCode); <span class="hljs-comment">// æ ¹æ® hashCode åˆ†é…èŠ‚ç‚¹</span>
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">private</span> ServiceInstance&lt;ServiceMeta&gt; <span class="hljs-title">allocateNode</span><span class="hljs-params">(TreeMap&lt;Integer, ServiceInstance&lt;ServiceMeta&gt;&gt; ring, <span class="hljs-keyword">int</span> hashCode)</span> </span>{
&nbsp; &nbsp; &nbsp; &nbsp; Map.Entry&lt;Integer, ServiceInstance&lt;ServiceMeta&gt;&gt; entry = ring.ceilingEntry(hashCode); <span class="hljs-comment">// é¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (entry == <span class="hljs-keyword">null</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entry = ring.firstEntry(); <span class="hljs-comment">// å¦‚æœæ²¡æœ‰å¤§äº hashCode çš„èŠ‚ç‚¹ï¼Œç›´æ¥å–ç¬¬ä¸€ä¸ª</span>
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> entry.getValue();
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-keyword">private</span> TreeMap&lt;Integer, ServiceInstance&lt;ServiceMeta&gt;&gt; makeConsistentHashRing(List&lt;ServiceInstance&lt;ServiceMeta&gt;&gt; servers) {
&nbsp; &nbsp; &nbsp; &nbsp; TreeMap&lt;Integer, ServiceInstance&lt;ServiceMeta&gt;&gt; ring = <span class="hljs-keyword">new</span> TreeMap&lt;&gt;();
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">for</span> (ServiceInstance&lt;ServiceMeta&gt; instance : servers) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; VIRTUAL_NODE_SIZE; i++) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ring.put((buildServiceInstanceKey(instance) + VIRTUAL_NODE_SPLIT + i).hashCode(), instance);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> ring;
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">buildServiceInstanceKey</span><span class="hljs-params">(ServiceInstance&lt;ServiceMeta&gt; instance)</span> </span>{
&nbsp; &nbsp; &nbsp; &nbsp; ServiceMeta payload = instance.getPayload();
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> String.join(<span class="hljs-string">":"</span>, payload.getServiceAddr(), String.valueOf(payload.getServicePort()));
&nbsp; &nbsp; }
}
</code></pre>
<p data-nodeid="616">JDK æä¾›äº† TreeMap æ•°æ®ç»“æ„ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ„é€ å“ˆå¸Œç¯ã€‚é€šè¿‡è®¡ç®—å‡ºæ¯ä¸ªæœåŠ¡å®ä¾‹ ServiceInstance çš„åœ°å€å’Œç«¯å£å¯¹åº”çš„ hashCodeï¼Œç„¶åç›´æ¥æ”¾å…¥ TreeMap ä¸­ï¼ŒTreeMap ä¼šå¯¹ hashCode é»˜è®¤ä»å°åˆ°å¤§è¿›è¡Œæ’åºã€‚åœ¨ä¸ºå®¢æˆ·ç«¯å¯¹è±¡åˆ†é…èŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡ TreeMap çš„ ceilingEntry() æ–¹æ³•æ‰¾å‡ºå¤§äºæˆ–ç­‰äºå®¢æˆ·ç«¯ hashCode çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå³ä¸ºå®¢æˆ·ç«¯å¯¹åº”è¦è°ƒç”¨çš„æœåŠ¡èŠ‚ç‚¹ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¤§äºæˆ–ç­‰äºå®¢æˆ·ç«¯ hashCode çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç›´æ¥å» TreeMap ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å³å¯ã€‚</p>
<p data-nodeid="617">è‡³æ­¤ï¼Œä¸€ä¸ªåŸºæœ¬çš„ä¸€è‡´æ€§ Hash ç®—æ³•å·²ç»å®ç°å®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥æŠŠæ³¨å†Œä¸­å¿ƒçš„æœåŠ¡å‘ç° discovery() æ–¹æ³•è¡¥å……å®Œæ•´äº†ã€‚</p>
<h3 data-nodeid="618">æœåŠ¡å‘ç°å®ç°</h3>
<p data-nodeid="619">æœåŠ¡å‘ç°çš„å®ç°æ€è·¯æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆæ‰¾å‡ºè¢«è°ƒç”¨æœåŠ¡æ‰€æœ‰çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œç„¶åé€šè¿‡ ZKConsistentHashLoadBalancer æä¾›çš„ä¸€è‡´æ€§ Hash ç®—æ³•æ‰¾å‡ºç›¸åº”çš„æœåŠ¡èŠ‚ç‚¹ã€‚å…·ä½“ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="620"><code data-language="java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> ServiceMeta <span class="hljs-title">discovery</span><span class="hljs-params">(String serviceName, <span class="hljs-keyword">int</span> invokerHashCode)</span> <span class="hljs-keyword">throws</span> Exception </span>{
&nbsp; &nbsp; Collection&lt;ServiceInstance&lt;ServiceMeta&gt;&gt; serviceInstances = serviceDiscovery.queryForInstances(serviceName);
&nbsp; &nbsp; ServiceInstance&lt;ServiceMeta&gt; instance = <span class="hljs-keyword">new</span> ZKConsistentHashLoadBalancer().select((List&lt;ServiceInstance&lt;ServiceMeta&gt;&gt;) serviceInstances, invokerHashCode);
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (instance != <span class="hljs-keyword">null</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> instance.getPayload();
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
}
</code></pre>
<p data-nodeid="621">æœåŠ¡æ¶ˆè´¹è€…é€šè¿‡åŠ¨æ€ä»£ç†å‘èµ· RPC è°ƒç”¨ä¹‹å‰ï¼Œéœ€è¦é€šè¿‡æœåŠ¡å‘ç°æ¥å£è·å–åˆ°å¯è°ƒç”¨çš„èŠ‚ç‚¹ï¼Œåœ¨ä¸‹èŠ‚è¯¾ã€ŠåŠ¨æ€ä»£ç†ï¼šä¸ºç”¨æˆ·å±è”½ RPC è°ƒç”¨çš„åº•å±‚ç»†èŠ‚ã€‹ä¼šæœ‰ç›¸åº”çš„ä»£ç å®ç°ï¼Œæœ¬èŠ‚è¯¾å…ˆä¸åšå±•å¼€ã€‚</p>
<h3 data-nodeid="622">æ€»ç»“</h3>
<p data-nodeid="623">æœåŠ¡æ³¨å†Œå’Œå‘ç°æ˜¯ RPC æ¡†æ¶ä¸­éå¸¸é‡è¦çš„ä¸€ç¯ï¼Œæœ¬èŠ‚è¯¾æˆ‘ä»¬è®¾è®¡äº†é€šç”¨çš„æ³¨å†Œä¸­å¿ƒæ¥å£ï¼Œå¹¶ç»™å‡ºäº† Zookeeper åœºæ™¯ä¸‹çš„é»˜è®¤å®ç°ã€‚åœ¨æœåŠ¡å‘ç°ä¸­éœ€è¦ä½¿ç”¨åˆ°è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå…¶ä¸­ä¸€è‡´æ€§ Hash ç®—æ³•åœ¨å¾ˆå¤šåœºæ™¯ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œå®ƒå¯ä»¥ä¿è¯æ¯ä¸ªæœåŠ¡èŠ‚ç‚¹åˆ†æ‘Šçš„æµé‡å°½å¯èƒ½å‡åŒ€ï¼Œè€Œä¸”èƒ½å¤ŸæŠŠæœåŠ¡èŠ‚ç‚¹æ‰©ç¼©å®¹å¸¦æ¥çš„å½±å“é™åˆ°æœ€ä½ã€‚å…³äºä¸€è‡´æ€§ Hash ç®—æ³•çš„å®ç°åŸç†åŠ¡å¿…æŒæ¡ï¼Œè¿™ä¹Ÿæ˜¯é¢è¯•ä¸­çš„é«˜é¢‘é—®é¢˜ã€‚</p>
<p data-nodeid="624">æœ€åç•™ä¸¤ä¸ªè¯¾åä»»åŠ¡ï¼š</p>
<ol data-nodeid="625">
<li data-nodeid="626">
<p data-nodeid="627">å¦‚æœä½ å¯¹ Eureka æˆ–è€…å…¶ä»–ç±»å‹çš„æ³¨å†Œä¸­å¿ƒæ¯”è¾ƒç†Ÿæ‚‰ï¼Œä½ å¯ä»¥å°è¯•æ‰©å±• RegistryService æ¥å£å¹¶å®ç°å®ƒã€‚</p>
</li>
<li data-nodeid="628">
<p data-nodeid="629" class="">åœ¨ä¸€è‡´æ€§ Hash ç®—æ³•çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•ä½¿ç”¨äº†æœåŠ¡å®ä¾‹çš„ hashCode ä½œä¸ºå“ˆå¸Œç¯çš„æ„å»ºä¾æ®ï¼Œæ›´å¥½çš„ Hash å‡½æ•°å¯ä»¥å‚è€ƒæ›´åŠ é«˜æ€§èƒ½çš„ MurmurHashï¼ŒGuava å·¥å…·åº“ä¸­å°±æœ‰é»˜è®¤å®ç°ï¼Œä½ å¯ä»¥å¼•å…¥ MurmurHash å¯¹ä¸Šæ–‡ä¸­çš„ä¸€è‡´æ€§ Hash ç®—æ³•å®ç°è¿›è¡Œä¼˜åŒ–ã€‚</p>
</li>
</ol>

---

### ç²¾é€‰è¯„è®º

##### **è¾‰ï¼š
> å¤§å¸ˆï¼Œå—å°å¼Ÿä¸€æ‹œï¼ŒçŒé¡¶äº†ğŸ˜€

##### **æ–‡ï¼š
> è¯¾ç¨‹çœŸçš„æŒºç¡¬æ ¸çš„ï¼Œä¸€ç›´æƒ³å­¦ä¹ å¹¶å®ç°ä¸€ä¸ªrpcæ¡†æ¶ï¼Œè¿™æ¬¡å¯ä»¥è·Ÿç€å¤§å¸ˆç³»ç»Ÿå­¦ä¹ ä¸‹äº†ã€‚


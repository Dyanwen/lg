<h3 data-nodeid="28788" class="">概述</h3>
<p data-nodeid="28789">在上一个小节，我介绍了<strong data-nodeid="28912">案例 3：PyEcharts 订单商品构成模型图</strong>的设计和使用。接下来，我们将进入本课程模块三的 10 课时<strong data-nodeid="28913">案例 4：客户地理位置分布图</strong>设计和使用。本小节是我们 6 个案例中的第 4 个案例，该案例在整个构成模型中的位置如下：</p>
<p data-nodeid="28790"><img src="https://s0.lgstatic.com/i/image/M00/50/2E/CgqCHl9h4m2ARpydAAEltc7Mi84051.png" alt="Drawing 0.png" data-nodeid="28916"></p>
<div data-nodeid="28791"><p style="text-align:center">图 1：章节内容定位</p></div>
<p data-nodeid="28792">上图中，红色部分是我将要在本节介绍的内容：客户地理位置分布图设计和使用。</p>
<p data-nodeid="28793">数据指标卡可以用来监控业务指标的波动范围是否符合预期，历史数据变化趋势用于预测未来，订单商品构成模型用于发现核心元素，<strong data-nodeid="28923">客户地址位置分布一方面可以评估客户营销的效果，另外一方面可以辅助寻找最有价值的客户地理分布，从而辅助决策营销策略的优化和调整</strong>。</p>
<p data-nodeid="28794">数据可视化分析案例部分，我会采用前面的操作流程，分步骤实施，逐项介绍常用的可视化图表的设计和使用方法。通过不断的重复，希望能让你建立一个固定的建设套路和思维模式。</p>
<p data-nodeid="28795"><img src="https://s0.lgstatic.com/i/image/M00/50/23/Ciqc1F9h4n2AGq0pAAEMIeJ0voc647.png" alt="Drawing 1.png" data-nodeid="28927"></p>
<div data-nodeid="28796"><p style="text-align:center">图 2：操作流程</p></div>
<h3 data-nodeid="28797">效果演示</h3>
<p data-nodeid="28798">客户地理位置分布图是通过数据可视化的方式，直观地展示出客户的分布区域，以及每一个区域内的客户数量。本节案例我采用租赁影片的客户的地址位置信息为切入点，通过地图的方式来展示租赁影片的客户大多数是来自哪些国家/地区的，到底哪几个国家/地区的客户数量最多。</p>
<p data-nodeid="28799">图 3 为最终效果图，图中红色的圆点代表租赁影片的客户所在的国家/地区，不同的颜色代表租赁影片的客户数量，其中红色为租赁影片最多的客户所在的国家/地区。</p>
<p data-nodeid="28800"><img src="https://s0.lgstatic.com/i/image/M00/50/2E/CgqCHl9h4oaAIIUEAAWYDgPDVEY059.png" alt="Drawing 2.png" data-nodeid="28933"></p>
<div data-nodeid="28801"><p style="text-align:center">图 3：客户地理位置信息分布图</p></div>
<h3 data-nodeid="28802">图表基础</h3>
<p data-nodeid="28803"><strong data-nodeid="28939">我们可以通过客户地理位置信息分布图，直观地看出客户分布情况以及数量的多少，以及不同区域间客户数量的对比</strong>。</p>
<p data-nodeid="28804">根据统计维度的层级不同，可以展示不同层级下的客户位置信息分布情况，比如从全球层面来看每个国家的客户数量、某个国家的客户数量、某个国家的某个地区的客户数量，层层对比下可以找出客户数量的分布在每个层级的分布情况以及差异。在 Echarts 图表中，全球地图的基本形式如下：</p>
<p data-nodeid="28805"><img src="https://s0.lgstatic.com/i/image/M00/50/2E/CgqCHl9h4o-AUsIqAAMlKC8Dea4512.png" alt="Drawing 3.png" data-nodeid="28943"></p>
<div data-nodeid="28806"><p style="text-align:center">图 4：世界地图</p></div>
<p data-nodeid="28807">世界地图可以查看全球每个国家和地区的数量。此外，我们还可以展示出某一个国家的客户分布数量，比如中国主要分布在哪几个省份，哪些省份的哪些城市分布数量最多。在 Echarts 中，展示形式如下：</p>
<p data-nodeid="28808"><img src="https://s0.lgstatic.com/i/image/M00/50/23/Ciqc1F9h4piAd_wNAAKJfg3tBi8427.png" alt="Drawing 4.png" data-nodeid="28947"></p>
<div data-nodeid="28809"><p style="text-align:center">图 5：中国地图</p></div>
<p data-nodeid="28810">更进一步，我们可以用地图展示某一个省的客户数分布数量，从而进一步分析在这个省份地的内部，哪些区域较为密集，哪些城市客户数量较多，哪些城市客户数量较少，哪些区域没有客户。在 Echarts 中，展示的形式如下：</p>
<p data-nodeid="28811"><img src="https://s0.lgstatic.com/i/image/M00/50/2E/CgqCHl9h4qCAZjbMAAJLvtHOztU066.png" alt="Drawing 5.png" data-nodeid="28951"></p>
<div data-nodeid="28812"><p style="text-align:center">图 6：广东省地图</p></div>
<p data-nodeid="28813">本节案例，我将以全球层级的视角来分析每一个国家/地区租赁影片的客户数分布情况，对比分析每个国家的客户分布数量。</p>
<h3 data-nodeid="28814">业务理解</h3>
<p data-nodeid="35500">业务理解环节，我会带你从业务流程、业务规划、业务活动和总线矩阵这 4 个方面进行梳理。影片租赁业务的业务活动主要包括租赁活动、支付活动和归还活动。具体的业务过程模型如下：</p>
<p data-nodeid="35501"><img src="https://s0.lgstatic.com/i/image/M00/50/28/Ciqc1F9h7F-ASo3uAAB9Qr9aPJE572.png" alt="7.png" data-nodeid="35505"></p>


<div data-nodeid="34856"><p style="text-align:center">图 7：业务过程模型</p></div>
















<p data-nodeid="28818">客户地理位置分布图设计，需要考虑的是参与影片租赁交易的客户的家庭地址，其中影片租借、归还和支付属于一次完整的交易，涉及的客户是同一个对象。因此我们只需要考虑影片租赁活动的客户信息即可。</p>
<h3 data-nodeid="28819">定义指标</h3>
<p data-nodeid="28820">客户地理位置信息分布图能够呈现每个区域的客户数量，具体的指标可以基于我们的业务需求进行选择。对应影片租赁业务的业务活动，我采用了租赁影片的客户数量作为指标。如下表所示：</p>
<table data-nodeid="28822">
<thead data-nodeid="28823">
<tr data-nodeid="28824">
<th data-org-content="指标名称" data-nodeid="28826">指标名称</th>
<th data-org-content="业务逻辑" data-nodeid="28827">业务逻辑</th>
<th data-org-content="计算逻辑" data-nodeid="28828">计算逻辑</th>
</tr>
</thead>
<tbody data-nodeid="28832">
<tr data-nodeid="28833">
<td data-org-content="租赁影片的客户数量" data-nodeid="28834">租赁影片的客户数量</td>
<td data-org-content="租赁影片的客户数量" data-nodeid="28835">租赁影片的客户数量</td>
<td data-org-content="select country,count(distinct rental\_id) as customer\_num&nbsp; from customer\_address<br>group by country" data-nodeid="28836">select country,count(distinct rental_id) as customer_num&nbsp; from customer_address<br>group by country</td>
</tr>
</tbody>
</table>
<div data-nodeid="28837"><p style="text-align:center">表 1：指标定义</p></div>
<h3 data-nodeid="28838">定义维度</h3>
<p data-nodeid="28839">客户地理位置分布图核心是<strong data-nodeid="28981">呈现出不同国家/地区客户数量的分布情况</strong>。我们可以从地理位置这一维度来看客户数量。本案例中地理位置信息维度有 3 个层级，分别为国家、地区、城市。我们选择从国家（地区）角度来看客户的分布情况。</p>
<h3 data-nodeid="28840">设计呈现</h3>
<p data-nodeid="28841">客户地理位置信息分布图的构成同样需要考虑页面布局和主题样式。一个典型的客户地理位置信息分布图的布局设计呈现案例，如下：</p>
<p data-nodeid="28842"><img src="https://s0.lgstatic.com/i/image/M00/50/23/Ciqc1F9h4sCAf6RZAAWYDgPDVEY875.png" alt="Drawing 7.png" data-nodeid="28986"></p>
<div data-nodeid="28843"><p style="text-align:center">图 8：客户地理位置信息分布图</p></div>
<h3 data-nodeid="28844">程序设计</h3>
<h4 data-nodeid="28845">数据理解</h4>
<p data-nodeid="28846">客户地理位置分布图的相关指标在业务模型中的位置如下：</p>
<p data-nodeid="28847"><img src="https://s0.lgstatic.com/i/image/M00/50/2E/CgqCHl9h4sqAVGKQAACBEkNPhKE016.png" alt="Drawing 8.png" data-nodeid="28992"></p>
<div data-nodeid="28848"><p style="text-align:center">图 9：数据主题</p></div>
<p data-nodeid="28849">地理信息表记录了每一个地址的详细信息，包含的字段有地址 ID、地址、地区、所属城市 ID、所在地邮编、电话、经纬度信息、最后更新日期。具体的字段结构和数据样本如下：</p>
<p data-nodeid="28850"><img src="https://s0.lgstatic.com/i/image/M00/50/23/Ciqc1F9h4tSAdLTYAAwwlCfAZk4524.png" alt="Drawing 9.png" data-nodeid="28996"></p>
<div data-nodeid="28851"><p style="text-align:center">图 10：地址信息表</p></div>
<p data-nodeid="28852">城市信息表记录了城市 ID、对应的城市名称、城市所属的国家/地区、最后更新日期。详情如下：</p>
<p data-nodeid="28853"><img src="https://s0.lgstatic.com/i/image/M00/50/23/Ciqc1F9h4t6AbyIDAAbYUYCypgQ122.png" alt="Drawing 10.png" data-nodeid="29000"></p>
<div data-nodeid="28854"><p style="text-align:center">图 11：城市信息表</p></div>
<p data-nodeid="28855">国家/地区信息表记录了国家/地区的 ID、国家/地区的名称、最后更新日期。详情如下：</p>
<p data-nodeid="28856"><img src="https://s0.lgstatic.com/i/image/M00/50/2E/CgqCHl9h4vCAacfKAAZv_AVmxgY419.png" alt="Drawing 11.png" data-nodeid="29004"></p>
<div data-nodeid="28857"><p style="text-align:center">图 12：国家/地区信息表</p></div>
<p data-nodeid="28858">顾客基本信息表记录了每一位顾客的基本信息，包括顾客 ID、门店 ID、顾客姓名、顾客邮箱、地址 ID、是否活跃、创建日期、最后更新日期。具体字段如下：</p>
<p data-nodeid="28859"><img src="https://s0.lgstatic.com/i/image/M00/50/23/Ciqc1F9h4veAcJbDAAC_XnUhuUQ906.png" alt="Drawing 12.png" data-nodeid="29008"></p>
<div data-nodeid="28860"><p style="text-align:center">图 13：顾客基本信息表</p></div>
<p data-nodeid="28861">租赁交易数据记录了详细的交易订单数据，每行记录是一条租赁交易信息，字段包括：交易 ID、交易时间、库存 ID、客户 ID、归还时间、店员 ID，更新日期。具体的字段结构和数据样本如下：</p>
<p data-nodeid="28862"><img src="https://s0.lgstatic.com/i/image/M00/50/2E/CgqCHl9h4wGACSEpAAC_XnUhuUQ486.png" alt="Drawing 13.png" data-nodeid="29012"></p>
<div data-nodeid="28863"><p style="text-align:center">图 14：影片租赁交易信息记录表</p></div>
<h4 data-nodeid="28864">数据准备</h4>
<p data-nodeid="28865">客户地理位置分布图，需要关注的是每个国家/地区的客户数量及其差异点。我们需要知道租赁影片的客户基本信息。通过对租赁交易信息记录表分析得出的数据并不能满足我们的需求，因此我们需要对原始数据加工处理。对于客户数量，我们需要按照国家/地区、城市分组汇总。</p>
<p data-nodeid="28866">要进行汇总，我们需要<strong data-nodeid="29020">基于当前的数据表，创建一个包含所有客户信息的表</strong>，包含租赁 ID、租赁日期、库存 ID、归还日期、员工 ID、顾客 ID、地址 ID、详细地址、地区、城市 ID、城市名称、经纬度信息、国家 ID，国家名称。详情如下：</p>
<p data-nodeid="28867"><img src="https://s0.lgstatic.com/i/image/M00/50/23/Ciqc1F9h4wuAR5eIAA6SbjN8ty0097.png" alt="Drawing 14.png" data-nodeid="29023"></p>
<div data-nodeid="28868"><p style="text-align:center">图 15：租赁客户基本信息数据</p></div>
<p data-nodeid="28869">SQL 脚本如下：</p>
<pre class="lang-java" data-nodeid="28870"><code data-language="java">DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;customer_address;
<span class="hljs-function">CREATE&nbsp;TABLE&nbsp;<span class="hljs-title">customer_address</span><span class="hljs-params">(
SELECT&nbsp;c2.rental_id,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c2.rental_date,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c2.inventory_id,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c2.return_date,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c2.staff_id,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c1.*
FROM(SELECT&nbsp;*&nbsp;from&nbsp;rental&nbsp;)</span>&nbsp;c2
LEFT&nbsp;<span class="hljs-title">JOIN</span>&nbsp;<span class="hljs-params">(
SELECT&nbsp;b1.customer_id,b1.address_id,b1.address,b1.district,b1.city_id,b1.location,b1.city,b1.country_id&nbsp;,b1.country
FROM&nbsp;(
SELECT&nbsp;a1.*,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a2.city,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a2.country_id,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a3.country,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a4.customer_id
FROM&nbsp;address&nbsp;a1,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;city&nbsp;a2,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;country&nbsp;a3,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;customer&nbsp;a4
WHERE&nbsp;a1.city_id&nbsp;=a2.city_id&nbsp;
AND&nbsp;a2.country_id&nbsp;=&nbsp;a3.country_id
AND&nbsp;a1.address_id&nbsp;=&nbsp;a4.address_id
ORDER&nbsp;BY&nbsp;a1.address_id
)</span>b1&nbsp;)&nbsp;c1&nbsp;&nbsp;ON&nbsp;c2.customer_id&nbsp;</span>=&nbsp;c1.customer_id);
</code></pre>
<p data-nodeid="28871"><strong data-nodeid="29029">基于此数据表，我们就可以按照不同的分组对数据进行加工混合，并使用不同种类的汇总数据作为数据组，生成我们图表所需要的数据</strong>。分组汇总的数据如下：</p>
<p data-nodeid="28872"><img src="https://s0.lgstatic.com/i/image/M00/50/2F/CgqCHl9h4ymAQROpAADEI9ehgUg881.png" alt="Drawing 15.png" data-nodeid="29032"></p>
<div data-nodeid="28873"><p style="text-align:center">图 16：各国家/地区的客户数量</p></div>
<p data-nodeid="28874">具体的 SQL 脚本如下：</p>
<pre class="lang-js" data-nodeid="28875"><code data-language="js">select&nbsp;country,count(distinct&nbsp;rental_id)&nbsp;<span class="hljs-keyword">as</span>&nbsp;customer_num&nbsp;&nbsp;<span class="hljs-keyword">from</span>&nbsp;customer_address
group&nbsp;by&nbsp;country
</code></pre>
<h4 data-nodeid="28876">图表设计</h4>
<p data-nodeid="28877"><strong data-nodeid="29038">概述</strong></p>
<p data-nodeid="29740"><strong data-nodeid="29746">图表设计包含数据查询、Echarts 图表元素库的引入、图标渲染</strong>。数据模型是基于具体的业务需求构建的租赁影片信息表，我会依据此模型查询数据，并将查询的数据返回给引入的图表中，调整图表配置的其他参数完成图表的渲染功能，从而完整的呈现出图表。完整的设计流程如下：</p>
<p data-nodeid="31023" class=""><img src="https://s0.lgstatic.com/i/image/M00/50/28/Ciqc1F9h7CqALUrvAACsyTEbYNQ956.png" alt="17.png" data-nodeid="31027"></p>
<div data-nodeid="31024"><p style="text-align:center">图 17：程序设计流程</p></div>








<p data-nodeid="28881"><strong data-nodeid="29050">数据查询</strong></p>
<p data-nodeid="28882">在这里，我引入 PyEcharts 框架中的图表类，作为我们可视化呈现的图表元素。同样的，图表设计包括<strong data-nodeid="29060">数据查询</strong>和<strong data-nodeid="29061">图表创建</strong>两部分。</p>
<p data-nodeid="28883"><strong data-nodeid="29066">数据查询实现与 MySQL 数据库建立连接、读取数据和格式化输出；图表创建包括文件导入、对象声明、参数配置和页面渲染</strong>。不同地区的客户数量查询代码如下：</p>
<pre class="lang-dart" data-nodeid="28884"><code data-language="dart">from&nbsp;pyecharts&nbsp;<span class="hljs-keyword">import</span>&nbsp;options&nbsp;<span class="hljs-keyword">as</span>&nbsp;opts
<span class="hljs-keyword">import</span>&nbsp;pymysql.cursors
from&nbsp;pyecharts.charts&nbsp;<span class="hljs-keyword">import</span>&nbsp;<span class="hljs-built_in">Map</span>
#&nbsp;不同国家/地区顾客数量
def&nbsp;customer_sum_query():
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;连接到数据库
&nbsp;&nbsp;&nbsp;&nbsp;connection&nbsp;=&nbsp;pymysql.connect(host=<span class="hljs-string">'111.231.196.162'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;port=<span class="hljs-number">3306</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user=<span class="hljs-string">'root'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;password=<span class="hljs-string">'zhangzl'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db=<span class="hljs-string">'sakila'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;charset=<span class="hljs-string">'utf8'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cursorclass=pymysql.cursors.DictCursor)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span>:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">with</span>&nbsp;connection.cursor()&nbsp;<span class="hljs-keyword">as</span>&nbsp;cursor:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;SQL&nbsp;查询语句
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sql&nbsp;=&nbsp;<span class="hljs-string">"select&nbsp;country,count(distinct&nbsp;rental_id)&nbsp;as&nbsp;customer_num&nbsp;&nbsp;from&nbsp;customer_address&nbsp;group&nbsp;by&nbsp;country&nbsp;"</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span>:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;执行SQL语句，返回影响的行数
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_count&nbsp;=&nbsp;cursor.execute(sql)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;获取所有记录列表
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;results&nbsp;=&nbsp;cursor.fetchall()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataX&nbsp;=&nbsp;[]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataY&nbsp;=&nbsp;[]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for</span>&nbsp;row&nbsp;<span class="hljs-keyword">in</span>&nbsp;results:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;此处不可以用索引访问：row[<span class="hljs-number">0</span>]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataX.append(row[<span class="hljs-string">"country"</span>])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataY.append(row[<span class="hljs-string">"customer_num"</span>])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;dataX,&nbsp;dataY
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">print</span>(<span class="hljs-string">"错误：数据查询操作失败"</span>)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">finally</span>:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connection.close()
</code></pre>
<p data-nodeid="28885">以上步骤只是完成了 PyEcharts 图表的数据查询，<strong data-nodeid="29072">接下来我们需要绑定和渲染 PyEcharts 图表元素</strong>，客户地理位置信息分布图的绑定和渲染程序如下所示：</p>
<pre class="lang-dart" data-nodeid="28886"><code data-language="dart">#&nbsp;执行主函数
<span class="hljs-keyword">if</span>&nbsp;__name__&nbsp;==&nbsp;<span class="hljs-string">'__main__'</span>:
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">print</span>(customer_sum_query())
&nbsp;&nbsp;&nbsp;&nbsp;dataX,&nbsp;dataY&nbsp;=&nbsp;customer_sum_query()
&nbsp;&nbsp;&nbsp;&nbsp;map&nbsp;=&nbsp;<span class="hljs-built_in">Map</span>(init_opts=opts.InitOpts(width=<span class="hljs-string">"1200px"</span>,&nbsp;height=<span class="hljs-string">"600px"</span>))
&nbsp;&nbsp;&nbsp;&nbsp;map.add(<span class="hljs-string">""</span>,&nbsp;[list(z)&nbsp;<span class="hljs-keyword">for</span>&nbsp;z&nbsp;<span class="hljs-keyword">in</span>&nbsp;zip(dataX,&nbsp;dataY)],&nbsp;<span class="hljs-string">"world"</span>)
&nbsp;&nbsp;&nbsp;&nbsp;map.set_series_opts(label_opts=opts.LabelOpts(is_show=False))
&nbsp;&nbsp;&nbsp;&nbsp;map.set_global_opts(title_opts=opts.TitleOpts(title=<span class="hljs-string">"客户地理位置分布图"</span>),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;visualmap_opts=opts.VisualMapOpts(max_=<span class="hljs-number">1600</span>,&nbsp;split_number=<span class="hljs-number">8</span>,&nbsp;is_piecewise=True)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;map.render(&nbsp;<span class="hljs-string">"customer_address.html"</span>)
</code></pre>
<p data-nodeid="28887">以上程序，通过数据模型调用查询数据，引入 PyEcharts 组件，获取 PyEcharts 图表配置参数，实现 PyEcharts 图表动态渲染。</p>
<h4 data-nodeid="28888">数据验证</h4>
<p data-nodeid="28889">用不同地区的客户数量填充城市的颜色，颜色越深代表客户数量越多。填充完成后会根据颜色展示客户的分布情况，我们可以根据业务情况判断，展示出来的内容是否与实际相符。</p>
<h3 data-nodeid="28890">数据发布</h3>
<p data-nodeid="28891">客户地理位置信息分布图，完成图表渲染后，以网页的形式发布，发布的形式如下：</p>
<p data-nodeid="28892"><img src="https://s0.lgstatic.com/i/image/M00/50/2F/CgqCHl9h41mAH_YKAAWYDgPDVEY612.png" alt="Drawing 17.png" data-nodeid="29080"></p>
<div data-nodeid="28893"><p style="text-align:center">图 18：客户地理位置信息分布图</p></div>
<h3 data-nodeid="28894">分析洞察</h3>
<p data-nodeid="28895">客户地理位置信息分布图的分析方法是：<strong data-nodeid="29087">通过红色圆点的数量来观察客户分布的城市个数和密集程度，通过不同的颜色来渲染不同地区客户分布数量</strong>。</p>
<p data-nodeid="28896">以图 18 为例，我们通过图 18 可以得到以下结论：</p>
<p data-nodeid="28897"><strong data-nodeid="29093">不同区域的客户分布密集程度不同。</strong> 客户在欧洲地区分布较为密集，其次是亚洲地区、非洲地区，而北美洲、南美洲、大洋洲客户密集程度较低。</p>
<p data-nodeid="28898">租赁影片的客户来自一共来自世界 108 个国家/地区，其中欧洲地区有法国、西班牙、苏黎世等 30 个国家；非洲地区有苏丹、利比亚、阿尔及利亚等 28 个国家；亚洲和其他洲则一共有 50 个国家。</p>
<p data-nodeid="28899"><strong data-nodeid="29099">不同国家的客户分布数量差异较大。</strong> 亚洲地区，印度、中国的客户数量最多，分别有 1576、1426 人；其次是北美的美国和墨西哥、巴西，分别有 968、825、798 个客户；其他国家的客户数量则较少。</p>
<h3 data-nodeid="28900">小结</h3>
<p data-nodeid="28901" class="">本节内容介绍了客户地理位置分布的相关情况，包括业务理解、指标设计、维度设计、图表设计、数据验证、数据发布和分析洞察等 7 个方面。希望通过本节内容的学习，你能够掌握地理位置信息的使用场景、设计方法和图表的使用方法。</p>

---

### 精选评论

##### **彪：
> 案例的数据可以提供给我们做练习吗

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 案例和数据已经统一放到了github我的个人目录下面，可以自己下载，具体地址：https://github.com/zhangziliang04/datastudio


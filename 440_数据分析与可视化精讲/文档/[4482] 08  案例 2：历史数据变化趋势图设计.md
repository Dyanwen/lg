<p data-nodeid="1689" class="">在 07 课时，我介绍了案例 1：PyEcharts 实时数据监控指标卡的设计和使用。接下来，我们进入案例 2：历史数据变化趋势图设计。该案例在整个数据可视化分析构成模型中的位置如下图所示：</p>
<p data-nodeid="1690"><img src="https://s0.lgstatic.com/i/image/M00/4C/D3/CgqCHl9Ym8WANeguAAFAODwcUzg548.png" alt="Drawing 0.png" data-nodeid="1830"></p>
<div data-nodeid="1691"><p style="text-align:center">图 1：章节内容定位</p></div>
<p data-nodeid="1692">上图中，橙色部分是我们本节将要进行介绍的内容：历史数据变化趋势图。</p>
<p data-nodeid="1693">实时监控数据指标卡用于呈现业务和发现业务问题，一旦发现指标异常，就需要引入多个不同的维度，对问题进行分析和判断。</p>
<p data-nodeid="1694">时间维度，即该指标的历史趋势，是要首先考虑的。<strong data-nodeid="1842">历史趋势分析问题的价值在于：一方面，进一步判断该异常是否在合理的范围之内；另外一方面，判断该异常是否具有周期性的特征</strong>。同时，<strong data-nodeid="1843">历史数据变化趋势图，也可以用于发展趋势预测</strong>。</p>
<p data-nodeid="1695">数据可视化分析的案例部分，我们采用前面的操作流程，分步骤实施，逐项介绍常用的可视化图表的设计和使用方法。通过不断重复，希望大家能够建立起一个固定的建设套路和思维模式。</p>
<p data-nodeid="1696"><img src="https://s0.lgstatic.com/i/image/M00/4C/C7/Ciqc1F9Ym92AEMh6AAEvLmL87Gk847.png" alt="Drawing 1.png" data-nodeid="1847"></p>
<div data-nodeid="1697"><p style="text-align:center">图 2：操作流程</p></div>
<h3 data-nodeid="1698">效果演示</h3>
<p data-nodeid="1699">历史数据变化趋势图，通过数据可视化的方式，呈现业务指标的历史变化趋势；通过业务指标曲线的平滑程度和总体变化趋势，呈现该指标是否异常和指标的总体变化趋势。以影片租赁系统为例，其订单历史变化趋势图的运行效果如下图所示：</p>
<p data-nodeid="1700"><img src="https://s0.lgstatic.com/i/image/M00/4C/C7/Ciqc1F9Ym-uAJcG-AADkE6_v9xM641.png" alt="Drawing 2.png" data-nodeid="1852"></p>
<div data-nodeid="1701"><p style="text-align:center">图 3：订单历史变化趋势图</p></div>
<h3 data-nodeid="1702">图表基础</h3>
<p data-nodeid="9405" class=""><strong data-nodeid="9410">历史数据变化趋势图，多用于监控历史数据趋势，旨在反映目标业务指标随时间变化的历史趋势</strong>，如订单历史变化趋势、交易额历史变化趋势、商品库存历史变化趋势等。</p>










<p data-nodeid="1704">通常情况下，历史数据变化趋势图的价值在于，<strong data-nodeid="1872">对历史业务状态的呈现</strong>，以及<strong data-nodeid="1873">基于历史状态趋势判断当前实时数据是否符合预期</strong>，<strong data-nodeid="1874">基于线性回归预测下一个阶段的指标变化</strong>等。一个最基本的历史数据变化趋势图，在 Echarts 标准图表中，通常以基本折线图的形式呈现。其基本形态是一个二维坐标轴，横轴代表时间，纵轴代表指标值。如下图所示：</p>
<p data-nodeid="1705"><img src="https://s0.lgstatic.com/i/image/M00/4C/C7/Ciqc1F9Ym_mAPzVyAABuaINURIk364.png" alt="Drawing 3.png" data-nodeid="1877"></p>
<div data-nodeid="1706"><p style="text-align:center">图 4：基本折线图</p></div>
<p data-nodeid="1707"><strong data-nodeid="1881">为了增强基本折线图的表现能力，尤其是强调数据量随时间变化的程度，引起人们对总值趋势的注意，历史数据变化趋势图也会采用面积图的形式。</strong></p>
<p data-nodeid="1708"><strong data-nodeid="1886">面积图是在折线图的基础之上形成的。它会使用颜色或者纹理填充折线图中的折线与自变量坐标轴之间的区域，这样一个填充区域我们叫作面积。</strong> 颜色的填充可以更好地突出趋势信息。</p>
<p data-nodeid="1709">需要注意的是<strong data-nodeid="1892">颜色要带有一定的透明度</strong>，透明度可以很好地帮助使用者观察不同序列之间的重叠关系，没有透明度的面积会导致不同序列之间相互遮盖，会导致可以被观察到的信息减少。一个典型的面积图结构如下所示：</p>
<p data-nodeid="1710"><img src="https://s0.lgstatic.com/i/image/M00/4C/D3/CgqCHl9YnASAWVd0AAEj21J2t5k033.png" alt="Drawing 4.png" data-nodeid="1895"></p>
<div data-nodeid="1711"><p style="text-align:center">图 5：面积图</p></div>
<p data-nodeid="1712"><strong data-nodeid="1900">基本折线图和面积图，除了展示某个指标发展的趋势，还可以用来比较多个不同的指标的数据序列</strong>。通过对比同时间段多个不同指标的值，可以分析哪一种指标的数据表现更好。一个典型的多指标折线图结构如下所示：</p>
<p data-nodeid="1713"><img src="https://s0.lgstatic.com/i/image/M00/4C/C8/Ciqc1F9YnA-ASu8EAAEJLnnlwWY348.png" alt="Drawing 5.png" data-nodeid="1903"></p>
<div data-nodeid="1714"><p style="text-align:center">图 6：多指标折线图</p></div>
<h3 data-nodeid="1715">业务理解</h3>
<p data-nodeid="1716">业务理解环节，我们需要从<strong data-nodeid="1922">业务流程</strong>、<strong data-nodeid="1923">业务规则</strong>、<strong data-nodeid="1924">业务活动</strong>和<strong data-nodeid="1925">总线矩阵</strong>这 4 个方面进行梳理。</p>
<p data-nodeid="1717">为了简化业务，避免专业的业务领域知识成为学习的门槛，聚焦数据可视化分析本身，我选择了比较简单的影片租赁业务场景。影片租赁业务的业务活动主要包括租赁活动、支付活动和归还活动。具体的业务过程模型如下图所示：</p>
<p data-nodeid="1718"><img src="https://s0.lgstatic.com/i/image/M00/4C/C8/Ciqc1F9YnByARwtCAABj7k63KY4516.png" alt="Drawing 6.png" data-nodeid="1929"></p>
<div data-nodeid="1719"><p style="text-align:center">图 7：业务过程模型</p></div>
<h3 data-nodeid="1720">定义指标</h3>
<p data-nodeid="1721">历史数据变化趋势图，可以用来呈现任何需要的、具有时间序列特征的指标。具体的指标可以基于业务需求选择。</p>
<p data-nodeid="1722">影片租赁业务共涉及 3 个主要的业务活动，具体需要考虑的指标为：订单量、交易额、库存量。本案例中，我们选择订单量作为我们分析的指标。关于以上 3 个指标定义如下表所示：</p>
<table data-nodeid="22865">
<thead data-nodeid="22866">
<tr data-nodeid="22867">
<th align="center" data-org-content="指标名称" data-nodeid="22869">指标名称</th>
<th data-org-content="业务逻辑" data-nodeid="22870">业务逻辑</th>
<th align="center" data-org-content="计算逻辑" data-nodeid="22871" class="">计算逻辑</th>
<td data-nodeid="22867"></td>
</tr>
</thead>
<tbody data-nodeid="22876">
<tr data-nodeid="22877">
<td align="center" data-org-content="订单量" data-nodeid="22878">订单量</td>
<td data-org-content="当日出租影片的数量和" data-nodeid="22879">当日出租影片的数量和</td>
<td align="center" data-org-content="SELECT \* FROM dm\_rental\_day ORDER BY 日期 ASC" data-nodeid="22880">SELECT * FROM dm_rental_day ORDER BY 日期 ASC</td>
<td data-nodeid="22881"></td>
</tr>
<tr data-nodeid="22882">
<td align="center" data-org-content="交易额" data-nodeid="22883">交易额</td>
<td data-org-content="当日出租影片的收入和" data-nodeid="22884">当日出租影片的收入和</td>
<td align="center" data-nodeid="22885"></td>
<td data-nodeid="22886"></td>
</tr>
<tr data-nodeid="22887">
<td align="center" data-org-content="库存量" data-nodeid="22888">库存量</td>
<td data-org-content="当日库存影片的数量和" data-nodeid="22889">当日库存影片的数量和</td>
<td align="center" data-nodeid="22890"></td>
<td data-nodeid="22891"></td>
</tr>
</tbody>
</table>




<div data-nodeid="1752"><p style="text-align:center">表 1：指标定义</p></div>
<h3 data-nodeid="1753">定义维度</h3>
<p data-nodeid="1754">历史数据变化趋势的核心是：<strong data-nodeid="1956">呈现指标随时间变化的趋势</strong>。因此，通常情况下，只需要考虑时间维度，而且在时间维度中，只考虑时间段，而非时间点。</p>
<p data-nodeid="1755">时间维度是有粒度的，常用时间粒度包括：秒、分钟、5 分钟、15 分钟、小时、日、周、月、季和年。时间粒度可以基于业务需求进行选择，本案例中，我们选择日作为时间维度的粒度。</p>
<h3 data-nodeid="1756">设计呈现</h3>
<p data-nodeid="1757">历史数据变化趋势图的设计需要考虑页面布局、主题样式，尤其是折线样式的设计。历史数据变化趋势图通常作为数据仪表盘的一部分存在，它的呈现设计一方面包括图表呈现，另外一方面也包括页面布局。</p>
<p data-nodeid="33927" class=""><strong data-nodeid="33940">通常情况下，历史数据变化趋势图，位于数据仪表盘数据指标卡的下方，单图成行或者横向并行排列，超出的部分另起一行</strong>。一个典型的历史数据变化趋势图的布局设计呈现案例如下所示，其中包括<strong data-nodeid="33941">时间序列</strong>和<strong data-nodeid="33942">指标数据序列</strong>。</p>














<p data-nodeid="1759"><img src="https://s0.lgstatic.com/i/image/M00/4C/D3/CgqCHl9YnFeALevSAAEBSSblseY245.png" alt="Drawing 7.png" data-nodeid="1967"></p>
<div data-nodeid="35953" class=""><p style="text-align:center">图 8：页面布局</p></div>





<h3 data-nodeid="1764">程序设计</h3>
<h4 data-nodeid="1765">数据理解</h4>
<p data-nodeid="14263" class="">影片租赁交易数据实时监控核心指标，位于影片租赁交易业务模型中的交易、支付和库存主题。实时监控核心指标涉及的相关主题在业务模型中的位置如下图所示：</p>






<p data-nodeid="1767"><img src="https://s0.lgstatic.com/i/image/M00/4C/C8/Ciqc1F9YnH-Ab7g1AADLfqVbWfM791.png" alt="Drawing 9.png" data-nodeid="1987"></p>
<div data-nodeid="37931" class=""><p style="text-align:center">图 9：数据主题</p></div>



<p data-nodeid="15875" class="">租赁交易数据记录了详细的交易订单数据，每行记录是一条租赁交易信息，字段包括：交易 ID、交易时间、库存 ID、客户 ID、归还时间、店员 ID、更新日期。具体的字段结构和数据样本如下图所示：</p>


<p data-nodeid="1770"><img src="https://s0.lgstatic.com/i/image/M00/4C/D3/CgqCHl9YnIiAVdeXAAC_XnUhuUQ716.png" alt="Drawing 10.png" data-nodeid="1991"></p>
<div data-nodeid="39513" class=""><p style="text-align:center">图 10：交易订单数据</p></div>


<p data-nodeid="1772">支付交易数据记录了详细的订单支付数据，每行记录是一条支付记录，字段包括：支付 ID、客户 ID、店员 ID、交易 ID、金额、支付时间、更新时间。具体的字段结构和数据样本如下图所示：</p>
<p data-nodeid="1773"><img src="https://s0.lgstatic.com/i/image/M00/4C/C8/Ciqc1F9YnI-AMgpzAADDhdUFYHs727.png" alt="Drawing 11.png" data-nodeid="1995"></p>
<div data-nodeid="41095" class=""><p style="text-align:center">图 11：订单支付数据</p></div>


<p data-nodeid="1775">库存数据记录了当前各门店的影片库存情况，具体的字段结构和数据样本如下图所示：</p>
<p data-nodeid="1776"><img src="https://s0.lgstatic.com/i/image/M00/4C/D4/CgqCHl9YnJqACY7OAABuOhD3L9g361.png" alt="Drawing 12.png" data-nodeid="1999"></p>
<div data-nodeid="42677" class=""><p style="text-align:center">图 12：库存商品数据</p></div>


<h4 data-nodeid="1778">数据准备</h4>
<p data-nodeid="1779">按照我在 07 课时中介绍的，我们按照“日”将数据聚合，并使用当天的订单量数据作为数据指标卡的数值。但是当前“日”交易明细数据表中，交易时间的字段是精确到分钟的，所以需要将交易时间列，转换成需要排序的年-月-日格式，然后生成新的交易日汇总报表。新交易日报的结构如下图所示：</p>
<p data-nodeid="1780"><img src="https://s0.lgstatic.com/i/image/M00/4C/C8/Ciqc1F9YnKaAJ-_qAAAvtdQMdmE064.png" alt="Drawing 13.png" data-nodeid="2004"></p>
<div data-nodeid="43468" class=""><p style="text-align:center">图 13：订单交易日报</p></div>

<p data-nodeid="1782">具体的处理方式是基于当前订单量明细数据，创建一个新的订单量日汇总数据表。详细的 SQL 脚本如下所示：</p>
<pre class="lang-js" data-nodeid="1783"><code data-language="js">DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;dm_rental_day;
CREATE&nbsp;TABLE&nbsp;dm_rental_day&nbsp;(SELECT&nbsp;DATE_FORMAT(rental_date,<span class="hljs-string">'%Y-%m-%d'</span>)&nbsp;<span class="hljs-keyword">as</span>&nbsp;日期,&nbsp;&nbsp;COUNT(rental_id)&nbsp;<span class="hljs-keyword">as</span>&nbsp;订单量&nbsp;FROM&nbsp;rental&nbsp;GROUP&nbsp;BY&nbsp;日期&nbsp;ORDER&nbsp;BY&nbsp;日期&nbsp;DESC);
</code></pre>
<p data-nodeid="1784">针对交易额指标，我们需要按照日进行数据聚合，并使用当天的交易额数据，作为数据指标卡的数值。但是当前日订单明细数据表中支付时间的字段是精确到分钟的，因此需要将支付时间列，转换成需要排序的年月日格式，并生成新的支付日汇总报表。支付日报的结构如下图所示：</p>
<p data-nodeid="1785"><img src="https://s0.lgstatic.com/i/image/M00/4C/C8/Ciqc1F9YnLaAFQAzAAA7VWHsmHs314.png" alt="Drawing 14.png" data-nodeid="2009"></p>
<div data-nodeid="44259" class=""><p style="text-align:center">图 14：订单支付日报</p></div>

<p data-nodeid="1787">具体的处理方式为：基于当前订单支付明细数据，创建一个新的订单支付日汇总数据表，详细的 SQL 脚本如下所示：</p>
<pre class="lang-js" data-nodeid="1788"><code data-language="js">DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;dm_payment_day;
CREATE&nbsp;TABLE&nbsp;dm_payment_day&nbsp;(SELECT&nbsp;DATE_FORMAT(payment_date,<span class="hljs-string">'%Y-%m-%d'</span>)&nbsp;<span class="hljs-keyword">as</span>&nbsp;日期,&nbsp;&nbsp;SUM(amount)&nbsp;<span class="hljs-keyword">as</span>&nbsp;金额&nbsp;&nbsp;FROM&nbsp;payment&nbsp;GROUP&nbsp;BY&nbsp;日期&nbsp;ORDER&nbsp;BY&nbsp;日期&nbsp;DESC);
</code></pre>
<h4 data-nodeid="1789">图表设计</h4>
<h5 data-nodeid="1790">概述</h5>
<p data-nodeid="1791">上一节我们引入了 Bootstrap 实现了数据指标卡，本节开始，我会教你如何采用 PyEcharts 框架生成单页面的可视化图表。</p>
<p data-nodeid="1792">图表设计包括数据查询和图表创建两个部分。<strong data-nodeid="2019">数据查询实现与 MySQL 数据库建立连接、读取数据和格式化输出；图表创建包括文件导入、对象声明、参数配置和页面渲染</strong>。完整的程序设计流程如下图所示：</p>
<p data-nodeid="1793"><img src="https://s0.lgstatic.com/i/image/M00/4C/D4/CgqCHl9YnMyAdkL0AACpqD4sAB0451.png" alt="Drawing 15.png" data-nodeid="2022"></p>
<div data-nodeid="45050" class=""><p style="text-align:center">图 15：程序设计流程</p></div>

<h5 data-nodeid="1795">数据查询</h5>
<p data-nodeid="1796">历史变化趋势图的数据查询程序，负责从数据准备中生成的影片信息表中，按日查询租赁的影片量，并返回给调用程序。日订单量查询代码如下：</p>
<pre class="lang-dart" data-nodeid="1797"><code data-language="dart">from&nbsp;pyecharts&nbsp;<span class="hljs-keyword">import</span>&nbsp;options&nbsp;<span class="hljs-keyword">as</span>&nbsp;opts
<span class="hljs-keyword">import</span>&nbsp;pymysql.cursors
from&nbsp;pyecharts.charts&nbsp;<span class="hljs-keyword">import</span>&nbsp;Line

def&nbsp;pay_sum_query():
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;连接到数据库
&nbsp;&nbsp;&nbsp;&nbsp;connection&nbsp;=&nbsp;pymysql.connect(host=<span class="hljs-string">'111.231.196.162'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;port=<span class="hljs-number">3306</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user=<span class="hljs-string">'root'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;password=<span class="hljs-string">'XXXXXX'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db=<span class="hljs-string">'sakila'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;charset=<span class="hljs-string">'utf8'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cursorclass=pymysql.cursors.DictCursor)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span>:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">with</span>&nbsp;connection.cursor()&nbsp;<span class="hljs-keyword">as</span>&nbsp;cursor:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;SQL&nbsp;查询语句
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sql&nbsp;=&nbsp;<span class="hljs-string">"SELECT&nbsp;*&nbsp;FROM&nbsp;dm_payment_day&nbsp;ORDER&nbsp;BY&nbsp;日期&nbsp;DESC"</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span>:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;执行 SQL 语句，返回影响的行数
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_count&nbsp;=&nbsp;cursor.execute(sql)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;获取所有记录列表
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;results&nbsp;=&nbsp;cursor.fetchall()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataX&nbsp;=&nbsp;[]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataY&nbsp;=&nbsp;[]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for</span>&nbsp;row&nbsp;<span class="hljs-keyword">in</span>&nbsp;results:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;此处不可以用索引访问：row[<span class="hljs-number">0</span>]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataX.append(row[<span class="hljs-string">"日期"</span>])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataY.append(row[<span class="hljs-string">"金额"</span>])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;打印结果

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;dataX,&nbsp;dataY
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">print</span>(<span class="hljs-string">"错误：数据查询操作失败"</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">print</span>(<span class="hljs-string">"日期：%s,交易额：%.2f"</span>&nbsp;%&nbsp;(dataX,&nbsp;dataY))
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">finally</span>:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connection.close()
</code></pre>
<p data-nodeid="1798">以上步骤只是完成了数据查询，并且返回对应的日期和交易额。接下来，我们看一下如何创建图表 PyEcharts 图表元素。</p>
<h5 data-nodeid="1799">图表创建</h5>
<p data-nodeid="1800">历史变化趋势图的图表创建程序设计，我们引入了 PyEcharts 框架中的图表类，作为我们可视化呈现的图表元素。PyEcharts 图表程序设计部分需要完成 4 个步骤：<strong data-nodeid="2044">文件导入</strong>、<strong data-nodeid="2045">对象声明</strong>、<strong data-nodeid="2046">参数配置</strong>和<strong data-nodeid="2047">页面渲染</strong>。具体的图表创建程序如下所示：</p>
<pre class="lang-dart" data-nodeid="1801"><code data-language="dart"># 文件导入
from&nbsp;pyecharts&nbsp;<span class="hljs-keyword">import</span>&nbsp;options&nbsp;<span class="hljs-keyword">as</span>&nbsp;opts
<span class="hljs-keyword">import</span>&nbsp;pymysql.cursors
from&nbsp;pyecharts.charts&nbsp;<span class="hljs-keyword">import</span>&nbsp;Line
#&nbsp;执行主函数
<span class="hljs-keyword">if</span>&nbsp;__name__&nbsp;==&nbsp;<span class="hljs-string">'__main__'</span>:
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">print</span>(order_sum_query())
# 数据查询
&nbsp;&nbsp;&nbsp;&nbsp;dataX,&nbsp;dataY&nbsp;=&nbsp;order_sum_query()
# 对象声明
&nbsp;&nbsp;&nbsp;&nbsp;line&nbsp;=&nbsp;Line()
&nbsp;&nbsp;&nbsp;&nbsp;line.add_xaxis(dataX)
&nbsp;&nbsp;&nbsp;&nbsp;line.add_yaxis(<span class="hljs-string">"订单量"</span>,&nbsp;dataY,&nbsp;is_smooth=True)
&nbsp;&nbsp;&nbsp;&nbsp;line.set_global_opts(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;title_opts=opts.TitleOpts(title=<span class="hljs-string">"日订单量历史数据趋势图"</span>),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yaxis_opts=opts.AxisOpts(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type_=<span class="hljs-string">"value"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;axistick_opts=opts.AxisTickOpts(is_show=True),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;splitline_opts=opts.SplitLineOpts(is_show=True),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xaxis_opts=opts.AxisOpts(type_=<span class="hljs-string">"category"</span>,&nbsp;boundary_gap=False)
&nbsp;&nbsp;&nbsp;&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;line.render(&nbsp;)
</code></pre>
<p data-nodeid="1802">以上程序，会创建了一个折线图，生成一个 HTML 页面文件。该折线图的数据来自数据查询部分输出的数据。</p>
<h4 data-nodeid="1803">数据验证</h4>
<p data-nodeid="1804"><strong data-nodeid="2054">历史数据趋势图会通过折线图的曲线变化，呈现指标数据的变化情况</strong>。历史数据趋势图的数据验证方法主要是检查数据离异点和总体趋势变化情况。如果发现某个时间点，特定指标发生了剧烈的变化，则需要进一步通过指标拆解的方式，查看引起数据异常的具体原因。</p>
<h3 data-nodeid="1805">数据发布</h3>
<p data-nodeid="1806">历史数据变化趋势图，通常作为 Dashboard 页面的一部分，和指标卡一起构成仪表盘，通常以网页的形式呈现。本环节结合上一小节介绍的实时监控指标卡，一起发布，发布后的页面如下图所示：</p>
<p data-nodeid="1807"><img src="https://s0.lgstatic.com/i/image/M00/4C/D4/CgqCHl9YnO-AR96kAAEerq2j938057.png" alt="Drawing 16.png" data-nodeid="2059"></p>
<div data-nodeid="45841" class=""><p style="text-align:center">图 16：历史数据变化趋势图页面</p></div>

<h3 data-nodeid="1809">分析洞察</h3>
<p data-nodeid="1810"><strong data-nodeid="2073">历史数据变化趋势图的分析方法，是通过数据可视化曲线的平滑程度和总体变化趋势进行判断</strong>。判断的基本逻辑是：<strong data-nodeid="2074">是否有异常点出现</strong>，<strong data-nodeid="2075">变化趋势是平滑向上还是平滑向下</strong>。以订单历史数据变化趋势图为例，其变化趋势如下图所示：</p>
<p data-nodeid="1811"><img src="https://s0.lgstatic.com/i/image/M00/4C/D4/CgqCHl9YnPqAQa32AAEazB3jH5o189.png" alt="Drawing 17.png" data-nodeid="2078"></p>
<div data-nodeid="46632" class=""><p style="text-align:center">图 17：分析洞察</p></div>

<p data-nodeid="1813">通过上图我们可以发现两点：</p>
<ol data-nodeid="1814">
<li data-nodeid="1815">
<p data-nodeid="1816">随着时间变化，订单量逐月增加。</p>
</li>
<li data-nodeid="1817">
<p data-nodeid="1818">每隔一段时间，总有一天订单量会发生异常。</p>
</li>
</ol>
<p data-nodeid="1819">承接上一个小节，我介绍的指标卡内容，会发现 2005.08.16、2005.07.26、2005.07.05 等几个时间点的日交易量，环比数据会发生较大的波动。</p>
<p data-nodeid="1820">通过趋势图，我们可以得出同样的结论，并能够发现该异常数据具有一定的时间间隔的特征。通过查看日历，发现以上几个数据异常时间点，都发生在周二。</p>
<p data-nodeid="1821"><img src="https://s0.lgstatic.com/i/image/M00/4C/D4/CgqCHl9YnQWAcVgkAADjicSbHmk037.png" alt="Drawing 18.png" data-nodeid="2086"></p>
<div data-nodeid="47423" class=""><p style="text-align:center">图 18：日历查询</p></div>

<p data-nodeid="19905" class="">要想发现数据异常的具体原因，这时候就可以和店员确认， 2005 年 7~8 月份的星期二发生了什么。</p>





<h3 data-nodeid="1824">小结</h3>
<p data-nodeid="1825">本节内容，我介绍了历史数据变化趋势图的相关情况，包括业务理解、指标设计、维度设计、图表设计、数据验证、数据发布和分析洞察共 7 个方面。希望通过本节内容的学习，你能够掌握历史数据变化趋势图的使用场景、设计方法和图表的使用方法。</p>
<p data-nodeid="1826" class="">历史数据变化趋势图，可以通过引入时间维度可以帮助我们分析业务问题，但是通常情况下，这样做还不够，我们还需要引入更多的维度来分析异常指标。</p>

---

### 精选评论



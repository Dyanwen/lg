<p data-nodeid="61296" class="">åœ¨ä¸Šä¸€è¯¾æ—¶ï¼Œæˆ‘ä»¬ä»‹ç»äº† Router æ¥å£çš„åŸºæœ¬åŠŸèƒ½ä»¥åŠ RouterChain åŠ è½½å¤šä¸ª Router çš„å®ç°ï¼Œä¹‹åä»‹ç»äº† ConditionRouter è¿™ä¸ªç±»å¯¹æ¡ä»¶è·¯ç”±è§„åˆ™çš„å¤„ç†é€»è¾‘ä»¥åŠ ScriptRouter è¿™ä¸ªç±»å¯¹è„šæœ¬è·¯ç”±è§„åˆ™çš„å¤„ç†é€»è¾‘ã€‚æœ¬è¯¾æ—¶æˆ‘ä»¬ç»§ç»­ä¸Šä¸€è¯¾æ—¶çš„å†…å®¹ï¼Œä»‹ç»å‰©ä½™çš„ä¸‰ä¸ª Router æ¥å£å®ç°ç±»ã€‚</p>
<h3 data-nodeid="61297">FileRouterFactory</h3>
<p data-nodeid="61298"><strong data-nodeid="61408">FileRouterFactory æ˜¯ ScriptRouterFactory çš„è£…é¥°å™¨</strong>ï¼Œå…¶æ‰©å±•åä¸º fileï¼ŒFileRouterFactory åœ¨ ScriptRouterFactory åŸºç¡€ä¸Š<strong data-nodeid="61409">å¢åŠ äº†è¯»å–æ–‡ä»¶çš„èƒ½åŠ›</strong>ã€‚æˆ‘ä»¬å¯ä»¥å°† ScriptRouter ä½¿ç”¨çš„è·¯ç”±è§„åˆ™ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œç„¶ååœ¨ URL ä¸­æŒ‡å®šæ–‡ä»¶è·¯å¾„ï¼ŒFileRouterFactory ä»ä¸­è§£æåˆ°è¯¥è„šæœ¬æ–‡ä»¶çš„è·¯å¾„å¹¶è¿›è¡Œè¯»å–ï¼Œè°ƒç”¨ ScriptRouterFactory å»åˆ›å»ºç›¸åº”çš„ ScriptRouter å¯¹è±¡ã€‚</p>
<p data-nodeid="61299">ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ FileRouterFactory å¯¹ getRouter() æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œå…¶ä¸­å®Œæˆäº† file åè®®çš„ URL åˆ° script åè®® URL çš„è½¬æ¢ï¼Œå¦‚ä¸‹æ˜¯ä¸€ä¸ªè½¬æ¢ç¤ºä¾‹ï¼Œé¦–å…ˆä¼šå°† file:// åè®®è½¬æ¢æˆ script:// åè®®ï¼Œç„¶åä¼šæ·»åŠ  type å‚æ•°å’Œ rule å‚æ•°ï¼Œå…¶ä¸­ type å‚æ•°å€¼æ ¹æ®æ–‡ä»¶åç¼€åç¡®å®šï¼Œè¯¥ç¤ºä¾‹ä¸º jsï¼Œrule å‚æ•°å€¼ä¸ºæ–‡ä»¶å†…å®¹ã€‚</p>
<p data-nodeid="62736"><img src="https://s0.lgstatic.com/i/image/M00/6E/C9/Ciqc1F-zkA2AduheAAGQTzCOwl8784.png" alt="2.png" data-nodeid="62739"></p>



<p data-nodeid="61301">æˆ‘ä»¬å¯ä»¥å†ç»“åˆæ¥ä¸‹æ¥è¿™ä¸ªç¤ºä¾‹åˆ†æ getRouter() æ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p>
<pre class="lang-java" data-nodeid="61302"><code data-language="java"><span class="hljs-function"><span class="hljs-keyword">public</span> Router <span class="hljs-title">getRouter</span><span class="hljs-params">(URL url)</span> </span>{
&nbsp; &nbsp; <span class="hljs-comment">// é»˜è®¤ä½¿ç”¨scriptåè®®</span>
&nbsp; &nbsp; String protocol = url.getParameter(ROUTER_KEY, ScriptRouterFactory.NAME);&nbsp;
&nbsp; &nbsp; String type = <span class="hljs-keyword">null</span>;&nbsp;
&nbsp; &nbsp; String path = url.getPath();&nbsp;
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (path != <span class="hljs-keyword">null</span>) { <span class="hljs-comment">// è·å–è„šæœ¬æ–‡ä»¶çš„è¯­è¨€ç±»å‹</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">int</span> i = path.lastIndexOf(<span class="hljs-string">'.'</span>);
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type = path.substring(i + <span class="hljs-number">1</span>);
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-comment">// è¯»å–è„šæœ¬æ–‡ä»¶ä¸­çš„å†…å®¹</span>
&nbsp; &nbsp; String rule = IOUtils.read(<span class="hljs-keyword">new</span> FileReader(<span class="hljs-keyword">new</span> File(url.getAbsolutePath())));
&nbsp; &nbsp; <span class="hljs-keyword">boolean</span> runtime = url.getParameter(RUNTIME_KEY, <span class="hljs-keyword">false</span>);
&nbsp; &nbsp; <span class="hljs-comment">// åˆ›å»ºscriptåè®®çš„URL</span>
&nbsp; &nbsp; URL script = URLBuilder.from(url)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .setProtocol(protocol)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .addParameter(TYPE_KEY, type)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .addParameter(RUNTIME_KEY, runtime)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .addParameterAndEncoded(RULE_KEY, rule)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .build();
&nbsp; &nbsp;&nbsp;<span class="hljs-comment">// è·å–scriptå¯¹åº”çš„Routerå®ç°</span>
&nbsp; &nbsp; <span class="hljs-keyword">return</span> routerFactory.getRouter(script);
}
</code></pre>
<h3 data-nodeid="61303">TagRouterFactory &amp; TagRouter</h3>
<p data-nodeid="61304"><strong data-nodeid="61426">TagRouterFactory ä½œä¸º RouterFactory æ¥å£çš„æ‰©å±•å®ç°</strong>ï¼Œå…¶æ‰©å±•åä¸º tagã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒTagRouterFactory ä¸ä¸Šä¸€è¯¾æ—¶ä»‹ç»çš„ ConditionRouterFactoryã€ScriptRouterFactory çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒæ˜¯<strong data-nodeid="61427">é€šè¿‡ç»§æ‰¿ CacheableRouterFactory è¿™ä¸ªæŠ½è±¡ç±»ï¼Œé—´æ¥å®ç°äº† RouterFactory æ¥å£</strong>ã€‚</p>
<p data-nodeid="61305">CacheableRouterFactory æŠ½è±¡ç±»ä¸­ç»´æŠ¤äº†ä¸€ä¸ª ConcurrentMap é›†åˆï¼ˆrouterMap å­—æ®µï¼‰ç”¨æ¥ç¼“å­˜ Routerï¼Œå…¶ä¸­çš„ Key æ˜¯ ServiceKeyã€‚åœ¨ CacheableRouterFactory çš„ getRouter() æ–¹æ³•ä¸­ï¼Œä¼šä¼˜å…ˆæ ¹æ® URL çš„ ServiceKey æŸ¥è¯¢ routerMap é›†åˆï¼ŒæŸ¥è¯¢å¤±è´¥ä¹‹åä¼šè°ƒç”¨ createRouter() æŠ½è±¡æ–¹æ³•æ¥åˆ›å»ºç›¸åº”çš„ Router å¯¹è±¡ã€‚åœ¨ TagRouterFactory.createRouter() æ–¹æ³•ä¸­ï¼Œåˆ›å»ºçš„è‡ªç„¶å°±æ˜¯ TagRouter å¯¹è±¡äº†ã€‚</p>
<h4 data-nodeid="61306">åŸºäº Tag çš„æµ‹è¯•ç¯å¢ƒéš”ç¦»æ–¹æ¡ˆ</h4>
<p data-nodeid="61307"><strong data-nodeid="61433">é€šè¿‡ TagRouterï¼Œæˆ‘ä»¬å¯ä»¥å°†æŸä¸€ä¸ªæˆ–å¤šä¸ª Provider åˆ’åˆ†åˆ°åŒä¸€åˆ†ç»„ï¼Œçº¦æŸæµé‡åªåœ¨æŒ‡å®šåˆ†ç»„ä¸­æµè½¬ï¼Œè¿™æ ·å°±å¯ä»¥è½»æ¾è¾¾åˆ°æµé‡éš”ç¦»çš„ç›®çš„ï¼Œä»è€Œæ”¯æŒç°åº¦å‘å¸ƒç­‰åœºæ™¯ã€‚</strong></p>
<p data-nodeid="61308">ç›®å‰ï¼ŒDubbo æä¾›äº†åŠ¨æ€å’Œé™æ€ä¸¤ç§æ–¹å¼ç»™ Provider æ‰“æ ‡ç­¾ï¼Œå…¶ä¸­åŠ¨æ€æ–¹å¼å°±æ˜¯é€šè¿‡æœåŠ¡æ²»ç†å¹³å°åŠ¨æ€ä¸‹å‘æ ‡ç­¾ï¼Œé™æ€æ–¹å¼å°±æ˜¯åœ¨ XML ç­‰é™æ€é…ç½®ä¸­æ‰“æ ‡ç­¾ã€‚Consumer ç«¯å¯ä»¥åœ¨ RpcContext çš„ attachment ä¸­æ·»åŠ  request.tag é™„åŠ å±æ€§ï¼Œæ³¨æ„<strong data-nodeid="61439">ä¿å­˜åœ¨ attachment ä¸­çš„å€¼å°†ä¼šåœ¨ä¸€æ¬¡å®Œæ•´çš„è¿œç¨‹è°ƒç”¨ä¸­æŒç»­ä¼ é€’</strong>ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨èµ·å§‹è°ƒç”¨æ—¶è¿›è¡Œè®¾ç½®ï¼Œå°±å¯ä»¥è¾¾åˆ°æ ‡ç­¾çš„æŒç»­ä¼ é€’ã€‚</p>
<p data-nodeid="61309">äº†è§£äº† Tag çš„åŸºæœ¬æ¦‚å¿µå’ŒåŠŸèƒ½ä¹‹åï¼Œæˆ‘ä»¬å†ç®€å•ä»‹ç»ä¸€ä¸ª Tag çš„ä½¿ç”¨ç¤ºä¾‹ã€‚</p>
<p data-nodeid="61310">åœ¨å®é™…çš„å¼€å‘æµ‹è¯•ä¸­ï¼Œä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚ä¼šæ¶‰åŠéå¸¸å¤šçš„ Providerï¼Œåˆ†å±ä¸åŒå›¢é˜Ÿè¿›è¡Œç»´æŠ¤ï¼Œè¿™äº›å›¢é˜Ÿæ¯å¤©éƒ½ä¼šå¤„ç†ä¸åŒçš„éœ€æ±‚ï¼Œå¹¶åœ¨å…¶è´Ÿè´£çš„ Provider æœåŠ¡ä¸­è¿›è¡Œä¿®æ”¹ï¼Œå¦‚æœæ‰€æœ‰å›¢é˜Ÿéƒ½ä½¿ç”¨ä¸€å¥—æµ‹è¯•ç¯å¢ƒï¼Œé‚£ä¹ˆæµ‹è¯•ç¯å¢ƒå°±ä¼šå˜å¾—å¾ˆä¸ç¨³å®šã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ4 ä¸ª Provider åˆ†å±ä¸åŒçš„å›¢é˜Ÿç®¡ç†ï¼ŒProvider 2 å’Œ Provider 4 åœ¨æµ‹è¯•ç¯å¢ƒæµ‹è¯•ï¼Œéƒ¨ç½²äº†æœ‰ Bug çš„ç‰ˆæœ¬ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´æ•´ä¸ªæµ‹è¯•ç¯å¢ƒæ— æ³•æ­£å¸¸å¤„ç†è¯·æ±‚ï¼Œåœ¨è¿™æ ·ä¸€ä¸ªä¸ç¨³å®šçš„æµ‹è¯•ç¯å¢ƒä¸­æ’æŸ¥ Bug æ˜¯éå¸¸å›°éš¾çš„ï¼Œå› ä¸ºå¯èƒ½æ’æŸ¥åˆ°æœ€åï¼Œå‘ç°æ˜¯åˆ«äººçš„ Bugã€‚</p>
<p data-nodeid="64182"><img src="https://s0.lgstatic.com/i/image/M00/6E/D4/CgqCHl-zkBuACzVCAABuM5-1_s4317.png" alt="3.png" data-nodeid="64185"></p>

<div data-nodeid="63598"><p style="text-align:center">ä¸åŒçŠ¶æ€çš„ Provider èŠ‚ç‚¹</p></div>




<p data-nodeid="61313">ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é’ˆå¯¹æ¯ä¸ªéœ€æ±‚åˆ†åˆ«ç‹¬ç«‹å‡ºä¸€å¥—æµ‹è¯•ç¯å¢ƒï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ¡ˆä¼šå ç”¨å¤§é‡æœºå™¨ï¼Œå‰æœŸçš„æ­å»ºæˆæœ¬ä»¥åŠåç»­çš„ç»´æŠ¤æˆæœ¬ä¹Ÿéƒ½éå¸¸é«˜ã€‚</p>
<p data-nodeid="61314">ä¸‹é¢æ˜¯ä¸€ä¸ªé€šè¿‡ Tag æ–¹å¼å®ç°ç¯å¢ƒéš”ç¦»çš„æ¶æ„å›¾ï¼Œå…¶ä¸­ï¼Œéœ€æ±‚ 1 å¯¹ Provider 2 çš„è¯·æ±‚ä¼šå…¨éƒ¨è½åˆ°æœ‰éœ€æ±‚ 1 æ ‡ç­¾çš„ Provider ä¸Šï¼Œå…¶ä»– Provider ä½¿ç”¨ç¨³å®šæµ‹è¯•ç¯å¢ƒä¸­çš„ Providerï¼›éœ€æ±‚ 2 å¯¹ Provider 4 çš„è¯·æ±‚ä¼šå…¨éƒ¨è½åˆ°æœ‰éœ€æ±‚ 2 æ ‡ç­¾çš„ Provider 4 ä¸Šï¼Œå…¶ä»– Provider ä½¿ç”¨ç¨³å®šæµ‹è¯•ç¯å¢ƒä¸­çš„ Providerã€‚</p>
<p data-nodeid="65628"><img src="https://s0.lgstatic.com/i/image/M00/6E/D4/CgqCHl-zkCyANtuuAADgH2I1upA475.png" alt="4.png" data-nodeid="65631"></p>

<div data-nodeid="65044"><p style="text-align:center">ä¾èµ– Tag å®ç°çš„æµ‹è¯•ç¯å¢ƒéš”ç¦»æ–¹æ¡ˆ</p></div>




<p data-nodeid="61317">åœ¨ä¸€äº›ç‰¹æ®Šåœºæ™¯ä¸­ï¼Œä¼šæœ‰ Tag é™çº§çš„åœºæ™¯ï¼Œæ¯”å¦‚æ‰¾ä¸åˆ°å¯¹åº” Tag çš„ Providerï¼Œä¼šæŒ‰ç…§ä¸€å®šçš„è§„åˆ™è¿›è¡Œé™çº§ã€‚å¦‚æœåœ¨ Provider é›†ç¾¤ä¸­ä¸å­˜åœ¨ä¸è¯·æ±‚ Tag å¯¹åº”çš„ Provider èŠ‚ç‚¹ï¼Œåˆ™é»˜è®¤å°†é™çº§è¯·æ±‚ Tag ä¸ºç©ºçš„ Providerï¼›å¦‚æœå¸Œæœ›åœ¨æ‰¾ä¸åˆ°åŒ¹é… Tag çš„ Provider èŠ‚ç‚¹æ—¶æŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œæˆ‘ä»¬éœ€è®¾ç½® request.tag.force = trueã€‚</p>
<p data-nodeid="61318">å¦‚æœè¯·æ±‚ä¸­çš„ request.tag æœªè®¾ç½®ï¼Œåªä¼šåŒ¹é… Tag ä¸ºç©ºçš„ Providerï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿é›†ç¾¤ä¸­å­˜åœ¨å¯ç”¨çš„æœåŠ¡ï¼Œè‹¥ Tag ä¸åŒ¹é…ä¹Ÿå°±æ— æ³•è°ƒç”¨ã€‚ä¸€å¥è¯æ€»ç»“ï¼Œ<strong data-nodeid="61456">æºå¸¦ Tag çš„è¯·æ±‚å¯ä»¥é™çº§è®¿é—®åˆ°æ—  Tag çš„ Providerï¼Œä½†ä¸æºå¸¦ Tag çš„è¯·æ±‚æ°¸è¿œæ— æ³•è®¿é—®åˆ°å¸¦æœ‰ Tag çš„ Provider</strong>ã€‚</p>
<h4 data-nodeid="61319">TagRouter</h4>
<p data-nodeid="66761">ä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ TagRouter çš„å…·ä½“å®ç°ã€‚åœ¨ TagRouter ä¸­æŒæœ‰ä¸€ä¸ª TagRouterRule å¯¹è±¡çš„å¼•ç”¨ï¼Œåœ¨ TagRouterRule ä¸­ç»´æŠ¤äº†ä¸€ä¸ª Tag é›†åˆï¼Œè€Œåœ¨æ¯ä¸ª Tag å¯¹è±¡ä¸­åˆéƒ½ç»´æŠ¤äº†ä¸€ä¸ª Tag çš„åç§°ï¼Œä»¥åŠ Tag ç»‘å®šçš„ç½‘ç»œåœ°å€é›†åˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p data-nodeid="66762" class=""><img src="https://s0.lgstatic.com/i/image/M00/6E/D5/CgqCHl-zkEGALTHPAADFZZM7Y2A139.png" alt="5.png" data-nodeid="66767"></p>
<div data-nodeid="66763"><p style="text-align:center">TagRouterã€TagRouterRuleã€Tag ä¸ address æ˜ å°„å…³ç³»å›¾</p></div>




<p data-nodeid="61323">å¦å¤–ï¼Œåœ¨ TagRouterRule ä¸­è¿˜ç»´æŠ¤äº† addressToTagnamesã€tagnameToAddresses ä¸¤ä¸ªé›†åˆï¼ˆéƒ½æ˜¯ Map&lt;String, List<code data-backticks="1" data-nodeid="61465">&lt;String&gt;</code>&gt; ç±»å‹ï¼‰ï¼Œåˆ†åˆ«è®°å½•äº† Tag åç§°åˆ°å„ä¸ª address çš„æ˜ å°„ä»¥åŠ address åˆ° Tag åç§°çš„æ˜ å°„ã€‚åœ¨ TagRouterRule çš„ init() æ–¹æ³•ä¸­ï¼Œä¼šæ ¹æ® tags é›†åˆåˆå§‹åŒ–è¿™ä¸¤ä¸ªé›†åˆã€‚</p>
<p data-nodeid="61324">äº†è§£äº† TagRouterRule çš„åŸºæœ¬æ„é€ ä¹‹åï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹ TagRouter æ„é€  TagRouterRule çš„è¿‡ç¨‹ã€‚TagRouter é™¤äº†å®ç°äº† Router æ¥å£ä¹‹å¤–ï¼Œè¿˜å®ç°äº† ConfigurationListener æ¥å£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p data-nodeid="68210"><img src="https://s0.lgstatic.com/i/image/M00/6E/C9/Ciqc1F-zkEyAMNXQAAF_oit25-o273.png" alt="6.png" data-nodeid="68213"></p>

<div data-nodeid="67626"><p style="text-align:center">TagRouter ç»§æ‰¿å…³ç³»å›¾</p></div>




<p data-nodeid="61327"><strong data-nodeid="61479">ConfigurationListener ç”¨äºç›‘å¬é…ç½®çš„å˜åŒ–ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ TagRouterRule é…ç½®çš„å˜æ›´</strong>ã€‚å½“æˆ‘ä»¬é€šè¿‡åŠ¨æ€æ›´æ–° TagRouterRule é…ç½®çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘ ConfigurationListener æ¥å£çš„ process() æ–¹æ³•ï¼ŒTagRouter å¯¹ process() æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="61328"><code data-language="java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(ConfigChangedEvent event)</span> </span>{
    <span class="hljs-comment">// DELETEDäº‹ä»¶ä¼šç›´æ¥æ¸…ç©ºtagRouterRule</span>
    <span class="hljs-keyword">if</span> (event.getChangeType().equals(ConfigChangeType.DELETED)) {
        <span class="hljs-keyword">this</span>.tagRouterRule = <span class="hljs-keyword">null</span>;
    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// å…¶ä»–äº‹ä»¶ä¼šè§£ææœ€æ–°çš„è·¯ç”±è§„åˆ™ï¼Œå¹¶è®°å½•åˆ°tagRouterRuleå­—æ®µä¸­</span>
        <span class="hljs-keyword">this</span>.tagRouterRule = TagRuleParser.parse(event.getContent());
    }
}
</code></pre>
<p data-nodeid="61329">æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯åˆ é™¤é…ç½®çš„æ“ä½œï¼Œåˆ™ç›´æ¥å°† tagRouterRule è®¾ç½®ä¸º nullï¼Œå¦‚æœæ˜¯ä¿®æ”¹æˆ–æ–°å¢é…ç½®ï¼Œåˆ™é€šè¿‡ TagRuleParser è§£æä¼ å…¥çš„é…ç½®ï¼Œå¾—åˆ°å¯¹åº”çš„ TagRouterRule å¯¹è±¡ã€‚TagRuleParser å¯ä»¥è§£æ yaml æ ¼å¼çš„ TagRouterRule é…ç½®ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªé…ç½®ç¤ºä¾‹ï¼š</p>
<pre class="lang-java" data-nodeid="61330"><code data-language="java">force: <span class="hljs-keyword">false</span>
runtime: <span class="hljs-keyword">true</span>
enabled: <span class="hljs-keyword">false</span>
priority: <span class="hljs-number">1</span>
key: demo-provider
tags:
&nbsp; - name: tag1
&nbsp; &nbsp; addresses: <span class="hljs-keyword">null</span>
&nbsp; - name: tag2
&nbsp; &nbsp; addresses: [<span class="hljs-string">"30.5.120.37:20880"</span>]
&nbsp; - name: tag3
&nbsp; &nbsp; addresses: []
</code></pre>
<p data-nodeid="61331">ç»è¿‡ TagRuleParser è§£æå¾—åˆ°çš„ TagRouterRule ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p data-nodeid="69656"><img src="https://s0.lgstatic.com/i/image/M00/6E/C9/Ciqc1F-zkF6AHgUEAAE3K8dR6QQ826.png" alt="1.png" data-nodeid="69659"></p>

<div data-nodeid="69072"><p style="text-align:center">TagRouterRule ç»“æ„å›¾</p></div>




<p data-nodeid="61334">é™¤äº†ä¸Šå›¾å±•ç¤ºçš„å‡ ä¸ªé›†åˆå­—æ®µï¼ŒTagRouterRule è¿˜ä» AbstractRouterRule æŠ½è±¡ç±»ç»§æ‰¿äº†ä¸€äº›æ§åˆ¶å­—æ®µï¼Œåé¢ä»‹ç»çš„ ConditionRouterRule ä¹Ÿç»§æ‰¿äº† AbstractRouterRuleã€‚</p>
<p data-nodeid="71102"><img src="https://s0.lgstatic.com/i/image/M00/6E/D5/CgqCHl-zkGmAYDBMAAFODGWwRfo125.png" alt="9.png" data-nodeid="71105"></p>

<div data-nodeid="70518"><p style="text-align:center">AbstractRouterRuleç»§æ‰¿å…³ç³»å›¾</p></div>




<p data-nodeid="61337">AbstractRouterRule ä¸­æ ¸å¿ƒå­—æ®µçš„å…·ä½“å«ä¹‰å¤§è‡´å¯æ€»ç»“ä¸ºå¦‚ä¸‹ã€‚</p>
<ul data-nodeid="61338">
<li data-nodeid="61339">
<p data-nodeid="61340">keyï¼ˆstring ç±»å‹ï¼‰ã€scopeï¼ˆstring ç±»å‹ï¼‰ï¼škey æ˜ç¡®è§„åˆ™ä½“ä½œç”¨åœ¨å“ªä¸ªæœåŠ¡æˆ–åº”ç”¨ã€‚scope ä¸º service æ—¶ï¼Œkey ç”± [{group}:]{service}[:{version}] æ„æˆï¼›scope ä¸º application æ—¶ï¼Œkey ä¸º application çš„åç§°ã€‚</p>
</li>
<li data-nodeid="61341">
<p data-nodeid="61342">rawRuleï¼ˆstring ç±»å‹ï¼‰ï¼šè®°å½•äº†è·¯ç”±è§„åˆ™è§£æå‰çš„åŸå§‹å­—ç¬¦ä¸²é…ç½®ã€‚</p>
</li>
<li data-nodeid="61343">
<p data-nodeid="61344">runtimeï¼ˆboolean ç±»å‹ï¼‰ï¼šè¡¨ç¤ºæ˜¯å¦åœ¨æ¯æ¬¡è°ƒç”¨æ—¶æ‰§è¡Œè¯¥è·¯ç”±è§„åˆ™ã€‚å¦‚æœè®¾ç½®ä¸º falseï¼Œåˆ™ä¼šåœ¨ Provider åˆ—è¡¨å˜æ›´æ—¶é¢„å…ˆæ‰§è¡Œå¹¶ç¼“å­˜ç»“æœï¼Œè°ƒç”¨æ—¶ç›´æ¥ä»ç¼“å­˜ä¸­è·å–è·¯ç”±ç»“æœã€‚</p>
</li>
<li data-nodeid="61345">
<p data-nodeid="61346">forceï¼ˆboolean ç±»å‹ï¼‰ï¼šå½“è·¯ç”±ç»“æœä¸ºç©ºæ—¶ï¼Œæ˜¯å¦å¼ºåˆ¶æ‰§è¡Œï¼Œå¦‚æœä¸å¼ºåˆ¶æ‰§è¡Œï¼Œè·¯ç”±ç»“æœä¸ºç©ºçš„è·¯ç”±è§„åˆ™å°†è‡ªåŠ¨å¤±æ•ˆã€‚è¯¥å­—æ®µé»˜è®¤å€¼ä¸º falseã€‚</p>
</li>
<li data-nodeid="61347">
<p data-nodeid="61348">validï¼ˆboolean ç±»å‹ï¼‰ï¼šç”¨äºæ ‡è¯†è§£æç”Ÿæˆå½“å‰ RouterRule å¯¹è±¡çš„é…ç½®æ˜¯å¦åˆæ³•ã€‚</p>
</li>
<li data-nodeid="61349">
<p data-nodeid="61350">enabledï¼ˆboolean ç±»å‹ï¼‰ï¼šæ ‡è¯†å½“å‰è·¯ç”±è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆã€‚</p>
</li>
<li data-nodeid="61351">
<p data-nodeid="61352">priorityï¼ˆint ç±»å‹ï¼‰ï¼šç”¨äºè¡¨ç¤ºå½“å‰ RouterRule çš„ä¼˜å…ˆçº§ã€‚</p>
</li>
<li data-nodeid="61353">
<p data-nodeid="61354">dynamicï¼ˆboolean ç±»å‹ï¼‰ï¼šè¡¨ç¤ºè¯¥è·¯ç”±è§„åˆ™æ˜¯å¦ä¸ºæŒä¹…æ•°æ®ï¼Œå½“æ³¨å†Œæ–¹é€€å‡ºæ—¶ï¼Œè·¯ç”±è§„åˆ™æ˜¯å¦ä¾ç„¶å­˜åœ¨ã€‚</p>
</li>
</ul>
<p data-nodeid="61355">æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒAbstractRouterRule ä¸­çš„æ ¸å¿ƒå­—æ®µä¸å‰é¢çš„ç¤ºä¾‹é…ç½®æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚</p>
<p data-nodeid="61356">æˆ‘ä»¬çŸ¥é“ï¼ŒRouter æœ€ç»ˆç›®çš„æ˜¯è¦è¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„ Invoker å¯¹è±¡ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ TagRouter æ˜¯å¦‚ä½•ä½¿ç”¨ TagRouterRule è·¯ç”±é€»è¾‘è¿›è¡Œ Invoker è¿‡æ»¤çš„ï¼Œå¤§è‡´æ­¥éª¤å¦‚ä¸‹ã€‚</p>
<ol data-nodeid="61357">
<li data-nodeid="61358">
<p data-nodeid="61359">å¦‚æœ invokers ä¸ºç©ºï¼Œç›´æ¥è¿”å›ç©ºé›†åˆã€‚</p>
</li>
<li data-nodeid="61360">
<p data-nodeid="61361">æ£€æŸ¥å…³è”çš„ tagRouterRule å¯¹è±¡æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨ï¼Œåˆ™ä¼šç›´æ¥è°ƒç”¨ filterUsingStaticTag() æ–¹æ³•è¿›è¡Œè¿‡æ»¤ï¼Œå¹¶è¿”å›è¿‡æ»¤ç»“æœã€‚åœ¨ filterUsingStaticTag() æ–¹æ³•ä¸­ï¼Œä¼šæ¯”è¾ƒè¯·æ±‚æºå¸¦çš„ tag å€¼ä¸ Provider URL ä¸­çš„ tag å‚æ•°å€¼ã€‚</p>
</li>
<li data-nodeid="61362">
<p data-nodeid="61363">è·å–æ­¤æ¬¡è°ƒç”¨çš„ tag ä¿¡æ¯ï¼Œè¿™é‡Œä¼šå°è¯•ä» Invocation ä»¥åŠ URL çš„å‚æ•°ä¸­è·å–ã€‚</p>
</li>
<li data-nodeid="61364">
<p data-nodeid="61365">å¦‚æœ<strong data-nodeid="61516">æ­¤æ¬¡è¯·æ±‚æŒ‡å®šäº† tag ä¿¡æ¯</strong>ï¼Œåˆ™é¦–å…ˆä¼šè·å– tag å…³è”çš„ address é›†åˆã€‚</p>
<ol data-nodeid="61366">
<li data-nodeid="61367">
<p data-nodeid="61368">å¦‚æœ address é›†åˆä¸ä¸ºç©ºï¼Œåˆ™æ ¹æ®è¯¥ address é›†åˆä¸­çš„åœ°å€ï¼ŒåŒ¹é…å‡ºç¬¦åˆæ¡ä»¶çš„ Invoker é›†åˆã€‚å¦‚æœå­˜åœ¨ç¬¦åˆæ¡ä»¶çš„ Invokerï¼Œåˆ™ç›´æ¥å°†è¿‡æ»¤å¾—åˆ°çš„ Invoker é›†åˆè¿”å›ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œå°±ä¼šæ ¹æ® force é…ç½®å†³å®šæ˜¯å¦è¿”å›ç©º Invoker é›†åˆã€‚</p>
</li>
<li data-nodeid="61369">
<p data-nodeid="61370">å¦‚æœ address é›†åˆä¸ºç©ºï¼Œåˆ™ä¼šå°†è¯·æ±‚æºå¸¦çš„ tag å€¼ä¸ Provider URL ä¸­çš„ tag å‚æ•°å€¼è¿›è¡Œæ¯”è¾ƒï¼ŒåŒ¹é…å‡ºç¬¦åˆæ¡ä»¶çš„ Invoker é›†åˆã€‚å¦‚æœå­˜åœ¨ç¬¦åˆæ¡ä»¶çš„ Invokerï¼Œåˆ™ç›´æ¥å°†è¿‡æ»¤å¾—åˆ°çš„ Invoker é›†åˆè¿”å›ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œå°±ä¼šæ ¹æ® force é…ç½®å†³å®šæ˜¯å¦è¿”å›ç©º Invoker é›†åˆã€‚</p>
</li>
<li data-nodeid="61371">
<p data-nodeid="61372">å¦‚æœ force é…ç½®ä¸º falseï¼Œä¸”ç¬¦åˆæ¡ä»¶çš„ Invoker é›†åˆä¸ºç©ºï¼Œåˆ™è¿”å›æ‰€æœ‰ä¸åŒ…å«ä»»ä½• tag çš„ Provider åˆ—è¡¨ã€‚</p>
</li>
</ol>
</li>
<li data-nodeid="61373">
<p data-nodeid="61374">å¦‚æœ<strong data-nodeid="61525">æ­¤æ¬¡è¯·æ±‚æœªæºå¸¦ tag ä¿¡æ¯</strong>ï¼Œåˆ™ä¼šå…ˆè·å– TagRouterRule è§„åˆ™ä¸­å…¨éƒ¨ tag å…³è”çš„ address é›†åˆã€‚å¦‚æœ address é›†åˆä¸ä¸ºç©ºï¼Œåˆ™è¿‡æ»¤å‡ºä¸åœ¨ address é›†åˆä¸­çš„ Invoker å¹¶æ·»åŠ åˆ°ç»“æœé›†åˆä¸­ï¼Œæœ€åï¼Œå°† Provider URL ä¸­çš„ tag å€¼ä¸ TagRouterRule ä¸­çš„ tag åç§°è¿›è¡Œæ¯”è¾ƒï¼Œå¾—åˆ°æœ€ç»ˆçš„ Invoker é›†åˆã€‚</p>
</li>
</ol>
<p data-nodeid="61375">ä¸Šè¿°æµç¨‹çš„å…·ä½“å®ç°æ˜¯åœ¨ TagRouter.route() æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="61376"><code data-language="java"><span class="hljs-keyword">public</span> &lt;T&gt; List&lt;Invoker&lt;T&gt;&gt; route(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) <span class="hljs-keyword">throws</span> RpcException {
&nbsp; &nbsp; ... <span class="hljs-comment">// å¦‚æœinvokersä¸ºç©ºï¼Œç›´æ¥è¿”å›ç©ºé›†åˆ(ç•¥)</span>
&nbsp; &nbsp; <span class="hljs-keyword">final</span> TagRouterRule tagRouterRuleCopy = tagRouterRule;
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (tagRouterRuleCopy == <span class="hljs-keyword">null</span> || !tagRouterRuleCopy.isValid() || !tagRouterRuleCopy.isEnabled()) {
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> filterUsingStaticTag(invokers, url, invocation);
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-comment">// æ£€æŸ¥å…³è”çš„tagRouterRuleå¯¹è±¡æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨ï¼Œåˆ™ä¼šç›´æ¥è°ƒç”¨filterUsingStaticTag() æ–¹æ³•è¿›è¡Œè¿‡æ»¤</span>
&nbsp; &nbsp; List&lt;Invoker&lt;T&gt;&gt; result = invokers;
&nbsp; &nbsp; <span class="hljs-comment">// è·å–æ­¤æ¬¡è°ƒç”¨çš„tagä¿¡æ¯ï¼Œå°è¯•ä»Invocationä»¥åŠURLä¸­è·å–</span>
&nbsp; &nbsp; String tag = StringUtils.isEmpty(invocation.getAttachment(TAG_KEY)) ? url.getParameter(TAG_KEY) :
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invocation.getAttachment(TAG_KEY);
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(tag)) { <span class="hljs-comment">// æ­¤æ¬¡è¯·æ±‚ä¸€ä¸ªç‰¹æ®Šçš„tag</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// è·å–tagå…³è”çš„addressé›†åˆ</span>
&nbsp; &nbsp; &nbsp; &nbsp; List&lt;String&gt; addresses = tagRouterRuleCopy.getTagnameToAddresses().get(tag);
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (CollectionUtils.isNotEmpty(addresses)) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// æ ¹æ®ä¸Šé¢çš„addressé›†åˆåŒ¹é…ç¬¦åˆæ¡ä»¶çš„Invoker</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = filterInvoker(invokers, invoker -&gt; addressMatches(invoker.getUrl(), addresses));
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å¦‚æœå­˜åœ¨ç¬¦åˆæ¡ä»¶çš„Invokerï¼Œåˆ™ç›´æ¥å°†è¿‡æ»¤å¾—åˆ°çš„Invokeré›†åˆè¿”å›</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å¦‚æœä¸å­˜åœ¨ç¬¦åˆæ¡ä»¶çš„Invokerï¼Œæ ¹æ®forceé…ç½®å†³å®šæ˜¯å¦è¿”å›ç©ºInvokeré›†åˆ</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (CollectionUtils.isNotEmpty(result) || tagRouterRuleCopy.isForce()) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> result;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; } <span class="hljs-keyword">else</span> {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å¦‚æœ address é›†åˆä¸ºç©ºï¼Œåˆ™ä¼šå°†è¯·æ±‚æºå¸¦çš„ tag ä¸ Provider URL ä¸­çš„ tag å‚æ•°å€¼è¿›è¡Œæ¯”è¾ƒï¼ŒåŒ¹é…å‡ºç¬¦åˆæ¡ä»¶çš„ Invoker é›†åˆã€‚</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = filterInvoker(invokers, invoker -&gt; tag.equals(invoker.getUrl().getParameter(TAG_KEY)));
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (CollectionUtils.isNotEmpty(result) || isForceUseTag(invocation)) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> result; <span class="hljs-comment">// å­˜åœ¨ç¬¦åˆæ¡ä»¶çš„Invokeræˆ–æ˜¯forceé…ç½®ä¸ºtrue</span>
&nbsp; &nbsp; &nbsp; &nbsp; }<span class="hljs-keyword">else</span> { <span class="hljs-comment">// å¦‚æœ force é…ç½®ä¸º falseï¼Œä¸”ç¬¦åˆæ¡ä»¶çš„ Invoker é›†åˆä¸ºç©ºï¼Œåˆ™è¿”å›æ‰€æœ‰ä¸åŒ…å«ä»»ä½• tag çš„ Provider åˆ—è¡¨ã€‚</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List&lt;Invoker&lt;T&gt;&gt; tmp = filterInvoker(invokers, invoker -&gt; addressNotMatches(invoker.getUrl(),
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tagRouterRuleCopy.getAddresses()));
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> filterInvoker(tmp, invoker -&gt; StringUtils.isEmpty(invoker.getUrl().getParameter(TAG_KEY)));
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; } <span class="hljs-keyword">else</span> {
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å¦‚æœæ­¤æ¬¡è¯·æ±‚æœªæºå¸¦ tag ä¿¡æ¯ï¼Œåˆ™ä¼šå…ˆè·å– TagRouterRule è§„åˆ™ä¸­å…¨éƒ¨ tag å…³è”çš„ address é›†åˆã€‚</span>
&nbsp; &nbsp; &nbsp; &nbsp; List&lt;String&gt; addresses = tagRouterRuleCopy.getAddresses();
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (CollectionUtils.isNotEmpty(addresses)) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å¦‚æœ address é›†åˆä¸ä¸ºç©ºï¼Œåˆ™è¿‡æ»¤å‡ºä¸åœ¨ address é›†åˆä¸­çš„ Invoker å¹¶æ·»åŠ åˆ°ç»“æœé›†åˆä¸­ã€‚</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = filterInvoker(invokers, invoker -&gt; addressNotMatches(invoker.getUrl(), addresses));
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(result)) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> result;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å¦‚æœä¸å­˜åœ¨ç¬¦åˆæ¡ä»¶çš„ Invoker æˆ–æ˜¯ address é›†åˆä¸ºç©ºï¼Œåˆ™ä¼šå°†è¯·æ±‚æºå¸¦çš„ tag ä¸ Provider URL ä¸­çš„ tag å‚æ•°å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¾—åˆ°æœ€ç»ˆçš„ Invoker é›†åˆã€‚</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> filterInvoker(result, invoker -&gt; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; String localTag = invoker.getUrl().getParameter(TAG_KEY);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> StringUtils.isEmpty(localTag) || !tagRouterRuleCopy.getTagNames().contains(localTag);
&nbsp; &nbsp; &nbsp; &nbsp; });
&nbsp; &nbsp; }
}
</code></pre>
<h3 data-nodeid="61377">ServiceRouter &amp; AppRouter</h3>
<p data-nodeid="61378">é™¤äº†å‰æ–‡ä»‹ç»çš„ TagRouterFactory ç»§æ‰¿äº† CacheableRouterFactory ä¹‹å¤–ï¼Œ<strong data-nodeid="61535">ServiceRouterFactory ä¹Ÿç»§æ‰¿ CachabelRouterFactoryï¼Œå…·æœ‰äº†ç¼“å­˜çš„èƒ½åŠ›</strong>ï¼Œå…·ä½“ç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p data-nodeid="72548"><img src="https://s0.lgstatic.com/i/image/M00/6E/C9/Ciqc1F-zkHqAH3diAAGWl6aQJy8860.png" alt="8.png" data-nodeid="72551"></p>

<div data-nodeid="71964"><p style="text-align:center">CacheableRouterFactory ç»§æ‰¿å…³ç³»å›¾</p></div>




<p data-nodeid="61381">ServiceRouterFactory åˆ›å»ºçš„ Router å®ç°æ˜¯ ServiceRouterï¼Œä¸ ServiceRouter ç±»ä¼¼çš„æ˜¯ AppRouterï¼Œ<strong data-nodeid="61544">ä¸¤è€…éƒ½ç»§æ‰¿äº† ListenableRouter æŠ½è±¡ç±»</strong>ï¼ˆè™½ç„¶ ListenableRouter æ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œä½†æ˜¯æ²¡æœ‰æŠ½è±¡æ–¹æ³•ç•™ç»™å­ç±»å®ç°ï¼‰ï¼Œç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p data-nodeid="73994"><img src="https://s0.lgstatic.com/i/image/M00/6E/C9/Ciqc1F-zkISAPopjAAH9Njd3pOE049.png" alt="7.png" data-nodeid="73997"></p>

<div data-nodeid="73410"><p style="text-align:center">ListenableRouter ç»§æ‰¿å…³ç³»å›¾</p></div>




<p data-nodeid="61384"><strong data-nodeid="61554">ListenableRouter åœ¨ ConditionRouter åŸºç¡€ä¸Šæ·»åŠ äº†åŠ¨æ€é…ç½®çš„èƒ½åŠ›</strong>ï¼ŒListenableRouter çš„ process() æ–¹æ³•ä¸ TagRouter ä¸­çš„ process() æ–¹æ³•ç±»ä¼¼ï¼Œå¯¹äº ConfigChangedEvent.DELETE äº‹ä»¶ï¼Œç›´æ¥æ¸…ç©º ListenableRouter ä¸­ç»´æŠ¤çš„ ConditionRouterRule å’Œ ConditionRouter é›†åˆçš„å¼•ç”¨ï¼›å¯¹äº ADDEDã€UPDATED äº‹ä»¶ï¼Œåˆ™é€šè¿‡ ConditionRuleParser è§£æäº‹ä»¶å†…å®¹ï¼Œå¾—åˆ°ç›¸åº”çš„ ConditionRouterRule å¯¹è±¡å’Œ ConditionRouter é›†åˆã€‚è¿™é‡Œçš„ ConditionRuleParser åŒæ ·æ˜¯ä»¥ yaml æ–‡ä»¶çš„æ ¼å¼è§£æ ConditionRouterRule çš„ç›¸å…³é…ç½®ã€‚ConditionRouterRule ä¸­ç»´æŠ¤äº†ä¸€ä¸ª conditions é›†åˆï¼ˆList<code data-backticks="1" data-nodeid="61552">&lt;String&gt;</code> ç±»å‹ï¼‰ï¼Œè®°å½•äº†å¤šä¸ª Condition è·¯ç”±è§„åˆ™ï¼Œå¯¹åº”ç”Ÿæˆå¤šä¸ª ConditionRouter å¯¹è±¡ã€‚</p>
<p data-nodeid="61385">æ•´ä¸ªè§£æ ConditionRouterRule çš„è¿‡ç¨‹ï¼Œä¸å‰æ–‡ä»‹ç»çš„è§£æ TagRouterRule çš„æµç¨‹ç±»ä¼¼ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<p data-nodeid="61386">åœ¨ ListenableRouter çš„ route() æ–¹æ³•ä¸­ï¼Œä¼šéå†å…¨éƒ¨ ConditionRouter è¿‡æ»¤å‡ºç¬¦åˆå…¨éƒ¨è·¯ç”±æ¡ä»¶çš„ Invoker é›†åˆï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="61387"><code data-language="java"><span class="hljs-keyword">public</span> &lt;T&gt; List&lt;Invoker&lt;T&gt;&gt; route(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) <span class="hljs-keyword">throws</span> RpcException {
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(invokers) || conditionRouters.size() == <span class="hljs-number">0</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> invokers; <span class="hljs-comment">// æ£€æŸ¥è¾¹ç•Œæ¡ä»¶ï¼Œç›´æ¥è¿”å›invokersé›†åˆ</span>
&nbsp; &nbsp; }&nbsp;
&nbsp; &nbsp; <span class="hljs-keyword">for</span> (Router router : conditionRouters) { <span class="hljs-comment">// è·¯ç”±è§„åˆ™è¿›è¡Œè¿‡æ»¤</span>
&nbsp; &nbsp; &nbsp; &nbsp; invokers = router.route(invokers, url, invocation);
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-keyword">return</span> invokers;
}
</code></pre>
<p data-nodeid="61388">ServiceRouter å’Œ AppRouter éƒ½æ˜¯ç®€å•åœ°ç»§æ‰¿äº† ListenableRouter æŠ½è±¡ç±»ï¼Œä¸”æ²¡æœ‰è¦†ç›– ListenableRouter çš„ä»»ä½•æ–¹æ³•ï¼Œä¸¤è€…åªæœ‰ä»¥ä¸‹ä¸¤ç‚¹åŒºåˆ«ã€‚</p>
<ul data-nodeid="61389">
<li data-nodeid="61390">
<p data-nodeid="61391"><strong data-nodeid="61562">ä¸€ä¸ªæ˜¯ priority å­—æ®µå€¼ä¸åŒ</strong>ã€‚ServiceRouter ä¸º 140ï¼ŒAppRouter ä¸º 150ï¼Œä¹Ÿå°±æ˜¯è¯´ ServiceRouter è¦å…ˆäº AppRouter æ‰§è¡Œã€‚</p>
</li>
<li data-nodeid="61392">
<p data-nodeid="61393"><strong data-nodeid="61575">å¦ä¸€ä¸ªæ˜¯è·å– ConditionRouterRule é…ç½®çš„ Key ä¸åŒ</strong>ã€‚ServiceRouter ä½¿ç”¨çš„ RuleKey æ˜¯ç”± {interface}:[version]:[group] ä¸‰éƒ¨åˆ†æ„æˆï¼Œè·å–çš„æ˜¯ä¸€ä¸ªæœåŠ¡å¯¹åº”çš„ ConditionRouterRuleã€‚AppRouter ä½¿ç”¨çš„ RuleKey æ˜¯ URL ä¸­çš„ application å‚æ•°å€¼ï¼Œè·å–çš„æ˜¯ä¸€ä¸ªæœåŠ¡å®ä¾‹å¯¹åº”çš„ ConditionRouterRuleã€‚</p>
</li>
</ul>
<h3 data-nodeid="61394">æ€»ç»“</h3>
<p data-nodeid="61395">æœ¬è¯¾æ—¶æˆ‘ä»¬æ˜¯ç´§æ¥ä¸Šä¸€è¯¾æ—¶çš„å†…å®¹ï¼Œç»§ç»­ä»‹ç»äº†å‰©ä½™ Router æ¥å£å®ç°çš„å†…å®¹ã€‚</p>
<p data-nodeid="61396">æˆ‘ä»¬é¦–å…ˆä»‹ç»äº†åŸºäºæ–‡ä»¶çš„ FileRouter å®ç°ï¼Œå…¶åº•å±‚ä¼šä¾èµ–ä¸Šä¸€è¯¾æ—¶ä»‹ç»çš„ ScriptRouterï¼›æ¥ä¸‹æ¥åˆè®²è§£äº†åŸºäº Tag çš„æµ‹è¯•ç¯å¢ƒéš”ç¦»æ–¹æ¡ˆï¼Œä»¥åŠå¦‚ä½•åŸºäº TagRouter å®ç°è¯¥æ–¹æ¡ˆï¼ŒåŒæ—¶æ·±å…¥åˆ†æäº† TagRouter çš„æ ¸å¿ƒå®ç°ï¼›æœ€åæˆ‘ä»¬è¿˜ä»‹ç»äº† ListenableRouter æŠ½è±¡ç±»ä»¥åŠ ServerRouter å’Œ AppRouter ä¸¤ä¸ªå®ç°ï¼Œå®ƒä»¬æ˜¯åœ¨æ¡ä»¶è·¯ç”±çš„åŸºç¡€ä¸Šæ·»åŠ äº†åŠ¨æ€å˜æ›´è·¯ç”±è§„åˆ™çš„èƒ½åŠ›ï¼ŒåŒæ—¶åŒºåˆ†äº†æœåŠ¡çº§åˆ«å’ŒæœåŠ¡å®ä¾‹çº§åˆ«çš„é…ç½®ã€‚</p>
<p data-nodeid="61397" class="">ä¸‹ä¸€è¯¾æ—¶ï¼Œæˆ‘ä»¬ä¼šç®€å•ä»‹ç»ä¸€ä¸ª Dubbo ä¸­é…ç½®ç›¸å…³çš„è¯é¢˜ï¼Œè®°å¾—æŒ‰æ—¶æ¥å¬è¯¾ã€‚</p>

---

### ç²¾é€‰è¯„è®º

##### *é•‡ï¼š
> è€å¸ˆï¼Œæœ€åèƒ½åˆ†äº«ä¸‹å¸¦æ³¨é‡Šçš„æºç å—ğŸ˜„

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; æ•´ä¸ª Dubbo çš„æºç ï¼ˆå¸¦æ³¨é‡Šçš„ï¼‰æˆ‘å·²ç»æ•´ç†åˆ° GitHub ä¸Šäº†ï¼Œä½ å¯ä»¥æŒ‰éœ€æŸ¥çœ‹ï¼šhttps://github.com/xxxlxy2008/dubbo ï¼ˆä¸ºæ–¹ä¾¿å°ä¼™ä¼´ä»¬æŸ¥çœ‹ï¼Œç½‘å€ä¹Ÿå·²æ›´æ–°åˆ°å¼€ç¯‡è¯ä¸­ï¼‰ã€‚


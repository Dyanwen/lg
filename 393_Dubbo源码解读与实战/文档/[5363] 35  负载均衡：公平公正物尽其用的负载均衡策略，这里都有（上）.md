<p data-nodeid="177459">åœ¨å‰é¢çš„è¯¾æ—¶ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¯¦ç»†ä»‹ç»äº† dubbo-cluster æ¨¡å—ä¸­çš„ Directory å’Œ Router ä¸¤ä¸ªæ ¸å¿ƒæ¥å£ä»¥åŠæ ¸å¿ƒå®ç°ï¼ŒåŒæ—¶ä¹Ÿä»‹ç»äº†è¿™ä¸¤ä¸ªæ¥å£ç›¸å…³çš„å‘¨è¾¹çŸ¥è¯†ã€‚æœ¬è¯¾æ—¶æˆ‘ä»¬ç»§ç»­æŒ‰ç…§ä¸‹å›¾çš„é¡ºåºä»‹ç» LoadBalance çš„ç›¸å…³å†…å®¹ã€‚</p>
<p data-nodeid="177460" class=""><img src="https://s0.lgstatic.com/i/image/M00/71/0A/Ciqc1F-81uuAdW51AAH-O1mrOoA018.png" alt="Drawing 0.png" data-nodeid="177465"></p>
<div data-nodeid="177461"><p style="text-align:center">LoadBalance æ ¸å¿ƒæ¥å£å›¾</p></div>




<p data-nodeid="176758"><strong data-nodeid="176857">LoadBalanceï¼ˆè´Ÿè½½å‡è¡¡ï¼‰çš„èŒè´£æ˜¯å°†ç½‘ç»œè¯·æ±‚æˆ–è€…å…¶ä»–å½¢å¼çš„è´Ÿè½½â€œå‡æ‘Šâ€åˆ°ä¸åŒçš„æœåŠ¡èŠ‚ç‚¹ä¸Šï¼Œä»è€Œé¿å…æœåŠ¡é›†ç¾¤ä¸­éƒ¨åˆ†èŠ‚ç‚¹å‹åŠ›è¿‡å¤§ã€èµ„æºç´§å¼ ï¼Œè€Œå¦ä¸€éƒ¨åˆ†èŠ‚ç‚¹æ¯”è¾ƒç©ºé—²çš„æƒ…å†µã€‚</strong></p>
<p data-nodeid="176759">é€šè¿‡åˆç†çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥è®©æ¯ä¸ªæœåŠ¡èŠ‚ç‚¹è·å–åˆ°é€‚åˆè‡ªå·±å¤„ç†èƒ½åŠ›çš„è´Ÿè½½ï¼Œ<strong data-nodeid="176871">å®ç°å¤„ç†èƒ½åŠ›å’Œæµé‡çš„åˆç†åˆ†é…</strong>ã€‚å¸¸ç”¨çš„è´Ÿè½½å‡è¡¡å¯åˆ†ä¸º<strong data-nodeid="176872">è½¯ä»¶è´Ÿè½½å‡è¡¡</strong>ï¼ˆæ¯”å¦‚ï¼Œæ—¥å¸¸å·¥ä½œä¸­ä½¿ç”¨çš„ Nginxï¼‰å’Œ<strong data-nodeid="176873">ç¡¬ä»¶è´Ÿè½½å‡è¡¡</strong>ï¼ˆä¸»è¦æœ‰ F5ã€Arrayã€NetScaler ç­‰ï¼Œä¸è¿‡å¼€å‘å·¥ç¨‹å¸ˆåœ¨å®è·µä¸­å¾ˆå°‘ç›´æ¥æ¥è§¦åˆ°ï¼‰ã€‚</p>
<p data-nodeid="176760">å¸¸è§çš„ RPC æ¡†æ¶ä¸­éƒ½æœ‰è´Ÿè½½å‡è¡¡çš„æ¦‚å¿µå’Œç›¸åº”çš„å®ç°ï¼ŒDubbo ä¹Ÿä¸ä¾‹å¤–ã€‚Dubbo éœ€è¦å¯¹ Consumer çš„è°ƒç”¨è¯·æ±‚è¿›è¡Œåˆ†é…ï¼Œé¿å…å°‘æ•° Provider èŠ‚ç‚¹è´Ÿè½½è¿‡å¤§ï¼Œè€Œå‰©ä½™çš„å…¶ä»– Provider èŠ‚ç‚¹å¤„äºç©ºé—²çš„çŠ¶æ€ã€‚å› ä¸ºå½“ Provider è´Ÿè½½è¿‡å¤§æ—¶ï¼Œå°±ä¼šå¯¼è‡´ä¸€éƒ¨åˆ†è¯·æ±‚è¶…æ—¶ã€ä¸¢å¤±ç­‰ä¸€ç³»åˆ—é—®é¢˜å‘ç”Ÿï¼Œé€ æˆçº¿ä¸Šæ•…éšœã€‚</p>
<p data-nodeid="176761">Dubbo æä¾›äº† 5 ç§è´Ÿè½½å‡è¡¡å®ç°ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul data-nodeid="176762">
<li data-nodeid="176763">
<p data-nodeid="176764">åŸºäº Hash ä¸€è‡´æ€§çš„ ConsistentHashLoadBalanceï¼›</p>
</li>
<li data-nodeid="176765">
<p data-nodeid="176766">åŸºäºæƒé‡éšæœºç®—æ³•çš„ RandomLoadBalanceï¼›</p>
</li>
<li data-nodeid="176767">
<p data-nodeid="176768">åŸºäºæœ€å°‘æ´»è·ƒè°ƒç”¨æ•°ç®—æ³•çš„ LeastActiveLoadBalanceï¼›</p>
</li>
<li data-nodeid="176769">
<p data-nodeid="176770">åŸºäºåŠ æƒè½®è¯¢ç®—æ³•çš„ RoundRobinLoadBalanceï¼›</p>
</li>
<li data-nodeid="176771">
<p data-nodeid="176772">åŸºäºæœ€çŸ­å“åº”æ—¶é—´çš„ ShortestResponseLoadBalance ã€‚</p>
</li>
</ul>
<h3 data-nodeid="176773">LoadBalance æ¥å£</h3>
<p data-nodeid="178407">ä¸Šè¿° Dubbo æä¾›çš„è´Ÿè½½å‡è¡¡å®ç°ï¼Œéƒ½æ˜¯ LoadBalance æ¥å£çš„å®ç°ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p data-nodeid="178408" class=""><img src="https://s0.lgstatic.com/i/image/M00/71/15/CgqCHl-81vaAYmqRAAFYpTlQI0s741.png" alt="Lark20201124-174750.png" data-nodeid="178413"></p>
<div data-nodeid="178409"><p style="text-align:center">LoadBalance ç»§æ‰¿å…³ç³»å›¾</p></div>




<p data-nodeid="176777"><strong data-nodeid="176890">LoadBalance æ˜¯ä¸€ä¸ªæ‰©å±•æ¥å£ï¼Œé»˜è®¤ä½¿ç”¨çš„æ‰©å±•å®ç°æ˜¯ RandomLoadBalance</strong>ï¼Œå…¶å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­çš„ @Adaptive æ³¨è§£å‚æ•°ä¸º loadbalanceï¼Œå³åŠ¨æ€ç”Ÿæˆçš„é€‚é…å™¨ä¼šæŒ‰ç…§ URL ä¸­çš„ loadbalance å‚æ•°å€¼é€‰æ‹©æ‰©å±•å®ç°ç±»ã€‚</p>
<pre class="lang-java" data-nodeid="176778"><code data-language="java"><span class="hljs-meta">@SPI(RandomLoadBalance.NAME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">LoadBalance</span> </span>{
&nbsp; &nbsp; <span class="hljs-meta">@Adaptive("loadbalance")</span>
&nbsp; &nbsp; &lt;T&gt; <span class="hljs-function">Invoker&lt;T&gt; <span class="hljs-title">select</span><span class="hljs-params">(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</span> <span class="hljs-keyword">throws</span> RpcException</span>;
}
</code></pre>
<p data-nodeid="176779">LoadBalance æ¥å£ä¸­ select() æ–¹æ³•çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯æ ¹æ®ä¼ å…¥çš„ URL å’Œ Invocationï¼Œä»¥åŠè‡ªèº«çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œä» Invoker é›†åˆä¸­é€‰æ‹©ä¸€ä¸ª Invoker è¿”å›ã€‚</p>
<p data-nodeid="176780">AbstractLoadBalance æŠ½è±¡ç±»å¹¶æ²¡æœ‰çœŸæ­£å®ç° select() æ–¹æ³•ï¼Œåªæ˜¯å¯¹ Invoker é›†åˆä¸ºç©ºæˆ–æ˜¯åªåŒ…å«ä¸€ä¸ª Invoker å¯¹è±¡çš„ç‰¹æ®Šæƒ…å†µè¿›è¡Œäº†å¤„ç†ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="176781"><code data-language="java"><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">Invoker&lt;T&gt; <span class="hljs-title">select</span><span class="hljs-params">(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</span> </span>{
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(invokers)) { 
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>; <span class="hljs-comment">// Invokeré›†åˆä¸ºç©ºï¼Œç›´æ¥è¿”å›null</span>
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (invokers.size() == <span class="hljs-number">1</span>) { <span class="hljs-comment">// Invokeré›†åˆåªåŒ…å«ä¸€ä¸ªInvokerï¼Œåˆ™ç›´æ¥è¿”å›è¯¥Invokerå¯¹è±¡</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> invokers.get(<span class="hljs-number">0</span>);
&nbsp; &nbsp; }
    <span class="hljs-comment">// Invokeré›†åˆåŒ…å«å¤šä¸ªInvokerå¯¹è±¡æ—¶ï¼Œäº¤ç»™doSelect()æ–¹æ³•å¤„ç†ï¼Œè¿™æ˜¯ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œç•™ç»™å­ç±»å…·ä½“å®ç°</span>
&nbsp; &nbsp; <span class="hljs-keyword">return</span> doSelect(invokers, url, invocation);
}
</code></pre>
<p data-nodeid="176782">å¦å¤–ï¼ŒAbstractLoadBalance è¿˜æä¾›äº†ä¸€ä¸ª getWeight() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºè®¡ç®— Provider æƒé‡ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="176783"><code data-language="java"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">getWeight</span><span class="hljs-params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> </span>{
&nbsp; &nbsp; <span class="hljs-keyword">int</span> weight;
&nbsp; &nbsp; URL url = invoker.getUrl();
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (REGISTRY_SERVICE_REFERENCE_PATH.equals(url.getServiceInterface())) {
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å¦‚æœæ˜¯RegistryServiceæ¥å£çš„è¯ï¼Œç›´æ¥è·å–æƒé‡å³å¯</span>
&nbsp; &nbsp; &nbsp; &nbsp; weight = url.getParameter(REGISTRY_KEY + <span class="hljs-string">"."</span> + WEIGHT_KEY, DEFAULT_WEIGHT);
&nbsp; &nbsp; } <span class="hljs-keyword">else</span> {
&nbsp; &nbsp; &nbsp; &nbsp; weight = url.getMethodParameter(invocation.getMethodName(), WEIGHT_KEY, DEFAULT_WEIGHT);
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (weight &gt; <span class="hljs-number">0</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// è·å–æœåŠ¡æä¾›è€…çš„å¯åŠ¨æ—¶é—´æˆ³</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">long</span> timestamp = invoker.getUrl().getParameter(TIMESTAMP_KEY, <span class="hljs-number">0L</span>);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (timestamp &gt; <span class="hljs-number">0L</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// è®¡ç®—Providerè¿è¡Œæ—¶é•¿</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">long</span> uptime = System.currentTimeMillis() - timestamp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (uptime &lt; <span class="hljs-number">0</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// è®¡ç®—Provideré¢„çƒ­æ—¶é•¿</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">int</span> warmup = invoker.getUrl().getParameter(WARMUP_KEY, DEFAULT_WARMUP);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å¦‚æœProviderè¿è¡Œæ—¶é—´å°äºé¢„çƒ­æ—¶é—´ï¼Œåˆ™è¯¥ProviderèŠ‚ç‚¹å¯èƒ½è¿˜åœ¨é¢„çƒ­é˜¶æ®µï¼Œéœ€è¦é‡æ–°è®¡ç®—æœåŠ¡æƒé‡(é™ä½å…¶æƒé‡)</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (uptime &gt; <span class="hljs-number">0</span> &amp;&amp; uptime &lt; warmup) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; weight = calculateWarmupWeight((<span class="hljs-keyword">int</span>)uptime, warmup, weight);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-keyword">return</span> Math.max(weight, <span class="hljs-number">0</span>);
}
</code></pre>
<p data-nodeid="176784">calculateWarmupWeight() æ–¹æ³•çš„ç›®çš„æ˜¯å¯¹è¿˜åœ¨é¢„çƒ­çŠ¶æ€çš„ Provider èŠ‚ç‚¹è¿›è¡Œé™æƒï¼Œé¿å… Provider ä¸€å¯åŠ¨å°±æœ‰å¤§é‡è¯·æ±‚æ¶Œè¿›æ¥ã€‚æœåŠ¡é¢„çƒ­æ˜¯ä¸€ä¸ªä¼˜åŒ–æ‰‹æ®µï¼Œè¿™æ˜¯ç”± JVM æœ¬èº«çš„ä¸€äº›ç‰¹æ€§å†³å®šçš„ï¼Œä¾‹å¦‚ï¼ŒJIT ç­‰æ–¹é¢çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šåœ¨æœåŠ¡å¯åŠ¨ä¹‹åï¼Œè®©å…¶åœ¨å°æµé‡çŠ¶æ€ä¸‹è¿è¡Œä¸€æ®µæ—¶é—´ï¼Œç„¶åå†é€æ­¥æ”¾å¤§æµé‡ã€‚</p>
<pre class="lang-java" data-nodeid="176785"><code data-language="java"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">calculateWarmupWeight</span><span class="hljs-params">(<span class="hljs-keyword">int</span> uptime, <span class="hljs-keyword">int</span> warmup, <span class="hljs-keyword">int</span> weight)</span> </span>{
&nbsp; &nbsp; <span class="hljs-comment">// è®¡ç®—æƒé‡ï¼Œéšç€æœåŠ¡è¿è¡Œæ—¶é—´uptimeå¢å¤§ï¼Œæƒé‡wwçš„å€¼ä¼šæ…¢æ…¢æ¥è¿‘é…ç½®å€¼weight</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span> ww = (<span class="hljs-keyword">int</span>) ( uptime / ((<span class="hljs-keyword">float</span>) warmup / weight));
&nbsp; &nbsp; <span class="hljs-keyword">return</span> ww &lt; <span class="hljs-number">1</span> ? <span class="hljs-number">1</span> : (Math.min(ww, weight));
}
</code></pre>
<p data-nodeid="176786">äº†è§£äº† LoadBalance æ¥å£çš„å®šä¹‰ä»¥åŠ AbstractLoadBalance æä¾›çš„å…¬å…±èƒ½åŠ›ä¹‹åï¼Œä¸‹é¢æˆ‘ä»¬å¼€å§‹é€ä¸ªä»‹ç» LoadBalance æ¥å£çš„å…·ä½“å®ç°ã€‚</p>
<h3 data-nodeid="176787">ConsistentHashLoadBalance</h3>
<p data-nodeid="176788">ConsistentHashLoadBalance åº•å±‚ä½¿ç”¨ä¸€è‡´æ€§ Hash ç®—æ³•å®ç°è´Ÿè½½å‡è¡¡ã€‚ä¸ºäº†è®©ä½ æ›´å¥½åœ°ç†è§£è¿™éƒ¨åˆ†å†…å®¹ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•ä»‹ç»ä¸€ä¸‹ä¸€è‡´æ€§ Hash ç®—æ³•ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚</p>
<h4 data-nodeid="176789">1. ä¸€è‡´æ€§ Hash ç®€æ</h4>
<p data-nodeid="176790"><strong data-nodeid="176905">ä¸€è‡´æ€§ Hash è´Ÿè½½å‡è¡¡å¯ä»¥è®©å‚æ•°ç›¸åŒçš„è¯·æ±‚æ¯æ¬¡éƒ½è·¯ç”±åˆ°ç›¸åŒçš„æœåŠ¡èŠ‚ç‚¹ä¸Š</strong>ï¼Œè¿™ç§è´Ÿè½½å‡è¡¡ç­–ç•¥å¯ä»¥åœ¨æŸäº› Provider èŠ‚ç‚¹ä¸‹çº¿çš„æ—¶å€™ï¼Œè®©è¿™äº›èŠ‚ç‚¹ä¸Šçš„æµé‡å¹³æ‘Šåˆ°å…¶ä»– Provider ä¸Šï¼Œä¸ä¼šå¼•èµ·æµé‡çš„å‰§çƒˆæ³¢åŠ¨ã€‚</p>
<p data-nodeid="176791">ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç¤ºä¾‹ï¼Œç®€å•ä»‹ç»ä¸€è‡´æ€§ Hash ç®—æ³•çš„åŸç†ã€‚</p>
<p data-nodeid="176792">å‡è®¾ç°åœ¨æœ‰ 1ã€2ã€3 ä¸‰ä¸ª Provider èŠ‚ç‚¹å¯¹å¤–æä¾›æœåŠ¡ï¼Œæœ‰ 100 ä¸ªè¯·æ±‚åŒæ—¶åˆ°è¾¾ï¼Œå¦‚æœæƒ³è®©è¯·æ±‚å°½å¯èƒ½å‡åŒ€åœ°åˆ†å¸ƒåˆ°è¿™ä¸‰ä¸ª Provider èŠ‚ç‚¹ä¸Šï¼Œæˆ‘ä»¬å¯èƒ½æƒ³åˆ°çš„æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ Hash å–æ¨¡ï¼Œå³ hash(è¯·æ±‚å‚æ•°) % 3ã€‚å¦‚æœå‚ä¸ Hash è®¡ç®—çš„æ˜¯è¯·æ±‚çš„å…¨éƒ¨å‚æ•°ï¼Œé‚£ä¹ˆå‚æ•°ç›¸åŒçš„è¯·æ±‚å°†ä¼šè½åˆ°åŒä¸€ä¸ª Provider èŠ‚ç‚¹ä¸Šã€‚ä¸è¿‡æ­¤æ—¶å¦‚æœçªç„¶æœ‰ä¸€ä¸ª Provider èŠ‚ç‚¹å‡ºç°å®•æœºçš„æƒ…å†µï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦å¯¹ 2 å–æ¨¡ï¼Œå³è¯·æ±‚ä¼šé‡æ–°åˆ†é…åˆ°ç›¸åº”çš„ Provider ä¹‹ä¸Šã€‚åœ¨æç«¯æƒ…å†µä¸‹ï¼Œç”šè‡³ä¼šå‡ºç°æ‰€æœ‰è¯·æ±‚çš„å¤„ç†èŠ‚ç‚¹éƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™å°±ä¼šé€ æˆæ¯”è¾ƒå¤§çš„æ³¢åŠ¨ã€‚</p>
<p data-nodeid="176793">ä¸ºäº†é¿å…å› ä¸€ä¸ª Provider èŠ‚ç‚¹å®•æœºï¼Œè€Œå¯¼è‡´å¤§é‡è¯·æ±‚çš„å¤„ç†èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸€è‡´æ€§ Hash ç®—æ³•ã€‚<strong data-nodeid="176912">ä¸€è‡´æ€§ Hash ç®—æ³•çš„åŸç†ä¹Ÿæ˜¯å–æ¨¡ç®—æ³•ï¼Œä¸ Hash å–æ¨¡çš„ä¸åŒä¹‹å¤„åœ¨äºï¼šHash å–æ¨¡æ˜¯å¯¹ Provider èŠ‚ç‚¹æ•°é‡å–æ¨¡ï¼Œè€Œä¸€è‡´æ€§ Hash ç®—æ³•æ˜¯å¯¹ 2^32 å–æ¨¡ã€‚</strong></p>
<p data-nodeid="176794">ä¸€è‡´æ€§ Hash ç®—æ³•éœ€è¦åŒæ—¶å¯¹ Provider åœ°å€ä»¥åŠè¯·æ±‚å‚æ•°è¿›è¡Œå–æ¨¡ï¼š</p>
<pre class="lang-java" data-nodeid="176795"><code data-language="java">hash(Provideråœ°å€) % <span class="hljs-number">2</span>^<span class="hljs-number">32</span>
hash(è¯·æ±‚å‚æ•°) % <span class="hljs-number">2</span>^<span class="hljs-number">32</span>
</code></pre>
<p data-nodeid="179355">Provider åœ°å€å’Œè¯·æ±‚ç»è¿‡å¯¹ 2^32 å–æ¨¡å¾—åˆ°çš„ç»“æœå€¼ï¼Œéƒ½ä¼šè½åˆ°ä¸€ä¸ª Hash ç¯ä¸Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p data-nodeid="179356" class=""><img src="https://s0.lgstatic.com/i/image/M00/71/15/CgqCHl-81wSAO1YfAAFfH6Qgse0640.png" alt="Lark20201124-174752.png" data-nodeid="179361"></p>
<div data-nodeid="179357"><p style="text-align:center">ä¸€è‡´æ€§ Hash èŠ‚ç‚¹å‡åŒ€åˆ†å¸ƒå›¾</p></div>




<p data-nodeid="176799">æˆ‘ä»¬æŒ‰é¡ºæ—¶é’ˆçš„æ–¹å‘ï¼Œä¾æ¬¡å°†è¯·æ±‚åˆ†å‘åˆ°å¯¹åº”çš„ Providerã€‚è¿™æ ·ï¼Œå½“æŸå° Provider èŠ‚ç‚¹å®•æœºæˆ–å¢åŠ æ–°çš„ Provider èŠ‚ç‚¹æ—¶ï¼Œåªä¼šå½±å“è¿™ä¸ª Provider èŠ‚ç‚¹å¯¹åº”çš„è¯·æ±‚ã€‚</p>
<p data-nodeid="180303">åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œä¸€è‡´æ€§ Hash ç®—æ³•ä¼šå°†è¿™ä¸‰ä¸ª Provider èŠ‚ç‚¹å‡åŒ€åœ°åˆ†å¸ƒåˆ° Hash ç¯ä¸Šï¼Œè¯·æ±‚ä¹Ÿå¯ä»¥å‡åŒ€åœ°åˆ†å‘ç»™è¿™ä¸‰ä¸ª Provider èŠ‚ç‚¹ã€‚ä½†åœ¨å®é™…æƒ…å†µä¸­ï¼Œè¿™ä¸‰ä¸ª Provider èŠ‚ç‚¹åœ°å€å–æ¨¡ä¹‹åçš„å€¼ï¼Œå¯èƒ½å·®è·ä¸å¤§ï¼Œè¿™æ ·ä¼šå¯¼è‡´å¤§é‡çš„è¯·æ±‚è½åˆ°ä¸€ä¸ª Provider èŠ‚ç‚¹ä¸Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p data-nodeid="180304" class=""><img src="https://s0.lgstatic.com/i/image/M00/71/15/CgqCHl-81w2ATT5qAAFjvpkgTNM463.png" alt="Lark20201124-174755.png" data-nodeid="180309"></p>
<div data-nodeid="180305"><p style="text-align:center">ä¸€è‡´æ€§ Hash èŠ‚ç‚¹éå‡åŒ€åˆ†å¸ƒå›¾</p></div>




<p data-nodeid="176803">è¿™å°±å‡ºç°äº†æ•°æ®å€¾æ–œçš„é—®é¢˜ã€‚<strong data-nodeid="176928">æ‰€è°“æ•°æ®å€¾æ–œæ˜¯æŒ‡ç”±äºèŠ‚ç‚¹ä¸å¤Ÿåˆ†æ•£ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚è½åˆ°äº†åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œè€Œå…¶ä»–èŠ‚ç‚¹åªä¼šæ¥æ”¶åˆ°å°‘é‡è¯·æ±‚çš„æƒ…å†µ</strong>ã€‚</p>
<p data-nodeid="176804">ä¸ºäº†è§£å†³ä¸€è‡´æ€§ Hash ç®—æ³•ä¸­å‡ºç°çš„æ•°æ®å€¾æ–œé—®é¢˜ï¼Œåˆæ¼”åŒ–å‡ºäº† Hash æ§½çš„æ¦‚å¿µã€‚</p>
<p data-nodeid="181251">Hash æ§½è§£å†³æ•°æ®å€¾æ–œçš„æ€è·¯æ˜¯ï¼šæ—¢ç„¶é—®é¢˜æ˜¯ç”± Provider èŠ‚ç‚¹åœ¨ Hash ç¯ä¸Šåˆ†å¸ƒä¸å‡åŒ€é€ æˆçš„ï¼Œé‚£ä¹ˆå¯ä»¥è™šæ‹Ÿå‡º n ç»„ P1ã€P2ã€P3 çš„ Provider èŠ‚ç‚¹ ï¼Œè®©å¤šç»„ Provider èŠ‚ç‚¹ç›¸å¯¹å‡åŒ€åœ°åˆ†å¸ƒåœ¨ Hash ç¯ä¸Šã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç›¸åŒé˜´å½±çš„èŠ‚ç‚¹å‡ä¸ºåŒä¸€ä¸ª Provider èŠ‚ç‚¹ï¼Œæ¯”å¦‚ P1-1ã€P1-2â€¦â€¦P1-99 è¡¨ç¤ºçš„éƒ½æ˜¯ P1 è¿™ä¸ª Provider èŠ‚ç‚¹ã€‚å¼•å…¥ Provider è™šæ‹ŸèŠ‚ç‚¹ä¹‹åï¼Œè®© Provider åœ¨åœ†ç¯ä¸Šåˆ†æ•£å¼€æ¥ï¼Œä»¥é¿å…æ•°æ®å€¾æ–œé—®é¢˜ã€‚</p>
<p data-nodeid="181252" class=""><img src="https://s0.lgstatic.com/i/image/M00/71/15/CgqCHl-81xaAEUSbAAG0t7C-hcQ544.png" alt="Lark20201124-174743.png" data-nodeid="181257"></p>
<div data-nodeid="181253"><p style="text-align:center">æ•°æ®å€¾æ–œè§£å†³ç¤ºæ„å›¾</p></div>




<h4 data-nodeid="176808">2. ConsistentHashSelector å®ç°åˆ†æ</h4>
<p data-nodeid="176809">äº†è§£äº†ä¸€è‡´æ€§ Hash ç®—æ³•çš„åŸºæœ¬åŸç†ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ ConsistentHashLoadBalance ä¸€è‡´æ€§ Hash è´Ÿè½½å‡è¡¡çš„å…·ä½“å®ç°ã€‚é¦–å…ˆæ¥çœ‹ doSelect() æ–¹æ³•çš„å®ç°ï¼Œå…¶ä¸­ä¼šæ ¹æ® ServiceKey å’Œ methodName é€‰æ‹©ä¸€ä¸ª ConsistentHashSelector å¯¹è±¡ï¼Œ<strong data-nodeid="176941">æ ¸å¿ƒç®—æ³•éƒ½å§”æ‰˜ç»™ ConsistentHashSelector å¯¹è±¡å®Œæˆã€‚</strong></p>
<pre class="lang-java" data-nodeid="176810"><code data-language="java"><span class="hljs-keyword">protected</span> &lt;T&gt; <span class="hljs-function">Invoker&lt;T&gt; <span class="hljs-title">doSelect</span><span class="hljs-params">(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</span> </span>{
&nbsp; &nbsp; <span class="hljs-comment">// è·å–è°ƒç”¨çš„æ–¹æ³•åç§°</span>
&nbsp; &nbsp; String methodName = RpcUtils.getMethodName(invocation);
&nbsp; &nbsp; <span class="hljs-comment">// å°†ServiceKeyå’Œæ–¹æ³•æ‹¼æ¥èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªkey</span>
&nbsp; &nbsp; String key = invokers.get(<span class="hljs-number">0</span>).getUrl().getServiceKey() + <span class="hljs-string">"."</span> + methodName;
&nbsp; &nbsp; <span class="hljs-comment">// æ³¨æ„ï¼šè¿™æ˜¯ä¸ºäº†åœ¨invokersåˆ—è¡¨å‘ç”Ÿå˜åŒ–æ—¶éƒ½ä¼šé‡æ–°ç”ŸæˆConsistentHashSelectorå¯¹è±¡</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span> invokersHashCode = invokers.hashCode();
&nbsp; &nbsp; <span class="hljs-comment">// æ ¹æ®keyè·å–å¯¹åº”çš„ConsistentHashSelectorå¯¹è±¡ï¼Œselectorsæ˜¯ä¸€ä¸ªConcurrentMap&lt;String, ConsistentHashSelector&gt;é›†åˆ</span>
&nbsp; &nbsp; ConsistentHashSelector&lt;T&gt; selector = (ConsistentHashSelector&lt;T&gt;) selectors.get(key);
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (selector == <span class="hljs-keyword">null</span> || selector.identityHashCode != invokersHashCode) { <span class="hljs-comment">// æœªæŸ¥æ‰¾åˆ°ConsistentHashSelectorå¯¹è±¡ï¼Œåˆ™è¿›è¡Œåˆ›å»º</span>
&nbsp; &nbsp; &nbsp; &nbsp; selectors.put(key, <span class="hljs-keyword">new</span> ConsistentHashSelector&lt;T&gt;(invokers, methodName, invokersHashCode));
&nbsp; &nbsp; &nbsp; &nbsp; selector = (ConsistentHashSelector&lt;T&gt;) selectors.get(key);
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-comment">// é€šè¿‡ConsistentHashSelectorå¯¹è±¡é€‰æ‹©ä¸€ä¸ªInvokerå¯¹è±¡</span>
&nbsp; &nbsp; <span class="hljs-keyword">return</span> selector.select(invocation);
}
</code></pre>
<p data-nodeid="176811">ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ ConsistentHashSelectorï¼Œå…¶æ ¸å¿ƒå­—æ®µå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<ul data-nodeid="176812">
<li data-nodeid="176813">
<p data-nodeid="176814">virtualInvokersï¼ˆTreeMap&lt;Long, Invoker<code data-backticks="1" data-nodeid="176946">&lt;T&gt;</code>&gt; ç±»å‹ï¼‰ï¼šç”¨äºè®°å½•è™šæ‹Ÿ Invoker å¯¹è±¡çš„ Hash ç¯ã€‚è¿™é‡Œä½¿ç”¨ TreeMap å®ç° Hash ç¯ï¼Œå¹¶å°†è™šæ‹Ÿçš„ Invoker å¯¹è±¡åˆ†å¸ƒåœ¨ Hash ç¯ä¸Šã€‚</p>
</li>
<li data-nodeid="176815">
<p data-nodeid="176816">replicaNumberï¼ˆint ç±»å‹ï¼‰ï¼šè™šæ‹Ÿ Invoker ä¸ªæ•°ã€‚</p>
</li>
<li data-nodeid="176817">
<p data-nodeid="176818">identityHashCodeï¼ˆint ç±»å‹ï¼‰ï¼šInvoker é›†åˆçš„ HashCode å€¼ã€‚</p>
</li>
<li data-nodeid="176819">
<p data-nodeid="176820">argumentIndexï¼ˆint[] ç±»å‹ï¼‰ï¼šéœ€è¦å‚ä¸ Hash è®¡ç®—çš„å‚æ•°ç´¢å¼•ã€‚ä¾‹å¦‚ï¼ŒargumentIndex = [0, 1, 2] æ—¶ï¼Œè¡¨ç¤ºè°ƒç”¨çš„ç›®æ ‡æ–¹æ³•çš„å‰ä¸‰ä¸ªå‚æ•°è¦å‚ä¸ Hash è®¡ç®—ã€‚</p>
</li>
</ul>
<p data-nodeid="176821">æ¥ä¸‹æ¥çœ‹ ConsistentHashSelector çš„æ„é€ æ–¹æ³•ï¼Œå…¶ä¸­çš„ä¸»è¦ä»»åŠ¡æ˜¯ï¼š</p>
<ul data-nodeid="176822">
<li data-nodeid="176823">
<p data-nodeid="176824">æ„å»º Hash æ§½ï¼›</p>
</li>
<li data-nodeid="176825">
<p data-nodeid="176826">ç¡®è®¤å‚ä¸ä¸€è‡´æ€§ Hash è®¡ç®—çš„å‚æ•°ï¼Œé»˜è®¤æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</p>
</li>
</ul>
<p data-nodeid="176827">è¿™äº›æ“ä½œçš„ç›®çš„å°±æ˜¯ä¸ºäº†è®© Invoker å°½å¯èƒ½å‡åŒ€åœ°åˆ†å¸ƒåœ¨ Hash ç¯ä¸Šï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="176828"><code data-language="java">ConsistentHashSelector(List&lt;Invoker&lt;T&gt;&gt; invokers, String methodName, <span class="hljs-keyword">int</span> identityHashCode) {
&nbsp; &nbsp; <span class="hljs-comment">// åˆå§‹åŒ–virtualInvokerså­—æ®µï¼Œä¹Ÿå°±æ˜¯è™šæ‹ŸHashæ§½</span>
&nbsp; &nbsp; <span class="hljs-keyword">this</span>.virtualInvokers = <span class="hljs-keyword">new</span> TreeMap&lt;Long, Invoker&lt;T&gt;&gt;();
&nbsp; &nbsp; <span class="hljs-comment">// è®°å½•Invokeré›†åˆçš„hashCodeï¼Œç”¨è¯¥hashCodeå€¼æ¥åˆ¤æ–­Provideråˆ—è¡¨æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–</span>
&nbsp; &nbsp; <span class="hljs-keyword">this</span>.identityHashCode = identityHashCode;
&nbsp; &nbsp; URL url = invokers.get(<span class="hljs-number">0</span>).getUrl();
&nbsp; &nbsp; <span class="hljs-comment">// ä»hash.nodeså‚æ•°ä¸­è·å–è™šæ‹ŸèŠ‚ç‚¹çš„ä¸ªæ•°</span>
&nbsp; &nbsp; <span class="hljs-keyword">this</span>.replicaNumber = url.getMethodParameter(methodName, HASH_NODES, <span class="hljs-number">160</span>);
&nbsp; &nbsp; <span class="hljs-comment">// è·å–å‚ä¸Hashè®¡ç®—çš„å‚æ•°ä¸‹æ ‡å€¼ï¼Œé»˜è®¤å¯¹ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡ŒHashè¿ç®—</span>
&nbsp; &nbsp; String[] index = COMMA_SPLIT_PATTERN.split(url.getMethodParameter(methodName, HASH_ARGUMENTS, <span class="hljs-string">"0"</span>));
&nbsp; &nbsp; argumentIndex = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[index.length];
&nbsp; &nbsp; <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; index.length; i++) {
&nbsp; &nbsp; &nbsp; &nbsp; argumentIndex[i] = Integer.parseInt(index[i]);
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-comment">// æ„å»ºè™šæ‹ŸHashæ§½ï¼Œé»˜è®¤replicaNumber=160ï¼Œç›¸å½“äºåœ¨Hashæ§½ä¸Šæ”¾160ä¸ªæ§½ä½</span>
&nbsp; &nbsp; <span class="hljs-comment">// å¤–å±‚è½®è¯¢40æ¬¡ï¼Œå†…å±‚è½®è¯¢4æ¬¡ï¼Œå…±40*4=160æ¬¡ï¼Œä¹Ÿå°±æ˜¯åŒä¸€èŠ‚ç‚¹è™šæ‹Ÿå‡º160ä¸ªæ§½ä½</span>
&nbsp; &nbsp; <span class="hljs-keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) {
&nbsp; &nbsp; &nbsp; &nbsp; String address = invoker.getUrl().getAddress();
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; replicaNumber / <span class="hljs-number">4</span>; i++) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å¯¹address + iè¿›è¡Œmd5è¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªé•¿åº¦ä¸º16çš„å­—èŠ‚æ•°ç»„</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">byte</span>[] digest = md5(address + i);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å¯¹digestéƒ¨åˆ†å­—èŠ‚è¿›è¡Œ4æ¬¡Hashè¿ç®—ï¼Œå¾—åˆ°4ä¸ªä¸åŒçš„longå‹æ­£æ•´æ•°</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> h = <span class="hljs-number">0</span>; h &lt; <span class="hljs-number">4</span>; h++) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// h = 0 æ—¶ï¼Œå– digest ä¸­ä¸‹æ ‡ä¸º 0~3 çš„ 4 ä¸ªå­—èŠ‚è¿›è¡Œä½è¿ç®—</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// h = 1 æ—¶ï¼Œå– digest ä¸­ä¸‹æ ‡ä¸º 4~7 çš„ 4 ä¸ªå­—èŠ‚è¿›è¡Œä½è¿ç®—</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// h = 2 å’Œ h = 3æ—¶ï¼Œè¿‡ç¨‹åŒä¸Š</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">long</span> m = hash(digest, h);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; virtualInvokers.put(m, invoker);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }
}
</code></pre>
<p data-nodeid="176829">æœ€åï¼Œè¯·æ±‚ä¼šé€šè¿‡ ConsistentHashSelector.select() æ–¹æ³•é€‰æ‹©åˆé€‚çš„ Invoker å¯¹è±¡ï¼Œå…¶ä¸­ä¼šå…ˆå¯¹è¯·æ±‚å‚æ•°è¿›è¡Œ md5 ä»¥åŠ Hash è¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ª Hash å€¼ï¼Œç„¶åå†é€šè¿‡è¿™ä¸ª Hash å€¼åˆ° TreeMap ä¸­æŸ¥æ‰¾ç›®æ ‡ Invokerã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="176830"><code data-language="java"><span class="hljs-function"><span class="hljs-keyword">public</span> Invoker&lt;T&gt; <span class="hljs-title">select</span><span class="hljs-params">(Invocation invocation)</span> </span>{
&nbsp; &nbsp; <span class="hljs-comment">// å°†å‚ä¸ä¸€è‡´æ€§Hashçš„å‚æ•°æ‹¼æ¥åˆ°ä¸€èµ·</span>
&nbsp; &nbsp; String key = toKey(invocation.getArguments());
&nbsp; &nbsp; <span class="hljs-comment">// è®¡ç®—keyçš„Hashå€¼</span>
&nbsp; &nbsp; <span class="hljs-keyword">byte</span>[] digest = md5(key);
&nbsp; &nbsp; <span class="hljs-comment">// åŒ¹é…Invokerå¯¹è±¡</span>
&nbsp; &nbsp; <span class="hljs-keyword">return</span> selectForKey(hash(digest, <span class="hljs-number">0</span>));
}

<span class="hljs-function"><span class="hljs-keyword">private</span> Invoker&lt;T&gt; <span class="hljs-title">selectForKey</span><span class="hljs-params">(<span class="hljs-keyword">long</span> hash)</span> </span>{
&nbsp; &nbsp; <span class="hljs-comment">// ä»virtualInvokersé›†åˆï¼ˆTreeMapæ˜¯æŒ‰ç…§Keyæ’åºçš„ï¼‰ä¸­æŸ¥æ‰¾ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å€¼å¤§äºæˆ–ç­‰äºä¼ å…¥Hashå€¼çš„Invokerå¯¹è±¡</span>
&nbsp; &nbsp; Map.Entry&lt;Long, Invoker&lt;T&gt;&gt; entry = virtualInvokers.ceilingEntry(hash);
&nbsp; &nbsp; <span class="hljs-comment">// å¦‚æœHashå€¼å¤§äºHashç¯ä¸­çš„æ‰€æœ‰Invokerï¼Œåˆ™å›åˆ°Hashç¯çš„å¼€å¤´ï¼Œè¿”å›ç¬¬ä¸€ä¸ªInvokerå¯¹è±¡</span>
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (entry == <span class="hljs-keyword">null</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; entry = virtualInvokers.firstEntry();
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-keyword">return</span> entry.getValue();
}
</code></pre>
<h3 data-nodeid="176831">RandomLoadBalance</h3>
<p data-nodeid="176832">RandomLoadBalance ä½¿ç”¨çš„è´Ÿè½½å‡è¡¡ç®—æ³•æ˜¯<strong data-nodeid="176970">åŠ æƒéšæœºç®—æ³•</strong>ã€‚RandomLoadBalance æ˜¯ä¸€ä¸ªç®€å•ã€é«˜æ•ˆçš„è´Ÿè½½å‡è¡¡å®ç°ï¼Œå®ƒä¹Ÿæ˜¯ Dubbo é»˜è®¤ä½¿ç”¨çš„ LoadBalance å®ç°ã€‚</p>
<p data-nodeid="182199">è¿™é‡Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¥è¯´æ˜åŠ æƒéšæœºç®—æ³•çš„æ ¸å¿ƒæ€æƒ³ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸‰ä¸ª Provider èŠ‚ç‚¹ Aã€Bã€Cï¼Œå®ƒä»¬å¯¹åº”çš„æƒé‡åˆ†åˆ«ä¸º 5ã€2ã€3ï¼Œæƒé‡æ€»å’Œä¸º 10ã€‚ç°åœ¨æŠŠè¿™äº›æƒé‡å€¼æ”¾åˆ°ä¸€ç»´åæ ‡è½´ä¸Šï¼Œ[0, 5) åŒºé—´å±äºèŠ‚ç‚¹ Aï¼Œ[5, 7) åŒºé—´å±äºèŠ‚ç‚¹ Bï¼Œ[7, 10) åŒºé—´å±äºèŠ‚ç‚¹ Cï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p data-nodeid="182200" class="te-preview-highlight"><img src="https://s0.lgstatic.com/i/image/M00/71/0A/Ciqc1F-81ySAdj_7AAAxc2j-s5k730.png" alt="Drawing 5.png" data-nodeid="182211"></p>
<div data-nodeid="182201"><p style="text-align:center">æƒé‡åæ ‡è½´ç¤ºæ„å›¾</p></div>




<p data-nodeid="176836">ä¸‹é¢æˆ‘ä»¬é€šè¿‡éšæœºæ•°ç”Ÿæˆå™¨åœ¨ [0, 10) è¿™ä¸ªèŒƒå›´å†…ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œç„¶åè®¡ç®—è¿™ä¸ªéšæœºæ•°ä¼šè½åˆ°å“ªä¸ªåŒºé—´ä¸­ã€‚ä¾‹å¦‚ï¼Œéšæœºç”Ÿæˆ 4ï¼Œå°±ä¼šè½åˆ° Provider A å¯¹åº”çš„åŒºé—´ä¸­ï¼Œæ­¤æ—¶ RandomLoadBalance å°±ä¼šè¿”å› Provider A è¿™ä¸ªèŠ‚ç‚¹ã€‚</p>
<p data-nodeid="176837">æ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹ RandomLoadBalance ä¸­ doSelect() æ–¹æ³•çš„å®ç°ï¼Œå…¶æ ¸å¿ƒé€»è¾‘åˆ†ä¸ºä¸‰ä¸ªå…³é”®ç‚¹ï¼š</p>
<ul data-nodeid="176838">
<li data-nodeid="176839">
<p data-nodeid="176840">è®¡ç®—æ¯ä¸ª Invoker å¯¹åº”çš„æƒé‡å€¼ä»¥åŠæ€»æƒé‡å€¼ï¼›</p>
</li>
<li data-nodeid="176841">
<p data-nodeid="176842">å½“å„ä¸ª Invoker æƒé‡å€¼ä¸ç›¸ç­‰æ—¶ï¼Œè®¡ç®—éšæœºæ•°åº”è¯¥è½åœ¨å“ªä¸ª Invoker åŒºé—´ä¸­ï¼Œè¿”å›å¯¹åº”çš„ Invoker å¯¹è±¡ï¼›</p>
</li>
<li data-nodeid="176843">
<p data-nodeid="176844">å½“å„ä¸ª Invoker æƒé‡å€¼ç›¸åŒæ—¶ï¼Œéšæœºè¿”å›ä¸€ä¸ª Invoker å³å¯ã€‚</p>
</li>
</ul>
<p data-nodeid="176845">RandomLoadBalance ç»è¿‡å¤šæ¬¡è¯·æ±‚åï¼Œèƒ½å¤Ÿå°†è°ƒç”¨è¯·æ±‚æŒ‰ç…§æƒé‡å€¼å‡åŒ€åœ°åˆ†é…åˆ°å„ä¸ª Provider èŠ‚ç‚¹ä¸Šã€‚ä¸‹é¢æ˜¯ RandomLoadBalance çš„æ ¸å¿ƒå®ç°ï¼š</p>
<pre class="lang-java" data-nodeid="176846"><code data-language="java"><span class="hljs-keyword">protected</span> &lt;T&gt; <span class="hljs-function">Invoker&lt;T&gt; <span class="hljs-title">doSelect</span><span class="hljs-params">(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</span> </span>{
&nbsp; &nbsp; <span class="hljs-keyword">int</span> length = invokers.size();
&nbsp; &nbsp; <span class="hljs-keyword">boolean</span> sameWeight = <span class="hljs-keyword">true</span>;
&nbsp; &nbsp; <span class="hljs-comment">// è®¡ç®—æ¯ä¸ªInvokerå¯¹è±¡å¯¹åº”çš„æƒé‡ï¼Œå¹¶å¡«å……åˆ°weights[]æ•°ç»„ä¸­</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span>[] weights = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[length];
&nbsp; &nbsp; <span class="hljs-comment">// è®¡ç®—ç¬¬ä¸€ä¸ªInvokerçš„æƒé‡</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span> firstWeight = getWeight(invokers.get(<span class="hljs-number">0</span>), invocation);
&nbsp; &nbsp; weights[<span class="hljs-number">0</span>] = firstWeight;
&nbsp; &nbsp; <span class="hljs-comment">// totalWeightç”¨äºè®°å½•æ€»æƒé‡å€¼</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span> totalWeight = firstWeight;
&nbsp; &nbsp; <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; length; i++) {
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// è®¡ç®—æ¯ä¸ªInvokerçš„æƒé‡ï¼Œä»¥åŠæ€»æƒé‡totalWeight</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">int</span> weight = getWeight(invokers.get(i), invocation);
&nbsp; &nbsp; &nbsp; &nbsp; weights[i] = weight;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// Sum</span>
&nbsp; &nbsp; &nbsp; &nbsp; totalWeight += weight;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// æ£€æµ‹æ¯ä¸ªProviderçš„æƒé‡æ˜¯å¦ç›¸åŒ</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (sameWeight &amp;&amp; weight != firstWeight) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sameWeight = <span class="hljs-keyword">false</span>;
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-comment">// å„ä¸ªInvokeræƒé‡å€¼ä¸ç›¸ç­‰æ—¶ï¼Œè®¡ç®—éšæœºæ•°è½åœ¨å“ªä¸ªåŒºé—´ä¸Š</span>
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (totalWeight &gt; <span class="hljs-number">0</span> &amp;&amp; !sameWeight) {
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// éšæœºè·å–ä¸€ä¸ª[0, totalWeight) åŒºé—´å†…çš„æ•°å­—</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">int</span> offset = ThreadLocalRandom.current().nextInt(totalWeight);
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å¾ªç¯è®©offsetæ•°å‡å»Invokerçš„æƒé‡å€¼ï¼Œå½“offsetå°äº0æ—¶ï¼Œè¿”å›ç›¸åº”çš„Invoker</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; offset -= weights[i];
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (offset &lt; <span class="hljs-number">0</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> invokers.get(i);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-comment">// å„ä¸ªInvokeræƒé‡å€¼ç›¸åŒæ—¶ï¼Œéšæœºè¿”å›ä¸€ä¸ªInvokerå³å¯</span>
&nbsp; &nbsp; <span class="hljs-keyword">return</span> invokers.get(ThreadLocalRandom.current().nextInt(length));
}
</code></pre>
<h3 data-nodeid="176847">æ€»ç»“</h3>
<p data-nodeid="176848">æœ¬è¯¾æ—¶æˆ‘ä»¬é‡ç‚¹ä»‹ç»äº† Dubbo Cluster å±‚ä¸­è´Ÿè½½å‡è¡¡ç›¸å…³çš„å†…å®¹ã€‚é¦–å…ˆæˆ‘ä»¬ä»‹ç»äº† LoadBalance æ¥å£çš„å®šä¹‰ä»¥åŠ AbstractLoadBalance æŠ½è±¡ç±»æä¾›çš„å…¬å…±èƒ½åŠ›ã€‚ç„¶åæˆ‘ä»¬è¿˜è¯¦ç»†è®²è§£äº† ConsistentHashLoadBalance çš„æ ¸å¿ƒå®ç°ï¼Œå…¶ä¸­è¿˜ç®€å•è¯´æ˜äº†ä¸€è‡´æ€§ Hash ç®—æ³•çš„åŸºç¡€çŸ¥è¯†ç‚¹ã€‚æœ€åï¼Œæˆ‘ä»¬åˆä¸€å—å„¿åˆ†æäº† RandomLoadBalance çš„åŸºæœ¬åŸç†å’Œæ ¸å¿ƒå®ç°ã€‚</p>
<p data-nodeid="176849" class="">ä¸‹ä¸€è¯¾æ—¶ï¼Œæˆ‘ä»¬å°†ç»§ç»­ä»‹ç»è´Ÿè½½å‡è¡¡çš„å‰©ä½™å®ç°ç±»ï¼Œè®°å¾—æŒ‰æ—¶æ¥å¬è¯¾ã€‚</p>

---

### ç²¾é€‰è¯„è®º

##### *é•‡ï¼š
> ç»§ç»­æ·±å…¥åˆ†æï¼ŒåŠ æ²¹å­¦ä¹ ğŸ˜€

##### *æ•ï¼š
> ä¸€è‡´æ€§hashç»ˆäºæ‡‚äº†ğŸ˜

##### LeonardoEzioï¼š
> çœ‹å®Œè¿™ä¸ª å»çœ‹dubboå®˜æ–¹æ–‡æ¡£æ”¶è·ä¼šæ›´å¤§

##### **é¹ï¼š
> è€å¸ˆï¼Œä¸è®²è®²é›†ç¾¤å®¹é”™å—ï¼Ÿ

 ###### &nbsp;&nbsp;&nbsp; ç¼–è¾‘å›å¤ï¼š
> &nbsp;&nbsp;&nbsp; é›†ç¾¤å®¹é”™ä¸‹å‘¨å°±æ›´æ–°å“ˆ~


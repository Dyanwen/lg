<p data-nodeid="45633" class="">åœ¨ä¸Šä¸€è¯¾æ—¶æˆ‘ä»¬äº†è§£äº† LoadBalance æ¥å£å®šä¹‰ä»¥åŠ AbstractLoadBalance æŠ½è±¡ç±»çš„å†…å®¹ï¼Œè¿˜è¯¦ç»†ä»‹ç»äº† ConsistentHashLoadBalance ä»¥åŠ RandomLoadBalance è¿™ä¸¤ä¸ªå®ç°ç±»çš„æ ¸å¿ƒåŸç†å’Œå¤§è‡´å®ç°ã€‚æœ¬è¯¾æ—¶æˆ‘ä»¬å°†ç»§ç»­ä»‹ç» LoadBalance çš„å‰©ä½™ä¸‰ä¸ªå®ç°ã€‚</p>
<h3 data-nodeid="45634">LeastActiveLoadBalance</h3>
<p data-nodeid="45635">LeastActiveLoadBalance ä½¿ç”¨çš„æ˜¯<strong data-nodeid="45685">æœ€å°æ´»è·ƒæ•°è´Ÿè½½å‡è¡¡ç®—æ³•</strong>ã€‚å®ƒè®¤ä¸ºå½“å‰æ´»è·ƒè¯·æ±‚æ•°è¶Šå°çš„ Provider èŠ‚ç‚¹ï¼Œå‰©ä½™çš„å¤„ç†èƒ½åŠ›è¶Šå¤šï¼Œå¤„ç†è¯·æ±‚çš„æ•ˆç‡ä¹Ÿå°±è¶Šé«˜ï¼Œé‚£ä¹ˆè¯¥ Provider åœ¨å•ä½æ—¶é—´å†…å°±å¯ä»¥å¤„ç†æ›´å¤šçš„è¯·æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥ä¼˜å…ˆå°†è¯·æ±‚åˆ†é…ç»™è¯¥ Provider èŠ‚ç‚¹ã€‚</p>
<p data-nodeid="45636">LeastActiveLoadBalance éœ€è¦é…åˆ ActiveLimitFilter ä½¿ç”¨ï¼ŒActiveLimitFilter ä¼šè®°å½•æ¯ä¸ªæ¥å£æ–¹æ³•çš„æ´»è·ƒè¯·æ±‚æ•°ï¼Œåœ¨ LeastActiveLoadBalance è¿›è¡Œè´Ÿè½½å‡è¡¡æ—¶ï¼Œåªä¼šä»æ´»è·ƒè¯·æ±‚æ•°æœ€å°‘çš„ Invoker é›†åˆé‡ŒæŒ‘é€‰ Invokerã€‚</p>
<p data-nodeid="45637">åœ¨ LeastActiveLoadBalance çš„å®ç°ä¸­ï¼Œé¦–å…ˆä¼šé€‰å‡ºæ‰€æœ‰æ´»è·ƒè¯·æ±‚æ•°æœ€å°çš„ Invoker å¯¹è±¡ï¼Œä¹‹åçš„é€»è¾‘ä¸ RandomLoadBalance å®Œå…¨ä¸€æ ·ï¼Œå³æŒ‰ç…§è¿™äº› Invoker å¯¹è±¡çš„æƒé‡æŒ‘é€‰æœ€ç»ˆçš„ Invoker å¯¹è±¡ã€‚ä¸‹é¢æ˜¯ LeastActiveLoadBalance.doSelect() æ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p>
<pre class="lang-java" data-nodeid="45638"><code data-language="java"><span class="hljs-keyword">protected</span> &lt;T&gt; <span class="hljs-function">Invoker&lt;T&gt; <span class="hljs-title">doSelect</span><span class="hljs-params">(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</span> </span>{
&nbsp; &nbsp; <span class="hljs-comment">// åˆå§‹åŒ–Invokeræ•°é‡</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span> length = invokers.size();
&nbsp; &nbsp; <span class="hljs-comment">// è®°å½•æœ€å°çš„æ´»è·ƒè¯·æ±‚æ•°</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span> leastActive = -<span class="hljs-number">1</span>;
&nbsp; &nbsp; <span class="hljs-comment">// è®°å½•æ´»è·ƒè¯·æ±‚æ•°æœ€å°çš„Invokeré›†åˆçš„ä¸ªæ•°</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span> leastCount = <span class="hljs-number">0</span>;
&nbsp; &nbsp; <span class="hljs-comment">// è®°å½•æ´»è·ƒè¯·æ±‚æ•°æœ€å°çš„Invokeråœ¨invokersæ•°ç»„ä¸­çš„ä¸‹æ ‡ä½ç½®&nbsp;</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span>[] leastIndexes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[length];
&nbsp; &nbsp; <span class="hljs-comment">// è®°å½•æ´»è·ƒè¯·æ±‚æ•°æœ€å°çš„Invokeré›†åˆä¸­ï¼Œæ¯ä¸ªInvokerçš„æƒé‡å€¼</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span>[] weights = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[length];
&nbsp; &nbsp; <span class="hljs-comment">// è®°å½•æ´»è·ƒè¯·æ±‚æ•°æœ€å°çš„Invokeré›†åˆä¸­ï¼Œæ‰€æœ‰Invokerçš„æƒé‡å€¼ä¹‹å’Œ</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span> totalWeight = <span class="hljs-number">0</span>;
&nbsp; &nbsp; <span class="hljs-comment">// è®°å½•æ´»è·ƒè¯·æ±‚æ•°æœ€å°çš„Invokeré›†åˆä¸­ï¼Œç¬¬ä¸€ä¸ªInvokerçš„æƒé‡å€¼</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span> firstWeight = <span class="hljs-number">0</span>;
&nbsp; &nbsp; <span class="hljs-comment">// æ´»è·ƒè¯·æ±‚æ•°æœ€å°çš„é›†åˆä¸­ï¼Œæ‰€æœ‰Invokerçš„æƒé‡å€¼æ˜¯å¦ç›¸åŒ</span>
&nbsp; &nbsp; <span class="hljs-keyword">boolean</span> sameWeight = <span class="hljs-keyword">true</span>;
&nbsp; &nbsp; <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) { <span class="hljs-comment">// éå†æ‰€æœ‰Invokerï¼Œè·å–æ´»è·ƒè¯·æ±‚æ•°æœ€å°çš„Invokeré›†åˆ</span>
&nbsp; &nbsp; &nbsp; &nbsp; Invoker&lt;T&gt; invoker = invokers.get(i);
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// è·å–è¯¥Invokerçš„æ´»è·ƒè¯·æ±‚æ•°</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">int</span> active = RpcStatus.getStatus(invoker.getUrl(), invocation.getMethodName()).getActive();
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// è·å–è¯¥Invokerçš„æƒé‡</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">int</span> afterWarmup = getWeight(invoker, invocation);
&nbsp; &nbsp; &nbsp; &nbsp; weights[i] = afterWarmup;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// æ¯”è¾ƒæ´»è·ƒè¯·æ±‚æ•°</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (leastActive == -<span class="hljs-number">1</span> || active &lt; leastActive) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å½“å‰çš„Invokeræ˜¯ç¬¬ä¸€ä¸ªæ´»è·ƒè¯·æ±‚æ•°æœ€å°çš„Invokerï¼Œåˆ™è®°å½•å¦‚ä¸‹ä¿¡æ¯</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; leastActive = active; <span class="hljs-comment">// é‡æ–°è®°å½•æœ€å°çš„æ´»è·ƒè¯·æ±‚æ•°</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; leastCount = <span class="hljs-number">1</span>; <span class="hljs-comment">// é‡æ–°è®°å½•æ´»è·ƒè¯·æ±‚æ•°æœ€å°çš„Invokeré›†åˆä¸ªæ•°</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; leastIndexes[<span class="hljs-number">0</span>] = i; <span class="hljs-comment">// é‡æ–°è®°å½•Invoker</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; totalWeight = afterWarmup; <span class="hljs-comment">// é‡æ–°è®°å½•æ€»æƒé‡å€¼</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; firstWeight = afterWarmup; <span class="hljs-comment">// è¯¥Invokerä½œä¸ºç¬¬ä¸€ä¸ªInvokerï¼Œè®°å½•å…¶æƒé‡å€¼</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sameWeight = <span class="hljs-keyword">true</span>; <span class="hljs-comment">// é‡æ–°è®°å½•æ˜¯å¦æƒé‡å€¼ç›¸ç­‰</span>
&nbsp; &nbsp; &nbsp; &nbsp; } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (active == leastActive) {&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å½“å‰Invokerå±äºæ´»è·ƒè¯·æ±‚æ•°æœ€å°çš„Invokeré›†åˆ</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; leastIndexes[leastCount++] = i; <span class="hljs-comment">// è®°å½•è¯¥Invokerçš„ä¸‹æ ‡</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; totalWeight += afterWarmup; <span class="hljs-comment">// æ›´æ–°æ€»æƒé‡</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (sameWeight &amp;&amp; afterWarmup != firstWeight) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sameWeight = <span class="hljs-keyword">false</span>; <span class="hljs-comment">// æ›´æ–°æƒé‡å€¼æ˜¯å¦ç›¸ç­‰</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-comment">// å¦‚æœåªæœ‰ä¸€ä¸ªæ´»è·ƒè¯·æ±‚æ•°æœ€å°çš„Invokerå¯¹è±¡ï¼Œç›´æ¥è¿”å›å³å¯</span>
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (leastCount == <span class="hljs-number">1</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> invokers.get(leastIndexes[<span class="hljs-number">0</span>]);
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-comment">// ä¸‹é¢æŒ‰ç…§RandomLoadBalanceçš„é€»è¾‘ï¼Œä»æ´»è·ƒè¯·æ±‚æ•°æœ€å°çš„Invokeré›†åˆä¸­ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªInvokerå¯¹è±¡è¿”å›</span>
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (!sameWeight &amp;&amp; totalWeight &gt; <span class="hljs-number">0</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">int</span> offsetWeight = ThreadLocalRandom.current().nextInt(totalWeight);
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; leastCount; i++) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">int</span> leastIndex = leastIndexes[i];
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; offsetWeight -= weights[leastIndex];
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (offsetWeight &lt; <span class="hljs-number">0</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> invokers.get(leastIndex);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-keyword">return</span> invokers.get(leastIndexes[ThreadLocalRandom.current().nextInt(leastCount)]);
}
</code></pre>
<p data-nodeid="45639">ActiveLimitFilter ä»¥åŠåº•å±‚çš„ RpcStatus è®°å½•æ´»è·ƒè¯·æ±‚æ•°çš„å…·ä½“åŸç†ï¼Œåœ¨å‰é¢çš„<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=393#/detail/pc?id=5194" data-nodeid="45691">ç¬¬ 30 è¯¾æ—¶</a>ä¸­æˆ‘ä»¬å·²ç»è¯¦ç»†åˆ†æè¿‡äº†ï¼Œè¿™é‡Œä¸å†é‡å¤ï¼Œå¦‚æœæœ‰ä¸æ¸…æ¥šçš„åœ°æ–¹ï¼Œä½ å¯ä»¥å›é¡¾ä¹‹å‰è¯¾æ—¶ç›¸å…³çš„å†…å®¹ã€‚</p>
<h3 data-nodeid="45640">RoundRobinLoadBalance</h3>
<p data-nodeid="45641">RoundRobinLoadBalance å®ç°çš„æ˜¯<strong data-nodeid="45699">åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡ç®—æ³•</strong>ã€‚</p>
<p data-nodeid="45642">è½®è¯¢æŒ‡çš„æ˜¯å°†è¯·æ±‚è½®æµåˆ†é…ç»™æ¯ä¸ª Providerã€‚ä¾‹å¦‚ï¼Œæœ‰ Aã€Bã€C ä¸‰ä¸ª Provider èŠ‚ç‚¹ï¼ŒæŒ‰ç…§æ™®é€šè½®è¯¢çš„æ–¹å¼ï¼Œæˆ‘ä»¬ä¼šå°†ç¬¬ä¸€ä¸ªè¯·æ±‚åˆ†é…ç»™ Provider Aï¼Œå°†ç¬¬äºŒä¸ªè¯·æ±‚åˆ†é…ç»™ Provider Bï¼Œç¬¬ä¸‰ä¸ªè¯·æ±‚åˆ†é…ç»™ Provider Cï¼Œç¬¬å››ä¸ªè¯·æ±‚å†æ¬¡åˆ†é…ç»™ Provider Aâ€¦â€¦å¦‚æ­¤å¾ªç¯å¾€å¤ã€‚</p>
<p data-nodeid="45643"><strong data-nodeid="45705">è½®è¯¢æ˜¯ä¸€ç§æ— çŠ¶æ€è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå®ç°ç®€å•ï¼Œé€‚ç”¨äºé›†ç¾¤ä¸­æ‰€æœ‰ Provider èŠ‚ç‚¹æ€§èƒ½ç›¸è¿‘çš„åœºæ™¯ã€‚</strong> ä½†ç°å®æƒ…å†µä¸­å°±å¾ˆéš¾ä¿è¯è¿™ä¸€ç‚¹äº†ï¼Œå› ä¸ºå¾ˆå®¹æ˜“å‡ºç°é›†ç¾¤ä¸­æ€§èƒ½æœ€å¥½å’Œæœ€å·®çš„ Provider èŠ‚ç‚¹å¤„ç†åŒæ ·æµé‡çš„æƒ…å†µï¼Œè¿™å°±å¯èƒ½å¯¼è‡´æ€§èƒ½å·®çš„ Provider èŠ‚ç‚¹å„æ–¹é¢èµ„æºéå¸¸ç´§å¼ ï¼Œç”šè‡³æ— æ³•åŠæ—¶å“åº”äº†ï¼Œä½†æ˜¯æ€§èƒ½å¥½çš„ Provider èŠ‚ç‚¹çš„å„æ–¹é¢èµ„æºä½¿ç”¨è¿˜è¾ƒä¸ºç©ºé—²ã€‚è¿™æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ æƒè½®è¯¢çš„æ–¹å¼ï¼Œé™ä½åˆ†é…åˆ°æ€§èƒ½è¾ƒå·®çš„ Provider èŠ‚ç‚¹çš„æµé‡ã€‚</p>
<p data-nodeid="45644">åŠ æƒä¹‹åï¼Œåˆ†é…ç»™æ¯ä¸ª Provider èŠ‚ç‚¹çš„æµé‡æ¯”ä¼šæ¥è¿‘æˆ–ç­‰äºå®ƒä»¬çš„æƒé‡æ¯”ã€‚ä¾‹å¦‚ï¼ŒProvider èŠ‚ç‚¹ Aã€Bã€C æƒé‡æ¯”ä¸º 5:1:1ï¼Œé‚£ä¹ˆåœ¨ 7 æ¬¡è¯·æ±‚ä¸­ï¼ŒèŠ‚ç‚¹ A å°†æ”¶åˆ° 5 æ¬¡è¯·æ±‚ï¼ŒèŠ‚ç‚¹ B ä¼šæ”¶åˆ° 1 æ¬¡è¯·æ±‚ï¼ŒèŠ‚ç‚¹ C åˆ™ä¼šæ”¶åˆ° 1 æ¬¡è¯·æ±‚ã€‚</p>
<p data-nodeid="45645"><strong data-nodeid="45711">åœ¨ Dubbo 2.6.4 ç‰ˆæœ¬åŠä¹‹å‰ï¼ŒRoundRobinLoadBalance çš„å®ç°å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚ï¼Œé€‰æ‹© Invoker çš„æ€§èƒ½é—®é¢˜ã€è´Ÿè½½å‡è¡¡æ—¶ä¸å¤Ÿå¹³æ»‘ç­‰ã€‚åœ¨ Dubbo 2.6.5 ç‰ˆæœ¬ä¹‹åï¼Œè¿™äº›é—®é¢˜éƒ½å¾—åˆ°äº†ä¿®å¤</strong>ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±æ¥ä»‹ç»æœ€æ–°çš„ RoundRobinLoadBalance å®ç°ã€‚</p>
<p data-nodeid="45646">æ¯ä¸ª Provider èŠ‚ç‚¹æœ‰ä¸¤ä¸ªæƒé‡ï¼šä¸€ä¸ªæƒé‡æ˜¯é…ç½®çš„ weightï¼Œè¯¥å€¼åœ¨è´Ÿè½½å‡è¡¡çš„è¿‡ç¨‹ä¸­ä¸ä¼šå˜åŒ–ï¼›å¦ä¸€ä¸ªæƒé‡æ˜¯ currentWeightï¼Œè¯¥å€¼ä¼šåœ¨è´Ÿè½½å‡è¡¡çš„è¿‡ç¨‹ä¸­åŠ¨æ€è°ƒæ•´ï¼Œåˆå§‹å€¼ä¸º 0ã€‚</p>
<p data-nodeid="45647">å½“æœ‰æ–°çš„è¯·æ±‚è¿›æ¥æ—¶ï¼ŒRoundRobinLoadBalance ä¼šéå† Invoker åˆ—è¡¨ï¼Œå¹¶ç”¨å¯¹åº”çš„ currentWeight åŠ ä¸Šå…¶é…ç½®çš„æƒé‡ã€‚éå†å®Œæˆåï¼Œå†æ‰¾åˆ°æœ€å¤§çš„ currentWeightï¼Œå°†å…¶å‡å»æƒé‡æ€»å’Œï¼Œç„¶åè¿”å›ç›¸åº”çš„ Invoker å¯¹è±¡ã€‚</p>
<p data-nodeid="45648">ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç¤ºä¾‹è¯´æ˜ RoundRobinLoadBalance çš„æ‰§è¡Œæµç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬ä¾æ—§å‡è®¾ Aã€Bã€C ä¸‰ä¸ªèŠ‚ç‚¹çš„æƒé‡æ¯”ä¾‹ä¸º 5:1:1ã€‚</p>
<p data-nodeid="46477"><img src="https://s0.lgstatic.com/i/image/M00/72/19/CgqCHl_ArGSAfxA6AAHyWL4Af1o908.png" alt="Lark20201127-153527.png" data-nodeid="46480"></p>



<ol data-nodeid="45650">
<li data-nodeid="45651">
<p data-nodeid="45652">å¤„ç†ç¬¬ä¸€ä¸ªè¯·æ±‚ï¼ŒcurrentWeight æ•°ç»„ä¸­çš„æƒé‡ä¸é…ç½®çš„ weight ç›¸åŠ ï¼Œå³ä» [0, 0, 0] å˜ä¸º [5, 1, 1]ã€‚æ¥ä¸‹æ¥ï¼Œä»ä¸­é€‰æ‹©æƒé‡æœ€å¤§çš„ Invoker ä½œä¸ºç»“æœï¼Œå³èŠ‚ç‚¹ Aã€‚æœ€åï¼Œå°†èŠ‚ç‚¹ A çš„ currentWeight å€¼å‡å» totalWeight å€¼ï¼Œæœ€ç»ˆå¾—åˆ° currentWeight æ•°ç»„ä¸º [-2, 1, 1]ã€‚</p>
</li>
<li data-nodeid="45653">
<p data-nodeid="45654">å¤„ç†ç¬¬äºŒä¸ªè¯·æ±‚ï¼ŒcurrentWeight æ•°ç»„ä¸­çš„æƒé‡ä¸é…ç½®çš„ weight ç›¸åŠ ï¼Œå³ä» [-2, 1, 1] å˜ä¸º [3, 2, 2]ã€‚æ¥ä¸‹æ¥ï¼Œä»ä¸­é€‰æ‹©æƒé‡æœ€å¤§çš„ Invoker ä½œä¸ºç»“æœï¼Œå³èŠ‚ç‚¹ Aã€‚æœ€åï¼Œå°†èŠ‚ç‚¹ A çš„ currentWeight å€¼å‡å» totalWeight å€¼ï¼Œæœ€ç»ˆå¾—åˆ° currentWeight æ•°ç»„ä¸º [-4, 2, 2]ã€‚</p>
</li>
<li data-nodeid="45655">
<p data-nodeid="45656">å¤„ç†ç¬¬ä¸‰ä¸ªè¯·æ±‚ï¼ŒcurrentWeight æ•°ç»„ä¸­çš„æƒé‡ä¸é…ç½®çš„ weight ç›¸åŠ ï¼Œå³ä» [-4, 2, 2] å˜ä¸º [1, 3, 3]ã€‚æ¥ä¸‹æ¥ï¼Œä»ä¸­é€‰æ‹©æƒé‡æœ€å¤§çš„ Invoker ä½œä¸ºç»“æœï¼Œå³èŠ‚ç‚¹ Bã€‚æœ€åï¼Œå°†èŠ‚ç‚¹ B çš„ currentWeight å€¼å‡å» totalWeight å€¼ï¼Œæœ€ç»ˆå¾—åˆ° currentWeight æ•°ç»„ä¸º [1, -4, 3]ã€‚</p>
</li>
<li data-nodeid="45657">
<p data-nodeid="45658">å¤„ç†ç¬¬å››ä¸ªè¯·æ±‚ï¼ŒcurrentWeight æ•°ç»„ä¸­çš„æƒé‡ä¸é…ç½®çš„ weight ç›¸åŠ ï¼Œå³ä» [1, -4, 3] å˜ä¸º [6, -3, 4]ã€‚æ¥ä¸‹æ¥ï¼Œä»ä¸­é€‰æ‹©æƒé‡æœ€å¤§çš„ Invoker ä½œä¸ºç»“æœï¼Œå³èŠ‚ç‚¹ Aã€‚æœ€åï¼Œå°†èŠ‚ç‚¹ A çš„ currentWeight å€¼å‡å» totalWeight å€¼ï¼Œæœ€ç»ˆå¾—åˆ° currentWeight æ•°ç»„ä¸º [-1, -3, 4]ã€‚</p>
</li>
<li data-nodeid="45659">
<p data-nodeid="45660">å¤„ç†ç¬¬äº”ä¸ªè¯·æ±‚ï¼ŒcurrentWeight æ•°ç»„ä¸­çš„æƒé‡ä¸é…ç½®çš„ weight ç›¸åŠ ï¼Œå³ä» [-1, -3, 4] å˜ä¸º [4, -2, 5]ã€‚æ¥ä¸‹æ¥ï¼Œä»ä¸­é€‰æ‹©æƒé‡æœ€å¤§çš„ Invoker ä½œä¸ºç»“æœï¼Œå³èŠ‚ç‚¹ Cã€‚æœ€åï¼Œå°†èŠ‚ç‚¹ C çš„ currentWeight å€¼å‡å» totalWeight å€¼ï¼Œæœ€ç»ˆå¾—åˆ° currentWeight æ•°ç»„ä¸º [4, -2, -2]ã€‚</p>
</li>
<li data-nodeid="45661">
<p data-nodeid="45662">å¤„ç†ç¬¬å…­ä¸ªè¯·æ±‚ï¼ŒcurrentWeight æ•°ç»„ä¸­çš„æƒé‡ä¸é…ç½®çš„ weight ç›¸åŠ ï¼Œå³ä» [4, -2, -2] å˜ä¸º [9, -1, -1]ã€‚æ¥ä¸‹æ¥ï¼Œä»ä¸­é€‰æ‹©æƒé‡æœ€å¤§çš„ Invoker ä½œä¸ºç»“æœï¼Œå³èŠ‚ç‚¹ Aã€‚æœ€åï¼Œå°†èŠ‚ç‚¹ A çš„ currentWeight å€¼å‡å» totalWeight å€¼ï¼Œæœ€ç»ˆå¾—åˆ° currentWeight æ•°ç»„ä¸º [2, -1, -1]ã€‚</p>
</li>
<li data-nodeid="45663">
<p data-nodeid="45664">å¤„ç†ç¬¬ä¸ƒä¸ªè¯·æ±‚ï¼ŒcurrentWeight æ•°ç»„ä¸­çš„æƒé‡ä¸é…ç½®çš„ weight ç›¸åŠ ï¼Œå³ä» [2, -1, -1] å˜ä¸º [7, 0, 0]ã€‚æ¥ä¸‹æ¥ï¼Œä»ä¸­é€‰æ‹©æƒé‡æœ€å¤§çš„ Invoker ä½œä¸ºç»“æœï¼Œå³èŠ‚ç‚¹ Aã€‚æœ€åï¼Œå°†èŠ‚ç‚¹ A çš„ currentWeight å€¼å‡å» totalWeight å€¼ï¼Œæœ€ç»ˆå¾—åˆ° currentWeight æ•°ç»„ä¸º [0, 0, 0]ã€‚</p>
</li>
</ol>
<p data-nodeid="45665">åˆ°æ­¤ä¸ºæ­¢ï¼Œä¸€ä¸ªè½®è¯¢çš„å‘¨æœŸå°±ç»“æŸäº†ã€‚</p>
<p data-nodeid="45666">è€Œåœ¨ Dubbo 2.6.4 ç‰ˆæœ¬ä¸­ï¼Œä¸Šé¢ç¤ºä¾‹çš„ä¸€æ¬¡è½®è¯¢ç»“æœæ˜¯ [A, A, A, A, A, B, C]ï¼Œä¹Ÿå°±æ˜¯è¯´å‰ 5 ä¸ªè¯·æ±‚ä¼šå…¨éƒ¨éƒ½è½åˆ° A è¿™ä¸ªèŠ‚ç‚¹ä¸Šã€‚è¿™å°†ä¼šä½¿èŠ‚ç‚¹ A åœ¨çŸ­æ—¶é—´å†…æ¥æ”¶å¤§é‡çš„è¯·æ±‚ï¼Œå‹åŠ›é™¡å¢ï¼Œè€ŒèŠ‚ç‚¹ B å’ŒèŠ‚ç‚¹ C æ­¤æ—¶æ²¡æœ‰æ”¶åˆ°ä»»ä½•è¯·æ±‚ï¼Œå¤„äºå®Œå…¨ç©ºé—²çš„çŠ¶æ€ï¼Œè¿™ç§â€œç¬é—´åˆ†é…ä¸å¹³è¡¡â€çš„æƒ…å†µä¹Ÿå°±æ˜¯å‰é¢æåˆ°çš„â€œä¸å¹³æ»‘é—®é¢˜â€ã€‚</p>
<p data-nodeid="45667">åœ¨ RoundRobinLoadBalance ä¸­ï¼Œæˆ‘ä»¬<strong data-nodeid="45820">ä¸ºæ¯ä¸ª Invoker å¯¹è±¡åˆ›å»ºäº†ä¸€ä¸ªå¯¹åº”çš„ WeightedRoundRobin å¯¹è±¡</strong>ï¼Œç”¨æ¥è®°å½•é…ç½®çš„æƒé‡ï¼ˆweight å­—æ®µï¼‰ä»¥åŠéšæ¯æ¬¡è´Ÿè½½å‡è¡¡ç®—æ³•æ‰§è¡Œå˜åŒ–çš„ current æƒé‡ï¼ˆcurrent å­—æ®µï¼‰ã€‚</p>
<p data-nodeid="45668">äº†è§£äº† WeightedRoundRobin è¿™ä¸ªå†…éƒ¨ç±»åï¼Œæˆ‘ä»¬å†æ¥çœ‹ RoundRobinLoadBalance.doSelect() æ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p>
<pre class="lang-java" data-nodeid="45669"><code data-language="java"><span class="hljs-keyword">protected</span> &lt;T&gt; <span class="hljs-function">Invoker&lt;T&gt; <span class="hljs-title">doSelect</span><span class="hljs-params">(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</span> </span>{
&nbsp; &nbsp; String key = invokers.get(<span class="hljs-number">0</span>).getUrl().getServiceKey() + <span class="hljs-string">"."</span> + invocation.getMethodName();
&nbsp; &nbsp; <span class="hljs-comment">// è·å–æ•´ä¸ªInvokeråˆ—è¡¨å¯¹åº”çš„WeightedRoundRobinæ˜ å°„è¡¨ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„WeightedRoundRobinæ˜ å°„è¡¨</span>
&nbsp; &nbsp; ConcurrentMap&lt;String, WeightedRoundRobin&gt; map = methodWeightMap.computeIfAbsent(key, k -&gt; <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;());
&nbsp; &nbsp; <span class="hljs-keyword">int</span> totalWeight = <span class="hljs-number">0</span>;
&nbsp; &nbsp; <span class="hljs-keyword">long</span> maxCurrent = Long.MIN_VALUE;
&nbsp; &nbsp; <span class="hljs-keyword">long</span> now = System.currentTimeMillis(); <span class="hljs-comment">// è·å–å½“å‰æ—¶é—´</span>
&nbsp; &nbsp; Invoker&lt;T&gt; selectedInvoker = <span class="hljs-keyword">null</span>;
&nbsp; &nbsp; WeightedRoundRobin selectedWRR = <span class="hljs-keyword">null</span>;
&nbsp; &nbsp; <span class="hljs-keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) {
&nbsp; &nbsp; &nbsp; &nbsp; String identifyString = invoker.getUrl().toIdentityString();
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">int</span> weight = getWeight(invoker, invocation);
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// æ£€æµ‹å½“å‰Invokeræ˜¯å¦æœ‰ç›¸åº”çš„WeightedRoundRobinå¯¹è±¡ï¼Œæ²¡æœ‰åˆ™è¿›è¡Œåˆ›å»º</span>
&nbsp; &nbsp; &nbsp; &nbsp; WeightedRoundRobin weightedRoundRobin = map.computeIfAbsent(identifyString, k -&gt; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WeightedRoundRobin wrr = <span class="hljs-keyword">new</span> WeightedRoundRobin();
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wrr.setWeight(weight);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> wrr;
&nbsp; &nbsp; &nbsp; &nbsp; });
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// æ£€æµ‹Invokeræƒé‡æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œè‹¥å‘ç”Ÿå˜åŒ–ï¼Œåˆ™æ›´æ–°WeightedRoundRobinçš„weightå­—æ®µ</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (weight != weightedRoundRobin.getWeight()) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; weightedRoundRobin.setWeight(weight);
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// è®©currentWeightåŠ ä¸Šé…ç½®çš„Weight</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">long</span> cur = weightedRoundRobin.increaseCurrent();
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">//&nbsp; è®¾ç½®lastUpdateå­—æ®µ</span>
&nbsp; &nbsp; &nbsp; &nbsp; weightedRoundRobin.setLastUpdate(now);
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å¯»æ‰¾å…·æœ‰æœ€å¤§currentWeightçš„Invokerï¼Œä»¥åŠInvokerå¯¹åº”çš„WeightedRoundRobin</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (cur &gt; maxCurrent) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; maxCurrent = cur;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; selectedInvoker = invoker;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; selectedWRR = weightedRoundRobin;
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; totalWeight += weight; <span class="hljs-comment">// è®¡ç®—æƒé‡æ€»å’Œ</span>
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (invokers.size() != map.size()) {
&nbsp; &nbsp; &nbsp; &nbsp; map.entrySet().removeIf(item -&gt; now - item.getValue().getLastUpdate() &gt; RECYCLE_PERIOD);
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (selectedInvoker != <span class="hljs-keyword">null</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// ç”¨currentWeightå‡å»totalWeight</span>
&nbsp; &nbsp; &nbsp; &nbsp; selectedWRR.sel(totalWeight);
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// è¿”å›é€‰ä¸­çš„Invokerå¯¹è±¡</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> selectedInvoker;
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-keyword">return</span> invokers.get(<span class="hljs-number">0</span>);
}
</code></pre>
<h3 data-nodeid="45670">ShortestResponseLoadBalance</h3>
<p data-nodeid="45671">ShortestResponseLoadBalance æ˜¯<strong data-nodeid="45832">Dubbo 2.7 ç‰ˆæœ¬ä¹‹åæ–°å¢åŠ çš„ä¸€ä¸ª LoadBalance å®ç°ç±»</strong>ã€‚å®ƒå®ç°äº†<strong data-nodeid="45833">æœ€çŸ­å“åº”æ—¶é—´çš„è´Ÿè½½å‡è¡¡ç®—æ³•</strong>ï¼Œä¹Ÿå°±æ˜¯ä»å¤šä¸ª Provider èŠ‚ç‚¹ä¸­é€‰å‡ºè°ƒç”¨æˆåŠŸçš„ä¸”å“åº”æ—¶é—´æœ€çŸ­çš„ Provider èŠ‚ç‚¹ï¼Œä¸è¿‡æ»¡è¶³è¯¥æ¡ä»¶çš„ Provider èŠ‚ç‚¹å¯èƒ½æœ‰å¤šä¸ªï¼Œæ‰€ä»¥è¿˜è¦å†ä½¿ç”¨éšæœºç®—æ³•è¿›è¡Œä¸€æ¬¡é€‰æ‹©ï¼Œå¾—åˆ°æœ€ç»ˆè¦è°ƒç”¨çš„ Provider èŠ‚ç‚¹ã€‚</p>
<p data-nodeid="45672">äº†è§£äº† ShortestResponseLoadBalance çš„æ ¸å¿ƒåŸç†ä¹‹åï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ ShortestResponseLoadBalance.doSelect() æ–¹æ³•çš„æ ¸å¿ƒå®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="45673"><code data-language="java"><span class="hljs-keyword">protected</span> &lt;T&gt; <span class="hljs-function">Invoker&lt;T&gt; <span class="hljs-title">doSelect</span><span class="hljs-params">(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</span> </span>{
&nbsp; &nbsp; <span class="hljs-comment">// è®°å½•Invokeré›†åˆçš„æ•°é‡</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span> length = invokers.size();
&nbsp; &nbsp; <span class="hljs-comment">// ç”¨äºè®°å½•æ‰€æœ‰Invokeré›†åˆä¸­æœ€çŸ­å“åº”æ—¶é—´</span>
&nbsp; &nbsp; <span class="hljs-keyword">long</span> shortestResponse = Long.MAX_VALUE;
&nbsp; &nbsp; <span class="hljs-comment">// å…·æœ‰ç›¸åŒæœ€çŸ­å“åº”æ—¶é—´çš„Invokerä¸ªæ•°</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span> shortestCount = <span class="hljs-number">0</span>;
&nbsp; &nbsp; <span class="hljs-comment">// å­˜æ”¾æ‰€æœ‰æœ€çŸ­å“åº”æ—¶é—´çš„Invokerçš„ä¸‹æ ‡</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span>[] shortestIndexes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[length];
&nbsp; &nbsp; <span class="hljs-comment">// å­˜å‚¨æ¯ä¸ªInvokerçš„æƒé‡</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span>[] weights = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[length];
&nbsp; &nbsp; <span class="hljs-comment">// å­˜å‚¨æƒé‡æ€»å’Œ</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span> totalWeight = <span class="hljs-number">0</span>;
&nbsp; &nbsp; <span class="hljs-comment">// è®°å½•ç¬¬ä¸€ä¸ªInvokerå¯¹è±¡çš„æƒé‡</span>
&nbsp; &nbsp; <span class="hljs-keyword">int</span> firstWeight = <span class="hljs-number">0</span>;
&nbsp; &nbsp; <span class="hljs-comment">// æœ€çŸ­å“åº”æ—¶é—´Invokeré›†åˆä¸­çš„Invokeræƒé‡æ˜¯å¦ç›¸åŒ</span>
&nbsp; &nbsp; <span class="hljs-keyword">boolean</span> sameWeight = <span class="hljs-keyword">true</span>;
&nbsp; &nbsp; <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {
&nbsp; &nbsp; &nbsp; &nbsp; Invoker&lt;T&gt; invoker = invokers.get(i);
&nbsp; &nbsp; &nbsp; &nbsp; RpcStatus rpcStatus = RpcStatus.getStatus(invoker.getUrl(), invocation.getMethodName());
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// è·å–è°ƒç”¨æˆåŠŸçš„å¹³å‡æ—¶é—´ï¼Œå…·ä½“è®¡ç®—æ–¹å¼æ˜¯ï¼šè°ƒç”¨æˆåŠŸçš„è¯·æ±‚æ•°æ€»æ•°å¯¹åº”çš„æ€»è€—æ—¶ / è°ƒç”¨æˆåŠŸçš„è¯·æ±‚æ•°æ€»æ•° = æˆåŠŸè°ƒç”¨çš„å¹³å‡æ—¶é—´</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// RpcStatus çš„å†…å®¹åœ¨å‰é¢è¯¾æ—¶å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œä¸å†é‡å¤</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">long</span> succeededAverageElapsed = rpcStatus.getSucceededAverageElapsed();
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// è·å–çš„æ˜¯è¯¥Providerå½“å‰çš„æ´»è·ƒè¯·æ±‚æ•°ï¼Œä¹Ÿå°±æ˜¯å½“å‰æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">int</span> active = rpcStatus.getActive();
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// è®¡ç®—ä¸€ä¸ªå¤„ç†æ–°è¯·æ±‚çš„é¢„ä¼°å€¼ï¼Œä¹Ÿå°±æ˜¯å¦‚æœå½“å‰è¯·æ±‚å‘ç»™è¿™ä¸ªProviderï¼Œå¤§æ¦‚è€—æ—¶å¤šä¹…å¤„ç†å®Œæˆ</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">long</span> estimateResponse = succeededAverageElapsed * active;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// è®¡ç®—è¯¥Invokerçš„æƒé‡ï¼ˆä¸»è¦æ˜¯å¤„ç†é¢„çƒ­ï¼‰</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">int</span> afterWarmup = getWeight(invoker, invocation);
&nbsp; &nbsp; &nbsp; &nbsp; weights[i] = afterWarmup;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (estimateResponse &lt; shortestResponse) {&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// ç¬¬ä¸€æ¬¡æ‰¾åˆ°Invokeré›†åˆä¸­æœ€çŸ­å“åº”è€—æ—¶çš„Invokerå¯¹è±¡ï¼Œè®°å½•å…¶ç›¸å…³ä¿¡æ¯</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shortestResponse = estimateResponse;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shortestCount = <span class="hljs-number">1</span>;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shortestIndexes[<span class="hljs-number">0</span>] = i;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; totalWeight = afterWarmup;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; firstWeight = afterWarmup;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sameWeight = <span class="hljs-keyword">true</span>;
&nbsp; &nbsp; &nbsp; &nbsp; } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (estimateResponse == shortestResponse) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-comment">// å‡ºç°å¤šä¸ªè€—æ—¶æœ€çŸ­çš„Invokerå¯¹è±¡</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shortestIndexes[shortestCount++] = i;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; totalWeight += afterWarmup;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (sameWeight &amp;&amp; i &gt; <span class="hljs-number">0</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; afterWarmup != firstWeight) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sameWeight = <span class="hljs-keyword">false</span>;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (shortestCount == <span class="hljs-number">1</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> invokers.get(shortestIndexes[<span class="hljs-number">0</span>]);
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-comment">// å¦‚æœè€—æ—¶æœ€çŸ­çš„æ‰€æœ‰Invokerå¯¹è±¡çš„æƒé‡ä¸ç›¸åŒï¼Œåˆ™é€šè¿‡åŠ æƒéšæœºè´Ÿè½½å‡è¡¡çš„æ–¹å¼é€‰æ‹©ä¸€ä¸ªInvokerè¿”å›</span>
&nbsp; &nbsp; <span class="hljs-keyword">if</span> (!sameWeight &amp;&amp; totalWeight &gt; <span class="hljs-number">0</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">int</span> offsetWeight = ThreadLocalRandom.current().nextInt(totalWeight);
&nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; shortestCount; i++) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">int</span> shortestIndex = shortestIndexes[i];
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; offsetWeight -= weights[shortestIndex];
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">if</span> (offsetWeight &lt; <span class="hljs-number">0</span>) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="hljs-keyword">return</span> invokers.get(shortestIndex);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="hljs-comment">// å¦‚æœè€—æ—¶æœ€çŸ­çš„æ‰€æœ‰Invokerå¯¹è±¡çš„æƒé‡ç›¸åŒï¼Œåˆ™éšæœºè¿”å›ä¸€ä¸ª</span>
&nbsp; &nbsp; <span class="hljs-keyword">return</span> invokers.get(shortestIndexes[ThreadLocalRandom.current().nextInt(shortestCount)]);
}
</code></pre>
<h3 data-nodeid="45674">æ€»ç»“</h3>
<p data-nodeid="45675">ä»Šå¤©æˆ‘ä»¬ç´§æ¥ä¸Šä¸€è¯¾æ—¶ä»‹ç»äº† LoadBalance æ¥å£çš„å‰©ä½™ä¸‰ä¸ªå®ç°ã€‚</p>
<p data-nodeid="45676">æˆ‘ä»¬é¦–å…ˆä»‹ç»äº† LeastActiveLoadBalance å®ç°ï¼Œå®ƒä½¿ç”¨æœ€å°æ´»è·ƒæ•°è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œé€‰æ‹©å½“å‰è¯·æ±‚æœ€å°‘çš„ Provider èŠ‚ç‚¹å¤„ç†æœ€æ–°çš„è¯·æ±‚ï¼›æ¥ä¸‹æ¥ä»‹ç»äº† RoundRobinLoadBalance å®ç°ï¼Œå®ƒä½¿ç”¨åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå¼¥è¡¥äº†å•çº¯çš„è½®è¯¢è´Ÿè½½å‡è¡¡ç®—æ³•å¯¼è‡´çš„é—®é¢˜ï¼ŒåŒæ—¶éšç€ Dubbo ç‰ˆæœ¬çš„å‡çº§ï¼Œä¹Ÿå°†å…¶è‡ªèº«ä¸å¤Ÿå¹³æ»‘çš„é—®é¢˜ä¼˜åŒ–æ‰äº†ï¼›æœ€åä»‹ç»äº† ShortestResponseLoadBalance å®ç°ï¼Œå®ƒä¼šä»å“åº”æ—¶é—´æœ€çŸ­çš„ Provider èŠ‚ç‚¹ä¸­é€‰æ‹©ä¸€ä¸ª Provider èŠ‚ç‚¹æ¥å¤„ç†æ–°è¯·æ±‚ã€‚</p>
<p data-nodeid="45677" class="">ä¸‹ä¸€è¯¾æ—¶ï¼Œæˆ‘ä»¬å°†å¼€å§‹ä»‹ç» Cluster æ¥å£ä»¥åŠå®¹é”™æœºåˆ¶çš„ç›¸å…³å†…å®¹ï¼Œè®°å¾—æŒ‰æ—¶æ¥å¬è¯¾ã€‚</p>

---

### ç²¾é€‰è¯„è®º

##### *é•‡ï¼š
> å¤§ç‰›è€å¸ˆï¼Œæœ€åé¢èƒ½åˆ†äº«å¸¦æœ‰æ³¨é‡Šçš„æºç å—ğŸ˜€

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; éå¸¸å¼€å¿ƒä½ èƒ½åšæŒåˆ°è¿™é‡Œï¼Œå­¦ä¹ æ˜¯ä»¶ä¸å®¹æ˜“çš„äº‹ï¼Œç»§ç»­åŠ æ²¹~å¦å¤–ï¼Œä¸ºä¾¿äºä½ å’Œå…¶ä»–å°ä¼™ä¼´ä»¬æ›´å¥½åœ°å­¦ä¹ ï¼Œæˆ‘å·²ç»å°†æ•´ä¸ª Dubbo çš„æºç ï¼ˆå¸¦æ³¨é‡Šçš„ï¼‰æ”¾åˆ° GitHub ä¸Šäº†ï¼Œä½ å¯ä»¥æŒ‰éœ€æŸ¥çœ‹ï¼šhttps://github.com/xxxlxy2008/dubboã€‚ï¼ˆä¸ºæ–¹ä¾¿æŸ¥çœ‹ï¼Œè¯¥ç½‘å€ä¹Ÿæ”¾åœ¨å¼€ç¯‡è¯ä¸­äº†ã€‚ï¼‰


<p data-nodeid="2457" class="">åœ¨æœ¬è¯¾æ—¶æˆ‘ä»¬ä¸»è¦è®²è§£ä»€ä¹ˆæ˜¯è‡ªæ—‹é”ï¼Ÿä»¥åŠä½¿ç”¨è‡ªæ—‹é”çš„å¥½å¤„å’Œåæœåˆ†åˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<h3 data-nodeid="2458">ä»€ä¹ˆæ˜¯è‡ªæ—‹</h3>
<p data-nodeid="2459">é¦–å…ˆï¼Œæˆ‘ä»¬äº†è§£ä»€ä¹ˆå«è‡ªæ—‹ï¼Ÿâ€œè‡ªæ—‹â€å¯ä»¥ç†è§£ä¸ºâ€œè‡ªæˆ‘æ—‹è½¬â€ï¼Œè¿™é‡Œçš„â€œæ—‹è½¬â€æŒ‡â€œå¾ªç¯â€ï¼Œæ¯”å¦‚ while å¾ªç¯æˆ–è€… for å¾ªç¯ã€‚â€œè‡ªæ—‹â€å°±æ˜¯è‡ªå·±åœ¨è¿™é‡Œä¸åœåœ°å¾ªç¯ï¼Œç›´åˆ°ç›®æ ‡è¾¾æˆã€‚è€Œä¸åƒæ™®é€šçš„é”é‚£æ ·ï¼Œå¦‚æœè·å–ä¸åˆ°é”å°±è¿›å…¥é˜»å¡ã€‚</p>
<h4 data-nodeid="2460">å¯¹æ¯”è‡ªæ—‹å’Œéè‡ªæ—‹çš„è·å–é”çš„æµç¨‹</h4>
<p data-nodeid="3053" class="">ä¸‹é¢æˆ‘ä»¬ç”¨è¿™æ ·ä¸€å¼ æµç¨‹å›¾æ¥å¯¹æ¯”ä¸€ä¸‹è‡ªæ—‹é”å’Œéè‡ªæ—‹é”çš„è·å–é”çš„è¿‡ç¨‹ã€‚</p>





<p data-nodeid="2462"><img src="https://s0.lgstatic.com/i/image3/M01/5F/A1/Cgq2xl4S44OAXtbZAAG7wulxruI786.png" alt="" data-nodeid="2497"></p>
<p data-nodeid="2463">é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹è‡ªæ—‹é”ï¼Œå®ƒå¹¶ä¸ä¼šæ”¾å¼ƒ &nbsp;CPU &nbsp;æ—¶é—´ç‰‡ï¼Œè€Œæ˜¯é€šè¿‡è‡ªæ—‹ç­‰å¾…é”çš„é‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¼šä¸åœåœ°å†æ¬¡åœ°å°è¯•è·å–é”ï¼Œå¦‚æœå¤±è´¥å°±å†æ¬¡å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚</p>
<p data-nodeid="2464">æˆ‘ä»¬å†æ¥çœ‹ä¸‹éè‡ªæ—‹é”ï¼Œéè‡ªæ—‹é”å’Œè‡ªæ—‹é”æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ï¼Œå¦‚æœå®ƒå‘ç°æ­¤æ—¶è·å–ä¸åˆ°é”ï¼Œå®ƒå°±æŠŠè‡ªå·±çš„çº¿ç¨‹åˆ‡æ¢çŠ¶æ€ï¼Œè®©çº¿ç¨‹ä¼‘çœ ï¼Œç„¶å CPU å°±å¯ä»¥åœ¨è¿™æ®µæ—¶é—´å»åšå¾ˆå¤šå…¶ä»–çš„äº‹æƒ…ï¼Œç›´åˆ°ä¹‹å‰æŒæœ‰è¿™æŠŠé”çš„çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œäºæ˜¯ CPU å†æŠŠä¹‹å‰çš„çº¿ç¨‹æ¢å¤å›æ¥ï¼Œè®©è¿™ä¸ªçº¿ç¨‹å†å»å°è¯•è·å–è¿™æŠŠé”ã€‚å¦‚æœå†æ¬¡å¤±è´¥ï¼Œå°±å†æ¬¡è®©çº¿ç¨‹ä¼‘çœ ï¼Œå¦‚æœæˆåŠŸï¼Œä¸€æ ·å¯ä»¥æˆåŠŸè·å–åˆ°åŒæ­¥èµ„æºçš„é”ã€‚</p>
<p data-nodeid="2465">å¯ä»¥çœ‹å‡ºï¼Œéè‡ªæ—‹é”å’Œè‡ªæ—‹é”æœ€å¤§çš„åŒºåˆ«ï¼Œå°±æ˜¯å¦‚æœå®ƒé‡åˆ°æ‹¿ä¸åˆ°é”çš„æƒ…å†µï¼Œå®ƒä¼šæŠŠçº¿ç¨‹é˜»å¡ï¼Œç›´åˆ°è¢«å”¤é†’ã€‚è€Œè‡ªæ—‹é”ä¼šä¸åœåœ°å°è¯•ã€‚é‚£ä¹ˆï¼Œè‡ªæ—‹é”è¿™æ ·ä¸åœå°è¯•çš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<h4 data-nodeid="2466">è‡ªæ—‹é”çš„å¥½å¤„</h4>
<p data-nodeid="2467">é¦–å…ˆï¼Œé˜»å¡å’Œå”¤é†’çº¿ç¨‹éƒ½æ˜¯éœ€è¦é«˜æ˜‚çš„å¼€é”€çš„ï¼Œå¦‚æœåŒæ­¥ä»£ç å—ä¸­çš„å†…å®¹ä¸å¤æ‚ï¼Œé‚£ä¹ˆå¯èƒ½è½¬æ¢çº¿ç¨‹å¸¦æ¥çš„å¼€é”€æ¯”å®é™…ä¸šåŠ¡ä»£ç æ‰§è¡Œçš„å¼€é”€è¿˜è¦å¤§ã€‚</p>
<p data-nodeid="2468">åœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œå¯èƒ½æˆ‘ä»¬çš„åŒæ­¥ä»£ç å—çš„å†…å®¹å¹¶ä¸å¤šï¼Œæ‰€ä»¥éœ€è¦çš„æ‰§è¡Œæ—¶é—´ä¹Ÿå¾ˆçŸ­ï¼Œå¦‚æœæˆ‘ä»¬ä»…ä»…ä¸ºäº†è¿™ç‚¹æ—¶é—´å°±å»åˆ‡æ¢çº¿ç¨‹çŠ¶æ€ï¼Œé‚£ä¹ˆå…¶å®ä¸å¦‚è®©çº¿ç¨‹ä¸åˆ‡æ¢çŠ¶æ€ï¼Œè€Œæ˜¯è®©å®ƒè‡ªæ—‹åœ°å°è¯•è·å–é”ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹é‡Šæ”¾é”ï¼Œæœ‰æ—¶æˆ‘åªéœ€è¦ç¨ç­‰ä¸€ä¸‹ï¼Œå°±å¯ä»¥é¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰å¼€é”€ï¼Œæé«˜äº†æ•ˆç‡ã€‚</p>
<p data-nodeid="2469">ç”¨ä¸€å¥è¯æ€»ç»“è‡ªæ—‹é”çš„å¥½å¤„ï¼Œé‚£å°±æ˜¯è‡ªæ—‹é”ç”¨å¾ªç¯å»ä¸åœåœ°å°è¯•è·å–é”ï¼Œè®©çº¿ç¨‹å§‹ç»ˆå¤„äº Runnable çŠ¶æ€ï¼ŒèŠ‚çœäº†çº¿ç¨‹çŠ¶æ€åˆ‡æ¢å¸¦æ¥çš„å¼€é”€ã€‚</p>
<h4 data-nodeid="2470">AtomicLong çš„å®ç°</h4>
<p data-nodeid="2471">åœ¨ Java 1.5 ç‰ˆæœ¬åŠä»¥ä¸Šçš„å¹¶å‘åŒ…ä¸­ï¼Œä¹Ÿå°±æ˜¯ java.util.concurrent çš„åŒ…ä¸­ï¼Œé‡Œé¢çš„åŸå­ç±»åŸºæœ¬éƒ½æ˜¯è‡ªæ—‹é”çš„å®ç°ã€‚</p>
<p data-nodeid="2472">æ¯”å¦‚æˆ‘ä»¬çœ‹ä¸€ä¸ª AtomicLong çš„å®ç°ï¼Œé‡Œé¢æœ‰ä¸€ä¸ª getAndIncrement æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="2473"><code data-language="java"><span class="hljs-function"><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">final</span>&nbsp;<span class="hljs-keyword">long</span>&nbsp;<span class="hljs-title">getAndIncrement</span><span class="hljs-params">()</span>&nbsp;</span>{
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;unsafe.getAndAddLong(<span class="hljs-keyword">this</span>,&nbsp;valueOffset,&nbsp;<span class="hljs-number">1L</span>);
}
</code></pre>
<p data-nodeid="2474">å¯ä»¥çœ‹åˆ°å®ƒè°ƒç”¨äº†ä¸€ä¸ª&nbsp;unsafe.getAndAddLongï¼Œæ‰€ä»¥æˆ‘ä»¬å†æ¥çœ‹è¿™ä¸ªæ–¹æ³•ï¼š</p>
<pre class="lang-java" data-nodeid="2475"><code data-language="java"><span class="hljs-function"><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">final</span>&nbsp;<span class="hljs-keyword">long</span>&nbsp;<span class="hljs-title">getAndAddLong</span>&nbsp;<span class="hljs-params">(Object&nbsp;var1,<span class="hljs-keyword">long</span>&nbsp;var2,&nbsp;<span class="hljs-keyword">long</span>&nbsp;var4)</span></span>{
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">long</span>&nbsp;var6;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">do</span>&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var6&nbsp;=&nbsp;<span class="hljs-keyword">this</span>.getLongVolatile(var1,&nbsp;var2);
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="hljs-keyword">while</span>&nbsp;(!<span class="hljs-keyword">this</span>.compareAndSwapLong(var1,&nbsp;var2,&nbsp;var6,&nbsp;var6&nbsp;+&nbsp;var4));


&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;var6;
}
</code></pre>
<p data-nodeid="2476">åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå®ƒç”¨äº†ä¸€ä¸ª do while å¾ªç¯ã€‚è¿™é‡Œå°±å¾ˆæ˜æ˜¾äº†ï¼š</p>
<pre class="lang-java" data-nodeid="2477"><code data-language="java"><span class="hljs-keyword">do</span>&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;var6&nbsp;=&nbsp;<span class="hljs-keyword">this</span>.getLongVolatile(var1,&nbsp;var2);
}&nbsp;
<span class="hljs-keyword">while</span>&nbsp;(!<span class="hljs-keyword">this</span>.compareAndSwapLong(var1,&nbsp;var2,&nbsp;var6,&nbsp;var6&nbsp;+&nbsp;var4));
</code></pre>
<p data-nodeid="2478">è¿™é‡Œçš„ do-while å¾ªç¯å°±æ˜¯ä¸€ä¸ªè‡ªæ—‹æ“ä½œï¼Œå¦‚æœåœ¨ä¿®æ”¹è¿‡ç¨‹ä¸­é‡åˆ°äº†å…¶ä»–çº¿ç¨‹ç«äº‰å¯¼è‡´æ²¡ä¿®æ”¹æˆåŠŸçš„æƒ…å†µï¼Œå°±ä¼š while å¾ªç¯é‡Œè¿›è¡Œæ­»å¾ªç¯ï¼Œç›´åˆ°ä¿®æ”¹æˆåŠŸä¸ºæ­¢ã€‚</p>
<h4 data-nodeid="2479">è‡ªå·±å®ç°ä¸€ä¸ªå¯é‡å…¥çš„è‡ªæ—‹é”</h4>
<p data-nodeid="2480">ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªè‡ªå·±å®ç°å¯é‡å…¥çš„è‡ªæ—‹é”ã€‚</p>
<p data-nodeid="2481">ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="lang-java" data-nodeid="2482"><code data-language="java"><span class="hljs-keyword">package</span>&nbsp;lesson27;
&nbsp;
<span class="hljs-keyword">import</span>&nbsp;java.util.concurrent.atomic.AtomicReference;
<span class="hljs-keyword">import</span>&nbsp;java.util.concurrent.locks.Lock;
&nbsp;
<span class="hljs-comment">/**
&nbsp;*&nbsp;æè¿°ï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®ç°ä¸€ä¸ªå¯é‡å…¥çš„è‡ªæ—‹é”
&nbsp;*/</span>
<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">ReentrantSpinLock</span>&nbsp;&nbsp;</span>{
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">private</span>&nbsp;AtomicReference&lt;Thread&gt;&nbsp;owner&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;AtomicReference&lt;&gt;();
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//é‡å…¥æ¬¡æ•°</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">private</span>&nbsp;<span class="hljs-keyword">int</span>&nbsp;count&nbsp;=&nbsp;<span class="hljs-number">0</span>;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">lock</span><span class="hljs-params">()</span>&nbsp;</span>{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread&nbsp;t&nbsp;=&nbsp;Thread.currentThread();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(t&nbsp;==&nbsp;owner.get())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++count;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//è‡ªæ—‹è·å–é”</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">while</span>&nbsp;(!owner.compareAndSet(<span class="hljs-keyword">null</span>,&nbsp;t))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="hljs-string">"è‡ªæ—‹äº†"</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">unlock</span><span class="hljs-params">()</span>&nbsp;</span>{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread&nbsp;t&nbsp;=&nbsp;Thread.currentThread();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//åªæœ‰æŒæœ‰é”çš„çº¿ç¨‹æ‰èƒ½è§£é”</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(t&nbsp;==&nbsp;owner.get())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(count&nbsp;&gt;&nbsp;<span class="hljs-number">0</span>)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--count;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="hljs-keyword">else</span>&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//æ­¤å¤„æ— éœ€CASæ“ä½œï¼Œå› ä¸ºæ²¡æœ‰ç«äº‰ï¼Œå› ä¸ºåªæœ‰çº¿ç¨‹æŒæœ‰è€…æ‰èƒ½è§£é”</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;owner.set(<span class="hljs-keyword">null</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">(String[]&nbsp;args)</span>&nbsp;</span>{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReentrantSpinLock&nbsp;spinLock&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;ReentrantSpinLock();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Runnable&nbsp;runnable&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;Runnable()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta">@Override</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">run</span><span class="hljs-params">()</span>&nbsp;</span>{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(Thread.currentThread().getName()&nbsp;+&nbsp;<span class="hljs-string">"å¼€å§‹å°è¯•è·å–è‡ªæ—‹é”"</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spinLock.lock();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span>&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(Thread.currentThread().getName()&nbsp;+&nbsp;<span class="hljs-string">"è·å–åˆ°äº†è‡ªæ—‹é”"</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread.sleep(<span class="hljs-number">4000</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="hljs-keyword">catch</span>&nbsp;(InterruptedException&nbsp;e)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="hljs-keyword">finally</span>&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spinLock.unlock();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(Thread.currentThread().getName()&nbsp;+&nbsp;<span class="hljs-string">"é‡Šæ”¾äº†äº†è‡ªæ—‹é”"</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread&nbsp;thread1&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;Thread(runnable);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread&nbsp;thread2&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;Thread(runnable);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;thread1.start();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;thread2.start();
&nbsp;&nbsp;&nbsp;&nbsp;}
}
</code></pre>
<p data-nodeid="2483">è¿™æ®µä»£ç çš„è¿è¡Œç»“æœæ˜¯ï¼š</p>
<pre class="lang-java" data-nodeid="2484"><code data-language="java">...
è‡ªæ—‹äº†
è‡ªæ—‹äº†
è‡ªæ—‹äº†
è‡ªæ—‹äº†
è‡ªæ—‹äº†
è‡ªæ—‹äº†
è‡ªæ—‹äº†
è‡ªæ—‹äº†
Thread-<span class="hljs-number">0</span>é‡Šæ”¾äº†äº†è‡ªæ—‹é”
Thread-<span class="hljs-number">1</span>è·å–åˆ°äº†è‡ªæ—‹é”
</code></pre>
<p data-nodeid="2485">å‰é¢ä¼šæ‰“å°å‡ºå¾ˆå¤šâ€œè‡ªæ—‹äº†â€ï¼Œè¯´æ˜è‡ªæ—‹æœŸé—´ï¼ŒCPUä¾ç„¶åœ¨ä¸åœè¿è½¬ã€‚</p>
<h4 data-nodeid="2486">ç¼ºç‚¹</h4>
<p data-nodeid="2487">é‚£ä¹ˆè‡ªæ—‹é”æœ‰æ²¡æœ‰ç¼ºç‚¹å‘¢ï¼Ÿå…¶å®è‡ªæ—‹é”æ˜¯æœ‰ç¼ºç‚¹çš„ã€‚å®ƒæœ€å¤§çš„ç¼ºç‚¹å°±åœ¨äºè™½ç„¶é¿å…äº†çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œä½†æ˜¯å®ƒåœ¨é¿å…çº¿ç¨‹åˆ‡æ¢å¼€é”€çš„åŒæ—¶ä¹Ÿå¸¦æ¥äº†æ–°çš„å¼€é”€ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸åœå¾—å»å°è¯•è·å–é”ã€‚å¦‚æœè¿™æŠŠé”ä¸€ç›´ä¸èƒ½è¢«é‡Šæ”¾ï¼Œé‚£ä¹ˆè¿™ç§å°è¯•åªæ˜¯æ— ç”¨çš„å°è¯•ï¼Œä¼šç™½ç™½æµªè´¹å¤„ç†å™¨èµ„æºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶ä¸€å¼€å§‹è‡ªæ—‹é”çš„å¼€é”€ä½äºçº¿ç¨‹åˆ‡æ¢ï¼Œä½†æ˜¯éšç€æ—¶é—´çš„å¢åŠ ï¼Œè¿™ç§å¼€é”€ä¹Ÿæ˜¯æ°´æ¶¨èˆ¹é«˜ï¼ŒåæœŸç”šè‡³ä¼šè¶…è¿‡çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œå¾—ä¸å¿å¤±ã€‚</p>
<h4 data-nodeid="2488">é€‚ç”¨åœºæ™¯</h4>
<p data-nodeid="2489">æ‰€ä»¥æˆ‘ä»¬å°±è¦çœ‹ä¸€ä¸‹è‡ªæ—‹é”çš„é€‚ç”¨åœºæ™¯ã€‚é¦–å…ˆï¼Œè‡ªæ—‹é”é€‚ç”¨äºå¹¶å‘åº¦ä¸æ˜¯ç‰¹åˆ«é«˜çš„åœºæ™¯ï¼Œä»¥åŠä¸´ç•ŒåŒºæ¯”è¾ƒçŸ­å°çš„æƒ…å†µï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥åˆ©ç”¨é¿å…çº¿ç¨‹åˆ‡æ¢æ¥æé«˜æ•ˆç‡ã€‚</p>
<p data-nodeid="3315">å¯æ˜¯å¦‚æœä¸´ç•ŒåŒºå¾ˆå¤§ï¼Œçº¿ç¨‹ä¸€æ—¦æ‹¿åˆ°é”ï¼Œå¾ˆä¹…æ‰ä¼šé‡Šæ”¾çš„è¯ï¼Œé‚£å°±ä¸åˆé€‚ç”¨è‡ªæ—‹é”ï¼Œå› ä¸ºè‡ªæ—‹ä¼šä¸€ç›´å ç”¨ CPU å´æ— æ³•æ‹¿åˆ°é”ï¼Œç™½ç™½æ¶ˆè€—èµ„æºã€‚</p>
<blockquote data-nodeid="8292">
<p data-nodeid="8293" class="">æœ¬è®²æµç¨‹å›¾å‚è€ƒè‡ª<a href="https://tech.meituan.com/2018/11/15/java-lock.html" data-nodeid="8297">https://tech.meituan.com/2018/11/15/java-lock.html</a><br>
è‡ªæ—‹é”çš„å®ç°çš„ä»£ç æ¥è‡ª<a href="https://www.fatalerrors.org/a/java-implementation-of-spin-lock.html" data-nodeid="8302">https://www.fatalerrors.org/a/java-implementation-of-spin-lock.html</a></p>
</blockquote>

---

### ç²¾é€‰è¯„è®º

##### *ç•…ï¼š
> unlock()é‡Œ ï¼Œcount ä¸º1 çš„æ—¶å€™ï¼Œåˆšå¥½å‡åˆ°0ï¼Œä¹Ÿéœ€è¦owner.set(null)å§?

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; ä¸éœ€è¦ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œlockä¸ä¼šå¢åŠ countçš„å€¼ï¼Œç›´æ¥CASå°±èƒ½æ‹¿åˆ°é”ï¼Œæ­¤æ—¶countä¸º0ï¼Œä¹‹åè§£é”æ—¶ï¼Œå½“countä¸º0æ—¶ï¼Œæ‰§è¡Œunlockæ‰ä»£è¡¨è§£é”ã€‚

##### **å†›ï¼š
> è€å¸ˆï¼Œè¯·é—®è‡ªæ—‹é”çš„æ¦‚å¿µå’Œå…¬å¹³é”çš„æ¦‚å¿µå†²çªä¹ˆï¼Œé”å¯ä»¥åŒæ—¶æ‹¥æœ‰è¿™ä¸¤ç§å±æ€§ä¹ˆï¼Ÿ

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; ä¸å†²çªï¼Œå¯ä»¥åŒæ—¶æ‹¥æœ‰ã€‚

##### **4300ï¼š
> ä¾‹å­å†™å¾—å¥½ï¼

##### *æ¡ƒï¼š
> å°†é˜»å¡çŠ¶æ€çš„çº¿ç¨‹ç¼–ç¨‹ runnable æ˜¯CPUå¹²çš„è¿˜æ˜¯æ“ä½œç³»ç»Ÿå¹²å¾—å•Š

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; æ“ä½œç³»ç»Ÿ

##### **å±±ï¼š
> ä¸ºå•¥owneræ²¡æœ‰èµ‹å€¼çš„åœ°æ–¹ï¼Œä½†æ˜¯ç¡®æ˜¯æœ‰å€¼çš„ï¼ŸğŸ˜‚

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; åœ¨æ­¤æ—¶èµ‹å€¼owner.compareAndSet(null,Â t)

##### *é”‹ï¼š
> å¾ˆæ¸…æ¥š

##### **è¾¾ï¼š
> è‡ªæ—‹é”æ˜¯å¯ä»¥ç”¨pauseæŒ‡ä»¤ä¼˜åŒ–çš„


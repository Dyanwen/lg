<p data-nodeid="134671" class="">今天这一讲，我想跟你聊一聊如何用架构师的视角进行技术面试。</p>
<p data-nodeid="134672">面试时你是否常被问到这样的问题：“你之前是如何设计这个系统（或子系统/模块/功能）的？请介绍你的思路。”</p>
<p data-nodeid="134673">很多研发同学在听到类似的面试题时，往往忽略“系统设计思路”关键词，而是陷入某个技术点细节里，让面试官听得一头雾水。这样即使技术再好，面试官也很难给你打高分，更可能认为你的设计能力不足，没有全局思维。</p>
<p data-nodeid="134674">而要想答得更好，你要用架构师的视角回答，即从全局技术视角阐述设计的过程。接下来我会通过一个案例，讲解如何从全局技术视角介绍自己的技术方案。</p>
<h3 data-nodeid="134675">案例背景</h3>
<p data-nodeid="134676">在电商中，当用户发表一条商品评论，后台的逻辑是点评系统会调用一系列的远程 API 接口，如调用风控系统、广告系统、消息系统……几个甚至十几个系统的接口。</p>
<p data-nodeid="134677">在业务建设之初，考虑到快速开发与上线，商品评论发布是通过同步 RPC（Remote Procedure Call，远程过程调用）远程调用各系统接口完成的。这种方式在系统少、逻辑简单的阶段很符合实际情况的设计。</p>
<p data-nodeid="134678">但随着业务快速发展，通过 RPC 同步调用的问题逐渐暴露出来。由于过多地依赖其他系统，导致评论发布的接口性能很低，可用性也容易受到其他系统影响。而且每当点评系统需求上线时，其他系统都需要跟着进行联调测试，导致需求迭代速度缓慢。<br>
<img src="https://s0.lgstatic.com/i/image2/M01/05/45/CgpVE1_-d-aAaAdUAAE0zFMFmxg960.png" alt="3.png" data-nodeid="134782"></p>
<div data-nodeid="134679"><p style="text-align:center"><span style="color:#b8b8b8">系统</span></p></div>
<p data-nodeid="135507">在做系统架构升级改造时，如果你有互联网设计理念，会很容易想到问题在于系统间的耦合度太高。解决办法就是采用异步化解耦，从而通过引入 MQ 消息管道，在架构上进行系统业务逻辑拆分，将原本强依赖的系统间的同步 RPC 调用变成异步消息触发，如下面图片中的架构所示：</p>
<p data-nodeid="135508" class="te-preview-highlight"><img src="https://s0.lgstatic.com/i/image2/M01/05/45/CgpVE1_-fh6AOb3SAAELEzS8dt8480.png" alt="4.png" data-nodeid="135513"></p>
<div data-nodeid="135509"><p style="text-align:center"><span style="color:#b8b8b8">架构</span></p></div>




<h3 data-nodeid="134683">案例分析</h3>
<p data-nodeid="134684">对于上面的案例，假设你是应聘者，当被问“如何做这个点评系统的改造？”时，你会怎么回答？你会不会直截了当地说“我引入了 MQ 消息队列，做了系统解耦，采用异步消息通知的方式来触发系统调用”呢？</p>
<p data-nodeid="134685">在互联网系统设计方案如此透明的今天，随便在网上搜一下都会有大量类似的解决方案。以上回答不但不会让面试官满意，甚至有可能令人怀疑你的项目经历的真实性。</p>
<p data-nodeid="134686">作为研发工程师，正确的回答方式是要让面试官知道你解决问题的思维。相比一上来就说用了什么技术，阐述解决思维更能证明你的能力，<strong data-nodeid="134795">因为解决技术问题的方法有很多，这是“术”，但解决技术问题的底层思维逻辑是一样的，这是“道”</strong>。</p>
<p data-nodeid="134687">面对此类问题，我总结了如下四个层面的答案：</p>
<ol data-nodeid="134688">
<li data-nodeid="134689">
<p data-nodeid="134690">谈复杂来源；</p>
</li>
<li data-nodeid="134691">
<p data-nodeid="134692">谈解决方案；</p>
</li>
<li data-nodeid="134693">
<p data-nodeid="134694">谈评估标准；</p>
</li>
<li data-nodeid="134695">
<p data-nodeid="134696">说技术实现。</p>
</li>
</ol>
<h3 data-nodeid="134697">问题解答</h3>
<p data-nodeid="134698">我还是拿上面的例子来分析如何回答此类问题。</p>
<h4 data-nodeid="134699">复杂来源</h4>
<p data-nodeid="134700">之所以要先分析系统的复杂度，是因为只有正确分析后才能明确设计原则，进而设计架构方案，整体项目才不会找错方向。</p>
<p data-nodeid="134701">如果一个系统本来因业务逻辑复杂导致功能耦合严重，你却设计了一个 TPS（Transactions Per Second，每秒事务处理量）达到 10000/秒 的高性能架构，那么即使架构性能再优秀，也没有现实意义，因为技术设计没有解决主要问题的复杂度。这是很多研发工程师的通病，设计偏离了方向，只是为了设计而设计。</p>
<p data-nodeid="134702"><strong data-nodeid="134810">那么如何正确评估系统的复杂度呢？</strong> 互联网软件通常分为功能性的复杂度和非功能性的复杂度两种。我将分析过程制作成了一张图片。</p>
<p data-nodeid="134703"><img src="https://s0.lgstatic.com/i/image/M00/8D/67/CgqCHl_-eVaAcKLPAAE9AeK1Y8k819.png" alt="5.png" data-nodeid="134813"></p>
<div data-nodeid="134704"><p style="text-align:center"><span style="color:#b8b8b8">复杂度评估</span></p></div>
<p data-nodeid="134705"><strong data-nodeid="134818">从功能性复杂度方面来看</strong>，你可以从案例中得知，产品业务发展快速、系统越来越多、协作效率越来越低。作为系统负责人，你敏锐地发现问题根源在架构上各业务子系统强耦合。于是你引入消息队列解耦各系统，这是系统业务领域带来的本质上的复杂度，也就是功能性的复杂度，解决的是系统效率的问题。</p>
<p data-nodeid="134706">此外，对于互联网系统设计，还需要考虑非功能性的复杂度，例如高性能、高可用和扩展性等的复杂度的设计。</p>
<p data-nodeid="134707"><strong data-nodeid="134832">从非功能性复杂度方面来看</strong>，我们假设系统用户每天发送 100 万条点评，那么点评的消息管道一天会产生 100 万条消息，再假设平均一条消息有 10 个子系统读取，那么每秒的处理数据，即点评消息队列系统的 TPS 和 QPS（Queries Per Second，每秒查询次数）就分别是 11（1000000/60*60*24）和 115（10000000/60*60*24）。</p>
<p data-nodeid="134708">不过系统的读写不是完全平均的，设计的目标应该以峰值来计算，即取平均值的 4 倍。于是点评消息队列系统的 TPS 变成了 44，QPS 变成了 460，这个量级的数据意味着并不需要设计高性能架构方案。</p>
<p data-nodeid="134709">接着还要考虑业务规模发展。架构设计的目标应该满足未来业务增长，我们把未来业务增长的预估峰值设定为目前峰值的 4 倍，这样最终的性能要求分别是：TPS 为 176，QPS 是 1840。这样的读写指标还达不到系统压测的性能基线，所以可以确定的是点评系统的复杂度并不在高性能问题上。</p>
<p data-nodeid="134710">对于点评系统来说，还需要考虑高可用的问题。假设点评系统的消息队列挂掉，将导致用户评论发送失败，当然在用户体验层面，解决方式可以在页面端提示用户重新操作，但如果问题影响到了点评消息的读取，导致评论没有走风控策略，就会造成严重的影响。所以高可用性是点评系统的设计复杂度之一，包括点评写入、点评存储，以及点评消息的读取，都需要保证高可用性。</p>
<p data-nodeid="134711">为了方便理解非功能性的复杂度，我只分析了“高性能”和“高可用”这两点，在实际应用中，不同的公司或者团队可能还有其他方面的复杂度分析。例如有的公司会考虑安全性，有的公司会考虑成本等。</p>
<p data-nodeid="134712">所以综合分析来看，点评系统改造的复杂度来源于两点。</p>
<ul data-nodeid="134713">
<li data-nodeid="134714">
<p data-nodeid="134715"><strong data-nodeid="134842">功能性复杂度</strong>：要解决业务发展带来的系统耦合、开发效率缓慢问题。</p>
</li>
<li data-nodeid="134716">
<p data-nodeid="134717"><strong data-nodeid="134847">非功能性复杂度</strong>：要保证系统的高可用性。</p>
</li>
</ul>
<h4 data-nodeid="134718">解决方案</h4>
<p data-nodeid="134719">在确定了系统面临的主要复杂度问题后，就有了明确的方案设计目标，这时就可以开始进行架构方案设计了。我同样会结合本文的案例场景，谈谈点评系统消息管道的架构设计解决方案。</p>
<ol data-nodeid="134720">
<li data-nodeid="134721">
<p data-nodeid="134722"><strong data-nodeid="134854">采用开源的 MQ 消息管道</strong>。目前 MQ 消息管道有很多开源解决方案，比如 Kafka、RocketMQ、RabbitMQ 等。在实际项目中，你可以根据不同的应用场景选择合适的成熟开源消息队列方案，这是很多公司常用的做法。</p>
</li>
<li data-nodeid="134723">
<p data-nodeid="134724"><strong data-nodeid="134859">采用开源的 Redis 实现消息队列</strong>。方案 1 虽然应用了开源 MQ 实现点评消息的通信，但是因为引入一个消息中间件就会带来运维成本，所以方案 2 可以基于轻量级的 Redis 实现，以降低系统的维护成本和实现复杂度。</p>
</li>
<li data-nodeid="134725">
<p data-nodeid="134726"><strong data-nodeid="134864">采用内存队列 + MySQL 来实现</strong>。方案 2 中虽然应用了较为轻量级的 Redis 来实现，但是还需要引入一个缓存系统，同样也会带来运维成本，所以方案 3 是直接基于 MySQL 实现，即基于内存队列的方式，异步持久化到数据库，然后通过定时任务读取 MySQL 中的消息并处理。</p>
</li>
</ol>
<p data-nodeid="134727">一般情况，你至少要设计两到三套备选方案，考虑通过不同的技术方式来解决问题。方案设计不用过于详细，而是要确定技术的可行性和优缺点。</p>
<h4 data-nodeid="134728">评估标准</h4>
<p data-nodeid="134729">设计完三套解决方案之后，摆在眼前的问题就是需要选择最合适的一个。<strong data-nodeid="134871">这就需要一套评估标准了。</strong></p>
<p data-nodeid="134730">在互联网软件架构中，架构师常常会把一些通用的设计原则写到设计文档中，比如设计松耦合、系统可监控，这些原则似乎不常用，但好的架构师会通过设计原则来控制项目的技术风险。比如系统无单点，限制了系统技术方案不可出现单点服务的设计；再如系统可降级，限制了系统有具备降级的能力，进而约束了开发人员需要设计数据兜底的技术方案。</p>
<p data-nodeid="134731">这些看似不重要的设计原则，其实是评估架构解决方案的重要手段。做系统架构，需要站在更高的层面考虑系统的全局性关注点，比如性能、可用性、IT 成本、投入资源、实现复杂度、安全性、后续扩展性等。这在不同场景的不同阶段会起到决定性作用。</p>
<p data-nodeid="134732">那么针对案例中的点评系统来说，要如何评估方案呢？这要从点评系统的复杂度来源进行评估。</p>
<ul data-nodeid="134733">
<li data-nodeid="134734">
<p data-nodeid="134735"><strong data-nodeid="134878">点评系统功能性复杂度</strong></p>
</li>
</ul>
<p data-nodeid="134736">点评系统的功能性复杂度问题，本质上是随着业务发展带来的系统开发效率问题。解决这个问题要试着站得更高一些，以部门负责人的视角，考虑现有研发团队的能力素质、IT 成本、资源投入周期等因素是否匹配上面三种架构解决方案。</p>
<ul data-nodeid="134737">
<li data-nodeid="134738">
<p data-nodeid="134739"><strong data-nodeid="134883">点评系统非功能性复杂度</strong></p>
</li>
</ul>
<p data-nodeid="134740">为了解决系统的高可用，可以参考三个设计原则。</p>
<p data-nodeid="134741"><strong data-nodeid="134889">第一个是系统无单点原则</strong>。首先要保证系统各节点在部署的时候至少是冗余的，没有单点。很显然三种设计方案都支持无单点部署方式，都可以做到高可用。</p>
<p data-nodeid="134742"><strong data-nodeid="134894">第二个是可水平扩展原则</strong>。对于水平扩展，MQ 和 Redis 都具有先天的优势，但内存队列 + MySQL 的方式则需要做分库分表的开发改造，并且还要根据业务提前考虑未来的容量预估。</p>
<p data-nodeid="134743"><strong data-nodeid="134899">第三个是可降级原则</strong>。降级处理是当系统出现故障的时候，为了系统的可用性，选择有损的或者兜底的方式提供服务。</p>
<p data-nodeid="134744">常用手段主要有三种。</p>
<ul data-nodeid="134745">
<li data-nodeid="134746">
<p data-nodeid="134747"><strong data-nodeid="134905">限流</strong>，即抛弃超出预估流量外的用户。</p>
</li>
<li data-nodeid="134748">
<p data-nodeid="134749"><strong data-nodeid="134910">降级</strong>，即抛弃部分不重要的功能，让系统提供有损服务，如商品详情页不展示宝贝收藏的数量，以确保核心功能不受影响。</p>
</li>
<li data-nodeid="134750">
<p data-nodeid="134751"><strong data-nodeid="134915">熔断</strong>，即抛弃对故障系统的调用。一般情况下熔断会伴随着降级处理，比如展示兜底数据。</p>
</li>
</ul>
<p data-nodeid="134752">针对案例场景中三个解决方案的降级策略，在一般的情况下，我们默认数据库是不可降级的，MQ 和 Redis 都可以通过降级到数据库的方式做容灾处理。所以案例中的三个解决方案，MQ 和 Redis 要考虑降级到 MySQL 或其他方式，这里就还需要根据情况投入降级的开发成本。</p>
<p data-nodeid="134753">对于本节课的案例我不评价哪个更好，你在多个解决方案中做选择时，<strong data-nodeid="134922">不要陷入某个纯粹技术点的优劣之争，那样很难有结果，越大的项目越明显。</strong> 通常来说，方案没有优劣之分，而是要看哪个更适合当下的问题，只要架构满足一定时期内的业务发展就可以。</p>
<p data-nodeid="134754"><strong data-nodeid="134926">你要知道，作为技术人，考虑问题的方式要比具体的选型结果更为重要，这是面试的加分点。</strong></p>
<h4 data-nodeid="134755">技术实现</h4>
<p data-nodeid="134756">在确定了具体的架构解决方案之后，<strong data-nodeid="134933">需要进一步说明技术上的落地实现方式和深层原理</strong>，如果你最终选择基于 Redis 来实现消息队列，那么可以有几种实现方式？各自的优缺点有哪些？对于这些问题，要做到心里有数。比如，基于 Redis List 的 LPUSH 和 RPOP 的实现方式、基于 Redis 的订阅或发布模式，或者基于 Redis 的有序集合（Sorted Set）的实现方式，你可以自行搜索，我不再赘述。</p>
<h3 data-nodeid="134757">总结</h3>
<p data-nodeid="134758">最后，我把今天的“四步回答法”做个总结，加深每一步你需要掌握的注意点。</p>
<ol data-nodeid="134759">
<li data-nodeid="134760">
<p data-nodeid="134761">在回答系统复杂度来源的时候，要注意结合具体的业务场景和业务发展阶段来阐述。业务场景表明了业务的独特性，发展阶段表明了业务的成熟度，因为同一业务场景在不同阶段产生的矛盾也是不同的。</p>
</li>
<li data-nodeid="134762">
<p data-nodeid="134763">在回答解决方案的时候，有价值的解决方案一定是建立在明确复杂度来源基础之上的。所以在设计架构的时候才分主要问题和次要问题，主要问题是必须要解决的点，次要问题可以根据实际情况进行取舍。</p>
</li>
<li data-nodeid="134764">
<p data-nodeid="134765">在回答如何评估架构方案时，至少要从功能性和非功能性两个角度出发判断方案的合理性。对于很难决策的方案，要从更高的视角（比如技术负责人、业务负责人的角度）进行考量。</p>
</li>
<li data-nodeid="134766">
<p data-nodeid="134767">在技术实现的细节上，要尽量讲出技术的实现原理，不要浮于表面的框架组合。</p>
</li>
</ol>
<p data-nodeid="134768">到这里，我们已经知道了如何用架构师的视角进行技术面试，那么你现在理解<strong data-nodeid="134949">什么是架构师视角了吗？<strong data-nodeid="134948">其实简单一句话，所谓的</strong>架构师视角就是全局的视角，这里的全局包括空间全局和时间全局，在空间全局上你要看到整个系统的领域边界，在时间全局上你要看到整个系统的发展周期。</strong></p>
<p data-nodeid="134769">本节课的思考题是：对于类似的案例，你曾在面试中是怎么回答的？欢迎你把答案写到留言区，和我一起讨论。</p>
<p data-nodeid="134770" class="">文章结尾，送给你一句话：“知道做什么永远比怎么做更为重要”。下节课，我将带你了解当面试中遇到 CAP 理论的问题时，怎么回答才更出彩。记得来听课！</p>

---

### 精选评论

##### Edison Zhou：
> 今天这节让我想到了一个思维模型的对比，一个是从what到how再到why，但很多人往往只到了how就截止了，部分人接触到了一点why。另一个是从why到how再到what，这是从本质出发的所谓的第一性原理的模型，然而往往要洞悉why，很多时候需要了解来龙去脉，这在设计过程中可能就需要站在全局的角度去思考，然后经过迭代的考虑和抽象得到why，也就有了最后直击问题本质的解决方案how，最后可以给这个方案定义为某个系统某个阶段的合适的解决方案也就是what。现在想想，回答一个问题，也就是回到解决问题最初的思考模型。

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 对滴，优秀！

##### Reiser：
> 我之前面试回答了一个用 Redis + HBase 实现的多级缓存的项目经历。我回想我的回答只是简单的描述了框架组合。这节课之后，我想到应该先交代一下问题的背景，多个解决方案的比对和迭代过程，功能与非功能的权衡，解决问题的效果和成本以及技术实现原理。这样才是一个完整的回答

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 对滴，要有个思考问题的过程，这也是对面试官的尊重，会很受用。

##### **赞：
> 面试中遇到过类似的问题，面试官拿着简历问：你能介绍下这个项目吗？我通常都是讲下项目背景、整体架构方案，然后再说技术选型之类的。总感觉不是很能打动面试官，今天拜读作者文章，知道问题出在哪里了，受益良多，谢谢！ 求加更！！！ 求加更！！！

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 你能有所收获，我就很开心了，多积累，多学习总归是不错的，欢迎随时交流哦。

##### *昊：
> 解决技术问题的方法有很多，这是“术”，但解决技术问题的底层思维逻辑是一样的，这是“道”！很好的总结，我们日常开发中总是在和“术”打交道，背后的“道”很难被发掘出来！

##### *娟：
> 讲得很好 受益了😁

##### *峥：
> 给老师32个赞！那些真正的高手不只是技术视野广，肯定技术认知也很深

##### *进：
> 老师说的真好，即使没实际做过，也让面试官感觉你很专业

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 谢谢

##### *凤：
> 感谢老师，之前总是觉得自己的工作无非就是增删改查，没什么好说的，通过这节课，发现还是有很多可说的点的。

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 对的

##### **飞：
> 讲的很好

##### *广：
> 系统设计介绍，相比具体的技术问题而言，没有非常准确的答案，是属于开放式的问题。这种问题往往更加能够体现出一个开发人员的综合素质。体现了开发人员是否真的完全理解项目的整体背景和来龙去脉，从业务的背景、复杂度、所处的解决入手，结合公司的实际技术体系，综合考虑实现成本、难度、风险、可行性等多方面的因素，选择出最适合当下场景的技术方案，才是一个优秀的开发者应该有的能力。

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 很赞同，给你点个赞

##### **耀：
> 老师，为什么峰值是平均值4倍计算？预估峰值又是峰值的4倍？

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 来自于历史峰值数据，也可以先提前了解业务方的活动力度再进行估算

##### *河：
> 讲的太精彩了，收获很多

##### **炎：
> 老师您说的整个系统的领域边界，这个领域边界是什么呢？可以举些例子吗？

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 领域边界不绝对，看你怎么定义这个领域。例如你在一家旅行OTA平台，这个平台中有酒店系统、机票系统，还有门票系统等，你可以把旅行定义为一个领域，也可以把酒店业务定义为一个领域。

##### **海：
> 这样的读写指标还达不到系统压测的性能基线，性能基线是什么标准呢？老师能不能讲述一下

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 这个跟业务复杂度和服务器配置相关，性能基线是在上线前通过压力测试确定的。

##### *硕：
> 为什么评论系统上线需要和其他系统联调？系统间的接口没有变化应该不用联调吧，即使引入MQ这个中间层，发送的消息格式等发生变化其他系统一样会受到影响，请问老师是这样么？

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 对的，任何通信方式，只要发生数据格式变更都会受到影响。RPC 相比于 MQ 来说，解耦程度不够彻底，在出现大的技改时候，测试联调也避免不了。

##### **驰：
> 谢谢分享，请问这种消息发布系统，如果下游系统出现错误该怎么处理呢。我指的的业务处理错误。

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 首先要确保消息不能丢失，并且有重传补偿的机制，下游系统还要具幂等性，在保证以上三点后，在根据实际的业务场景进行处理，对于线上的系统出现问题，先将这台消费机摘掉，确保线上服务的正常，这是第一优先级，然后再做后续处理，分析日志，查看监控...。

##### **一：
> 精彩，很多程序员给人不擅表达感受，一个常见的现象就是直接说出结论，却说不出得出结论的过程和依据。

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 感谢支持，咱们互相学习

##### *瑶：
> 老师讲的很好，就是更新太慢了，不够看啊

 ###### &nbsp;&nbsp;&nbsp; 编辑回复：
> &nbsp;&nbsp;&nbsp; 课程是周一、周四更新嘛~不要着急惹~

##### **华：
> 不错，收获很多，还要努力学习

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 加油！

##### l：
> 经典，很少看到专门讲架构的，大多数讲架构的课，最后都演变成讲技术解决方案了。希望老师后面的内容越来越精辟。

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 感谢支持哦，多多学习和积累。

##### *亚：
> 打卡

##### **峰：
> 最终方案是要做到前端提交评论，后端放到消息队列之后直接返回成功，然后后端再慢慢消费消息调用其他系统处理吗？

 ###### &nbsp;&nbsp;&nbsp; 讲师回复：
> &nbsp;&nbsp;&nbsp; 这是一种通用的系统解耦方案，也是系统最终一致性的设计方案，但基于 MQ 的最终一致性的方案还要考虑比如如何防止消息丢失，补偿，以及积压等问题。

##### **滨：
> 第一打卡

 ###### &nbsp;&nbsp;&nbsp; 编辑回复：
> &nbsp;&nbsp;&nbsp; 加油哦！

